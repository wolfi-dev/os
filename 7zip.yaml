package:
  name: 7zip
  version: "2501"
  epoch: 2
  description: "File archiver with a high compression ratio"
  copyright:
    - license: LGPL-2.0-only

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle

var-transforms:
  - from: ${{package.version}}
    match: ^(\d{2})(\d{2})
    replace: $1.$2
    to: real-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/ip7z/7zip
      tag: ${{vars.real-package-version}}
      expected-commit: 5e96a8279489832924056b1fa82f29d5837c9469

  - name: Configure and build
    runs: |
      cd CPP/7zip/Bundles/Alone2
      mkdir -p b/g
      make -f ../../cmpl_gcc.mak -j$(nproc) \
        CC="${CC:-cc} $CFLAGS $CPPFLAGS $LDFLAGS" \
        CXX="${CXX:-c++} $CXXFLAGS $CPPFLAGS $LDFLAGS" \
        DISABLE_RAR=1

  - runs: |
      install -Dm755 CPP/7zip/Bundles/Alone2/b/g/7zz "${{targets.destdir}}"/usr/bin/7zz
      ln -s /usr/bin/7zz "${{targets.destdir}}"/usr/bin/7z
      install -Dm644 DOC/* -t "${{targets.destdir}}"/usr/share/doc/7zip

  - uses: strip

subpackages:
  - name: "7zip-doc"
    description: "7zip documentation"
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share
          mv "${{targets.destdir}}"/usr/share/doc/7zip "${{targets.subpkgdir}}"/usr/share
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: ip7z/7zip
  version-transform:
    - match: \.
      replace: ''

test:
  environment:
    contents:
      packages:
        - bash
        - coreutils
  pipeline:
    - uses: test/tw/help-check
      with:
        bins: 7z 7zz
    - name: "Verify binary installation"
      runs: |
        test -f /usr/bin/7zz
        test -L /usr/bin/7z
        test "$(readlink /usr/bin/7z)" = "/usr/bin/7zz"
    - name: "Test basic compression (7z format)"
      runs: |
        echo "test content" > testfile.txt
        7z a archive.7z testfile.txt
        test -f archive.7z
    - name: "Test archive listing"
      runs: |
        7z l archive.7z | grep -q "testfile.txt"
    - name: "Test extraction"
      runs: |
        rm testfile.txt
        7z x archive.7z
        test -f testfile.txt
        grep -q "test content" testfile.txt
    - name: "Test compression with different formats"
      runs: |
        # Test ZIP format
        7z a test.zip testfile.txt
        test -f test.zip

        # Test TAR format
        7z a test.tar testfile.txt
        test -f test.tar
    - name: "Test multiple file handling"
      runs: |
        mkdir testdir
        echo "file1" > testdir/file1.txt
        echo "file2" > testdir/file2.txt
        7z a multiple.7z testdir/*
        rm -rf testdir
        7z x multiple.7z
        test -f testdir/file1.txt
        test -f testdir/file2.txt
    - name: "Test archive integrity checking"
      runs: |
        7z t archive.7z
    - uses: test/no-docs
