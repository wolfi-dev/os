package:
  name: NetworkManager
  version: 1.54.0
  epoch: 0
  description: Network management daemon
  copyright:
    - license: LGPL-2.1-only
  dependencies:
    runtime:
      - libnspr
      - libnss
  resources:
    cpu: 32
    memory: 48Gi


environment:
  contents:
    packages:
    - ModemManager-dev
    - audit-dev
    - bluez-dev
    - build-base
    - curl-dev
    - dbus-dev
    - glib-dev
    - glib-gir
    - gobject-introspection-dev
    - jansson-dev
    - libndp-dev
    - libnss-dev
    - libnvme-dev
    - libpsl-dev
    - libselinux-dev
    - libxslt
    - linux-headers
    - mobile-broadband-provider-info-dev
    - newt-dev
    - perl
    - polkit-dev
    - systemd-dev
    - usrmerge-tool
    - util-linux-dev
    - vala
  environment:
    CFLAGS: -Wno-error=incompatible-pointer-types

pipeline:
  - uses: git-checkout
    with:
      repository: https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git
      tag: ${{package.version}}
      expected-commit: 37dbdd3199cfd369a49d03888e75491f92dfbbfa

  - uses: meson/configure
    with:
      opts: |
        --warnlevel 2 \
        -D b_lto=true \
        -Db_ndebug=false \
        -Dbluez5_dun=true \
        -Dconcheck=true \
        -Dconfig_auth_polkit_default=true \
        -Dconfig_dns_rc_manager_default=auto \
        -Dconfig_logging_backend_default=journal \
        -Dconfig_migrate_ifcfg_rh_default=true \
        -Dconfig_plugins_default=ifcfg-rh \
        -Dcrypto=nss \
        -Ddbus_conf_dir=/usr/share/dbus-1/system.d \
        -Ddhclient=/usr/bin/dhclient \
        -Ddhcpcd=no \
        -Ddist_version=${{package.version}}-${{package.epoch}} \
        -Ddocs=false \
        -Debpf=true \
        -Difcfg_rh=true \
        -Difupdown=false \
        -Dintrospection=true \
        -Dip6tables=/usr/bin/ip6tables \
        -Diptables=/usr/bin/iptables \
        -Diwd=true \
        -Dld_gc=true \
        -Dlibaudit=yes-disabled-by-default \
        -Dlibpsl=true \
        -Dmodem_manager=true \
        -Dmodify_system=true \
        -Dmore_asserts=0 \
        -Dmore_logging=false \
        -Dnetconfig=no \
        -Dnft=/usr/bin/nft \
        -Dnm_cloud_setup=true \
        -Dovs=false \
        -Dpolkit=true  \
        -Dppp=false \
        -Dqt=false \
        -Dresolvconf=no \
        -Dselinux=true \
        -Dsession_tracking=systemd \
        -Dsuspend_resume=systemd \
        -Dsystem_ca_path=/etc/pki/tls/cert.pem \
        -Dsystemdsystemunitdir=/usr/lib/systemd/system \
        -Dteamdctl=false \
        -Dtests=yes \
        -Dvalgrind=no \
        -Dvapi=true \
        -Dwext=true \
        -Dwifi=true
 
  - uses: meson/compile

  - uses: meson/install

  # Seems to get some binaries on `/usr/sbin` without any way to configure it except for a patch
  - runs: usrmerge-tool -usr-sbin "${{targets.destdir}}"

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: ${{package.name}} development libraries
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/pkgconf

test:
  pipeline:
    - uses: test/tw/ldd-check
