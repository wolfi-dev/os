package:
  name: aerospike-7
  version: "7.2.0.14"
  epoch: 2 # go/wolfi-rsc/aerospike-7
  description: Aerospike Database Server - flash-optimized, in-memory, nosql database
  copyright:
    - license: AGPL-3.0-only
  resources:
    cpu: "5"
    memory: 10Gi

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - coreutils
      - gmp-dev
      - libtool
      - openssl-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/aerospike/aerospike-server
      tag: ${{package.version}}
      expected-commit: 40b9ce10c5137fb32a2d3e379bada9a0ccdc8b46
      recurse-submodules: true

  - runs: |
      # There's some OS detection that doesn't know about wolfi and gets the wrong path
      sed -i 's|ABSL_LIB_DIR = $(ABSL)/installation/lib$|ABSL_LIB_DIR = $(ABSL)/installation/lib64|g' make_in/Makefile.vars

      # Fix some warnings
      sed -i 's|COMMON_CFLAGS += -Wno-address-of-packed-member|COMMON_CFLAGS += -Wno-address-of-packed-member -Wno-use-after-free -Wno-discarded-qualifiers|g' make_in/Makefile.in

      # glibc 2.43 defaults to C23, which requires us to pass
      # -Wno-discarded-qualifiers.  Make sure that, when compiling C++ code,
      # only CFLAGS contains the new flag, otherwise g++ will error out.
      sed -i 's|filter-out -std=gnu99|filter-out -std=gnu99 -Wno-discarded-qualifiers|g' as/src/Makefile

      git diff

  - runs: |
      export CFLAGS="-Wno-address-of-packed-member -Wno-use-after-free"
      export CXXFLAGS="$CFLAGS"
      export CPPFLAGS="$CFLAGS"
      # Add -Wno-discarded-qualifiers to CFLAGS (but *not* to the other flags)
      # in order to fix FTBFS with
      # glibc 2.43.
      export CFLAGS="${CFLAGS} -Wno-discarded-qualifiers"
      make -j$(nproc)

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin ${{targets.destdir}}/usr/share/aerospike-server
      mv target/Linux-${{build.arch}}/* ${{targets.destdir}}/usr/share/aerospike-server

      ln -sf /usr/share/aerospike-server/bin/asd ${{targets.destdir}}/usr/bin/asd

update:
  enabled: true
  github:
    identifier: aerospike/aerospike-server
    tag-filter: 7.

test:
  pipeline:
    - runs: |
        asd --version
        asd --help
