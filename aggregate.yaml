package:
  name: aggregate
  version: "1.6.8"
  epoch: 0
  description: Optimise a list of route prefixes to help make nice short filters
  copyright:
    - license: ISC

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - coreutils
      - patch
  environment:
    CPPFLAGS: "-Wno-implicit-int" # Needed for checks in the configure script

var-transforms:
  - from: ${{package.version}}
    match: \.(\d+)$
    replace: -$1
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://salsa.debian.org/salvage-team/aggregate.git
      tag: debian/${{vars.mangled-package-version}}
      expected-commit: 74b302efd6b21d6d729e14aea5b76e25d89f1372

  - runs: "for patchfile in $(cat debian/patches/series); do\n  patch -p1 < debian/patches/$patchfile    \ndone    \n"

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

test:
  pipeline:
    - name: "Test basic prefix aggregation"
      runs: |
        set -euo pipefail
        # Test combining adjacent prefixes
        echo -e "203.97.2.0/24\n203.97.3.0/24" | aggregate | grep -q "203.97.2.0/23"
    - name: "Test redundancy removal"
      runs: |
        set -euo pipefail
        # A /17 should encompass a /24 in its range
        result=$(echo -e "203.97.0.0/17\n203.97.2.0/24" | aggregate)
        # Should only output the /17, not the /24
        [ $(echo "$result" | wc -l) -eq 1 ]
        echo "$result" | grep -q "203.97.0.0/17"
    - name: "Test max prefix length option (-m)"
      runs: |
        set -euo pipefail
        # Test that -m limits the maximum prefix length
        echo -e "192.168.1.0/24\n192.168.2.0/30" | aggregate -m 24
    - name: "Test default prefix length option (-p)"
      runs: |
        set -euo pipefail
        # Test setting default mask length for bare addresses
        echo "10.0.0.0" | aggregate -p 8 | grep -q "10.0.0.0/8"
    - name: "Test verbose output (-v)"
      runs: |
        set -euo pipefail
        # Verbose mode should show line numbers in brackets
        result=$(echo -e "192.168.1.0/24\n192.168.2.0/24" | aggregate -v)
        echo "$result" | grep -q "\[.*1\]"
    - name: "Test truncate mode (-t)"
      runs: |
        set -euo pipefail
        # Test that -t silently corrects inconsistent masks
        echo "192.168.1.5/24" | aggregate -t
    - name: "Test quiet mode (-q)"
      runs: |
        set -euo pipefail
        # Quiet mode suppresses warnings
        echo "192.168.1.0/24" | aggregate -q
    - name: "Test multiple prefix optimization"
      runs: |
        set -euo pipefail
        # Test combining multiple adjacent /24 networks into larger blocks
        result=$(echo -e "10.0.0.0/24\n10.0.1.0/24\n10.0.2.0/24\n10.0.3.0/24" | aggregate)
        # Four consecutive /24s should combine into a /22
        echo "$result" | grep -q "10.0.0.0/22"
    - name: "Test max optimization length (-o)"
      runs: |
        set -euo pipefail
        # Test that -o limits which prefixes get optimized
        echo -e "192.168.1.0/24\n192.168.2.0/24" | aggregate -o 23
    - name: "Test with IPv4 prefixes of various sizes"
      runs: |
        set -euo pipefail
        # Test with a mix of prefix lengths
        echo -e "10.0.0.0/8\n172.16.0.0/12\n192.168.0.0/16" | aggregate | wc -l

update:
  enabled: true
  git:
    strip-prefix: debian/
    tag-filter-contains: debian/
  version-transform:
    - match: -(\d)$
      replace: '.$1'
