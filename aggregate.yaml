package:
  name: aggregate
  version: "1.6.8"
  epoch: 1
  description: Optimise a list of route prefixes to help make nice short filters
  copyright:
    - license: ISC

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - coreutils
  environment:
    CPPFLAGS: "-Wno-implicit-int" # Needed for checks in the configure script

var-transforms:
  - from: ${{package.version}}
    match: \.(\d+)$
    replace: -$1
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://salsa.debian.org/salvage-team/aggregate.git
      tag: debian/${{vars.mangled-package-version}}
      expected-commit: 74b302efd6b21d6d729e14aea5b76e25d89f1372

  - runs: mv debian/patches/* .

  - uses: patch
    with:
      series: series

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: "aggregate-doc"
    description: "aggregate documentation"
    pipeline:
      - uses: split/alldocs
    test:
      pipeline:
        - uses: test/tw/docs

test:
  pipeline:
    - name: "Test basic prefix aggregation"
      runs: |
        set -euo pipefail
        # Test combining adjacent prefixes
        echo -e "203.97.2.0/24\n203.97.3.0/24" | aggregate | grep -q "203.97.2.0/23"
    - name: "Test redundancy removal"
      runs: |
        set -euo pipefail
        # A /17 should encompass a /24 in its range
        result=$(echo -e "203.97.0.0/17\n203.97.2.0/24" | aggregate)
        # Should only output the /17, not the /24
        [ $(echo "$result" | wc -l) -eq 1 ]
        echo "$result" | grep -q "203.97.0.0/17"
    - name: "Test max prefix length option (-m)"
      runs: |
        set -euo pipefail
        # Test that -m limits the maximum prefix length
        result=$(echo -e "192.168.1.0/24\n192.168.2.0/30" | aggregate -m 24)
        # The /30 should be ignored, only the /24 should remain
        [ $(echo "$result" | wc -l) -eq 1 ]
    - name: "Test default prefix length option (-p)"
      runs: |
        set -euo pipefail
        # Test setting default mask length for bare addresses
        result=$(echo -e "10.0.0.0\n192.168.2.0\n5.0.0.0" | aggregate -p 8)
        echo "$result" | grep -q "10.0.0.0/8"
        echo "$result" | grep -qv "192.168.2"
        echo "$result" | grep -q "5.0.0.0/8"
        [ $(echo "$result" | wc -l) -eq 2 ]
    - name: "Test verbose output (-v)"
      runs: |
        set -euo pipefail
        # Verbose mode should show line numbers in brackets
        result=$(echo -e "192.168.1.0/24\n192.168.2.0/24" | aggregate -v)
        echo "$result" | grep -q "\[.*1\]"
    - name: "Test truncate mode (-t)"
      runs: |
        set -euo pipefail
        # Test that -t silently corrects inconsistent masks
        result=$(echo "192.168.1.5/24" | aggregate -t)
        echo "$result" | grep -q "192.168.1.0/24"
    - name: "Test quiet mode (-q)"
      runs: |
        set -euo pipefail
        # Quiet mode should suppress warnings on stderr
        echo "192.168.1.0/24" | aggregate -q 2>&1 | grep -v "aggregate"
    - name: "Test multiple prefix optimization"
      runs: |
        set -euo pipefail
        # Test combining multiple adjacent /24 networks into larger blocks
        result=$(echo -e "10.0.0.0/24\n10.0.1.0/24\n10.0.2.0/24\n10.0.3.0/24" | aggregate)
        # Four consecutive /24s should combine into a /22
        echo "$result" | grep -q "10.0.0.0/22"
    - name: "Test max optimization length (-o)"
      runs: |
        set -euo pipefail
        # Test that -o limits which prefixes get optimized
        result=$(echo -e "192.168.1.0/24\n192.168.2.8/24" | aggregate -o 23)
        [ $(echo "$result" | wc -l) -eq 1 ]
    - name: "Test with IPv4 prefixes of various sizes"
      runs: |
        set -euo pipefail
        # Test with a mix of prefix lengths
        result=$(echo -e "10.0.0.0/8\n172.16.0.0/12\n172.16.0.5/32\n192.168.0.0/16\n192.168.2.0/24" | aggregate)
        [ $(echo "$result" | wc -l) -eq 3 ]

update:
  enabled: true
  git:
    strip-prefix: debian/
    tag-filter-contains: debian/
  version-transform:
    - match: -(\d)$
      replace: '.$1'
