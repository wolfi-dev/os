From 2e2c5ed9ddc63441d5ddecfc6cfae849f097d377 Mon Sep 17 00:00:00 2001
From: Uti Edun <uti.edun@chainguard.dev>
Date: Sat, 4 Oct 2025 22:28:06 +0000
Subject: [PATCH] Using security feature to check for the presence of scrypt
 instead of using versions

---
 .../auth_manager/security_manager/override.py | 21 ++++++++-----------
 1 file changed, 9 insertions(+), 12 deletions(-)

diff --git a/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py b/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
index 488d57b66c..88d97b62e4 100644
--- a/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
+++ b/providers/fab/src/airflow/providers/fab/auth_manager/security_manager/override.py
@@ -802,18 +802,8 @@ class FabAirflowSecurityManagerOverride(AirflowSecurityManagerV2):
         app.config.setdefault("AUTH_ROLES_SYNC_AT_LOGIN", False)
         app.config.setdefault("AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS", False)
 
-        from packaging.version import Version
-        from werkzeug import __version__ as werkzeug_version
-
-        parsed_werkzeug_version = Version(werkzeug_version)
-        if parsed_werkzeug_version < Version("3.0.0"):
-            app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "pbkdf2:sha256")
-            app.config.setdefault(
-                "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
-                "pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118"
-                "c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c",
-            )
-        else:
+        try:
+             _ = generate_password_hash("test", method="scrypt"):
             app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "scrypt")
             app.config.setdefault(
                 "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
@@ -821,6 +811,13 @@ class FabAirflowSecurityManagerOverride(AirflowSecurityManagerV2):
                 "8350189ffc4bcc71286edf1b8ad94a442c00f890224bf2b32153d0750c89ee9"
                 "401e62f9dcee5399065e4e5",
             )
+        except (ValueError, TypeError):
+            app.config.setdefault("FAB_PASSWORD_HASH_METHOD", "pbkdf2:sha256")
+            app.config.setdefault(
+                "AUTH_DB_FAKE_PASSWORD_HASH_CHECK",
+                "pbkdf2:sha256:150000$Z3t6fmj2$22da622d94a1f8118"
+                "c0976a03d2f18f680bfff877c9a965db9eedc51bc0be87c",
+            )
 
         # LDAP Config
         if self.auth_type == AUTH_LDAP:
-- 
2.51.0

