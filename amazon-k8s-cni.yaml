package:
  name: amazon-k8s-cni
  version: "1.21.1"
  epoch: 4 # CVE-2025-61732
  description: Networking plugin repository for pod networking in Kubernetes using Elastic Network Interfaces on AWS
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - iptables-wrappers # amazon-k8s-cni *assumes* this, do not change

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - go

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/aws/amazon-vpc-cni-k8s
      tag: v${{package.version}}
      expected-commit: e082bae7c03ddc28357b01595f3746b117ac08c7

  - name: Copy conflist
    runs: |
      mkdir -p ${{targets.destdir}}/app
      cp -r misc/10-aws.conflist ${{targets.destdir}}/app

  - uses: go/build
    with:
      ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
      output: aws-cni
      packages: ./cmd/routed-eni-cni-plugin

  - uses: go/build
    with:
      ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
      output: aws-k8s-agent
      packages: ./cmd/aws-k8s-agent

  - uses: go/build
    with:
      ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
      output: aws-vpc-cni
      packages: ./cmd/aws-vpc-cni

  - uses: go/build
    with:
      ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
      output: egress-cni
      packages: ./cmd/egress-cni-plugin

  - uses: go/build
    with:
      ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
      output: grpc-health-probe
      packages: ./cmd/grpc-health-probe

subpackages:
  - name: "${{package.name}}-init"
    description: "init package for amazon-k8s-cni"
    pipeline:
      - uses: go/build
        with:
          ldflags: -X pkg/version/info.Version=${{package.version}} -X pkg/awsutils/awssession.version=${{package.version}}
          output: aws-vpc-cni-init
          packages: ./cmd/aws-vpc-cni-init
    # test added by a robot (binary)
    test:
      pipeline:
        - runs: |
            stat /usr/bin/aws-vpc-cni-init

  - name: "${{package.name}}-compat"
    description: "Compatibility package to place binaries in the location expected by upstream helm charts"
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/app
          ln -sf /usr/bin/aws-cni ${{targets.subpkgdir}}/app/aws-cni
          ln -sf /usr/bin/aws-k8s-agent ${{targets.subpkgdir}}/app/aws-k8s-agent
          ln -sf /usr/bin/aws-vpc-cni ${{targets.subpkgdir}}/app/aws-vpc-cni
          ln -sf /usr/bin/egress-cni ${{targets.subpkgdir}}/app/egress-cni
          ln -sf /usr/bin/grpc-health-probe ${{targets.subpkgdir}}/app/grpc-health-probe
    # test added by a robot (compat)
    test:
      pipeline:
        - runs: |
            readlink -v /app/aws-cni
            readlink -v /app/aws-k8s-agent
            readlink -v /app/aws-vpc-cni
            readlink -v /app/egress-cni
            readlink -v /app/grpc-health-probe

  - name: "${{package.name}}-init-compat"
    description: "Compatibility package to place binaries in the location expected by upstream helm charts"
    dependencies:
      runtime:
        - cni-plugins-aws-k8s-compat
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/init
          ln -sf /usr/bin/aws-vpc-cni-init ${{targets.subpkgdir}}/init/aws-vpc-cni-init
          # Download the debug script from awslabs/amazon-eks-ami
          curl -L https://raw.githubusercontent.com/awslabs/amazon-eks-ami/master/log-collector-script/linux/eks-log-collector.sh -o ${{targets.subpkgdir}}/init/aws-cni-support.sh
    # test added by a robot (compat)
    test:
      pipeline:
        - runs: |
            readlink -v /init/aws-vpc-cni-init

update:
  enabled: true
  github:
    identifier: aws/amazon-vpc-cni-k8s
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - ${{package.name}}
        - ${{package.name}}-compat
        - ${{package.name}}-init
        - ${{package.name}}-init-compat
  pipeline:
    - name: Verify CNI protocol versions
      runs: |
        # Test that aws-cni reports supported CNI protocol versions
        aws-cni 2>&1 | grep -F 'CNI protocol versions supported: 0.1.0, 0.2.0, 0.3.0, 0.3.1, 0.4.0, 1.0.0, 1.1.0'

        # Test that egress-cni reports supported CNI protocol versions
        egress-cni 2>&1 | grep -F 'CNI protocol versions supported: 0.1.0, 0.2.0, 0.3.0, 0.3.1, 0.4.0, 1.0.0, 1.1.0'
    - name: Verify grpc-health-probe execution
      runs: |
        # Test that grpc-health-probe correctly reports missing --addr flag
        if output=$(grpc-health-probe 2>&1); then
          echo "ERROR: grpc-health-probe should fail without --addr"
          exit 1
        fi
        echo "$output" | grep -F 'error: --addr not specified' || {
          echo "ERROR: Expected '--addr not specified' error message"
          echo "Got: $output"
          exit 1
        }
    - name: Test aws-vpc-cni binary copy success path
      runs: |
        # Test that aws-vpc-cni can copy binaries when given valid paths
        mkdir -p /tmp/host-cni-bin

        # Create a mock aws-cni source binary for testing
        mkdir -p /tmp/cni-source
        cp /usr/bin/aws-cni /tmp/cni-source/

        # Change to source directory and test the copy mechanism
        cd /tmp/cni-source

        # aws-vpc-cni requires specific environment - test it can at least start
        # The binary is expected to fail without full K8s environment, but should attempt installation
        output=$(HOST_CNI_BIN_PATH=/tmp/host-cni-bin aws-vpc-cni 2>&1 || true)
        echo "aws-vpc-cni output:"
        echo "$output"

        # Verify the binary attempted to do something meaningful
        if ! echo "$output" | grep -iE 'install|copy|cni|plugin'; then
          echo "ERROR: aws-vpc-cni did not attempt installation operations"
          echo "Expected output to contain 'install', 'copy', 'cni', or 'plugin'"
          exit 1
        fi
        echo "aws-vpc-cni correctly attempted installation"
    - name: Test CNI plugin stdin input parsing
      runs: |
        # CNI plugins expect JSON config via stdin and CNI_* environment variables
        # Test that aws-cni correctly parses CNI ADD command input

        # Create minimal CNI config
        tee /tmp/cni-config.json <<'EOF'
        {
          "cniVersion": "1.0.0",
          "name": "test-network",
          "type": "aws-cni"
        }
        EOF

        # Test CNI VERSION command (should return supported versions)
        export CNI_COMMAND=VERSION
        export CNI_CONTAINERID=test-container
        export CNI_NETNS=/var/run/netns/test
        export CNI_IFNAME=eth0
        export CNI_PATH=/opt/cni/bin

        output=$(cat /tmp/cni-config.json | aws-cni 2>&1 || true)
        echo "CNI VERSION output:"
        echo "$output"

        # Verify the plugin responds with version info
        if ! echo "$output" | grep -iE 'cniVersion|version|supported'; then
          echo "ERROR: Plugin did not respond with version information"
          echo "Expected output to contain version-related content"
          exit 1
        fi
        echo "Plugin correctly responds to VERSION command"

        # Test CNI ADD command parsing (will fail without real environment but should parse input)
        export CNI_COMMAND=ADD
        output=$(cat /tmp/cni-config.json | aws-cni 2>&1 || true)
        echo "CNI ADD output:"
        echo "$output"

        # Plugin should attempt to process the request even if it fails due to missing resources
        if ! echo "$output" | grep -iE 'error|failed|missing|cannot|unable'; then
          echo "ERROR: Plugin did not attempt to process ADD command"
          echo "Expected output to indicate processing attempt (error/failed/missing/cannot/unable)"
          exit 1
        fi
        echo "Plugin correctly attempts to process ADD command"
    - name: Test egress-cni stdin input parsing
      runs: |
        # Test that egress-cni correctly parses CNI config via stdin

        tee /tmp/egress-config.json <<'EOF'
        {
          "cniVersion": "1.0.0",
          "name": "egress-test",
          "type": "egress-cni"
        }
        EOF

        export CNI_COMMAND=VERSION
        export CNI_CONTAINERID=test-container
        export CNI_NETNS=/var/run/netns/test
        export CNI_IFNAME=eth0
        export CNI_PATH=/opt/cni/bin

        output=$(cat /tmp/egress-config.json | egress-cni 2>&1 || true)
        echo "egress-cni VERSION output:"
        echo "$output"

        # Verify the plugin responds with version info
        if ! echo "$output" | grep -iE 'cniVersion|version|supported'; then
          echo "ERROR: egress-cni did not respond with version information"
          echo "Expected output to contain version-related content"
          exit 1
        fi
        echo "egress-cni correctly responds to VERSION command"
    - name: Verify aws-vpc-cni-init
      runs: |
        cd /init
        HOST_CNI_BIN_PATH="/tmp" aws-vpc-cni-init 2>&1 | grep -F 'Copied all CNI plugin binaries to /tmp'
        if [ -z "$(ls -A /tmp)" ]; then
          echo "/tmp should have been populated with CNI plugin binaries."
          exit 1
        fi
