package:
  name: apache-exporter
  version: "1.0.10"
  epoch: 0
  description: apache-exporter exposes Apache server metrics for Prometheus monitoring
  copyright:
    - license: MIT

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Lusitaniae/apache_exporter
      tag: v${{package.version}}
      expected-commit: c4206b529038d79f20f2eeba98a9780c8cb4a2c2

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.35.0
        golang.org/x/net@v0.38.0
        golang.org/x/oauth2@v0.27.0

  - uses: go/build
    with:
      packages: .
      output: apache_exporter
      ldflags: |
        -X github.com/prometheus/common/version.Version=$(cat ./VERSION) \
        -X github.com/prometheus/common/version.Revision=$(git rev-parse --short HEAD) \
        -X github.com/prometheus/common/version.Branch=$(git rev-parse --abbrev-ref HEAD) \
        -X github.com/prometheus/common/version.BuildUser=$(whoami)@$(hostname) \
        -X github.com/prometheus/common/version.BuildDate=$(date +"%Y%m%d-%H:%M:%S")

update:
  enabled: true
  github:
    identifier: Lusitaniae/apache_exporter
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - apache2
  pipeline:
    - name: "Basic functionality tests"
      runs: |
        apache_exporter --version 2>&1 | grep -q "${{package.version}}"
        apache_exporter --help 2>&1
    - name: "Test exporter startup without Apache"
      uses: test/daemon-check-output
      with:
        start: apache_exporter --scrape_uri="http://localhost:9999/server-status?auto"
        timeout: 15
        expected_output: |
          Starting apache_exporter
          Listening on
        post: |
          #!/bin/sh -e
          # Test that metrics endpoint is accessible even when Apache is down
          curl -s http://localhost:9117/metrics | grep -q "apache_up"
          # Should show apache_up as 0 since Apache is not accessible
          curl -s http://localhost:9117/metrics | grep -q "apache_up 0"
    - name: "Test with mock Apache server"
      uses: test/daemon-check-output
      with:
        setup: |
          # Create Apache configuration for mod_status
          mkdir -p /etc/apache2/conf.d
          cat > /etc/apache2/conf.d/status.conf <<EOF
          <Location "/server-status">
              SetHandler server-status
              Require all granted
          </Location>
          ExtendedStatus On
          EOF

          # Start Apache server
          httpd -D FOREGROUND > /dev/null 2>&1 &
          APACHE_PID=$!
          sleep 3

          # Wait for Apache to be ready
          for i in $(seq 1 10); do
            if curl -s http://localhost/server-status?auto > /dev/null 2>&1; then
              break
            fi
            sleep 1
          done
        start: apache_exporter --scrape_uri="http://localhost/server-status?auto"
        timeout: 30
        expected_output: |
          Starting apache_exporter
          Listening on
        post: |
          #!/bin/sh -e
          # Test that metrics endpoint is accessible and shows Apache is up
          curl -s http://localhost:9117/metrics | grep -q "apache_up 1"

          # Cleanup Apache process
          kill $APACHE_PID 2>/dev/null || true
