package:
  name: apache-hop
  version: "2.15.0"
  epoch: 0
  description: Apache Hop is a data orchestration and data engineering platform
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - fontconfig
      - glibc-locale-en
      - gtk-3-dev
      - gtk-4
      - libx11-dev
      - libxext
      - libxrender
      - libxtst
      - msttcorefonts-installer
      - openjdk-${{vars.java-version}}-default-jvm
      - ttf-dejavu

vars:
  # Apache Hop's official 2.14.0 GA release uses the 2.14.0-rc1 Git tag
  # See: https://hop.apache.org/blog/2025/05/hop-2.14.0/
  version-suffix: rc1
  java-version: 17

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - maven
      - openjdk-${{vars.java-version}}-default-jdk
      - unzip
  environment:
    JAVA_HOME: /usr/lib/jvm/java-${{vars.java-version}}-openjdk
    DEPLOYMENT_PATH: /opt/hop
    VOLUME_MOUNT_POINT: /files
    HOP_LOG_LEVEL: Basic
    # Empty env vars below are required by load-and-execute.sh which uses 'set -u' (unbound variable errors)
    # The script references these variables directly and fails if they're undefined, but handles empty strings properly
    HOP_FILE_PATH: "" # determines server vs pipeline execution mode
    HOP_LOG_PATH: /opt/hop/hop.err.log
    HOP_SHARED_JDBC_FOLDERS: ""
    HOP_PROJECT_NAME: project1
    HOP_PROJECT_DIRECTORY: "" # backward compatibility fallback
    HOP_PROJECT_FOLDER: "" # project configuration
    HOP_PROJECT_CONFIG_FILE_NAME: project-config.json
    HOP_ENVIRONMENT_NAME: environment1
    HOP_ENVIRONMENT_CONFIG_FILE_NAME_PATHS: "" # environment config paths
    HOP_RUN_CONFIG: "" # pipeline/workflow run configuration
    HOP_RUN_PARAMETERS: "" # runtime parameters
    HOP_RUN_METADATA_EXPORT: "" # metadata export configuration
    HOP_SYSTEM_PROPERTIES: "" # system properties
    HOP_OPTIONS: -XX:+AggressiveHeap
    HOP_CUSTOM_ENTRYPOINT_EXTENSION_SHELL_FILE_PATH: "" # custom entrypoint script
    HOP_SERVER_USER: cluster
    HOP_SERVER_PASSWORD: cluster
    HOP_SERVER_HOSTNAME: 0.0.0.0
    HOP_SERVER_PORT: "8080"
    HOP_SERVER_SHUTDOWNPORT: "8079"
    HOP_SERVER_METADATA_FOLDER: "" # server metadata folder
    HOP_SERVER_KEYSTORE: "" # SSL keystore path
    HOP_SERVER_KEYSTORE_PASSWORD: "" # SSL keystore password
    HOP_SERVER_KEY_PASSWORD: "" # SSL key password
    HOP_SERVER_MAX_LOG_LINES: "" # server log limits
    HOP_SERVER_MAX_LOG_TIMEOUT: "" # server log timeout
    HOP_SERVER_MAX_OBJECT_TIMEOUT: "" # server object timeout
    MAVEN_OPTS: |
      -Xmx2g
      -XX:+UseG1GC
      -Dorg.slf4j.simpleLogger.defaultLogLevel=WARN

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/hop
      tag: ${{package.version}}-${{vars.version-suffix}}
      expected-commit: 77e311f8258074bcca13895cc925226469e2362c

  - uses: maven/pombump
    with:
      patch-file: pombump-deps.yaml

  - uses: maven/pombump
    with:
      patch-file: pombump-deps.yaml
      properties-file: pombump-properties.yaml

  - runs: |
      mvn clean install -T 2 -DskipTests -Dmaven.javadoc.skip=true

      unzip assemblies/client/target/hop-client-*.zip -d /tmp/hop-unpacked
      cd /tmp/hop-unpacked/hop

      mkdir -p "${{targets.contextdir}}"/opt/hop
      mkdir -p "${{targets.contextdir}}"/usr/bin

      cp -r ./* "${{targets.contextdir}}"/opt/hop/

      for tool in hop-conf hop-encrypt hop-gui hop-import hop-run hop-search hop-server; do
        ln -sf /opt/hop/$tool.sh "${{targets.contextdir}}"/usr/bin/$tool
      done

      mkdir -p "${{targets.contextdir}}"/home/hop
      mkdir -p "${{targets.contextdir}}"/files

      cp /home/build/docker/resources/run.sh "${{targets.contextdir}}"/opt/hop/run.sh
      cp /home/build/docker/resources/load-and-execute.sh "${{targets.contextdir}}"/opt/hop/load-and-execute.sh

      chmod +x "${{targets.contextdir}}"/opt/hop/run.sh
      chmod +x "${{targets.contextdir}}"/opt/hop/load-and-execute.sh

  - uses: strip

update:
  enabled: true
  version-transform:
    - match: ^(.+)-rc(\d+)$
      replace: $1-rc$2
  github:
    identifier: apache/hop
    strip-prefix: ""
    strip-suffix: -rc1
    use-tag: true

test:
  environment:
    contents:
      packages:
        - ${{package.name}}
        - curl
        - xmlstarlet
        - wait-for-it
        - jq
    environment:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk
      DEPLOYMENT_PATH: /opt/hop
      VOLUME_MOUNT_POINT: /files
      HOP_LOG_LEVEL: Basic
      HOP_FILE_PATH: ""
      HOP_LOG_PATH: /opt/hop/hop.err.log
      HOP_SHARED_JDBC_FOLDERS: ""
      HOP_PROJECT_NAME: project1
      HOP_PROJECT_DIRECTORY: ""
      HOP_PROJECT_FOLDER: ""
      HOP_PROJECT_CONFIG_FILE_NAME: project-config.json
      HOP_ENVIRONMENT_NAME: environment1
      HOP_ENVIRONMENT_CONFIG_FILE_NAME_PATHS: ""
      HOP_RUN_CONFIG: ""
      HOP_RUN_PARAMETERS: ""
      HOP_RUN_METADATA_EXPORT: ""
      HOP_SYSTEM_PROPERTIES: ""
      HOP_OPTIONS: -XX:+AggressiveHeap
      HOP_CUSTOM_ENTRYPOINT_EXTENSION_SHELL_FILE_PATH: ""
      HOP_SERVER_USER: cluster
      HOP_SERVER_PASSWORD: cluster
      HOP_SERVER_HOSTNAME: 0.0.0.0
      HOP_SERVER_PORT: "8080"
      HOP_SERVER_SHUTDOWNPORT: "8079"
      HOP_SERVER_METADATA_FOLDER: ""
      HOP_SERVER_KEYSTORE: ""
      HOP_SERVER_KEYSTORE_PASSWORD: ""
      HOP_SERVER_KEY_PASSWORD: ""
      HOP_SERVER_MAX_LOG_LINES: ""
      HOP_SERVER_MAX_LOG_TIMEOUT: ""
      HOP_SERVER_MAX_OBJECT_TIMEOUT: ""
  pipeline:
    - name: "Verify Installation"
      runs: |
        # Verify symlinks
        [ "$(readlink -f /usr/bin/hop-gui)" = "/opt/hop/hop-gui.sh" ]
        [ "$(readlink -f /usr/bin/hop-run)" = "/opt/hop/hop-run.sh" ]
        [ "$(readlink -f /usr/bin/hop-conf)" = "/opt/hop/hop-conf.sh" ]
        [ "$(readlink -f /usr/bin/hop-encrypt)" = "/opt/hop/hop-encrypt.sh" ]
        [ "$(readlink -f /usr/bin/hop-import)" = "/opt/hop/hop-import.sh" ]
        [ "$(readlink -f /usr/bin/hop-search)" = "/opt/hop/hop-search.sh" ]
        [ "$(readlink -f /usr/bin/hop-server)" = "/opt/hop/hop-server.sh" ]

        # Verify shell scripts are executable
        [ -x "${DEPLOYMENT_PATH}/hop-conf.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-encrypt.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-gui.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-import.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-run.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-search.sh" ]
        [ -x "${DEPLOYMENT_PATH}/hop-server.sh" ]
        [ -x "${DEPLOYMENT_PATH}/run.sh" ]
        [ -x "${DEPLOYMENT_PATH}/load-and-execute.sh" ]

        # Verify batch files exist
        [ -f "${DEPLOYMENT_PATH}/hop-conf.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-encrypt.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-gui.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-import.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-run.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-search.bat" ]
        [ -f "${DEPLOYMENT_PATH}/hop-server.bat" ]

        # Verify key directories exist
        [ -d "${DEPLOYMENT_PATH}/lib" ]
        [ -d "${DEPLOYMENT_PATH}/plugins" ]
        [ -d "${DEPLOYMENT_PATH}/config" ]
        [ -d "${DEPLOYMENT_PATH}/static" ]
        [ -d "${DEPLOYMENT_PATH}/licenses" ]
        [ -d "${VOLUME_MOUNT_POINT}" ]
        [ -d "/home/hop" ]

        # Verify core files exist
        [ -f "${DEPLOYMENT_PATH}/LICENSE" ]
        [ -f "${DEPLOYMENT_PATH}/NOTICE" ]
        [ -f "${DEPLOYMENT_PATH}/hop-server.xml" ]
    - name: "Test Basic Functionality"
      working-directory: /opt/hop
      runs: |
        ./hop-run.sh --version 2>&1 | grep -E "^[0-9]+\.[0-9]+\.[0-9]+"
        ./hop-conf.sh --help 2>&1 | grep -E "Usage: <main class>"
    - name: "Create Test Pipeline"
      runs: |
        mkdir -p /tmp/hop-test
        cat > /tmp/hop-test/test-pipeline.hpl <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <pipeline>
          <info>
            <name>test-pipeline</name>
            <description>Test pipeline for validation</description>
          </info>
          <transforms>
            <transform>
              <name>Generate Data</name>
              <type>RowGenerator</type>
              <fields>
                <field>
                  <name>message</name>
                  <type>String</type>
                  <value>Hello Hop</value>
                </field>
              </fields>
              <limit>1</limit>
            </transform>
          </transforms>
        </pipeline>
        EOF
        xmlstarlet val /tmp/hop-test/test-pipeline.hpl
    - name: "Runing GUI tests"
      working-directory: /opt/hop
      runs: |
        timeout 60s Xvfb :99 -screen 0 1024x768x24 & export DISPLAY=:99 && ./hop-gui.sh 2>&1 | grep "Enabling project.*default"
    - name: "Test Hop Server startup"
      uses: test/daemon-check-output
      with:
        start: /opt/hop/load-and-execute.sh
        expected_output: |
          Starting a hop-server on port
          Writing a hop-server config file to /tmp/hop-server.xml
          Starting a hop-server on port 8080
        timeout: 45
        post: |-
          wait-for-it localhost:${HOP_SERVER_PORT} -t 30
          # Test web UI root page
          curl -fsSL -u cluster:cluster http://localhost:${HOP_SERVER_PORT}/ | grep "Hop hop server"
