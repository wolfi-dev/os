package:
  name: apache-kvrocks
  version: "2.11.1"
  epoch: 0
  description: Apache Kvrocks is a distributed key value NoSQL database that uses RocksDB as storage engine and is compatible with Redis protocol.
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - cmake
      - coreutils
      - libtool
      - lld
      - openssl-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/kvrocks
      tag: v${{package.version}}
      expected-commit: 8d56734134918120520abdcec70dcf0f73db5492

  - uses: cmake/configure
    with:
      opts: |
        -DENABLE_OPENSSL=ON \
        -DPORTABLE=1 \
        -DCMAKE_BUILD_TYPE=Release \

  - uses: cmake/build

  - uses: cmake/install

  # NOTE: Install does not copy binary over, installing it manually
  - runs: |
      mkdir -p "${{targets.contextdir}}/usr/bin"
      install -m755 "./output/kvrocks" "${{targets.contextdir}}/usr/bin/kvrocks"

  - uses: strip

update:
  enabled: true
  github:
    identifier: apache/kvrocks
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - redis-cli
        - wait-for-port
  pipeline:
    - runs: |
        kvrocks &
        wait-for-port 6666
        redis-cli -p 6666 SET bike:1 "Process 134" || exit 1
        redis-cli -p 6666 GET bike:1 | grep 'Process 134' || exit 1
        redis-cli -p 6666 exists bike:1 | grep 1 || exit 1
        redis-cli -p 6666 exists bike:2 | grep 0 || exit 1
    - runs: |
        kvrocks --version | grep "${{ package.version }}"
