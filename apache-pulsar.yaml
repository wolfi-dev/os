package:
  name: apache-pulsar
  version: 4.0.1
  epoch: 0
  description: Pulsar is a distributed pub-sub messaging platform with a very flexible messaging model and an intuitive client API.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - openjdk-17-default-jvm
      - openjdk-17-jre

environment:
  contents:
    packages:
      - busybox
      - maven
      - openjdk-17-default-jdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/pulsar
      tag: v${{package.version}}
      expected-commit: 3ea527bf6b720dcfe074c4476257cce96ebc068a

  - name: Build
    runs: ./mvnw package -DskipTests -Pcore-modules,-main

  - name: Install
    runs: |
      dest="${{targets.destdir}}/usr/share/java/pulsar"
      mkdir -p "${dest}" "${{targets.destdir}}"/usr/bin

      tar -zxf ./distribution/server/target/${{package.name}}-${{package.version}}-bin.tar.gz -C "${dest}" --strip-components=1
      rm -rf ${dest}/bin/*.cmd

  - uses: strip

update:
  enabled: true
  github:
    identifier: apache/pulsar
    use-tag: true
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - openjdk-17
        - openjdk-17-default-jvm
  pipeline:
    - name: Test that all binaries are at least installed
      runs: |
        pulsar --help
        pulsar-admin --help
        pulsar-client --help
        pulsar-daemon --help
        pulsar-managed-ledger-admin --help
        pulsar-perf --help
        pulsar-shell --help

    - name: Run Maven unit tests from source repo
      runs: |
        ./mvnw test
