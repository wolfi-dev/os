From https://gitlab.alpinelinux.org/alpine/apk-tools/-/merge_requests/387.patch
From 9c5d9efb05e4b1775da2270223011345a9b5dae8 Mon Sep 17 00:00:00 2001
From: Scott Moser <smoser@brickies.net>
Date: Thu, 22 Jan 2026 16:43:04 -0500
Subject: [PATCH] libfetch: increase password buffer to support long tokens

Increase password/token buffer size from 1024 to 4096 bytes to
support long JWT tokens.

Changes:
- Increase fetch_read_word() buffer from 1024 to 4096 bytes
- Increase URL_PWDLEN from 1024 to 4096 bytes
- Improve error handling: fail with clear message if credentials
  exceed buffer size instead of silently truncating

chainguard uses tokens for auth and they can easily exceed the
1024 limit.

A more complete dynamic limit is more entailed.

(cherry picked from commit 923e77bb31852e5531972e99a6affd69bbcfb1e7)
---
 libfetch/common.c | 12 ++++++++----
 libfetch/fetch.h  |  2 +-
 2 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/libfetch/common.c b/libfetch/common.c
index af064b8..ebefe85 100644
--- a/libfetch/common.c
+++ b/libfetch/common.c
@@ -1047,9 +1047,9 @@ fetchFreeURLList(struct url_list *ue)
 static const char *
 fetch_read_word(FILE *f)
 {
-	static char word[1024];
+	static char word[4096];
 
-	if (fscanf(f, " %1023s ", word) != 1)
+	if (fscanf(f, " %4095s ", word) != 1)
 		return (NULL);
 	return (word);
 }
@@ -1102,16 +1102,20 @@ fetch_netrc_auth(struct url *url)
 				goto ferr;
 			if (snprintf(url->user, sizeof(url->user),
 				"%s", word) > (int)sizeof(url->user)) {
-				fetch_info("login name in .netrc is too long");
 				url->user[0] = '\0';
+				fetch_info("login name in .netrc is too long (exceeds %d bytes)",
+				    (int)sizeof(url->user) - 1);
+				goto ferr;
 			}
 		} else if (strcmp(word, "password") == 0) {
 			if ((word = fetch_read_word(f)) == NULL)
 				goto ferr;
 			if (snprintf(url->pwd, sizeof(url->pwd),
 				"%s", word) > (int)sizeof(url->pwd)) {
-				fetch_info("password in .netrc is too long");
 				url->pwd[0] = '\0';
+				fetch_info("password in .netrc is too long (exceeds %d bytes)",
+				    (int)sizeof(url->pwd) - 1);
+				goto ferr;
 			}
 		} else if (strcmp(word, "account") == 0) {
 			if ((word = fetch_read_word(f)) == NULL)
diff --git a/libfetch/fetch.h b/libfetch/fetch.h
index 15c60e9..edce57a 100644
--- a/libfetch/fetch.h
+++ b/libfetch/fetch.h
@@ -41,7 +41,7 @@
 #define URL_HOSTLEN 255
 #define URL_SCHEMELEN 16
 #define URL_USERLEN 256
-#define URL_PWDLEN 1024
+#define URL_PWDLEN 4096
 
 typedef struct fetchIO fetchIO;
 
-- 
2.43.0

