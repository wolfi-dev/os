package:
  name: apptainer
  version: 1.3.6
  epoch: 0
  description: "Application containers for Linux"
  copyright:
    - license: BSD-3-Clause AND BSD-3-Clause-LBNL
  dependencies:
    runtime:
      - squashfs-tools

environment:
  contents:
    packages:
      - bash
      - busybox
      - cni-plugins
      - cryptsetup
      - go
      - libseccomp-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apptainer/apptainer
      tag: v${{package.version}}
      expected-commit: 9725fd3ba6199e5eb2bbc1f343b788bad91eb4f0

  - uses: go/bump
    with:
      deps: github.com/docker/docker@v25.0.6 github.com/opencontainers/runc@v1.1.14 golang.org/x/crypto@v0.31.0 golang.org/x/net@v0.33.0

  - runs: |
      echo "${{package.version}}-r${{package.epoch}}" >> VERSION

      ./mconfig \
          --prefix=/usr \
          --sysconfdir=/etc \
          --libexecdir=/usr/lib \
          --localstatedir=/var/lib \
          -P release-stripped \
          --without-suid

      make -C builddir
      make -C builddir install DESTDIR="${{targets.contextdir}}"

  - uses: strip

subpackages:
  - name: "apptainer-doc"
    description: "apptainer documentation"
    pipeline:
      - uses: split/manpages

  - name: apptainer-bash-completion
    description: apptainer bash completion
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/share"
          mv "${{targets.destdir}}/usr/share/bash-completion" \
            "${{targets.subpkgdir}}/usr/share/bash-completion"

update:
  enabled: true
  github:
    strip-prefix: v
    identifier: apptainer/apptainer

test:
  pipeline:
    - runs: |
        apptainer version
        apptainer help
    - runs: |
        apptainer remote add --no-login docker docker://docker.io
        apptainer build --sandbox /tmp/alpine.sif docker://alpine:latest
