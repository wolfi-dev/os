package:
  name: atop
  version: "2.12.1"
  epoch: 0
  description: "advanced interactive monitor for Linux systems"
  copyright:
    - license: GPL-2.0-only

environment:
  environment:
    # Link libtinfo explicitly as ncursesw is split from tinfo in wolfi
    LDFLAGS: "-ltinfo"
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - glib-dev
      - ncurses-dev
      - pkgconf-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Atoptool/atop
      tag: v${{package.version}}
      expected-commit: 4492ec7f757d88c61b656b39236339a1602be1e7

  - runs: |
      # Build only the user-space binaries (no systemd services)
      make atop atopsar atopconvert atopcat atophide

  - runs: |
      # Install binaries
      mkdir -p "${{targets.destdir}}"/usr/bin
      install -m 755 atop "${{targets.destdir}}"/usr/bin/
      install -m 755 atopconvert "${{targets.destdir}}"/usr/bin/
      install -m 755 atopcat "${{targets.destdir}}"/usr/bin/
      install -m 755 atophide "${{targets.destdir}}"/usr/bin/
      # atopsar is a symlink to atop
      ln -s atop "${{targets.destdir}}"/usr/bin/atopsar

      # Install man pages
      mkdir -p "${{targets.destdir}}"/usr/share/man/man1
      mkdir -p "${{targets.destdir}}"/usr/share/man/man5
      mkdir -p "${{targets.destdir}}"/usr/share/man/man8
      install -m 644 man/atop.1 "${{targets.destdir}}"/usr/share/man/man1/
      install -m 644 man/atopsar.1 "${{targets.destdir}}"/usr/share/man/man1/
      install -m 644 man/atopconvert.1 "${{targets.destdir}}"/usr/share/man/man1/
      install -m 644 man/atopcat.1 "${{targets.destdir}}"/usr/share/man/man1/
      install -m 644 man/atophide.1 "${{targets.destdir}}"/usr/share/man/man1/
      install -m 644 man/atoprc.5 "${{targets.destdir}}"/usr/share/man/man5/
      install -m 644 man/atopacctd.8 "${{targets.destdir}}"/usr/share/man/man8/
      install -m 644 man/atopgpud.8 "${{targets.destdir}}"/usr/share/man/man8/

  - uses: strip

subpackages:
  - name: atop-doc
    description: atop documentation
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/tw/docs

update:
  enabled: true
  github:
    identifier: Atoptool/atop
    strip-prefix: v

test:
  pipeline:
    - uses: test/tw/ldd-check
    - uses: test/tw/help-check
      with:
        bins: atop atopsar atopconvert atopcat atophide
    - uses: test/tw/ver-check
      with:
        bins: atop
        version: ${{package.version}}
    - runs: |
        set -euo pipefail
        # Verify all binaries are installed
        stat /usr/bin/atop
        stat /usr/bin/atopsar
        stat /usr/bin/atopconvert
        stat /usr/bin/atopcat
        stat /usr/bin/atophide
        # Verify atopsar is a symlink to atop
        readlink /usr/bin/atopsar | grep -F "atop"
