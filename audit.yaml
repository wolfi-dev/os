package:
  name: audit
  version: 4.0.2
  epoch: 3
  description: User space tools for kernel auditing
  copyright:
    - license: LGPL-2.1-or-later
  scriptlets:
    pre-install: |
      #!/bin/sh

      # auditd will not start if its log directory is missing
      mkdir -p /var/log/audit

      exit 0

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - libcap-ng-dev
      - libtool
      - linux-headers
      - openldap-dev
      - openssf-compiler-options
      - python3
      - python3-dev
      - swig

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/linux-audit/audit-userspace
      expected-commit: 4e6deae41d4646d28bb3ba9524a8a227a38ccd0b
      tag: v${{package.version}}

  - uses: patch
    with:
      patches: usr-paths.patch

  - uses: patch
    with:
      patches: test-uid-42.patch

  - uses: patch
    with:
      patches: 0003-all-get-rid-of-strndupa.patch

  - runs: |
      autoreconf -fiv

  - runs: |
      # Base flags
      _flags="
          --prefix=/usr
          --disable-zos-remote
          --enable-shared=audit
          --with-python3=yes
          --enable-gssapi-krb5=yes
          --with-libcap-ng=yes
          --without-golang
          --with-io_uring
      "

      # Append architecture-specific flag if needed
      if [ "${build_arch}" = "aarch64" ]; then
          _flags="$_flags --with_aarch64=yes"
      fi

      # Configure with the joined flags
      ./configure $_flags

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: audit-static
    pipeline:
      - uses: split/static
    description: audit static

  - name: audit-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - audit
        - linux-headers
    description: audit dev

  - name: audit-doc
    pipeline:
      - uses: split/manpages
    description: audit manpages

  - name: audit-openrc
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/etc/init.d
          mkdir -p "${{targets.contextdir}}"/etc/conf.d
          install -Dm755 auditd.initd "${{targets.contextdir}}"/etc/init.d/auditd
          install -Dm644 auditd.confd "${{targets.contextdir}}"/etc/conf.d/auditd
      - uses: strip
    dependencies:
      runtime:
        - openrc

update:
  enabled: true
  github:
    identifier: linux-audit/audit-userspace
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        audisp-remote --version
        aureport --version
        ausearch --version
        audisp-remote --help
        aureport --help
        ausearch --help
    - uses: python/import
      with:
        import: audit
