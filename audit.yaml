package:
  name: audit
  version: 4.0.3
  epoch: 40
  description: User space tools for kernel auditing
  copyright:
    - license: LGPL-2.1-or-later
  dependencies:
    runtime:
      - merged-usrsbin
      - wolfi-baselayout

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - libcap-ng-dev
      - libtool
      - linux-headers
      - openldap-dev
      - python3
      - python3-dev
      - swig

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/linux-audit/audit-userspace
      expected-commit: 51d154c5b7ec91831cbb89fe6ca54d8eb7ba344c
      tag: v${{package.version}}

  - uses: patch
    with:
      patches: usr-paths.patch

  - uses: patch
    with:
      patches: test-uid-42.patch

  - uses: patch
    with:
      patches: 0003-all-get-rid-of-strndupa.patch

  - runs: |
      autoreconf -fiv

  - runs: |
      # Base flags
      _flags="
          --prefix=/usr
          --disable-zos-remote
          --enable-shared=audit
          --with-python3=yes
          --enable-gssapi-krb5=yes
          --with-libcap-ng=yes
          --without-golang
          --with-io_uring
          --runstatedir=/var/run
          --sbindir=/usr/bin
      "

      # Append architecture-specific flag if needed
      if [ "${build_arch}" = "aarch64" ]; then
          _flags="$_flags --with_aarch64=yes"
      fi

      # Configure with the joined flags
      ./configure $_flags

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: libaudit
    description: c library for security auditing
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/lib*.so.* ${{targets.contextdir}}/usr/lib
    test:
      pipeline:
        - uses: test/tw/ldd-check
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: py3-audit
    description: python bindings for audit
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/python3.* ${{targets.contextdir}}/usr/lib
    test:
      pipeline:
        - uses: python/import
          with:
            import: audit
        - uses: test/tw/ldd-check
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: audit-static
    pipeline:
      - uses: split/static
    description: audit static
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: audit-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - linux-headers
        - merged-usrsbin
        - wolfi-baselayout
    description: audit dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: audit-doc
    pipeline:
      - uses: split/manpages
    description: audit manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

update:
  enabled: true
  github:
    identifier: linux-audit/audit-userspace
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        audisp-remote --version
        aureport --version
        ausearch --version
        audisp-remote --help
        aureport --help
        ausearch --help
    - uses: test/tw/ldd-check
