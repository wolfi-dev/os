package:
  name: aws-sdk-cpp
  version: "1.11.630"
  epoch: 1
  description: "The AWS SDK for C++"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      # SCA seems to miss this dep for this package
      - aws-crt-cpp

environment:
  contents:
    packages:
      - aws-c-cal
      - aws-c-common-dev
      - aws-c-http
      - aws-c-io
      - aws-crt-cpp-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - openssl-dev
      - s2n-tls
      - samurai
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/aws/aws-sdk-cpp
      tag: ${{package.version}}
      expected-commit: 53bb5afac4d0b49a27c0de8e995cb714b06fcb75

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_PREFIX_PATH=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DBUILD_SHARED_LIBS=True \
        -DCMAKE_BUILD_TYPE=None \
        -DBUILD_DEPS=OFF \
        -DBUILD_TESTING=OFF \
        -DCMAKE_SYSTEM_NAME=Linux \
        -DCMAKE_HOST_SYSTEM_NAME=Linux \
        -DENABLE_TESTING=OFF \
        -DFORCE_SHARED_CRT=ON \
        -DAWS_SDK_WARNINGS_ARE_ERRORS=OFF \
        -DUSE_CRT_HTTP_CLIENT=ON \
        -DUSE_OPENSSL=ON

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: aws-sdk-cpp-dev
    description: aws-sdk-cpp dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - aws-sdk-cpp=${{package.full-version}}
        - aws-crt-cpp-dev
    test:
      environment:
        contents:
          packages:
            - cmake
            - build-base
      pipeline:
        - runs: |
            cat > CMakeLists.txt << __EOF__
            cmake_minimum_required(VERSION 3.15)
            project(my_s3_client LANGUAGES CXX)

            set(CMAKE_CXX_STANDARD 17)
            set(CMAKE_CXX_STANDARD_REQUIRED ON)

            find_package(AWSSDK COMPONENTS s3 core REQUIRED CONFIG)

            add_executable(\${PROJECT_NAME} main.cpp)

            target_link_libraries(\${PROJECT_NAME} PRIVATE aws-cpp-sdk-s3 aws-cpp-sdk-core)
            __EOF__

            cat > main.cpp << __EOF__
            #include <aws/core/Aws.h>
            #include <aws/s3/S3Client.h>
            #include <iostream>

            int main(int argc, char** argv)
            {
                Aws::SDKOptions options;

                Aws::InitAPI(options);
                {
                    // Create a default client configuration
                    Aws::Client::ClientConfiguration clientConfig;
                    std::cout << "Attempting to create S3Client..." << std::endl;
                    // Create an S3 client object. This will trigger the loading of
                    // necessary AWS SDK components and s2n-tls.
                    Aws::S3::S3Client s3_client(clientConfig);
                    std::cout << "S3Client created successfully. This indicates the AWS SDK for S3 loaded and initialized correctly." << std::endl;
                }

                Aws::ShutdownAPI(options);
                std::cout << "AWS SDK Shutdown." << std::endl;
                return 0;
            }
            __EOF__

            cmake . -DCMAKE_BUILD_TYPE=Release
            cmake --build .
            ./my_s3_client

update:
  enabled: true
  github:
    identifier: aws/aws-sdk-cpp
    use-tag: true

test:
  pipeline:
    - uses: test/tw/ldd-check
