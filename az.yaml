package:
  name: az
  version: "2.83.0"
  epoch: 1 # GHSA-jm66-cg57-jjv5
  description: Azure CLI
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - py${{vars.python-version}}-cryptography
      - py${{vars.python-version}}-packaging
      - python-${{vars.python-version}}

vars:
  python-version: "3.13"
  venv-path: /opt/chainguard/az

environment:
  contents:
    packages:
      - busybox
      - py${{vars.python-version}}-cryptography
      - py${{vars.python-version}}-pip
      - py${{vars.python-version}}-setuptools
      - py${{vars.python-version}}-wheel
      - python-${{vars.python-version}}-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Azure/azure-cli/
      tag: azure-cli-${{package.version}}
      expected-commit: c1906171202b73f6c478f4313ff6c4f1ae840d14

  - name: Python Build
    runs: |
      cd src/azure-cli
      python${{vars.python-version}} setup.py bdist_wheel
      cd ../azure-cli-core
      python${{vars.python-version}} setup.py bdist_wheel

  - runs: |
      python${{vars.python-version}} -m venv "${{vars.venv-path}}" --system-site-packages

      "${{vars.venv-path}}/bin/pip" install --force-reinstall --no-compile \
        src/azure-cli/dist/*.whl src/azure-cli-core/dist/*.whl

      # Remediate GHSA-38jv-5279-wg99
      "${{vars.venv-path}}/bin/pip" install --upgrade "urllib3==2.6.3"

      # Remove pip from venv to avoid accumulating CVEs in vendored dependencies
      "${{vars.venv-path}}/bin/pip" uninstall --yes pip

      # Move venv into package output
      mkdir -p "${{targets.destdir}}${{vars.venv-path}}"
      mv "${{vars.venv-path}}"/* "${{targets.destdir}}${{vars.venv-path}}/"

      # Symlink az command to PATH
      mkdir -p "${{targets.destdir}}/usr/bin"
      ln -sf "${{vars.venv-path}}/bin/az" "${{targets.destdir}}/usr/bin/az"

  - uses: strip

update:
  enabled: true
  github:
    identifier: Azure/azure-cli
    strip-prefix: azure-cli-

test:
  pipeline:
    - uses: test/tw/pip-check
      with:
        python: /opt/chainguard/az/bin/python
    - name: Validate Core CLI Commands
      runs: |
        # Check az version in multiple formats
        az version -o json
        az version -o table
        az version -o yaml

        # Check top-level help commands
        az -h
        az --help

        # Verify that core command groups exist
        for cmd in account group network storage; do
          if ! az "$cmd" -h > /dev/null; then
            echo "Core command group '$cmd' not found"
            exit 1
          fi
        done

        echo "Basic command tests passed!"
    - name: Extended CLI Functionality Checks
      runs: |
        # Test cloud-related commands without authentication
        az cloud list -o table
        az cloud show -n AzureCloud -o json

        # Test configure commands
        az configure -h
        az configure --list-defaults

        # Verify presence of additional command groups
        for cmd in cloud extension configure; do
          if ! az "$cmd" -h > /dev/null; then
            echo "Command group '$cmd' not found"
            exit 1
          fi
        done

        # List available extensions (no need to install them)
        az extension list-available --output table

        # Check if 'az find' help works
        az find --help

        # Validate debug output
        az version --debug

        # Verify additional commands are available
        for cmd in feedback rest upgrade interactive; do
          if ! az "$cmd" -h > /dev/null; then
            echo "Command group or command '$cmd' not found"
            exit 1
          fi
        done

        # Check help for these commands explicitly
        az feedback -h
        az rest -h
        az upgrade -h
        az interactive -h

        echo "Expanded command tests passed!"
    - uses: test/tw/ldd-check

subpackages:
  - name: ${{package.name}}-iamguarded-compat
    description: "compat package with iamguarded/azure-cli image"
    dependencies:
      runtime:
        - az=${{package.full-version}}
        - bash
        - busybox
        - merged-usrsbin
        - python-${{vars.python-version}}
        - wolfi-baselayout
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: azure-cli
          version: "2"
      - runs: |
          mkdir -p /opt/iamguarded/azure-cli/bin
          chmod g+rwX /opt/iamguarded

          # Create symlink for az binary
          ln -sf /usr/bin/az /opt/iamguarded/azure-cli/bin/az

          # Create expected directories
          mkdir -p /opt/iamguarded/azure-cli/tmp
          mkdir -p /opt/iamguarded/azure-cli/logs
          mkdir -p /iamguarded/azure-cli
      - uses: iamguarded/finalize-compat
        with:
          package: azure-cli
          version: "2"
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: iamguarded/test-compat
          with:
            package: azure-cli
            version: "2"
        - name: Verify iamguarded symlinks work
          runs: |
            # Test az command through symlink
            /opt/iamguarded/azure-cli/bin/az --version

            # Test basic command functionality
            /opt/iamguarded/azure-cli/bin/az -h
            /opt/iamguarded/azure-cli/bin/az version -o json
