#nolint:valid-pipeline-git-checkout-tag
package:
  name: azfiles-authenticator
  # Version is sourced from AzFilesAuthenticator.git/configure.ac:L2
  version: 1.0.7
  epoch: 0
  description: Azure Files Authentication Manager Library for Kerberos authentication on Linux
  copyright:
    - license: MIT
  dependencies:
    # Runtime scripts require both /usr/bin/python3 and /usr/bin/python3.(build version)
    runtime:
      - py3-requests
      - python-3
      - shadow
      - sudo

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl-dev
      - krb5-dev
      - libtool
      - python3

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Azure/AzFilesAuthenticator
      expected-commit: 0715121ea3f919d30f6077171e3ba459af854bc1

  - uses: patch
    with:
      patches: |
        fix-library-loading.patch
        fix-sudo-group.patch

  - runs: |
      autoreconf -vif

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: azfiles-authenticator-dev
    description: Development files for azfiles-authenticator
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - curl-dev
        - krb5-dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

test:
  pipeline:
    - name: Verify library installation
      runs: |
        [ -f /usr/lib/libazfilesauth.so.0 ] || [ -f /usr/lib64/libazfilesauth.so.0 ]
    - name: Verify command-line tool installation
      runs: |
        command -v azfilesauthmanager
        azfilesauthmanager | grep Usage
        azfilesauthmanager --version | grep "New user azfilesuser created with UID: 1001"
        azfilesauthmanager --version | grep "1.0.7"
        azfilesauthmanager list --json
    - name: Verify Python module installation
      runs: |
        [ -d /usr/lib/python3.13/azfilesauth ]
        [ -f /usr/lib/python3.13/azfilesauth/__init__.py ]
        [ -f /usr/lib/python3.13/azfilesauth/azfilesauthmanager.py ]
    - name: Verify configuration directory
      runs: |
        [ -d /etc/azfilesauth ]
        [ -f /etc/azfilesauth/config.yaml ]
    - name: Verify azfilesrefresh daemon can start
      runs: |
        command -v azfilesrefresh
        timeout 15 azfilesrefresh
        cat /var/log/azfilesrefresh.log
        cat /var/log/azfilesrefresh.log | grep "AZ Files Refresh Daemon started"
        # Expected error due to no auth config and blank json returned
        cat /var/log/azfilesrefresh.log | grep "Error getting tickets: Expecting value: line 1 column 1 (char 0)"
        cat /var/log/azfilesrefresh.log | grep "Done checking. Sleeping"
    - name: Test library loading with Python
      runs: |
        python3 <<-'EOF'
        import ctypes
        import os

        # Try to load the library
        library_paths = [
            '/usr/lib/libazfilesauth.so.0',
            '/usr/lib64/libazfilesauth.so.0',
            '/usr/lib/libazfilesauth.so.0.0.0',
            '/usr/lib64/libazfilesauth.so.0.0.0'
        ]

        found = False
        for path in library_paths:
            if os.path.exists(path):
                lib = ctypes.CDLL(path)
                found = True
                print(f"Successfully loaded library from {path}")
                break

        if not found:
            print("Library not found")
            exit(1)

        # Verify function symbols exist
        hasattr(lib, 'extern_smb_set_credential_oauth_token')
        hasattr(lib, 'extern_smb_clear_credential')
        hasattr(lib, 'extern_smb_list_credential')
        hasattr(lib, 'extern_smb_version')

        print("All library functions found")
        EOF

update:
  enabled: false
  exclude-reason: Repository has no tags or releases; version is tracked in configure.ac
  manual: true
