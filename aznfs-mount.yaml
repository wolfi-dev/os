package:
  name: aznfs-mount
  version: "2.0.12"
  epoch: 5
  description: AZNFS Mount Helper
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - conntrack-tools
      - coreutils
      - findmnt
      - flock
      - iptables-wrappers
      - procps
      - util-linux

environment:
  contents:
    packages:
      - build-base
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Azure/AZNFS-mount.git
      tag: ${{package.version}}
      expected-commit: 9511dd9b91eed27ea68ae83d8ba14fd3d3c67dd1

  - runs: |
      install -Dm755 src/aznfswatchdog "${{targets.contextdir}}"/usr/bin/aznfswatchdog
      gcc -O3 src/mount.aznfs.c -o "${{targets.contextdir}}"/usr/bin/mount.aznfs
      install -Dm755 src/mountscript.sh "${{targets.contextdir}}"/opt/microsoft/aznfs/mountscript.sh
      install -Dm755 scripts/aznfs_install.sh "${{targets.contextdir}}"/opt/microsoft/aznfs/aznfs_install.sh
      install -Dm755 lib/common.sh "${{targets.contextdir}}"/opt/microsoft/aznfs/common.sh
      mkdir -p "${{targets.contextdir}}"/opt/microsoft/aznfs/data
      touch "${{targets.contextdir}}"/opt/microsoft/aznfs/data/aznfs.log

test:
  environment:
    contents:
      packages:
        - bash
  pipeline:
    - name: Verify binaries are installed
      runs: |
        test -f /usr/bin/aznfswatchdog
        test -x /usr/bin/aznfswatchdog
        test -f /usr/bin/mount.aznfs
        test -x /usr/bin/mount.aznfs
    - name: Verify support scripts are installed
      runs: |
        test -f /opt/microsoft/aznfs/mountscript.sh
        test -f /opt/microsoft/aznfs/aznfs_install.sh
        test -f /opt/microsoft/aznfs/common.sh
    - name: Test mount.aznfs binary execution
      runs: |
        mount.aznfs --help || true
    - name: Test aznfswatchdog script syntax
      runs: |
        bash -n /usr/bin/aznfswatchdog

update:
  enabled: true
  github:
    identifier: Azure/AZNFS-mount
    use-tag: true
