package:
  name: babeltrace-2
  version: 2.1.0
  epoch: 0
  description: "An open-source trace manipulation toolkit."
  # upstream usage of multiple licenses led us to use this here rather
  copyright:
    - license: LicenseRef-babeltrace-2
      license-path: LICENSE
  dependencies:
    runtime:
      # needs setuptools for distuils use
      - py3-setuptools

environment:
  contents:
    packages:
      - asciidoc
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - doxygen
      - elfutils-dev
      - flex
      - glib-dev
      - libelf
      - libtool
      - pkgconf-dev
      - py3-configobj
      - py3-setuptools
      - python3-dev
      - swig
      - texinfo
      - xmlto
  environment:
    PYTHON: python3
    PYTHON_CONFIG: python3-config
    BABELTRACE_DEV_MODE: 1

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/efficios/babeltrace.git
      tag: v${{package.version}}
      expected-commit: e61d41ff3c3ac6a123930d4e60cf710ff9ea18e0

  - uses: autoconf/configure
    ## We cannot currently build with python bindings because the version of swig has changed how
    ## SWIG_AppendOutput is used. This is a known issue since 4.3.0. If we want to build the python bindings bt2, we would need to
    ## use an older version of swig.
    with:
      #   opts: |
      #     --enable-python-bindings:
      opts: |
        --enable-api-doc \
        --enable-python-plugins \

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - ${{package.name}}
    description: babeltrace dev

  - name: ${{package.name}}-doc
    pipeline:
      - uses: split/manpages
      - uses: split/infodir
      - runs: |
          mv "${{targets.destdir}}/usr/share/doc" "${{targets.contextdir}}/usr/share"
    description: babeltrace manpages
    test:
      environment:
        contents:
          packages:
            - man-db
      pipeline:
        - uses: test/daemon-check-output
          with:
            start: man -w babeltrace2
            timeout: 60
            expected_output: |
              /usr/share/man/man1/babeltrace2.1

test:
  environment:
    contents:
      packages:
        - build-base
  pipeline:
    - runs: |
        babeltrace2 --version
        babeltrace2 --help
    - uses: test/daemon-check-output
      with:
        start: babeltrace2 list-plugins
        timeout: 60
        expected_output: |
          Found 11 component classes in 4 plugins.
    - runs: babeltrace2 list-plugins | grep -E "ctf|utils|text"
    - uses: test/ldd-check
      with:
        packages: ${{package.name}}

# We will have to use tag here as release is not consistent with latest tags
update:
  enabled: true
  ignore-regex-patterns:
    - -rc.*
    - -pre.*
  github:
    identifier: efficios/babeltrace
    use-tag: true
    strip-prefix: v
