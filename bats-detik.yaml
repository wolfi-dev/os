package:
  name: bats-detik
  version: 1.4.0
  epoch: 0
  description: A library to ease e2e tests of applications in K8s environments
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bats-core/bats-detik
      tag: v${{package.version}}
      expected-commit: d42699741a2ed7b74ab8178b0038276d6e36faf1

  - runs: |
      for fn in "lib/"*.bash; do
        install -Dm0755 "$fn" "${{targets.destdir}}/usr/lib/bats/${{package.name}}/$(basename "$fn")"
      done

update:
  enabled: true
  git:
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - bats-core
  pipeline:
    - runs: |
        tee ./inline_test.bats <<'EOF'
        # bats-detik doesn't include a load.bats
        load "/usr/lib/bats/bats-detik/detik"
        @test "verify the undeployment" {
        	run try "at most 5 times every 5s to find 0 pod named 'nginx' with 'status' being 'running'"
        	[ "$status" -eq 0 ]

        	run verify "there is 0 service named 'nginx'"
        	[ "$status" -eq 0 ]
        }
        EOF

        # Run the bats tests
        bats ./inline_test.bats
