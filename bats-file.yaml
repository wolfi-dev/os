package:
  name: bats-file
  version: 0.4.0
  epoch: 0
  description: Common filesystem assertions for Bats
  copyright:
    - license: CC0-1.0
  dependencies:
    runtime:
      - bats-support

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bats-core/bats-file
      tag: v${{package.version}}
      expected-commit: 13ad5e2ffcc360281432db3d43a306f7b3667d60

  - runs: |
      for fn in "src/"*.bash; do
        install -Dm755 "load.bash" "${{targets.destdir}}/usr/lib/bats/${{package.name}}/load.bash"
        install -Dm0755 "$fn" "${{targets.destdir}}/usr/lib/bats/${{package.name}}/src/$(basename "$fn")"
      done

update:
  enabled: true
  git:
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - bats-core
  pipeline:
    - runs: |
        tee ./inline_test.bats <<'EOF'
        bats_load_library bats-support
        bats_load_library bats-file

        @test "file_exists should return true for existing file" {
          touch testfile.txt
          assert_exists testfile.txt
        }

        @test "assert_not_exists should return true for non-existing file" {
          assert_not_exists non_existing_file.txt
        }

        @test "assert_dir_not_exists should return true for non-existing directory" {
          assert_not_exists /this/is/fake
        }
        EOF

        tee ./inline_fail_test.bats <<'EOF'
        bats_require_minimum_version 1.5.0

        @test 'fail to fail if library is not here' {
          run -127 assert_exists non_existing_file.txt
        }
        EOF

        # Run the bats tests
        bats ./inline_test.bats
        bats ./inline_fail_test.bats
