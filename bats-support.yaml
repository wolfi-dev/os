package:
  name: bats-support
  version: 0.3.0
  epoch: 0
  description: Supporting library for Bats test helpers
  copyright:
    - license: 0BSD

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bats-core/bats-support
      tag: v${{package.version}}
      expected-commit: 24a72e14349690bcbf7c151b9d2d1cdd32d36eb1

  - runs: |
      for fn in "src/"*.bash; do
        install -Dm755 "load.bash" "${{targets.destdir}}/usr/lib/bats/${{package.name}}/load.bash"
        install -Dm0755 "$fn" "${{targets.destdir}}/usr/lib/bats/${{package.name}}/src/$(basename "$fn")"
      done

update:
  enabled: true
  git:
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - bats-core
  pipeline:
    - runs: |
        tee ./inline_test.bats <<'EOF'
        bats_load_library bats-support

        @test 'fail() <message>: returns 1 and displays <message>' {
          run fail 'message'
          [ "$status" -eq 1 ]
          [ "$output" == 'message' ]
        }
        EOF

        tee ./inline_fail_test.bats <<'EOF'
        bats_require_minimum_version 1.5.0

        @test 'fail to fail if library is not here' {
          run -127 fail 'message'
          [ "$status" -eq 127 ]
        }
        EOF

        # Run the bats tests
        bats ./inline_test.bats
        bats ./inline_fail_test.bats
