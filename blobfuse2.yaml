package:
  name: blobfuse2
  version: 2.4.2
  epoch: 0
  description: A virtual file system adapter for Azure Blob storage
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - fuse3-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 25d91613a14bc3847d4443188340cc7e4c65a43f
      repository: https://github.com/Azure/azure-storage-fuse
      tag: ${{package.name}}-${{package.version}}

  - uses: go/build
    with:
      output: blobfuse2
      packages: .

subpackages:
  - name: "${{package.name}}-health-monitor"
    description: "Health monitor for blobfuse2"
    pipeline:
      - uses: go/build
        with:
          output: bfusemon
          packages: ./tools/health-monitor
    test:
      pipeline:
        - runs: |
            # Check basic help and version
            bfusemon --help
            bfusemon -version
        # requires blobfuse2 process running in background.
        - uses: test/daemon-check-output
          with:
            start: /usr/bin/bfusemon -no-cpu-profiler -no-memory-profiler -no-network-profiler -pid 12345 &
            timeout: 30
            expected_output: |
              Transfer Pipe: 12345 
              Polling Pipe: /tmp/transferPipe_12345 
              Blobfuse2 Stats poll interval: /tmp/pollPipe_12345 
              Health Stats poll interval: 10 
update:
  enabled: true
  github:
    identifier: Azure/azure-storage-fuse
    strip-prefix: blobfuse2-
    tag-filter: blobfuse2-2.4.

test:
  environment:
    contents:
      packages:
        - umount
  pipeline:
    - runs: |
        # Check basic help and version
        blobfuse2 --help | grep "Blobfuse2 is an open source project"
        blobfuse2 --version | grep ${{package.version}}
    # Requires Azure credentials
    # Fails with "Error: failed to initialize new pipeline [config error in azstorage [account name not provided]]"
    # - runs: |
    #     #!/bin/bash
    #     set -e

    #     cat > "/tmp/config.yaml" <<EOF
    #       allow-other: true

    #       logging:
    #         type: syslog

    #       components:
    #         - libfuse
    #         - file_cache
    #         - attr_cache
    #         - azstorage

    #       libfuse:
    #         attribute-expiration-sec: 120
    #         entry-expiration-sec: 120
    #         negative-entry-expiration-sec: 240

    #       file_cache:
    #         path: /tmp/blobfuse_temp
    #         timeout-sec: 0 
    #         allow-non-empty-temp: true
    #         cleanup-on-start: true

    #       attr_cache:
    #         timeout-sec: 7200
    #     EOF

    #     mkdir -p /tmp/bfuse_test_mnt

    #     blobfuse2 mount /tmp/bfuse_test_mnt --config-file="/tmp/config.yaml" &
    #     sleep 5
    #     umount /tmp/bfuse_test_mnt
