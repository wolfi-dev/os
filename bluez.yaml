# Generated from https://git.alpinelinux.org/aports/plain/main/bluez/APKBUILD
package:
  name: bluez
  version: "5.79"
  epoch: 2
  description: Tools for the Bluetooth protocol stack
  copyright:
    - license: GPL-2.0-or-later AND BSD-2-Clause AND MIT

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - dbus
      - dbus-dev
      - ell-dev
      - glib-dev
      - icu-dev
      - json-c-dev
      - libical-dev
      - libtool
      - linux-headers
      - openssf-compiler-options
      - py3-docutils
      - py3-pygments
      - python3
      - readline-dev
      - systemd-dev

pipeline:
  - uses: fetch
    with:
      expected-sha256: 4164a5303a9f71c70f48c03ff60be34231b568d93a9ad5e79928d34e6aa0ea8a
      uri: https://www.kernel.org/pub/linux/bluetooth/bluez-${{package.version}}.tar.xz

  - uses: autoconf/configure
    with:
      opts: |
        --disable-systemd \
        --enable-library \
        --enable-deprecated \
        --enable-hid2hci \
        --enable-mesh \
        --enable-sixaxis \
        --with-dbusconfdir=/usr/share

  - uses: autoconf/make

  - runs: |
      make DESTDIR="${{targets.destdir}}" install install-pluginLTLIBRARIES
      install -Dm755 test/simple-agent "${{targets.destdir}}"/usr/bin/bluez-simple-agent
      install -Dm755 tools/btmgmt -t "${{targets.destdir}}"/usr/bin/
      install -Dm755 attrib/gatttool -t "${{targets.destdir}}"/usr/bin/

      install -Dm644 obexd/src/org.bluez.obex.service \
        "${{targets.destdir}}"/usr/share/dbus-1/services/org.bluez.obex.service

      # Workaround permission issue. Fixed upstream, but pulling in patch requires
      # running autoreconf which seems to generate issues.
      # https://github.com/bluez/bluez/commit/b1fd409960001a77cda2a09ecc00147ebd9c3667
      # Fixes: https://github.com/wolfi-dev/os/issues/31026
      chmod 0755 "${{targets.destdir}}"/etc/bluetooth

  - uses: strip

subpackages:
  - name: bluez-dbg
    pipeline:
      - uses: split/debug

  - name: bluez-doc
    pipeline:
      - uses: split/manpages
    description: bluez manpages

  - name: bluez-btmgmt
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/btmgmt ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            btmgmt --version

  - name: bluez-btmon
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/btmon ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            btmon --version
            btmon --help

  - name: bluez-cups
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/cups ${{targets.subpkgdir}}/usr/lib

  - name: bluez-meshctl
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/meshctl ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            meshctl --version

  - name: bluez-dev
    pipeline:
      - uses: split/dev
    description: bluez dev
    test:
      pipeline:
        - uses: test/pkgconf

update:
  enabled: true
  release-monitor:
    identifier: 10029

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        bluemoon --version
        bluetoothctl --version
        btattach --version
        ciptool --version
        gatttool --help
        hciconfig --version
        hcidump --version
        hcitool --version
        hex2hcd --version
        mesh-cfgclient --version
        mesh-cfgtest --version
        mpris-proxy --version
        rfcomm --version
        sdptool --help
        bluemoon --help
        btattach --help
        ciptool --help
        hciconfig --help
        hcidump --help
        hcitool --help
        hex2hcd --help
        mesh-cfgtest --help
        mpris-proxy --help
        rfcomm --help
