package:
  name: busybox
  version: 1.37.0
  epoch: 53
  description: "swiss-army knife for embedded systems"
  copyright:
    - license: GPL-2.0-only
  dependencies:
    provider-priority: 10
    runtime:
      - merged-bin
      - merged-sbin
      - merged-usrsbin
      - wolfi-baselayout
  scriptlets:
    trigger:
      paths:
        - /bin
        - /sbin
        - /usr/bin
        - /usr/sbin
      script: |
        #!/usr/bin/busybox sh
        /usr/bin/busybox --install -s

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: _
    to: mangled-package-version

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - perl # provides pod2html/pod2text

pipeline:
  - uses: git-checkout
    with:
      expected-commit: be7d1b7b1701d225379bc1665487ed0871b592a5
      repository: https://git.busybox.net/busybox
      tag: ${{vars.mangled-package-version}}

  - uses: patch
    with:
      patches: CVE-2022-28391-1.patch CVE-2022-28391-2.patch

  # from aports.git busybox/0001-tar-fix-TOCTOU-symlink-race-condition.patch
  - uses: patch
    with:
      patches: 0001-tar-fix-TOCTOU-symlink-race-condition.patch

  # from aports.git busybox/0037-awk.c-fix-CVE-2023-42366-bug-15874.patch
  # http://lists.busybox.net/pipermail/busybox/2024-March/090654.html
  - uses: patch
    with:
      patches: 0037-awk.c-fix-CVE-2023-42366-bug-15874.patch

  # created patch for CVE-2024-58251
  - uses: patch
    with:
      patches: CVE-2024-58251-2.patch

  - uses: patch
    with:
      patches: CVE-2025-46394.patch

  # Patch from SUSE, also see https://github.com/wolfi-dev/os/pull/77355
  - uses: patch
    with:
      patches: CVE-2025-60876.patch

  - name: Configure
    runs: |
      cp busyboxconfig .config

  - runs: |
      make CC="${{host.triplet.gnu}}-gcc" V=1 -j$(nproc)

  - name: Install
    runs: |
      mkdir -p "${{targets.destdir}}"/usr/bin
      mkdir -p "${{targets.destdir}}"/etc/busybox-paths.d
      install -m755 busybox "${{targets.destdir}}"/usr/bin/busybox
      install -m644 securetty "${{targets.destdir}}"/etc/securetty
      ./busybox --list-path > "${{targets.destdir}}"/etc/busybox-paths.d/busybox

      # sbin merge
      sed 's|^sbin|usr/bin|' -i "${{targets.destdir}}"/etc/busybox-paths.d/busybox
      # bin merge
      sed 's|^bin|usr/bin|' -i "${{targets.destdir}}"/etc/busybox-paths.d/busybox
      # usrsbin merge
      sed 's|^usr/sbin|usr/bin|' -i "${{targets.destdir}}"/etc/busybox-paths.d/busybox

subpackages:
  - name: busybox-full
    dependencies:
      provides:
        - busybox=${{package.full-version}}
      provider-priority: 5
      runtime:
        - merged-bin
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout
    options:
      no-commands: true
    pipeline:
      - name: Configure
        runs: |
          cp busyboxconfig-full .config
      - runs: |
          make CC="${{host.triplet.gnu}}-gcc" V=1 -j$(nproc)
      - name: Install
        runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mkdir -p "${{targets.subpkgdir}}"/etc/busybox-paths.d
          install -m755 busybox "${{targets.subpkgdir}}"/usr/bin/busybox
          install -m644 securetty "${{targets.subpkgdir}}"/etc/securetty
          ./busybox --list-path > "${{targets.subpkgdir}}"/etc/busybox-paths.d/busybox-full

          # sbin merge
          sed 's|^sbin|usr/bin|' -i "${{targets.subpkgdir}}"/etc/busybox-paths.d/busybox-full
          # bin merge
          sed 's|^bin|usr/bin|' -i "${{targets.subpkgdir}}"/etc/busybox-paths.d/busybox-full
          # usrsbin merge
          sed 's|^usr/sbin|usr/bin|' -i "${{targets.subpkgdir}}"/etc/busybox-paths.d/busybox-full
    scriptlets:
      trigger:
        paths:
          - /bin
          - /sbin
          - /usr/bin
          - /usr/sbin
        script: |
          #!/usr/bin/busybox sh
          /usr/bin/busybox --install -s
    test:
      environment:
        contents:
          packages:
            - wolfi-base
            - ver-check
            - python3
      pipeline:
        - name: Verify network utilities are present
          runs: |
            busybox --help
            busybox --list-full >full.txt
            # These programs are expected to be present
            for p in nc netcat wget; do
                if ! grep "usr/bin/$p" full.txt; then
                    echo "$p is not present in busybox --list-full output"
                    exit 1
                fi
                "$p" --help ||
                  { echo "$p --help exited $?. expected pass"; exit 1; }
            done
        - name: Test wget can download a file
          runs: |
            # Create test content for HTTP server
            mkdir -p /tmp/www
            echo "wget test content" > /tmp/www/test.txt

            # Start Python HTTP server
            cd /tmp/www
            python3 -m http.server 8888 > /tmp/httpd.log 2>&1 &
            SERVER_PID=$!

            # Wait for server to be ready
            sleep 2

            # Test wget download
            wget -O /tmp/downloaded.txt http://127.0.0.1:8888/test.txt

            # Verify downloaded content
            if ! grep -F "wget test content" /tmp/downloaded.txt; then
              echo "FAIL: wget did not download expected content"
              cat /tmp/downloaded.txt
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi

            echo "PASS: wget successfully downloaded file"

            # Cleanup
            kill $SERVER_PID 2>/dev/null || true
        - name: Test nc can make network connections
          runs: |
            # Start nc listening in background, will send test data to first connection
            echo "nc test data" | nc -l -p 9999 &
            LISTEN_PID=$!

            # Wait for listener to be ready
            sleep 1

            # Connect to the listening nc and capture data
            result=$(nc 127.0.0.1 9999)

            # Wait for listener to finish
            wait $LISTEN_PID 2>/dev/null || true

            # Verify data was transferred
            if [ "$result" = "nc test data" ]; then
              echo "PASS: nc network connection works"
            else
              echo "FAIL: nc did not receive expected data"
              echo "Expected: nc test data"
              echo "Got: $result"
              exit 1
            fi

test:
  environment:
    contents:
      packages:
        - ver-check
  pipeline:
    - uses: test/hardening-check
      with:
        args: --nocfprotection
    - name: Test echo and grep utilities via pipe
      runs: |
        if ! echo "hello world" | grep -F "hello"; then
          echo "FAIL: echo | grep pipe test failed"
          exit 1
        fi
        echo "PASS: echo | grep pipe works"
    - name: Test file I/O with echo and cat
      runs: |
        echo "test content" > /tmp/testfile.txt
        if ! cat /tmp/testfile.txt | grep -F "test content"; then
          echo "FAIL: cat file test failed"
          exit 1
        fi
        echo "PASS: file I/O with echo and cat works"
    - name: Test ls and grep to find busybox
      runs: |
        if ! ls /usr/bin | grep -F "busybox"; then
          echo "FAIL: busybox not found in /usr/bin"
          exit 1
        fi
        echo "PASS: ls | grep finds busybox"
    - name: Test shell script execution
      runs: |
        tee /tmp/test-script.sh <<'EOF'
        #!/usr/bin/busybox sh
        echo "script executed successfully"
        EOF
        chmod +x /tmp/test-script.sh
        output=$(/tmp/test-script.sh)
        if [ "$output" != "script executed successfully" ]; then
          echo "FAIL: Shell script execution failed"
          echo "Expected: script executed successfully"
          echo "Got: $output"
          exit 1
        fi
        echo "PASS: Shell script execution works"
    - name: Verify network utilities are not present
      runs: |
        busybox --help
        busybox --list-full >full.txt

        # These programs have been intentionally removed from default busybox
        for p in nc netcat wget; do
            if grep "usr/bin/$p" full.txt; then
                echo "Found '$p' in list-full output"
                exit 1
            fi
            command -v "$p" &&
              { echo "command '$p' is present. It should not be."; exit 1; }
        done
    - name: "awk = and ?: precedence"
      runs: |
        found=$(awk 'BEGIN { a=0?"bug":"ok"; print a}')
        [ "$found" = "ok" ] &&
          echo "PASS: ternary precedence" ||
          { echo "FAIL: ternary precedence" ; exit 1; }

update:
  enabled: true
  release-monitor:
    identifier: 230
