package:
  name: bzip2
  version: 1.0.8
  epoch: 10
  description: "a library implementing the bzip2 compression algorithms"
  copyright:
    - license: MPL-2.0 AND MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - make
      - wolfi-baselayout

pipeline:
  - uses: git-checkout
    with:
      repository: https://sourceware.org/git/bzip2.git
      tag: bzip2-${{package.version}}
      expected-commit: 6a8690fc8d26c815e798c588f796eabe9d684cf0

  - uses: patch
    with:
      patches: bzip2-1.0.2-progress.patch

  - uses: patch
    with:
      patches: bzip2-1.0.3-no-test.patch

  - uses: patch
    with:
      patches: bzip2-1.0.4-makefile-CFLAGS.patch

  - uses: patch
    with:
      patches: bzip2-1.0.4-man-links.patch

  - uses: patch
    with:
      patches: saneso.patch

  - runs: |
      sed -i \
        -e 's:\$(PREFIX)/man:\$(PREFIX)/share/man:g' \
        -e 's:ln -s -f $(PREFIX)/bin/:ln -s :' \
        Makefile

      sed -i \
        -e "s:1\.0\.4:${{package.version}}:" \
        bzip2.1 bzip2.txt Makefile-libbz2_so manual.*

  - runs: |
      make -f Makefile-libbz2_so all
      make all

  - runs: |
      make PREFIX="${{targets.destdir}}/usr" install

  - uses: strip

subpackages:
  - name: "libbz2-1"
    description: bzip2 shared library
    pipeline:
      - runs: |
          install -D libbz2.so.${{package.version}} "${{targets.subpkgdir}}"/usr/lib/libbz2.so.${{package.version}}
          ln -s libbz2.so.${{package.version}} "${{targets.subpkgdir}}"/usr/lib/libbz2.so.1
          ln -s libbz2.so.1 "${{targets.subpkgdir}}/usr/lib/libbz2.so.1.0"
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: libbz2-1

  - name: "bzip2-dev"
    description: "bzip2 headers"
    pipeline:
      - uses: split/dev
      - runs: |
          ln -s libbz2.so.1 "${{targets.subpkgdir}}"/usr/lib/libbz2.so

  - name: bzip2-doc
    description: bzip2 docs
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  release-monitor:
    identifier: 237

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        bunzip2 --help
        bzcat --help
        bzip2 --version
        bzless --version
        bzmore --version
        bzip2 --help
        bzless --help
        bzmore --help
