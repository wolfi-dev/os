package:
  name: cdparanoia
  version: 10.2
  epoch: 6
  description: An audio CD extraction application
  copyright:
    - license: GPL-2.0-or-later

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - libtool
      - linux-headers

pipeline:
  - uses: fetch
    with:
      expected-sha512: 4ab0a0f5ef44d56c1af72d1fc1035566a1a89c4eeddb9e8baea675fe51c06138d913342afc8bed167d9fa55672fa25a2763ce21f7e24c1232e4739aff20733a7
      uri: https://downloads.xiph.org/releases/cdparanoia/cdparanoia-III-${{package.version}}.src.tgz

  - uses: patch
    with:
      patches: fix-includes.patch

  - uses: patch
    with:
      patches: format-security.patch

  - uses: patch
    with:
      patches: gcc.patch

  - runs: |
      mv configure.guess config.guess
      mv configure.sub config.sub
      # update_config_sub
      sed -i -e '/configure.\(guess\|sub\)/d' configure.in
      aclocal && autoconf
      libtoolize

  - uses: autoconf/configure
    with:
      opts: |
        CFLAGS="$CFLAGS -fPIC" \
        CPPFLAGS="$CFLAGS" \
        CXXFLAGS="$CFLAGS"

  - uses: autoconf/make
    with:
      opts: |
        MAKEFLAGS=-j1

  - runs: |
      make -j1 prefix="${{targets.destdir}}"/usr LIBDIR=${{targets.destdir}}/usr/lib MANDIR="${{targets.destdir}}"/usr/share/man install

  - uses: strip

subpackages:
  # This needs to come before -dev because there's a symlink in usr/lib that gets screwed up
  - name: ${{package.name}}-libs
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib

          # Delete unused static libraries
          rm -f ${{targets.destdir}}/usr/lib/*.a

          mv ${{targets.destdir}}/usr/lib/* ${{targets.subpkgdir}}/usr/lib/

          # Fix permissions so melnage detects the libraries
          chmod 755 "${{targets.subpkgdir}}"/usr/lib/*.so*
    description: Libraries for libcdda_paranoia (Paranoia III)
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
    description: ${{package.name}} dev

  - name: ${{package.name}}-doc
    pipeline:
      - uses: split/manpages
    description: ${{package.name}} manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  release-monitor:
    identifier: 15309

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        cdparanoia --version
        cdparanoia --help
