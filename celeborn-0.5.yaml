package:
  name: celeborn-0.5
  version: 0.5.4
  epoch: 0
  description: "Apache Celeborn - A Remote Shuffle Service for Distributed Data Processing Engines"
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - celeborn=${{package.full-version}}
    runtime:
      - bash
      - openjdk-17-default-jdk
      - procps
      - tini

vars:
  base-package-name: celeborn
  scala-version: 

environment:
  contents:
    packages:
      - bash
      - busybox
      - git
      - libstdc++
      - maven
      - openjdk-17-default-jdk
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk
    LANG: en_US.UTF-8

pipeline:
  - uses: git-checkout
    with:
      expected-commit: cf6ac8cc1d0b013c21a4894776e560c3d63dc42e
      repository: https://github.com/apache/${{vars.base-package-name}}.git
      tag: v${{package.version}}

  - uses: maven/pombump

  - name: Build / install Celeborn
    runs: |
      # Build parts taken from https://github.com/apache/celeborn/blob/main/build/make-distribution.sh

      dest=${{targets.contextdir}}/usr/share/java/${{vars.base-package-name}}
      mkdir -p \
        $dest \
        $dest/bin \
        $dest/conf \
        $dest/jars \
        $dest/sbin

      SCALA_VERSION="$(mvn help:evaluate -Dexpression=scala.binary.version 2>/dev/null \
        | grep -v "INFO" \
        | grep -v "WARNING" \
        | tail -n 1)"
      VERSION="$(mvn help:evaluate -Dexpression=project.version 2>/dev/null \
        | grep -v "INFO" \
        | grep -v "WARNING" \
        | tail -n 1)"

      echo "Celeborn ${{package.version}} (git revision $(git rev-parse --short HEAD 2>/dev/null))" > $dest/RELEASE

      mvn clean package -DskipTests -Dmaven.javadoc.skip=true -Dmaven.source.skip -pl master,worker -am

      for dir in master worker
      do
        mkdir -p "$dest/$dir-jars"

        cp "$dir"/target/celeborn-"$dir"_"$SCALA_VERSION"-"$VERSION".jar "$dest/$dir-jars/"
        cp "$dir"/target/scala-"$SCALA_VERSION"/jars/*.jar "$dest/jars/"
        for jar in $(ls "$dir/target/scala-$SCALA_VERSION/jars");
        do
          (cd "$dest/$dir-jars"; ln -snf "../jars/$jar" .)
        done
      done

      cp conf/*.template $dest/conf
      cp -r bin $dest
      cp -r sbin $dest

subpackages:
  - name: ${{package.name}}-compat
    description: Compat package for ${{package.name}}
    dependencies:
      provides:
        - ${{vars.base-package-name}}-compat=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/opt/${{vars.base-package-name}}

          for dir in bin conf jars master-jars sbin worker-jars
          do
            ln -sf /usr/share/java/${{vars.base-package-name}}/$dir ${{targets.contextdir}}/opt/${{vars.base-package-name}}/$dir
          done
    test:
      pipeline:
        - name: Test symlinks
          runs: |
            for dir in bin cli-jars conf jars master-jars sbin worker-jars
            do
              stat -L /opt/${{vars.base-package-name}}/$bin
            done

test:
  environment:
    contents:
      packages:
        - ${{package.name}}-compat
    environment:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk
  pipeline:
    - name: Test start-master
      runs: |
        # Startup command from helm chart: https://github.com/apache/celeborn/blob/main/charts/celeborn/templates/master/statefulset.yaml#L69
        /bin/sh -c /opt/celeborn/sbin/start-master.sh

update:
  enabled: true
  github:
    identifier: apache/celeborn
    tag-filter: v0.5.
    strip-prefix: v
  ignore-regex-patterns:
    - -rc[0-9]+$
