From a7428416e798eec3501c036a3368832013abb01d Mon Sep 17 00:00:00 2001
From: uti <uti.edun@chainguard.dev>
Date: Thu, 14 Aug 2025 11:02:55 +0000
Subject: [PATCH] feat: add support for Apk packager with repo management and
 installation methods

---
 src/cephadm/cephadmlib/packagers.py | 54 +++++++++++++++++++++++++++++
 1 file changed, 54 insertions(+)

diff --git a/src/cephadm/cephadmlib/packagers.py b/src/cephadm/cephadmlib/packagers.py
index 9187b718411..6bfe8d66024 100644
--- a/src/cephadm/cephadmlib/packagers.py
+++ b/src/cephadm/cephadmlib/packagers.py
@@ -461,6 +461,50 @@ class YumDnf(Packager):
         self.install(['podman'])
 
 
+class Apk(Packager):
+    DISTRO_NAMES = ['wolfi', 'alpine']
+
+    def __init__(
+        self,
+        ctx: CephadmContext,
+        stable: Optional[str],
+        version: Optional[str],
+        branch: Optional[str],
+        commit: Optional[str],
+        distro: Optional[str],
+        distro_version: Optional[str],
+    ) -> None:
+        super(Apk, self).__init__(
+            ctx, stable=stable, version=version, branch=branch, commit=commit
+        )
+        assert distro is not None
+        self.ctx = ctx
+        self.tool = 'apk'
+        self.distro = distro
+        self.distro_version = distro_version
+
+    def add_repo(self) -> None:
+        # For Wolfi/Alpine, we don't add custom Ceph repos as packages
+        # should be provided through the standard repositories
+        logger.info('Skipping repo addition for %s - using system packages' % self.distro)
+
+    def rm_repo(self) -> None:
+        # No custom repos to remove
+        pass
+
+    def install(self, ls: List[str]) -> None:
+        logger.info('Installing packages %s...' % ls)
+        call_throws(self.ctx, [self.tool, 'add'] + ls)
+
+    def install_podman(self) -> None:
+        logger.info('Attempting podman install...')
+        try:
+            self.install(['podman'])
+        except Error:
+            logger.info('Podman did not work. Falling back to docker...')
+            self.install(['docker'])
+
+
 class Zypper(Packager):
     DISTRO_NAMES = ['sles', 'opensuse-tumbleweed', 'opensuse-leap']
 
@@ -609,6 +653,16 @@ def create_packager(
             distro=distro,
             distro_version=distro_version,
         )
+    elif distro in Apk.DISTRO_NAMES:
+        return Apk(
+            ctx,
+            stable=stable,
+            version=version,
+            branch=branch,
+            commit=commit,
+            distro=distro,
+            distro_version=distro_version,
+        )
     raise Error(
         'Distro %s version %s not supported' % (distro, distro_version)
     )
-- 
2.50.1


