From 8eb70b6cb76f0a3a2cff9f594b7d3f2d5cabc123 Mon Sep 17 00:00:00 2001
From: uti <uti.edun@chainguard.dev>
Date: Thu, 14 Aug 2025 11:02:55 +0000
Subject: [PATCH] mgr: tolerate sqlite IO errors when setting page size

---
 src/pybind/mgr/mgr_module.py | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/pybind/mgr/mgr_module.py b/src/pybind/mgr/mgr_module.py
index 2830a0b4cb0..a3c0bb24a0f 100644
--- a/src/pybind/mgr/mgr_module.py
+++ b/src/pybind/mgr/mgr_module.py
@@ -1318,10 +1318,25 @@ class MgrModule(ceph_module.BaseMgrModule, MgrModuleLoggingMixin):
         if kv == 3:
             os._exit(120)
 
+    def _set_page_size(self, db: sqlite3.Connection, size: int) -> None:
+        try:
+            db.execute(f'PRAGMA PAGE_SIZE = {size}')
+        except sqlite3.DatabaseError as exc:
+            err_name = getattr(exc, 'sqlite_errorname', None)
+            if err_name == 'SQLITE_IOERR' or 'disk I/O error' in str(exc).lower():
+                self.log.warning(
+                    'Failed to set SQLite page size to %d (%s); '
+                    'continuing with default page size.',
+                    size,
+                    exc,
+                )
+            else:
+                raise
+
     def configure_db(self, db: sqlite3.Connection) -> None:
         db.execute('PRAGMA FOREIGN_KEYS = 1')
         db.execute('PRAGMA JOURNAL_MODE = PERSIST')
-        db.execute('PRAGMA PAGE_SIZE = 65536')
+        self._set_page_size(db, 65536)
         db.execute('PRAGMA CACHE_SIZE = 64')
         db.execute('PRAGMA TEMP_STORE = memory')
         db.row_factory = sqlite3.Row
-- 
2.50.1

