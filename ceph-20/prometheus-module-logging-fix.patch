From b49caa0e0d0df8d4e9c36f7a9d0a7b2e3f4c5d6e Mon Sep 17 00:00:00 2001
From: Sunnatillo Istamov <sunnatisatmov@gmail.com>
Date: Fri, 11 Oct 2024 16:33:45 +0300
Subject: [PATCH] mgr/prometheus: fix string formatting error in exception
 logging

This PR handles the empty invalid JSON errors from orch get-security-config.

Fixes: https://tracker.ceph.com/issues/73492
Backport of: https://github.com/ceph/ceph/pull/65033
Introduced by: https://github.com/ceph/ceph/pull/64371

Signed-off-by: Sunnatillo Istamov <sunnatisatmov@gmail.com>
---
 src/pybind/mgr/prometheus/module.py | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/pybind/mgr/prometheus/module.py b/src/pybind/mgr/prometheus/module.py
index 41b62fd6a93..b49caa0e0d0 100644
--- a/src/pybind/mgr/prometheus/module.py
+++ b/src/pybind/mgr/prometheus/module.py
@@ -1884,6 +1884,7 @@ def self_test(self) -> None:
     def configure(self, server_addr: str, server_port: int) -> None:
         cmd = {'prefix': 'orch get-security-config'}
         ret, out, _ = self.mon_command(cmd)
+
         if ret == 0 and out is not None:
             try:
                 security_config = json.loads(out)
@@ -1891,8 +1892,8 @@ def configure(self, server_addr: str, server_port: int) -> None:
                     self.setup_tls_config(server_addr, server_port)
                     return
             except Exception as e:
-                self.log.exception(f'Failed to setup cephadm based secure monitoring stack: {e}\n',
-                                   'Falling back to default configuration')
+                self.log.exception('Failed to setup cephadm based secure monitoring stack: %s\n'
+                                   'Falling back to default configuration', e)

         # In any error fallback to plain http mode
         self.setup_default_config(server_addr, server_port)
--
2.50.1
