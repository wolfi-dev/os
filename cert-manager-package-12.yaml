package:
  name: cert-manager-package-12
  version: 20230311.12.1.3 # Tracks Debian 12 (Bookworm) ca-certificates version (20230311-deb12u1.X)
  epoch: 0
  description: cert-manager trust package with Debian 12 (Bookworm) CA certificates
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - tini

var-transforms:
  - from: ${{package.version}}
    match: '^(\d+)\.(\d+)\.(\d+)\.(\d+)$'
    replace: '${1}-deb${2}u${3}.${4}'
    to: debian-version

environment:
  contents:
    packages:
      - binutils
      - busybox
      - ca-certificates-bundle
      - curl
      - gnutar
      - jq
      - trust-package
      - xz

pipeline:
  # Check version drift with upstream - fail build if mismatch
  - runs: |
      set -euo pipefail

      # Get upstream version from Debian Bookworm
      UPSTREAM_VERSION=$(curl -sL https://raw.githubusercontent.com/cert-manager/trust-manager/main/make/00_debian_bookworm_version.mk | \
        grep "DEBIAN_BOOKWORM_BUNDLE_VERSION :=" | \
        cut -d'=' -f2 | \
        tr -d ' ')

      # Convert our hyphen-based version to plus for comparison
      OUR_VERSION=$(echo "${{vars.debian-version}}" | sed 's/-deb/+deb/')

      # Compare with upstream version
      if [ "$OUR_VERSION" != "$UPSTREAM_VERSION" ]; then
        echo "ERROR: Version mismatch!"
        echo "  Our version: ${{package.version}} converts to $OUR_VERSION)"
        echo "  Upstream:    $UPSTREAM_VERSION"
        echo "Update package version to match upstream"
        exit 1
      fi
      echo "Version matches upstream: $UPSTREAM_VERSION"

  # Copy copyandmaybepause from trust-package runtime dependency to root level
  - runs: |
      mkdir -p ${{targets.destdir}}
      # The trust-package provides copyandmaybepause at /usr/bin/copyandmaybepause
      # We need it at the root level to match upstream structure
      cp /usr/bin/copyandmaybepause ${{targets.destdir}}/copyandmaybepause
      chmod +x ${{targets.destdir}}/copyandmaybepause

  # Fetch and process the Debian ca-certificates package
  # Replicates upstream: make/debian-trust-package-fetch.sh
  - name: Process Debian CA certificates
    runs: |
      set -euo pipefail

      # Create the debian-package directory
      mkdir -p "${{targets.destdir}}/debian-package"

      # Replicate upstream script variables
      # Production always uses ACTION="exact" - see:
      # https://github.com/cert-manager/trust-manager/blob/main/make/debian-bookworm-trust-package.mk#L24
      ACTION="exact"  # Production uses "exact" not "latest"
      # Convert hyphen to plus for Debian package format
      TARGET_DEBIAN_BUNDLE_VERSION=$(echo "${{vars.debian-version}}" | sed 's/-deb/+deb/')  # e.g., 20230311+deb12u1.3
      target_ca_certificates_version="${TARGET_DEBIAN_BUNDLE_VERSION%.*}"  # e.g., 20230311+deb12u1

      # Download and extract Debian ca-certificates
      DEB_URL="https://deb.debian.org/debian/pool/main/c/ca-certificates/ca-certificates_${target_ca_certificates_version}_all.deb"
      echo "Fetching Debian ca-certificates from: $DEB_URL"
      curl -fLO "$DEB_URL"

      # Extract the .deb package using ar
      ar x "ca-certificates_${target_ca_certificates_version}_all.deb"
      tar -xf data.tar.xz

      # Concatenate all mozilla certificates Debian default
      > ca-bundle.crt
      for cert in usr/share/ca-certificates/mozilla/*.crt; do
        [ -f "$cert" ] && cat "$cert" >> ca-bundle.crt
      done

      installed_version="${target_ca_certificates_version}"

      # Build JSON package with upstream version logic
      PACKAGE_NAME="cert-manager-debian-bookworm"
      # https://github.com/cert-manager/trust-manager/blob/main/make/debian-trust-package-fetch.sh#L113
      version_suffix=".0"  # ACTION="exact" keeps .0
      json_version="${installed_version}${version_suffix}"  # 20230311+deb12u1.0

      echo "Creating JSON bundle with version: $json_version"
      echo "{}" | jq \
        --rawfile bundle ca-bundle.crt \
        --arg name "$PACKAGE_NAME" \
        --arg version "$json_version" \
        '.name = $name | .bundle = $bundle | .version = $version' \
        > "${{targets.destdir}}/debian-package/cert-manager-package-debian.json"

      # Cleanup temporary files
      rm -f ca-certificates_${target_ca_certificates_version}_all.deb control.tar.* data.tar.* debian-binary ca-bundle.crt
      rm -rf usr etc

update:
  enabled: true
  schedule:
    period: weekly
    reason: Weekly rebuild to fetch latest Debian CA certificates are updated more frequently than the package version

test:
  environment:
    contents:
      packages:
        - jq
        - openssl # For certificate validation
        - git
        - go
        - build-base
  pipeline:
    # Validate JSON bundle with trust-manager's official validator
    - name: Validate with trust-manager validator
      runs: |
        set -euo pipefail
        git clone --depth 1 --branch v0.20.3 https://github.com/cert-manager/trust-manager /tmp/trust-manager
        cd /tmp/trust-manager

        # Build the validator
        go build -o /tmp/validate-trust-package ./cmd/validate-trust-package

        # Validate the JSON bundle
        /tmp/validate-trust-package < /debian-package/cert-manager-package-debian.json

        # Cleanup
        rm -rf /tmp/trust-manager /tmp/validate-trust-package
    - name: Verify JSON bundle structure
      runs: |
        set -euo pipefail

        # Check the JSON file exists
        stat /debian-package/cert-manager-package-debian.json

        # Validate JSON structure
        jq -e '.name == "cert-manager-debian-bookworm"' /debian-package/cert-manager-package-debian.json
        jq -e '.version | startswith("20230311")' /debian-package/cert-manager-package-debian.json
    - name: Validate CA certificates content
      runs: |
        set -euo pipefail

        # Extract and validate certificates
        jq -r '.bundle' /debian-package/cert-manager-package-debian.json > /tmp/ca-bundle.crt

        # Validate certificate format
        openssl crl2pkcs7 -nocrl -certfile /tmp/ca-bundle.crt | openssl pkcs7 -print_certs -noout
    - name: Test copyandmaybepause functionality
      runs: |
        set -euo pipefail

        # Test the copy functionality
        mkdir -p /tmp/source /tmp/dest
        cp /debian-package/cert-manager-package-debian.json /tmp/source/

        # Run copyandmaybepause
        /copyandmaybepause /tmp/source /tmp/dest

        # Verify the file was copied
        stat /tmp/dest/cert-manager-package-debian.json

        # Verify content is identical
        diff /tmp/source/cert-manager-package-debian.json /tmp/dest/cert-manager-package-debian.json
    - name: Integration test - Package deployment simulation
      runs: |
        set -euo pipefail

        # Simulate an init container scenario
        mkdir -p /tmp/packages

        # Use copyandmaybepause as an init container would
        /copyandmaybepause /debian-package /tmp/packages

        # Verify the package was copied correctly
        stat /tmp/packages/cert-manager-package-debian.json

        # Validate the copied JSON
        jq -e '.name and .version and .bundle' /tmp/packages/cert-manager-package-debian.json

        # Extract and count certificates from copied file
        CERT_COUNT=$(jq -r '.bundle' /tmp/packages/cert-manager-package-debian.json | grep -c "BEGIN CERTIFICATE")
