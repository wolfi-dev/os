package:
  name: chainguard-security-guide
  version: "3.2.7"
  epoch: 0
  description: Security automation content for Chainguard Images
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/chainguard-dev/stigs
      expected-commit: 20f69a28e697635fcd7c7d8d33fe81c1ea78c9ec
      tag: v${{package.version}}

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/share
      cp -r gpos/* ${{targets.destdir}}/usr/share/

  - uses: strip

update:
  enabled: true
  github:
    identifier: chainguard-dev/stigs
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - ca-certificates-bundle
        - diffutils
        - openscap
        - python-3.12
        - yq
  pipeline:
    - name: Verify gpos content is recognized by oscap
      runs: |
        oscap info /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml
    - name: Verify that the bundle hashes match
      runs: |
        sha256sum /etc/ssl/certs/ca-certificates.crt | awk '{ print $1 }' > /tmp/actual_hash && \
        yq -p=xml -oy '.["ds:data-stream-collection"]["ds:extended-component"][]
        | select(."+@id" == "scap_org_ecomp_.certaudit")
        | .oval_definitions.states.["ind:filehash58_state"]["ind:hash"]' \
        /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml > /tmp/expected_hash && \
        diff /tmp/actual_hash /tmp/expected_hash
        rm /tmp/actual_hash /tmp/expected_hash
    - name: Verify that the trust anchor check passes
      runs: |
        if ! oscap xccdf eval --verbose WARNING --rule xccdf_mil.disa.stig_rule_SV-263659r982563_rule /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml ; then
            # if we failed, then re-run more verbosely to help make diagnosing easier
            oscap xccdf eval --verbose INFO --rule xccdf_mil.disa.stig_rule_SV-263659r982563_rule /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml
        fi
    - name: Verify that the remote service check passes, even with python-3.12 (telnetlib.py) installed
      runs: |
        if ! oscap xccdf eval --verbose WARNING --rule xccdf_mil.disa.stig_rule_SV-203736r958848_rule /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml ; then
            # if we failed, then re-run more verbosely to help make diagnosing easier
            oscap xccdf eval --verbose INFO --rule xccdf_mil.disa.stig_rule_SV-203736r958848_rule /usr/share/xml/scap/ssg/content/ssg-chainguard-gpos-ds.xml
        fi
