package:
  name: checkov
  version: "3.2.494"
  epoch: 0
  description: "static code and composition analysis tool for IaC"
  copyright:
    - license: MIT
  options: 
    no-depends: true
    no-provides: true
  dependencies:
    runtime:
      - bash
      - python-${{vars.python-version}}
      - py${{vars.python-version}}-pyyaml
      - ca-certificates-bundle

vars:
  python-version: '3.12'

environment:
  contents:
    packages:
      - build-base
      - ca-certificates-bundle
      - glibc
      - linux-headers
      - posix-libc-utils
      - py${{vars.python-version}}-pip
      - py${{vars.python-version}}-pyyaml
      - py${{vars.python-version}}-setuptools
      - py${{vars.python-version}}-wheel
      - python-${{vars.python-version}}
      - py${{vars.python-version}}-packaging
      - wolfi-base
      - wolfi-baselayout

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bridgecrewio/checkov
      tag: ${{package.version}}
      expected-commit: b1114135b5f9a33922ec290826c744e048c8d770

  - runs: | 
      # Create virtual environment
      python3 -m venv venv --system-site-packages
      source venv/bin/activate

      # Remediate CVE-2025-8869
      pip install --upgrade 'pip>=25.3'

      # Install dependencies
      pip install bc-jsonpath-ng junit-xml lark bc-detect-secrets dpath rustworkx bc-python-hcl2

      # Install checkov
      pip install .

      # Remove pip and virtualenv
      pip uninstall --yes pip virtualenv

      # Use Python in virtual environment
      find venv/pyvenv.cfg venv/bin/ -type f | xargs sed -i 's|/home/build/venv|/usr/share/checkov|g'

      # Install virtual environment
      mkdir -p ${{targets.destdir}}/usr/share/checkov
      cp -r venv/* ${{targets.destdir}}/usr/share/checkov/

      # Create symlink so checkov is available in PATH
      mkdir -p ${{targets.destdir}}/usr/bin
      ln -sf /usr/share/checkov/bin/checkov ${{targets.destdir}}/usr/bin/checkov

  - uses: strip

test:
  pipeline:
    - uses: test/tw/ldd-check
    - uses: python/import
      with:
        python: python${{vars.python-version}}
        import: checkov

update:
  enabled: true
  git: {}
