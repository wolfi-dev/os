Description: Use system OpenSSL
Author: Michael Paul <michael.paul@chainguard.dev>
Forwarded: not-needed

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 19292f9e29b..3d7f112f9d2 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -490,8 +490,31 @@ endif ()
 
 message (STATUS "Building for: ${CMAKE_SYSTEM} ${CMAKE_SYSTEM_PROCESSOR} ${CMAKE_LIBRARY_ARCHITECTURE}")
 
+# Use system OpenSSL
+if(ENABLE_OPENSSL_DYNAMIC OR ENABLE_SSL)
+    find_package(OpenSSL REQUIRED)
+    if(OpenSSL_FOUND)
+        message(STATUS "Using system OpenSSL: ${OPENSSL_VERSION}")
+        if(NOT TARGET OpenSSL::Crypto)
+            add_library(OpenSSL::Crypto INTERFACE IMPORTED)
+            set_target_properties(OpenSSL::Crypto PROPERTIES
+                INTERFACE_INCLUDE_DIRECTORIES "${OPENSSL_INCLUDE_DIR}"
+                INTERFACE_LINK_LIBRARIES "${OPENSSL_CRYPTO_LIBRARY}")
+        endif()
+        if(NOT TARGET OpenSSL::SSL)
+            add_library(OpenSSL::SSL INTERFACE IMPORTED)
+            set_target_properties(OpenSSL::SSL PROPERTIES
+                INTERFACE_INCLUDE_DIRECTORIES "${OPENSSL_INCLUDE_DIR}"
+                INTERFACE_LINK_LIBRARIES "${OPENSSL_SSL_LIBRARY}")
+        endif()
+    endif()
+endif()
+
 add_subdirectory (contrib EXCLUDE_FROM_ALL)
 
+# Add OpenSSL include paths to all targets that might need it
+include_directories(SYSTEM BEFORE ${OPENSSL_INCLUDE_DIR})
+
 # Sets dummy launchers to suppress linking. Used for clang-tidy builds.
 enable_dummy_launchers_if_needed()
 
diff --git a/contrib/CMakeLists.txt b/contrib/CMakeLists.txt
index 95143606..6db31650 100644
--- a/contrib/CMakeLists.txt
+++ b/contrib/CMakeLists.txt
@@ -43,8 +43,7 @@ endfunction()
 disable_heavy_build_check_if_needed()
 disable_dummy_launchers_if_needed()
 
-# We need to add OpenSSL first so that all our projects use our own version instead of the system one.
-add_contrib (openssl-cmake openssl)  # Needed for delta-lake
+# Using system OpenSSL
 add_contrib (abseil-cpp-cmake abseil-cpp)
 add_contrib (zlib-ng-cmake zlib-ng)
 add_contrib (google-protobuf-cmake google-protobuf)
