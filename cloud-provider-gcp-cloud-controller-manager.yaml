package:
  name: cloud-provider-gcp-cloud-controller-manager
  version: "35.0.2"
  epoch: 0 # go/wolfi-rsc/cloud-provider-gcp-cloud-controller-manager
  description: cloud-provider-gcp contains several projects used to run Kubernetes in Google Cloud
  copyright:
    - license: Apache-2.0
  resources:
    cpu: "11"
    memory: 15Gi

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kubernetes/cloud-provider-gcp
      tag: ccm/v${{package.version}}
      expected-commit: 1684496a9a905038f09d2380db5a9e23371dcf49

  - runs: |
      # Explicitly update go.work to use the installed Go version
      go work edit -go=$(go version | awk '{print $3}' | sed 's/go//')

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: providers

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0

  - uses: go/bump
    with:
      deps: |-
        k8s.io/kubernetes@v1.33.2
        golang.org/x/crypto@v0.45.0
      modroot: test/e2e
      replaces: |-
        k8s.io/mount-utils=k8s.io/mount-utils@v0.33.3 k8s.io/cri-client=k8s.io/cri-client@v0.33.3 k8s.io/dynamic-resource-allocation=k8s.io/dynamic-resource-allocation@v0.33.3 k8s.io/kube-scheduler=k8s.io/kube-scheduler@v0.33.3 k8s.io/csi-translation-lib=k8s.io/csi-translation-lib@v0.33.3

  - uses: go/build
    with:
      packages: ./cmd/cloud-controller-manager
      output: cloud-controller-manager

subpackages:
  - name: ${{package.name}}-compat
    description: "Compatibility package for cluster-api-gcp-controller"
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/
          ln -s ./usr/bin/cloud-controller-manager ${{targets.subpkgdir}}/cloud-controller-manager
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check
        - runs: |
            /cloud-controller-manager --help

# the repository has separate tags for the cloud-controller-manager, so
# each binary has to be a separate package with separate update definition
update:
  enabled: true
  github:
    identifier: kubernetes/cloud-provider-gcp
    strip-prefix: ccm/v
    tag-filter: ccm/v
    use-tag: true

test:
  pipeline:
    - runs: |
        /usr/bin/cloud-controller-manager --help
        /usr/bin/cloud-controller-manager --version
