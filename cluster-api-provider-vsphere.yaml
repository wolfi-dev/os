package:
  name: cluster-api-provider-vsphere
  version: "1.14.0"
  epoch: 3 # CVE-2025-61725
  description: Kubernetes-native declarative infrastructure for vSphere.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 57a59ca5bac6db031a0fff48ad448660b4eceadb
      repository: https://github.com/kubernetes-sigs/cluster-api-provider-vsphere
      tag: v${{package.version}}

  - uses: go/build
    with:
      ldflags: |
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.buildDate=$(date -u -d "@${SOURCE_DATE_EPOCH:-$(date +%s)}" "+%Y-%m-%dT%H:%M:%SZ")
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.gitCommit=$(git rev-parse HEAD)
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.gitTreeState=$(if [ -z "$(git status --porcelain)" ]; then echo "clean"; else echo "dirty"; fi)
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.gitMajor=$(echo v${{package.version}} | cut -d. -f1 | sed 's/v//')
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.gitMinor=$(echo v${{package.version}} | cut -d. -f2)
        -X sigs.k8s.io/cluster-api-provider-vsphere/pkg/version.gitVersion=v${{package.version}}
      output: manager
      packages: .

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package for cluster-api-provider-vsphere
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"
          ln -sf ./usr/bin/manager "${{targets.contextdir}}/manager"
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check
        - runs: |
            /manager --help 2>&1 | grep "Usage of /manager"

update:
  enabled: true
  github:
    identifier: kubernetes-sigs/cluster-api-provider-vsphere
    strip-prefix: v

test:
  pipeline:
    - runs: |
        manager --help 2>&1 | grep "Usage of manager"
    - name: Binary test
      uses: test/kwok/cluster
      with:
        serviceaccount: true
    - name: Launch manager with dummy kubeconfig
      uses: test/daemon-check-output
      with:
        start: manager
        timeout: 30
        expected_output: |
          error opening credentials file
          open /etc/capv/credentials.yaml
          no such file or directory
