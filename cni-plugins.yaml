package:
  name: cni-plugins
  version: "1.9.0"
  epoch: 0
  description: Some reference and example networking plugins, maintained by the CNI team.
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/containernetworking/plugins
      tag: v${{package.version}}
      expected-commit: 9b3772e1a7abf93cbb7c6526a28bc0d27b830e02

  - uses: go/bump
    with:
      deps: |-
        github.com/opencontainers/selinux@v1.13.0

  - runs: |
      # Ensure we build statically since CNI plugins often get moved onto the
      # host machine where we can't guarantee GLIBC verion compatibility
      LDFLAGS="-w -extldflags '-static'"
      LDFLAGS="$LDFLAGS -X github.com/containernetworking/plugins/pkg/utils/buildversion.BuildVersion=$(git describe --tags --dirty)"
      CGO_ENABLED=0 ./build_linux.sh -ldflags "$LDFLAGS"

      mkdir -p "${{targets.destdir}}"/usr/bin
      cp -a bin/* "${{targets.destdir}}"/usr/bin/

  - uses: strip

data:
  - name: plugins
    items:
      bridge: Creates a bridge, adds the host and the container to it.
      ipvlan: Adds an ipvlan interface in the container.
      loopback: Set the state of loopback interface to up
      macvlan: Creates a new MAC address, forwards all traffic to that to the container.
      ptp: Creates a veth pair.
      vlan: Allocates a vlan device.
      host-device: Move an already-existing device into a container.
      dummy: Creates a new Dummy device in the container.
      dhcp: Runs a daemon on the host to make DHCP requests on behalf of the container
      host-local: Maintains a local database of allocated IPs
      static: Allocate a single static IPv4/IPv6 address to container. It's useful in debugging purpose.
      tuning: Tweaks sysctl parameters of an existing interface
      portmap: An iptables-based portmapping plugin. Maps ports from the host's address space to the container.
      bandwidth: Allows bandwidth-limiting through use of traffic control tbf (ingress/egress).
      sbr: A plugin that configures source based routing for an interface (from which it is chained).
      firewall: A firewall plugin which uses iptables or firewalld to add rules to allow traffic to/from the container.
      tap: Creates a tap device inside the container namespace.
      vrf: Creates a VRF in the network namespace and assigns it the interface passed in the arguments.

vars:
  plugins-all: bridge bandwidth dhcp dummy firewall host-device host-local ipvlan loopback macvlan ptp portmap sbr static tap tuning vrf vlan
  plugins-main: bridge dummy host-device ipvlan loopback macvlan ptp tap vlan
  plugins-ipam: dhcp host-local static
  plugins-meta: bandwidth firewall portmap sbr tuning vrf

# CNI Plugins, separated into groups
subpackages:
  - name: "cni-plugins-main"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          for binary in ${{vars.plugins-main}}; do
            cp bin/$binary "${{targets.subpkgdir}}"/usr/bin/
          done
    # test added by a robot (binary)
    test:
      pipeline:
        - runs: |
            stat /usr/bin/bridge
            stat /usr/bin/dummy
            stat /usr/bin/host-device
            stat /usr/bin/ipvlan
            stat /usr/bin/loopback
            stat /usr/bin/macvlan
            stat /usr/bin/ptp
            stat /usr/bin/tap
            stat /usr/bin/vlan

  - name: "cni-plugins-ipam"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          for binary in ${{vars.plugins-ipam}}; do
            cp bin/$binary "${{targets.subpkgdir}}"/usr/bin/
          done
    # test added by a robot (binary)
    test:
      pipeline:
        - runs: |
            stat /usr/bin/dhcp
            stat /usr/bin/host-local
            stat /usr/bin/static

  - name: "cni-plugins-meta"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          for binary in ${{vars.plugins-meta}}; do
            cp bin/$binary "${{targets.subpkgdir}}"/usr/bin/
          done
    # test added by a robot (binary)
    test:
      pipeline:
        - runs: |
            stat /usr/bin/bandwidth
            stat /usr/bin/firewall
            stat /usr/bin/portmap
            stat /usr/bin/sbr
            stat /usr/bin/tuning
            stat /usr/bin/vrf

  - range: plugins
    name: "cni-plugins-${{range.key}}"
    description: ${{range.value}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          cp bin/${{range.key}} "${{targets.subpkgdir}}"/usr/bin
    test:
      pipeline:
        - runs: |
            ${{range.key}} --version

  - range: plugins
    name: cni-plugins-${{range.key}}-compat
    dependencies:
      runtime:
        - "cni-plugins-${{range.key}}"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/opt/cni/bin
          ln -s /usr/bin/${{range.key}} "${{targets.subpkgdir}}"/opt/cni/bin/${{range.key}}
    # test added by a robot (compat)
    test:
      pipeline:
        - runs: |
            readlink -v /opt/cni/bin/${{range.key}}

  - name: "cni-plugins-aws-k8s-compat"
    description: "Compatibility package for aws-k8s-cni"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/init
          for binary in ${{vars.plugins-all}}; do
            cp bin/${binary} "${{targets.subpkgdir}}"/init/
          done
    test:
      pipeline:
        - name: "verify binaries are in their expected place"
          runs: |
            stat /init/bandwidth
            stat /init/bridge
            stat /init/dhcp
            stat /init/dummy
            stat /init/firewall
            stat /init/host-device
            stat /init/host-local
            stat /init/ipvlan
            stat /init/loopback
            stat /init/macvlan
            stat /init/portmap
            stat /init/ptp
            stat /init/sbr
            stat /init/static
            stat /init/tap
            stat /init/tuning
            stat /init/vlan
            stat /init/vrf

update:
  enabled: true
  github:
    identifier: containernetworking/plugins
    strip-prefix: v

# test added by a robot (binary)
test:
  pipeline:
    - runs: |
        stat /usr/bin/bandwidth
        stat /usr/bin/bridge
        stat /usr/bin/dhcp
        stat /usr/bin/dummy
        stat /usr/bin/firewall
        stat /usr/bin/host-device
        stat /usr/bin/host-local
        stat /usr/bin/ipvlan
        stat /usr/bin/loopback
        stat /usr/bin/macvlan
        stat /usr/bin/portmap
        stat /usr/bin/ptp
        stat /usr/bin/sbr
        stat /usr/bin/static
        stat /usr/bin/tap
        stat /usr/bin/tuning
        stat /usr/bin/vlan
        stat /usr/bin/vrf
