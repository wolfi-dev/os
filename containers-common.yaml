package:
  name: containers-common
  # NOTES: WHEN UPDATING ALSO UPDATE CONTAINERS-{COMMON,STORAGE,SHORTNAMES,SKOPEO-CONFIG}
  version: "0.64.1" # ref: https://src.fedoraproject.org/rpms/containers-common/blob/rawhide/f/containers-common.spec
  epoch: 0
  description: "Common configuration and documentation for container tools ecosystem"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates-bundle
      - containers-image
      - containers-shortnames
      - containers-skopeo-config
      - containers-storage

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - git

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/containers/common
      tag: v${{package.version}}
      expected-commit: ffacc4610d2281511f6875f3cf73e81d4a32a865

  - runs: |
      # Create necessary directories
      mkdir -p "${{targets.destdir}}/etc/containers"
      mkdir -p "${{targets.destdir}}/etc/containers/certs.d"
      mkdir -p "${{targets.destdir}}/etc/containers/networks"
      mkdir -p "${{targets.destdir}}/etc/containers/oci"
      mkdir -p "${{targets.destdir}}/etc/containers/oci/hooks.d"
      mkdir -p "${{targets.destdir}}/etc/containers/registries.conf.d"
      mkdir -p "${{targets.destdir}}/etc/containers/registries.d"
      mkdir -p "${{targets.destdir}}/etc/containers/systemd"
      mkdir -p "${{targets.destdir}}/usr/share/containers"
      mkdir -p "${{targets.destdir}}/usr/share/containers/systemd"
      mkdir -p "${{targets.destdir}}/var/lib/containers/sigstore"
      mkdir -p "${{targets.destdir}}/usr/lib/containers/storage"
      mkdir -p "${{targets.destdir}}/usr/lib/containers/storage/overlay-images"
      mkdir -p "${{targets.destdir}}/usr/lib/containers/storage/overlay-layers"

  - runs: |
      # Install configuration files
      install -m 644 pkg/config/containers.conf "${{targets.destdir}}/usr/share/containers/containers.conf"
      install -m 644 pkg/seccomp/seccomp.json "${{targets.destdir}}/usr/share/containers/seccomp.json"
      install -m 644 pkg/subscriptions/mounts.conf "${{targets.destdir}}/usr/share/containers/mounts.conf"

  - runs: |
      # Create lock files for storage
      touch "${{targets.destdir}}/usr/lib/containers/storage/overlay-images/images.lock"
      touch "${{targets.destdir}}/usr/lib/containers/storage/overlay-layers/layers.lock"

  - uses: strip

update:
  enabled: false
  # ref: https://src.fedoraproject.org/rpms/containers-common/blob/rawhide/f/containers-common.spec
  exclude-reason: "the reason it's disabled because we want to update containers-{common,storage,shortnames,skopeo-config} all together"

test:
  pipeline:
    - name: Verify containers-common installation
      runs: |
        # Check configuration files exist
        stat /usr/share/containers/containers.conf
        stat /usr/share/containers/seccomp.json
        stat /usr/share/containers/mounts.conf

        # Check directories exist
        stat /etc/containers
        stat /etc/containers/certs.d
        stat /etc/containers/oci/hooks.d
        stat /usr/lib/containers/storage

        echo "containers-common installation verified"
