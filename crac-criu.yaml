package:
  name: crac-criu
  version: "4.2.0.1"
  epoch: 0
  description: A project to implement checkpoint/restore functionality for Linux
  copyright:
    - license: GPL-2.0-only

var-transforms:
  - from: ${{package.version}}
    match: ^(\d+\.\d+)\.(\d+)\.(\d+)$
    replace: ${1}-${2}ubuntu${3}
    to: mangled-package-version

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils
      - gnutls-dev
      - iproute2
      - libaio-dev
      - libbpf-dev
      - libbsd-dev
      - libcap-dev
      - libdrm
      - libdrm-dev
      - libnet-dev
      - libnl3
      - libnl3-dev
      - libnl3-static
      - libxml2-utils
      - nftables
      - nftables-dev
      - nftables-static
      - perl
      - pkgconf
      - protobuf-c-dev
      - protobuf-dev
      - protoc
      - python3
      - util-linux-dev
  environment:
    CFLAGS: "-Wno-error=format-truncation -Wno-error=maybe-uninitialized"

pipeline:
  - uses: git-checkout
    with:
      expected-commit: b903ba64d1b59949004e88d063fa9fb2a9367c2c
      repository: https://git.launchpad.net/ubuntu/+source/crac-criu
      tag: applied/${{vars.mangled-package-version}}

  - name: "update PLUGIN_CFLAGS, which we can't otherwise override via env"
    working-directory: plugins/amdgpu
    runs: |
      sed -i 's/\(PLUGIN_CFLAGS.*:=.*\)/\1 -Wno-error=unused-result -Wno-error=stringop-truncation -Wno-error=format-overflow/' Makefile
      sed -i 's/\(PLUGIN_CFLAGS.*:=.*\)/\1 -Wno-error=maybe-uninitialized -Wno-error=format-truncation/' Makefile

  - uses: autoconf/make-install
    with:
      opts: PREFIX=/usr

  - name: "upstream installs to /usr/sbin, fix that"
    runs: |
      mkdir -p "${{targets.destdir}}"/usr/bin
      mv "${{targets.destdir}}"/usr/sbin/* "${{targets.destdir}}"/usr/bin
      rmdir "${{targets.destdir}}"/usr/sbin

  - uses: strip

update:
  enabled: true
  version-transform:
    - match: ^(.+)\-(\d+)ubuntu(\d+)
      replace: $1.$2.$3
  git:
    strip-prefix: applied/
  ignore-regex-patterns:
    - import/.* # Not the relevant tags
    - upstream/.* # Not the relevant tags
    # Ignore backports to older releases, the non-backport version is the one we want
    - _\d\d.04(.\d+)?$
    - _\d\d.10(.\d+)?$

test:
  pipeline:
    - uses: test/no-docs
    - uses: test/tw/ldd-check
    - name: "verify binaries are in their expected path"
      runs: |
        stat /usr/bin/crac-criu
        stat /usr/bin/crac-criu-ns
    - name: "basic binary execution"
      runs: |
        crac-criu --version
        crac-criu --help
