package:
  name: crossplane-provider-azure
  version: "2.3.0"
  epoch: 2 # CVE-2025-61731
  description: Official Azure Provider for Crossplane by Upbound
  copyright:
    - license: Apache-2.0
  resources:
    cpu: 32
    memory: 48Gi

environment:
  contents:
    packages:
      - crossplane-crank
      - gzip

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/crossplane-contrib/provider-upjet-azure
      tag: v${{package.version}}
      expected-commit: 1b42cec3b5004e9665bc0e8cde000713f7533883
      recurse-submodules: true

data:
  - name: packages
    items:
      config: 'provider-family-azure'
      authorization: 'provider-azure-authorization'
      managedidentity: 'provider-azure-managedidentity'
      sql: 'provider-azure-sql'
      storage: 'provider-azure-storage'

subpackages:
  - name: crossplane-${{range.value}}
    range: packages
    pipeline:
      - uses: go/build
        with:
          packages: ./cmd/provider/${{range.key}}
          output: ${{range.value}}
          ldflags: |
            -X github.com/crossplane-contrib/provider-upjet-azure/internal/version.Version=v${{package.version}}
      - runs: |
          crank xpkg extract ghcr.io/crossplane-contrib/${{range.value}}:v${{package.version}}
          gunzip out.gz -c > ${{targets.contextdir}}/package.yaml

  - name: crossplane-${{range.value}}-compat
    range: packages
    description: Provides ${{range.value}} at /usr/local/bin/provider
    dependencies:
      runtime:
        - crossplane-${{range.value}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/local/bin
          ln -s /usr/bin/${{range.value}} ${{targets.contextdir}}/usr/local/bin/provider
    test:
      pipeline:
        - uses: test/tw/symlink-check
          with:
            allow-absolute: true

update:
  enabled: true
  github:
    identifier: crossplane-contrib/provider-upjet-azure
    strip-prefix: v

test:
  pipeline:
    - uses: test/emptypackage
