package:
  name: curl
  version: "8.17.0"
  epoch: 0
  description: "URL retrieval utility and library"
  copyright:
    - license: MIT
  dependencies:
    runtime:
      # Allow only libcurl libraries built from the same upstream
      # source version instead of only relying on SONAMEs.
      # https://github.com/chainguard-dev/internal-dev/issues/10381
      - libcurl-abi=${{package.version}}

environment:
  contents:
    packages:
      - autoconf
      - automake
      - brotli-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - cyrus-sasl-dev
      - git-bootstrap
      - krb5-dev
      - libpsl-dev
      - libtool
      - nghttp2-dev
      - nghttp3-dev
      - openldap-dev
      - openssl-hardened-dev
      - perl
      - wolfi-base
      - zlib-dev

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: _
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/curl/curl.git
      tag: curl-${{vars.mangled-package-version}}
      expected-commit: 400fffa90f30c7a2dc762fa33009d24851bd2016

  - runs: autoreconf -vif

  - uses: autoconf/configure
    with:
      # https://everything.curl.dev/build/deps#libpsl
      opts: |
        --enable-ipv6 \
        --enable-kerberos-auth \
        --enable-negotiate-auth \
        --with-gssapi \
        --enable-unix-sockets \
        --with-openssl \
        --without-rustls \
        --with-nghttp2 \
        --with-pic \
        --with-openssl-quic \
        --enable-ldap \
        --disable-ntlm \
        --without-libssh2 \
        --with-libpsl \
        $([ -d /usr/lib/oldglibc ] && echo ac_cv_func_getpass_r='no' ac_cv_header_stdatomic_h='no')

  - uses: autoconf/make
    with:
      opts: CPPFLAGS="$CPPFLAGS -DOPENSSL_NO_ENGINE -D_GNU_SOURCE"

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: "curl-static"
    description: "Statically linked libcurl"
    pipeline:
      - uses: split/static

  - name: "curl-dev"
    description: "headers for libcurl"
    pipeline:
      - uses: split/dev
      # cd2nroff is needed by trurl
      - runs: install -Dpm0755 -t "${{targets.contextdir}}"/usr/bin ./scripts/cd2nroff
    dependencies:
      runtime:
        - brotli-dev
        - libpsl-dev
        - nghttp2-dev
        - openssl-dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: curl-config
        - uses: test/tw/help-check
          with:
            bins: curl-config

  - name: "curl-doc"
    description: "documentation for curl"
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

  - name: "libcurl-openssl4"
    description: "curl library (openssl backend)"
    dependencies:
      # raise the priority here so this beats rustls
      # TODO: revert this to "5" once rustls is fixed.
      provider-priority: 15
      provides:
        - libcurl-abi=${{package.version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libcurl.so.* "${{targets.subpkgdir}}"/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: "libcurl-abi"
            real-pkg-name: "${{subpkg.name}}"

  - name: ${{package.name}}-oci-entrypoint
    description: "Entrypoint subpackage for official curl image"
    dependencies:
      runtime:
        - curl
    pipeline:
      - uses: git-checkout
        with:
          repository: https://github.com/curl/curl-container
          branch: main
      - runs: |
          install -Dm755 etc/entrypoint.sh ${{targets.subpkgdir}}/entrypoint.sh
    test:
      pipeline:
        - uses: test/tw/symlink-check

update:
  enabled: true
  version-separator: _
  github:
    identifier: curl/curl
    strip-prefix: curl-

test:
  environment:
    accounts:
      groups:
        - groupname: nginx
          gid: 65532
      users:
        - username: nginx
          gid: 65532
          uid: 65532
    contents:
      packages:
        - git
        - nginx
        - wait-for-it
  pipeline:
    - uses: test/tw/ver-check
      with:
        bins: curl
    - uses: test/tw/help-check
      with:
        bins: curl
    - runs: |
        curl --version | grep "ldap ldaps"
        curl --version | grep "HTTP3"
    - uses: test/daemon-check-output
      with:
        setup: |
          tee /etc/nginx/nginx.conf <<EOF
          daemon off;

          events {
              worker_connections 1024;
          }

          http {
            server {
              listen       8080 default_server;
              listen       [::]:8080 default_server;
              server_name  _;
              root         /usr/share/nginx/html;
              location /hello {
                add_header Content-Type text/html;

                return 200 "Hello, Linky!";
              }
              location /redirect {
                return 301 /hello;
              }
            }
          }
          EOF

          nginx -t
        start: nginx
        expected_output: " "
        post: |
          set -x
          wait-for-it localhost:8080
          curl http://localhost:8080/hello | grep -F -e "Hello, Linky!"
          curl -L http://localhost:8080/redirect | grep -F -e "Hello, Linky!"
