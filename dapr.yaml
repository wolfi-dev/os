package:
  name: dapr
  version: "1.15.3"
  epoch: 0
  description: Cluster API meta package
  dependencies:
    provides:
      - dapr=${{package.full-version}}
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - protobuf
      - protoc
      - protoc-gen-go
      - protoc-gen-go-grpc
  environment:
    LD_FLAGS: "-X github.com/dapr/dapr/pkg/buildinfo.gitversion=$(git describe --always --abbrev=7 --dirty) -X github.com/dapr/dapr/pkg/buildinfo.gitcommit=$(git rev-list -1 HEAD) -X github.com/dapr/dapr/pkg/buildinfo.version=v${{package.version}} -X github.com/dapr/kit/logger.DaprVersion=v${{package.version}}"
    GO_TAGS: "allcomponents"

pipeline:
  - uses: git-checkout
    with:
      expected-commit: c3687714f9592def48b14b8300bf5170fe8a1bff
      repository: https://github.com/dapr/dapr
      tag: v${{package.version}}

  - runs: |
      # Generate proto code
      make gen-proto

subpackages:
  - name: ${{package.name}}-daprd
    description: Daprd side car
    dependencies:
      provides:
        - ${{package.name}}-daprd=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: daprd
          packages: ./cmd/daprd
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

  - name: ${{package.name}}-placement
    description: Dapr Placement control plane service
    dependencies:
      provides:
        - ${{package.name}}-placement=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: placement
          packages: ./cmd/placement
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

  - name: ${{package.name}}-operator
    description: Dapr Operator service manages Dapr component updates and provides Kubernetes services endpoints for Dapr
    dependencies:
      provides:
        - ${{package.name}}-operator=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: operator
          packages: ./cmd/operator
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

  - name: ${{package.name}}-injector
    description: cluster-api core controller
    dependencies:
      provides:
        - ${{package.name}}-injector=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: injector
          packages: ./cmd/injector
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

  - name: ${{package.name}}-scheduler
    description: Dapr Scheduler service is used to schedule different types of jobs, running in self-hosted mode or on Kubernetes.
    dependencies:
      provides:
        - ${{package.name}}-scheduler=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: scheduler
          packages: ./cmd/scheduler
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

  - name: ${{package.name}}-sentry
    description: Dapr Sentry service manages mTLS between services and acts as a certificate authority
    dependencies:
      provides:
        - ${{package.name}}-sentry=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          output: sentry
          packages: ./cmd/sentry
          ldflags: $LD_FLAGS
          tags: $GO_TAGS

update:
  enabled: true
  github:
    identifier: dapr/dapr
    strip-prefix: v
    tag-filter: v
    use-tag: true
