package:
  name: datadog-operator
  version: "1.20.0"
  epoch: 1
  description: Kubernetes Operator for Datadog Resources
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 55c5702a222666ed877ae35d61eabfe8669afa0c
      repository: https://github.com/DataDog/datadog-operator
      tag: v${{package.version}}

  - uses: go/build
    with:
      ldflags: |
        -X github.com/DataDog/datadog-operator/pkg/version.Commit=$(git rev-parse HEAD)
        -X github.com/DataDog/datadog-operator/pkg/version.Version=${{package.version}}
        -X github.com/DataDog/datadog-operator/pkg/version.BuildTime=$(date -u -d "@$SOURCE_DATE_EPOCH" +%Y-%m-%d-%H:%M)
      output: manager
      packages: ./cmd

  - uses: go/build
    with:
      ldflags: |
        -X github.com/DataDog/datadog-operator/pkg/version.Commit=$(git rev-parse HEAD)
        -X github.com/DataDog/datadog-operator/pkg/version.Version=${{package.version}}
        -X github.com/DataDog/datadog-operator/pkg/version.BuildTime=$(date -u -d "@$SOURCE_DATE_EPOCH" +%Y-%m-%d-%H:%M)
      output: helpers
      packages: ./cmd/helpers

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility symlink for ${{package.name}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"
          install -Dm755 scripts/readsecret.sh "${{targets.contextdir}}/secrets.sh"
          ln -s /usr/bin/manager "${{targets.contextdir}}/manager"
          ln -s /usr/bin/helpers "${{targets.contextdir}}/helpers"
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check
          with:
            allow-absolute: true
        - runs: |
            test -x /secrets.sh

update:
  enabled: true
  github:
    identifier: DataDog/datadog-operator
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - git
  pipeline:
    # AUTOGENERATED
    - runs: |
        manager --help
        manager -version
        # Check that the binary is built with the expected version
        manager -version | grep "${{package.version}}"
        helpers --help
    - uses: test/kwok/cluster
    - name: Apply CRDs
      runs: |
        kubectl apply --server-side=true -k github.com/DataDog/datadog-operator/config/crd?ref=v${{package.version}}
        kubectl wait --for=condition=Established crd --all --timeout=60s
    - uses: test/daemon-check-output
      with:
        start: manager -enable-leader-election=false
        timeout: 30
        # As of 1.17.0, datadog-operator requires Datadog Agent to be fully
        # running: this isn't practical in a package test context
        error_strings: please-dont-match-anything
        expected_output: |
          Starting Controller
          Starting workers
          starting server
