package:
  name: ding-libs
  version: 0.6.2
  epoch: 0
  description: "'DING is not GNU' helper libraries for SSSD and FreeIPA"
  url: https://github.com/SSSD/ding-libs
  copyright:
    - license: LGPL-3.0 AND GPL-3.0
  dependencies:
    runtime:
      # Pull all libs if this gets installed
      - ding-libs-ini_config
      - ding-libs-dhash
      - ding-libs-path_utils
      - ding-libs-ref_array

environment:
  contents:
    packages:
      - busybox
      - build-base
      - bash
      - gettext
      - check
      - make
      - diffutils
      - coreutils
      - gcc
      - glibc-dev
      - file

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/SSSD/ding-libs/releases/download/${{package.version}}/ding-libs-${{package.version}}.tar.gz
      expected-sha256: e5f07f34f5921bcb5ccccfe3751c28497879a6451cd7b395e99e24d9b5728e8d
  - uses: autoconf/configure
    with:
      opts: "--enable-shared=yes --enable-static=no"
  - name: "Build libraries"
    uses: autoconf/make
  - name: "Test libraries"
    uses: autoconf/make
    with:
      opts: "check"
  - name: "Build documentation"
    uses: autoconf/make
    with:
      opts: "docs"
  - uses: autoconf/make-install
  - uses: strip

subpackages:
  - name: ding-doc
    description: "Ding libs documentation"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/doc"
          mv  "${{targets.destdir}}/usr/share/doc/ding-libs" "${{targets.subpkgdir}}/usr/share/doc/"

  - name: ding-libs-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - ding-libs
    test:
      pipeline:
        - uses: test/pkgconf

  - name: ding-libs-ini_config
    pipeline:
      - runs: |
          # The way ding has been made, libini_config is the only lib
          # that depends on libcollection and libbasicobjects so that
          # looks like internal dependencies.

          mkdir -p "${{targets.subpkgdir}}/usr/lib"

          for libname in "ini_config" "collection" "basicobjects"
          do
            mv "${{targets.destdir}}"/usr/lib/lib${libname}.so* "${{targets.subpkgdir}}/usr/lib/"
          done

  - name: ding-libs-dhash
    pipeline:
      - runs: |
          libname=dhash
          mkdir -p "${{targets.subpkgdir}}/usr/lib"
          mv "${{targets.destdir}}"/usr/lib/lib${libname}.so* "${{targets.subpkgdir}}/usr/lib/"

  - name: ding-libs-path_utils
    pipeline:
      - runs: |
          libname=path_utils
          mkdir -p "${{targets.subpkgdir}}/usr/lib"
          mv "${{targets.destdir}}"/usr/lib/lib${libname}.so* "${{targets.subpkgdir}}/usr/lib/"

  - name: ding-libs-ref_array
    pipeline:
      - runs: |
          libname=ref_array
          mkdir -p "${{targets.subpkgdir}}/usr/lib"
          mv "${{targets.destdir}}"/usr/lib/lib${libname}.so* "${{targets.subpkgdir}}/usr/lib/"
        
update:
  enabled: true
  github: 
    identifier: SSSD/ding-libs
    
