package:
  name: dkron
  version: "4.0.9"
  epoch: 0 # GHSA-g754-hx8w-x2g6
  description: Distributed job scheduler for microservices
  copyright:
    - license: LGPL-3.0
  dependencies:
    runtime:
      - tzdata

environment:
  contents:
    packages:
      - buf
      - build-base
      - bun
      - ca-certificates-bundle
      - corepack
      - go
      - jq
      - nodejs-20
      - pnpm
      - protobuf-dev
      - protoc-gen-go
      - protoc-gen-go-grpc

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/distribworks/dkron
      tag: v${{package.version}}
      expected-commit: 83b440bd1bedfb6639b371f7d1d38660569cb90c

  - name: Generate protobuf files
    runs: |
      # Generate protobuf files using buf (as upstream does)
      # buf will use buf.gen.yaml to generate to gen/proto/types/v1/
      buf generate

  - name: Build UI components
    runs: |
      cd ui
      # Add query-string as explicit dependency (pnpm requires it, yarn was more permissive)
      jq '.dependencies["query-string"] = "^7.1.3"' package.json > package.json.tmp
      mv package.json.tmp package.json

      corepack enable
      # Upstream uses pnpm now
      pnpm install
      pnpm build --out-dir ../dkron/ui-dist
      cd ..

      echo "UI build output for debugging:"
      ls -la dkron/ui-dist/

  - name: Install builtin plugins
    runs: |
      GOBIN=$PWD go install ./builtin/...
      go mod tidy

  - uses: go/build
    with:
      packages: .
      output: dkron
      ldflags: |
        -X github.com/distribworks/dkron/v4/dkron.Version=${{package.version}}
        -X github.com/distribworks/dkron/v4/dkron.Codename=Apat
        -X github.com/distribworks/dkron/v4/dkron.BuildDate=$(date -u "+%Y-%m-%dT%H:%M:%SZ" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})
      tags: builtinassets

data:
  - name: plugins
    items:
      # Executors
      executor-gcppubsub: "Dkron Google Cloud Pub/Sub executor plugin"
      executor-grpc: "Dkron gRPC executor plugin"
      executor-kafka: "Dkron Kafka executor plugin"
      executor-nats: "Dkron NATS executor plugin"
      executor-rabbitmq: "Dkron RabbitMQ executor plugin"
      # Processors
      processor-files: "Dkron files processor plugin"
      processor-fluent: "Dkron Fluent processor plugin"
      processor-log: "Dkron log processor plugin"
      processor-syslog: "Dkron syslog processor plugin"

subpackages:
  - name: ${{package.name}}-compat
    description: "Compatibility package for container environments"
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/local/bin
          ln -sf /usr/bin/dkron ${{targets.contextdir}}/usr/local/bin/dkron
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - runs: test "$(readlink /usr/local/bin/dkron)" = "/usr/bin/dkron"

  - range: plugins
    name: ${{package.name}}-${{range.key}}
    description: ${{range.value}}
    pipeline:
      - uses: go/build
        with:
          packages: ./builtin/bins/dkron-${{range.key}}
          output: dkron-${{range.key}}
    test:
      pipeline:
        - name: "basic binary path verification"
          runs: stat /usr/bin/${{subpkg.name}}

  - range: plugins
    name: ${{package.name}}-${{range.key}}-compat
    description: "Compatibility symlink for ${{range.key}} plugin in /usr/local/bin"
    dependencies:
      runtime:
        - ${{package.name}}-${{range.key}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/local/bin
          ln -sf /usr/bin/dkron-${{range.key}} ${{targets.contextdir}}/usr/local/bin/dkron-${{range.key}}
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-${{range.key}}
      pipeline:
        - runs: test "$(readlink /usr/local/bin/dkron-${{range.key}})" = "/usr/bin/dkron-${{range.key}}"

update:
  enabled: true
  github:
    identifier: distribworks/dkron
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - ca-certificates-bundle
        - coreutils
        - curl
        - netcat-openbsd
        - nodejs
        - procps
        - wait-for-it
  pipeline:
    - name: Verify dkron version
      runs: |
        dkron version | grep -q "${{package.version}}"
    - name: Verify dkron help and commands
      runs: dkron agent --help | grep -q "Start a dkron agent"
    - name: Test dkron agent startup and API
      runs: |
        mkdir -p /tmp/dkron-test/data
        cat > /tmp/dkron-test/dkron.json <<EOF
        {
          "bind-addr": "127.0.0.1:8946",
          "advertise-addr": "127.0.0.1:8946",
          "http-addr": "127.0.0.1:8080",
          "node-name": "test-node",
          "server": true,
          "bootstrap-expect": 1,
          "data-dir": "/tmp/dkron-test/data"
        }
        EOF

        # Start agent in background
        dkron agent --config /tmp/dkron-test/dkron.json > /tmp/dkron-agent.log 2>&1 &
        AGENT_PID=$!
        echo "Started dkron agent with PID $AGENT_PID"

        # Give it a moment and check if it's still running
        sleep 3
        if ! kill -0 $AGENT_PID 2>/dev/null; then
          echo "ERROR: Agent process died immediately. Logs:"
          cat /tmp/dkron-agent.log
          exit 1
        fi

        # Show initial logs
        echo "Agent appears to be running, first few log lines:"
        head -20 /tmp/dkron-agent.log || true

        # Wait for HTTP server
        if ! wait-for-it 127.0.0.1:8080 -t 30; then
          echo "ERROR: HTTP server did not start. Full logs:"
          cat /tmp/dkron-agent.log
          exit 1
        fi

        # Test API endpoint
        echo "Testing API endpoint..."
        curl -sf http://127.0.0.1:8080/v1/ | grep -q '"server":"true"'

        # Test UI is served
        echo "Testing UI..."
        curl -Ls http://127.0.0.1:8080/ui/ | grep -i "<title>Dkron</title>"

        echo "All tests passed!"
