package:
  name: dnsdist-1.9
  version: "1.9.10"
  epoch: 0
  description: PowerDNS dnsdist â€” highly DNS-, DoS- and abuse-aware load-balancer
  copyright:
    - license: GPL-2.0-only
  dependencies:
    provides:
      - dnsdist=${{package.full-version}}
  scriptlets:
    pre-install: |
      #!/bin/sh
      addgroup -S dnsdist 2>/dev/null
      adduser  -S -D -H -h /var/empty -s /bin/false -G dnsdist -g dnsdist dnsdist 2>/dev/null
      exit 0

vars:
  lua-version: 5.4 # keep in sync with remaining Wolfi stack

environment:
  contents:
    packages:
      - boost-dev
      - build-base
      - busybox
      - cargo-auditable
      - cmake
      - fstrm-dev
      - libbpf-dev # eBPF/XDP support
      - libcap-dev
      - libedit-dev
      - libsodium-dev
      - libtool
      # - libxdp-dev
      - lmdb-dev
      - lua${{vars.lua-version}}-dev
      - luajit-dev
      - mtdev-dev
      - net-snmp-dev
      - nghttp2-dev
      - openssl-dev
      - pkgconf-dev
      - protobuf-dev
      - py3-yaml
      - python-3.12
      - ragel-dev
      - re2-dev
      - systemd
      - systemd-dev
      - systemd-dev
      # - wslay-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/PowerDNS/pdns
      tag: dnsdist-${{package.version}}
      expected-commit: a1ab4e4d0764d2f36eec35f169f81e30281a9b09

  - working-directory: ./pdns/dnsdistdist
    pipeline:
      - uses: autoconf/configure
        with:
          opts: |
            --sysconfdir=/etc/dnsdist \
            --sbindir=/usr/bin \
            --enable-dnscrypt \
            --enable-dns-over-tls \
            --enable-dns-over-https \
            # --enable-dns-over-quic \
            --enable-unit-tests \
            --with-re2 \
            --with-libsodium \
            --with-net-snmp \
            --with-lua=lua${{vars.lua-version}} \
            --enable-yaml
      - uses: autoconf/make
      - uses: autoconf/make-install
      - runs: make check

  - uses: strip

subpackages:
  - name: ${{package.name}}-recursor-compat
    description: Compatibility package for dnsdist
    dependencies:
      provides:
        - dnsdist-compat=${{package.full-version}}
      runtime:
        - python-${{vars.py-version}}
        - py${{vars.py-version}}-jinja2
        - tini
        - libcap-utils
        - coreutils # For env -S support
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - working-directory: ./dockerdata
        pipeline:
          - runs: |
              # https://github.com/PowerDNS/pdns/blob/master/Dockerfile-dnsdist
              mkdir -p ${{targets.contextdir}}/etc/dnsdist
              mkdir -p ${{targets.contextdir}}/usr/local/sbin/
              mkdir -p ${{targets.contextdir}}/etc/dnsdist/conf.d
              mkdir -p ${{targets.contextdir}}/etc/dnsdist/templates.d
              install -Dm755 startup.py ${{targets.contextdir}}/usr/local/bin/dnsdist-startup
              install -Dm755 dnsdist.conf ${{targets.contextdir}}/etc/dnsdist/dnsdist.conf
              install -Dm644 dnsdist-resolver.lua ${{targets.contextdir}}/etc/dnsdist/dnsdist-resolver.lua
              ln -sf /usr/bin/dnsdist ${{targets.contextdir}}/usr/local/sbin/dnsdist
    test:
      pipeline:
        - runs: |
            test "$(readlink /usr/local/sbin/dnsdist)" = "/usr/bin/dnsdist"

  - name: ${{package.name}}-doc
    description: dnsdist manual pages & docs
    pipeline:
      - uses: split/manpages
    dependencies:
      provides:
        - dnsdist-doc=${{package.full-version}}
    test:
      pipeline:
        - uses: test/docs

test:
  environment:
    contents:
      packages:
        - wait-for-it
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        dnsdist --version
        dnsdist --help
    - name: "daemon smoke-test"
      uses: test/daemon-check-output
      with:
        start: "/usr/bin/dnsdist --disable-syslog --local=127.0.0.1:5053 --console-address=127.0.0.1 --console-port=5199 --disable-syslog --uid=0"
        timeout: 20
        expected_output: |
          Listening on 127.0.0.1:5053
          DNS over TLS disabled
          DNS over HTTPS enabled
        post: |
          wait-for-it -t 5 --strict 127.0.0.1:5053 -- echo "dnsdist is up"

update:
  enabled: true
  ignore-regex-patterns:
    - -alpha
    - -beta
    - -rc
  github:
    identifier: PowerDNS/pdns
    strip-prefix: dnsdist-
    tag-filter: dnsdist-1.9.
    use-tag: true
