package:
  name: dnsdist-2.0
  version: "2.0.0"
  epoch: 0
  description: PowerDNS dnsdist â€” highly DNS-, DoS- and abuse-aware load-balancer
  copyright:
    - license: GPL-2.0-only
  dependencies:
    provides:
      - dnsdist=${{package.full-version}}
  scriptlets:
    pre-install: |
      #!/bin/sh
      addgroup -S dnsdist 2>/dev/null
      adduser  -S -D -H -h /var/empty -s /bin/false -G dnsdist -g dnsdist dnsdist 2>/dev/null
      exit 0

vars:
  py-version: 3.12 # Pinning 3.12 due to imghdr. See: https://peps.python.org/pep-0594/#imghdr
  lua-version: 5.4 # Pinning latest lua version to pass cmake

environment:
  contents:
    packages:
      - boost-dev
      - build-base
      - busybox
      - cargo-auditable
      - cmake
      - fstrm-dev
      - gnutls-dev
      - libbpf-dev # eBPF/XDP support
      - libcap-dev
      - libedit-dev
      - libquiche
      - libsodium-dev
      - libtool
      - lmdb-dev
      - lua${{vars.lua-version}}-dev
      - luajit-dev
      - mtdev-dev
      - net-snmp-dev
      - nghttp2-dev
      - openssl-dev
      - pkgconf-dev
      - protobuf-dev
      - py${{vars.py-version}}-build-base-dev
      - py${{vars.py-version}}-pyyaml
      - quiche
      - ragel-dev
      - re2-dev
      - rust
      - systemd
      - systemd-dev
      - wslay-dev
      - xdp-tools-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/PowerDNS/pdns
      tag: dnsdist-${{package.version}}
      expected-commit: 89747e81bc60d7950276d5fda3ca669fa81b7cf9

  - working-directory: ./pdns/dnsdistdist
    pipeline:
      - uses: autoconf/configure
        with:
          opts: |
            --sysconfdir=/etc/dnsdist \
            --sbindir=/usr/bin \
            --enable-dnscrypt \
            --enable-dns-over-tls \
            --enable-dns-over-https \
            --enable-dns-over-quic \
            --enable-dns-over-http3 \
            --enable-unit-tests \
            --enable-yaml \
            --enable-systemd \
            --enable-dnstap \
            --with-libsodium \
            --with-net-snmp \
            --with-lua=lua${{vars.lua-version}} \
            --with-gnutls \
            --with-h2o \
            --with-libcap \
            --with-nghttp2 \
            --with-re2
      - uses: autoconf/make
      - uses: autoconf/make-install
      - runs: make check

  - uses: strip

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package for dnsdist
    dependencies:
      provides:
        - dnsdist-compat=${{package.full-version}}
      runtime:
        - python-${{vars.py-version}}
        - py${{vars.py-version}}-jinja2
        - tini
        - libcap-utils
        - coreutils # For env -S support
        - lua${{vars.lua-version}}
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - working-directory: ./dockerdata
        pipeline:
          - runs: |
              # https://github.com/PowerDNS/pdns/blob/master/Dockerfile-dnsdist
              mkdir -p ${{targets.contextdir}}/etc/dnsdist
              mkdir -p ${{targets.contextdir}}/usr/local/bin/
              mkdir -p ${{targets.contextdir}}/etc/dnsdist/conf.d
              mkdir -p ${{targets.contextdir}}/etc/dnsdist/templates.d
              install -Dm755 startup.py ${{targets.contextdir}}/usr/local/bin/dnsdist-startup
              install -Dm755 dnsdist.conf ${{targets.contextdir}}/etc/dnsdist/dnsdist.conf
              install -Dm644 dnsdist-resolver.lua ${{targets.contextdir}}/etc/dnsdist/dnsdist-resolver.lua
              ln -sf /usr/bin/dnsdist ${{targets.contextdir}}/usr/local/bin/dnsdist
    test:
      pipeline:
        - runs: |
            test "$(readlink /usr/local/bin/dnsdist)" = "/usr/bin/dnsdist"

  - name: ${{package.name}}-doc
    description: dnsdist manual pages & docs
    pipeline:
      - uses: split/manpages
    dependencies:
      provides:
        - dnsdist-doc=${{package.full-version}}
    test:
      pipeline:
        - uses: test/docs

test:
  environment:
    contents:
      packages:
        - wait-for-it
        - ${{package.name}}-compat
        - bind-tools
    accounts:
      groups:
        - groupname: pdns
          gid: 953
      users:
        - username: pdns
          gid: 953
          uid: 953
      run-as: 0 # To bind :53 on the CI
    environment:
      TINI_SUBREAPER: 1
      DEBUG_CONFIG: yes
      PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        dnsdist --version
        dnsdist --help
    - name: "daemon smoke-test for entrypoint"
      uses: test/daemon-check-output
      with:
        start: "/usr/bin/tini -- /usr/local/bin/dnsdist-startup"
        timeout: 30
        expected_output: |
          Listening on
        post: |
          wait-for-it -t 5 --strict 127.0.0.1:53 -- echo "dnsdist is up"
    - name: "daemon smoke-test for standalone"
      uses: test/daemon-check-output
      with:
        setup: |
          cat > test.toml <<EOF
          setLocal("127.0.0.1:5300")
          newServer("1.1.1.1")
          EOF
        start: "dnsdist --config test.toml --supervised"
        timeout: 30
        expected_output: |
          Listening on
          Marking downstream 1.1.1.1:53
        post: |
          wait-for-it -t 5 --strict 127.0.0.1:5300 -- echo "dnsdist is up"
          dig @127.0.0.1 -p 5300 example.com A | grep -q "ANSWER"

update:
  enabled: true
  ignore-regex-patterns:
    - -alpha
    - -beta
    - -rc
  github:
    identifier: PowerDNS/pdns
    strip-prefix: dnsdist-
    tag-filter: dnsdist-2.0.
    use-tag: true
