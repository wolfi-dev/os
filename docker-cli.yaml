package:
  name: docker-cli
  version: "28.1.0"
  epoch: 0
  description: The Docker CLI
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - bash
      - btrfs-progs-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - containerd
      - coreutils
      - go
      - libseccomp-dev
      - libtool
      - linux-headers
      - lvm2-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/docker/cli
      tag: v${{package.version}}
      expected-commit: 4d8c241ff09be37e7cfd120424a8a2f9fe3dff0d

  - runs: |
      export DISABLE_WARN_OUTSIDE_CONTAINER=1

      mkdir -p "$GOPATH/src/github.com/docker/"
      ln -sf /home/build "$GOPATH"/src/github.com/docker/cli
      LDFLAGS="" make VERSION=${{package.version}} dynbinary

      install -Dm755 build/docker-linux-* ${{targets.destdir}}/usr/bin/docker

  - runs: |
      make manpages
      install -Dm644 man/man1/* -t ${{targets.destdir}}/usr/share/man/man1/

  # Docker is vehemenetly against stripping the resulting binary
  # Ref: https://github.com/moby/moby/blob/d8a51d2887cbc465ab8d76ed98f7a86996ab3c22/project/PACKAGERS.md#stripping-binaries
  # - uses: strip
  - runs: |
      # this exists to appease yam

subpackages:
  - name: "docker-cli-doc"
    description: "docker-cli documentation"
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  ignore-regex-patterns:
    - (.*)(beta|rc)(.*) # Ignore beta, and rc releases
  github:
    identifier: docker/cli
    strip-prefix: v
    tag-filter: v
    use-tag: true

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        docker --version
        docker --help
