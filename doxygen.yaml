package:
  name: doxygen
  version: "1.13.2"
  epoch: 2
  description: A documentation system for C++, C, Java, IDL and PHP
  copyright:
    - license: GPL-2.0-or-later
  dependencies:
    runtime:
      - bzip2
      - graphviz
      - zlib

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - coreutils
      - flex
      - graphviz
      - perl
      - python3
      - samurai

pipeline:
  - uses: fetch
    with:
      expected-sha256: 3a25e3386c26ea5494c784e946327225debfbc5dbfa8b13549010a315aace66d
      uri: https://doxygen.nl/files/doxygen-${{package.version}}.src.tar.gz

  - runs: |
      cmake -B build -G Ninja \
          -DGIT_EXECUTABLE=/bin/false \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_BUILD_TYPE=MinSizeRel \
          -Dbuild_xmlparser=ON \
          -Wno-dev \
          -DCMAKE_BUILD_TYPE=Release
      cmake --build build
      DESTDIR="${{targets.destdir}}" cmake --install build

  - uses: strip

update:
  enabled: true
  release-monitor:
    identifier: 457
  version-separator: "_"

subpackages:
  - name: doxygen-doc
    description: doxygen documentation
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

test:
  pipeline:
    - name: Smoke check for doxygen CLI
      # AUTOGENERATED
      runs: |
        doxygen --version
        doxygen --help
    - name: Generate default configuration file
      runs: |
        doxygen -g Doxyfile
        test -f Doxyfile
        grep -q "PROJECT_NAME" Doxyfile
    - name: Run doxygen on simple C++ source
      runs: |
        mkdir -p testsrc
        cat > testsrc/test.cpp <<EOF
        /**
         * \\brief Adds two integers
         *
         * \\param a First integer
         * \\param b Second integer
         * \\return Sum of a and b
         */
        int add(int a, int b) {
            return a + b;
        }
        EOF
        doxygen -g Doxyfile
        sed -i 's|^INPUT *=.*|INPUT = testsrc|' Doxyfile
        sed -i 's|^RECURSIVE *=.*|RECURSIVE = YES|' Doxyfile
        doxygen Doxyfile
        test -f html/index.html
    - name: Test dot integration with Graphviz
      runs: |
        doxygen -g Doxyfile
        sed -i 's|^HAVE_DOT *=.*|HAVE_DOT = YES|' Doxyfile
        sed -i 's|^CALL_GRAPH *=.*|CALL_GRAPH = YES|' Doxyfile
        sed -i 's|^CALLER_GRAPH *=.*|CALLER_GRAPH = YES|' Doxyfile
        mkdir -p graphsrc
        cat > graphsrc/main.c <<EOF
        void bar() {}
        void foo() { bar(); }
        int main() { foo(); return 0; }
        EOF
        sed -i 's|^INPUT *=.*|INPUT = graphsrc|' Doxyfile
        doxygen Doxyfile
        find . -name "*.png" | grep -q .
    - name: Run doxygen on bzip2-compressed input
      runs: |
        mkdir -p bzipsrc
        cat > bzipsrc/example.cpp <<EOF
        /**
         * \\brief Example function
         */
        void example() {}
        EOF
        bzip2 bzipsrc/example.cpp
        doxygen -g Doxyfile
        sed -i 's|^INPUT *=.*|INPUT = bzipsrc|' Doxyfile
        sed -i 's|^RECURSIVE *=.*|RECURSIVE = YES|' Doxyfile
        doxygen Doxyfile
        test -f html/index.html
    - name: Include zlib-compressed asset in output
      runs: |
        mkdir -p zlibtest
        echo "dummy image" > zlibtest/diagram.png
        gzip -c zlibtest/diagram.png > zlibtest/diagram.png.gz
        doxygen -g Doxyfile
        sed -i 's|^INPUT *=.*|INPUT = zlibtest|' Doxyfile
        sed -i 's|^RECURSIVE *=.*|RECURSIVE = YES|' Doxyfile
        doxygen Doxyfile
        test -f html/index.html
    - name: Generate HTML then gzip it to test zlib
      runs: |
        mkdir -p htmltest
        cat > htmltest/index.h <<EOF
        /**
         * \\mainpage
         * This is a test page.
         */
        EOF
        doxygen -g Doxyfile
        sed -i 's|^INPUT *=.*|INPUT = htmltest|' Doxyfile
        sed -i 's|^RECURSIVE *=.*|RECURSIVE = YES|' Doxyfile
        doxygen Doxyfile
        test -f html/index.html
        gzip html/index.html
        test -f html/index.html.gz
