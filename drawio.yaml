package:
  name: drawio
  version: 24.7.17
  epoch: 0
  description: "Draw.io Desktop Headless"
  target-architecture:
    - x86_64  # due to so:ld-linux-x86-64.so.2 for arm64 not being available
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ffmpeg
      - ffmpeg-dev
      - libnss
      - mesa-libgallium
      - Xvfb
      - xvfb-run
      - xkeyboard-config
      - xkbcomp

environment:
  contents:
    packages:
      - build-base
      - busybox
      - nodejs
      - npm
      - glib
      - glibc
      - ld-linux
      - ffmpeg
      - ffmpeg-dev
      - mesa-libgallium

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/jgraph/drawio-desktop
      tag: v${{package.version}}
      expected-commit: d1bb63c97f4b5e33a3adc200687a0c2a7265e290

  - runs: |
      npm install
      node_modules/.bin/electron-builder build --dir -l --x64
      
      mkdir -p \
        "${{targets.destdir}}"/usr/local/bin \
        "${{targets.destdir}}"/usr/local/lib
      
      cp -a ./dist/linux-unpacked/. "${{targets.destdir}}"/usr/local/bin/
      cp -a ./dist/linux-unpacked/*.so "${{targets.destdir}}"/usr/local/lib/
      
      chmod -R 4755 "${{targets.destdir}}"/usr/local/bin/chrome-sandbox
      
      mv "${{targets.destdir}}"/usr/local/bin/draw.io "${{targets.destdir}}"/usr/local/bin/drawio

update:
  enabled: true
  github:
    identifier: jgraph/drawio-desktop
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - build-base
        - busybox
  pipeline:
    - runs: |
        version=$(/bin/local/usr/drawio --version)
        echo "$version" | grep "${{package.version}}"