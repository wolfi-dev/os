package:
  name: erlang-26
  version: "26.2.5.16"
  epoch: 0
  description: General-purpose programming language and runtime environment
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      # mnesia depends on the ca-certificates bundle
      - ca-certificates-bundle
    provides:
      - erlang=${{package.full-version}}
      # Backwards compatible provides based on observed usage of this package.
      - ${{package.name}}-xmerl=${{package.full-version}}
      - ${{package.name}}-tools=${{package.full-version}}
      - ${{package.name}}-tftp=${{package.full-version}}
      - ${{package.name}}-syntax_tools=${{package.full-version}}
      - ${{package.name}}-ssl=${{package.full-version}}
      - ${{package.name}}-snmp=${{package.full-version}}
      - ${{package.name}}-runtime_tools=${{package.full-version}}
      - ${{package.name}}-public_key=${{package.full-version}}
      - ${{package.name}}-parsetools=${{package.full-version}}
      - ${{package.name}}-os_mon=${{package.full-version}}
      - ${{package.name}}-mnesia=${{package.full-version}}
      - ${{package.name}}-inets=${{package.full-version}}
      - ${{package.name}}-ftp=${{package.full-version}}
      - ${{package.name}}-eldap=${{package.full-version}}
      - ${{package.name}}-crypto=${{package.full-version}}
      - ${{package.name}}-asn1=${{package.full-version}}

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - ncurses-dev
      - openssl-dev
      - perl-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/erlang/otp.git
      tag: OTP-${{package.version}}
      expected-commit: ce72bbc20a4236d69ac716624ccb799921ac5903

  - runs: |
      export CPPFLAGS="-D_BSD_SOURCE $CPPFLAGS"

      ./otp_build autoconf
      ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --host="$CHOST" \
        --build="$CBUILD" \
        --enable-threads \
        --enable-shared-zlib \
        --enable-ssl=dynamic-ssl-lib \
        --enable-jit

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      # Remove examples and test certificates to avoid false positives in security scans
      find "${{targets.contextdir}}"/usr/lib/erlang -path "*/examples/*" -name "*.pem" -type f -exec rm -rf {} +

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: "headers for erlang"
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - ${{package.name}}
      provides:
        - erlang-dev=${{package.full-version}}
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: erlang-dev
            real-pkg-name: ${{subpkg.name}}

update:
  enabled: true
  github:
    identifier: erlang/otp
    strip-prefix: OTP-
    use-tag: true
    tag-filter: OTP-26

test:
  pipeline:
    - runs: |
        dialyzer --version
        dialyzer --help
        typer --version
        typer --help
        erlc -help 2>&1 | grep Usage:
    - runs: |
        erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().'  -noshell
        ct_run -noshell
        erl < /dev/null
    - runs: |
        cat <<EOF > "hello.erl"
        -module(hello).
        -export([hello_wolfi/0]).

        hello_wolfi() -> io:fwrite("hello, wolfi\n").
        EOF

        erlc hello.erl

        erl -noshell -pa . -eval "hello:hello_wolfi()." -s init stop
    - uses: test/tw/ldd-check
