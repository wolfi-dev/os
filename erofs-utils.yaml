# Generated from https://git.alpinelinux.org/aports/plain/community/erofs-utils/APKBUILD
package:
  name: erofs-utils
  version: "1.8.10"
  epoch: 5 # go/wolfi-rsc/erofs-utils
  description: userspace utilities for erofs filesystem
  copyright:
    - license: Apache-2.0 AND GPL-2.0-or-later
  resources:
    cpu: "1"
    memory: 5Gi

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - fuse3-dev
      - libtool
      - lz4-dev
      - pkgconf-dev
      - util-linux-dev
      - zlib-dev
      - zstd-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://kernel.googlesource.com/pub/scm/linux/kernel/git/xiang/erofs-utils.git
      tag: v${{package.version}}
      expected-commit: 51b5939b5f783221310d25146e6a2019ba8129b6

  - uses: autoconf/configure
    with:
      opts: |
        --enable-fuse \
        --enable-multithreading \
        --with-libzstd \
        --prefix=/usr

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: erofs-utils-docs
    pipeline:
      - uses: split/manpages
    description: erofs-utils manpages
    test:
      pipeline:
        - uses: test/docs

  - name: erofs-utils-fuse
    description: "FUSE driver for erofs filesystem"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/bin"
          mv "${{targets.destdir}}/usr/bin/erofsfuse" "${{targets.subpkgdir}}/usr/bin/erofsfuse"

test:
  pipeline:
    - runs: |
        mkfs.erofs --help 2>&1 | grep "Generate EROFS image"
        mkfs.erofs --version 2>&1 | grep "${{package.version}}"
        dump.erofs --help
        dump.erofs --version
        fsck.erofs --help
        fsck.erofs --version
    - uses: test/no-docs

update:
  enabled: true
  release-monitor:
    identifier: 63188
