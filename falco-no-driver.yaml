package:
  name: falco-no-driver
  version: "0.41.1"
  epoch: 1
  description: Cloud Native Runtime Security
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - falco-rules
  resources:
    # https://go/wolfi-rsc/falco-no-driver
    cpu: 20
    memory: 20Gi

vars:
  llvm-vers: 19

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - autoconf
      - bash
      - bpftool
      - build-base
      - busybox
      - c-ares-dev
      - clang-${{vars.llvm-vers}}
      - cmake
      - cpp-httplib
      - curl-dev
      - cxxopts-dev
      - elfutils-dev
      - gcc
      - git
      - grpc-1.66-dev
      - isl-dev
      - libbpf
      - libbpf-dev
      - libelf-static
      - libtool
      - mpc-dev
      - nlohmann-json
      - openssl-dev
      - pkgconf
      - protobuf-dev
      - systemd-dev
      - yaml-cpp-dev
      - zlib-dev
  environment:
    # See https://github.com/wolfi-dev/os/issues/34075
    GCC_SPEC_FILE: "/dev/null"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/falcosecurity/falco
      tag: ${{package.version}}
      expected-commit: 9652de9f5d1a1675087de4c583ba7f50dcfdf6f5
      recurse-submodules: true

  - runs: |
      mkdir skeleton-build && cd skeleton-build
      cmake -DUSE_BUNDLED_DEPS=ON -DBUILD_FALCO_MODERN_BPF=ON -DCREATE_TEST_TARGETS=Off -DFALCO_VERSION=${{package.version}} ..
      make ProbeSkeleton -j$(nproc)

      mkdir -p /tmp
      cp ./skel_dir/bpf_probe.skel.h /tmp

  - runs: |
      mkdir build && cd build
      cmake \
        -DCMAKE_BUILD_TYPE=Release \
        -DUSE_BUNDLED_DEPS=Off \
        -DFALCO_ETC_DIR=/etc/falco \
        -DBUILD_FALCO_MODERN_BPF=ON \
        -DMODERN_BPF_SKEL_DIR=/tmp \
        -DBUILD_DRIVER=Off \
        -DBUILD_BPF=Off \
        -DFALCO_VERSION=${{package.version}} \
        ..
      make falco -j$(nproc)

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mv ./build/userspace/falco/falco ${{targets.destdir}}/usr/bin/falco

      mkdir -p "${{targets.destdir}}"/etc/falco
      install -Dm755 ./falco.yaml "${{targets.destdir}}"/etc/falco/falco.yaml

  - uses: strip

update:
  enabled: true
  github:
    identifier: falcosecurity/falco

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        falco --version
        falco --help
