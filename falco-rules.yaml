package:
  name: falco-rules
  version: "5.0.0"
  epoch: 1 # go/wolfi-rsc/falco-rules
  description: Falco rule repository
  copyright:
    - license: Apache-2.0
  resources:
    cpu: "2"
    memory: 1Gi

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/falcosecurity/rules
      tag: falco-rules-${{package.version}}
      expected-commit: d919107be667675a816ec4fb6b8fea6f39445e46

  - runs: |
      install -Dm755 ./rules/falco_rules.yaml "${{targets.destdir}}"/etc/falco/falco_rules.yaml

update:
  enabled: true
  ignore-regex-patterns:
    - falco-sandbox-rules-*
    - falco-incubating-rules-*
    - falco-deprecated-rules-*
    - application-rules-*
  github:
    identifier: falcosecurity/rules
    strip-prefix: falco-rules-

test:
  environment:
    contents:
      packages:
        - yq
  pipeline:
    - runs: |
        # Check that yq can read an array from the installed file
        [ "$(yq '.[0]' /etc/falco/falco_rules.yaml)" != "null" ]
