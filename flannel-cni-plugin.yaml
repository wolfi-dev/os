package:
  name: flannel-cni-plugin
  version: "1.9.0.1"
  epoch: 0 # CVE-2025-47907
  description: flannel cni plugin
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      # busybox is required for the cni daemonset to run
      - busybox

var-transforms:
  - from: ${{package.version}}
    match: \.(\d+)$
    replace: -flannel$1
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/flannel-io/cni-plugin
      tag: v${{vars.mangled-package-version}}
      expected-commit: 0940aaf4a0edda6c9bcd9bc34b3466a0d579ddda

  - uses: go/build
    with:
      output: flannel
      packages: .
      ldflags: -X main.Version=v${{vars.mangled-package-version}} -X main.Commit=$(git rev-parse --short=8 HEAD) -X main.Program=flannel -X main.buildDate=$(date -u -d "@${SOURCE_DATE_EPOCH:-$(date +%s)}" "+%Y-%m-%dT%H:%M:%SZ")

subpackages:
  - name: ${{package.name}}-compat
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/opt/cni/bin
          ln -sf usr/bin/flannel "${{targets.contextdir}}"/flannel
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check

update:
  enabled: true
  github:
    identifier: flannel-io/cni-plugin
    strip-prefix: v
  version-transform:
    - match: -flannel(\d+)$
      replace: .$1

test:
  pipeline:
    - uses: test/tw/help-check
      with:
        bins: flannel
    - name: "Test flannel CNI VERSION command"
      runs: |
        set -o pipefail
        TEST_DIR=$(mktemp -d)  # Use temp directory for test isolation
        trap 'rm -rf "${TEST_DIR}"' EXIT

        cat > "${TEST_DIR}/flannel-config.json" << 'EOF'
        {
          "cniVersion": "0.3.1",
          "name": "test-flannel",
          "type": "flannel"
        }
        EOF
        CNI_COMMAND=VERSION flannel < "${TEST_DIR}/flannel-config.json" | grep -F "cniVersion"
