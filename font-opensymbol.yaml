package:
  name: font-opensymbol
  version: 102.12
  epoch: 2
  description: LibreOffice-compatible OpenSymbol font for technical and symbolic glyphs
  copyright:
    - license: MPL-2.0

environment:
  contents:
    packages:
      - busybox
      - fontforge

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.libreoffice.org/core
      tag: libreoffice-7.4.7.1
      expected-commit: 9204137cd80881d05c679c2486e99f8e6c810710
      sparse-paths: |
        extras/source/truetype/symbol

  # https://git.libreoffice.org/core/+/refs/heads/master/extras/CustomTarget_opensymbol.mk
  - name: Generate TTF font
    runs: |
      fontforge -lang=ff -c 'Open($1); Generate($2)' \
        extras/source/truetype/symbol/OpenSymbol.sfd opens___.ttf

  # https://git.libreoffice.org/core/+/refs/heads/master/postprocess/CustomTarget_fontconfig.mk
  - name: Generate fontconfig configuration
    runs: |
      (
        printf '<?xml version="1.0"?>\n<!DOCTYPE fontconfig SYSTEM "/etc/fonts/conf.d/fonts.dtd">\n<fontconfig>\n'
        cat extras/source/truetype/symbol/fc_local.snippet
        printf '</fontconfig>\n'
      ) >30-opensymbol.conf

  - runs: |
      mkdir -p "${{targets.contextdir}}/usr/share/fontconfig/conf.avail"
      mv 30-opensymbol.conf "${{targets.contextdir}}/usr/share/fontconfig/conf.avail/"

      mkdir -p "${{targets.contextdir}}/etc/fonts/conf.d"
      ln -s /usr/share/fontconfig/conf.avail/30-opensymbol.conf "${{targets.contextdir}}/etc/fonts/conf.d/30-opensymbol.conf"

      mkdir -p "${{targets.contextdir}}/usr/share/fonts/truetype/libreoffice"
      mv opens___.ttf "${{targets.contextdir}}/usr/share/fonts/truetype/libreoffice/"

update:
  enabled: false
  manual: true
  exclude-reason: "See Version: field in extras/source/truetype/symbol/OpenSymbol.sfd; only updated by some LibreOffice releases"

test:
  pipeline:
    - uses: test/fonts
