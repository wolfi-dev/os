package:
  name: fontforge
  version: "20230101"
  epoch: 1
  description: Free (libre) font editor
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - gnu-libiconv-dev
      - libspiro
      - py3-setuptools
      - woff2-dev

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - freetype-dev
      - giflib-dev
      - gnu-libiconv-dev
      - gtk-3-dev
      - libspiro-dev
      - libxml2-dev
      - pango-dev
      - potrace
      - py3-setuptools
      - python3-dev
      - readline-dev
      - samurai
      - tiff-dev
      - woff2-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/fontforge/fontforge
      expected-commit: a1dad3e81da03d5d5f3c4c1c1b9b5ca5ebcfcecf
      tag: ${{package.version}}

  - uses: patch
    with:
      patches: gettext-0.22.patch

  - runs: |
      mkdir -p build
      export CFLAGS="$CFLAGS -flto=auto -I/usr/include/gnu-libiconv"
      export CXXFLAGS="$CXXFLAGS -flto=auto -I/usr/include/gnu-libiconv"
      cd build
      cmake \
      	-DCMAKE_BUILD_TYPE=Release \
      	-DCMAKE_INSTALL_PREFIX=/usr \
      	-DENABLE_MAINTAINER_TOOLS=TRUE \
      	-DENABLE_FONTFORGE_EXTRAS=TRUE \
        -DENABLE_GUI=OFF \
        -DENABLE_LIBSPIRO=ON \
        -DENABLE_LIBREADLINE=ON \
        -DENABLE_WOFF2=ON \
        -DENABLE_DOCS=OFF \
      	-DUNIX=TRUE \
      	..
      make

      make DESTDIR="${{targets.destdir}}" install

  - uses: strip

subpackages:
  - name: fontforge-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - fontforge
    description: fontforge dev

  - name: fontforge-doc
    pipeline:
      - uses: split/manpages
    description: fontforge manpages
    test:
      pipeline:
        - uses: test/docs

  - name: py3-fontforge
    pipeline:
      - runs: |
          PYVER=$(python --version | awk '{print $2}' | awk -F. '{print $1"."$2}')
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages
          mkdir -p "${{targets.subpkgdir}}"/usr/share/fontforge/python
          # use find and exec to move them to the right place
          find ${{targets.destdir}}/usr/lib/python${PYVER}/site-packages -name "fontforge.so" -exec mv {} "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages \;
          find ${{targets.destdir}}/usr/lib/python${PYVER}/site-packages -name "psMat.so" -exec mv {} "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages \;
          mv ${{targets.destdir}}/usr/share/fontforge/python "${{targets.subpkgdir}}"/usr/share/fontforge/python
    description: Python 3 bindings for fontforge

update:
  enabled: true
  github:
    identifier: fontforge/fontforge

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        acorn2sfd --version
        dewoff --version
        fontforge --version
        fontimage --version
        fontlint --help
        pcl2ttf --version
        pfadecrypt --version
        sfddiff --version
        woff --version
        acorn2sfd --help
        dewoff --help
        fontforge --help
        fontimage --help
        pcl2ttf --help
        pfadecrypt --help
        sfddiff --help
        woff --help
