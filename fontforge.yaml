package:
  name: fontforge
  version: "20230101"
  epoch: 3
  description: Free (libre) font editor
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - gnu-libiconv-dev
      - libspiro
      - py3-setuptools
      - woff2-dev

vars:
  import: fontforge

data:
  - name: py-versions
    items:
      3.10: '310'
      3.11: '311'
      3.12: '312'
      3.13: '313'

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - freetype-dev
      - giflib-dev
      - gnu-libiconv-dev
      - gtk-3-dev
      - libspiro-dev
      - libxml2-dev
      - pango-dev
      - potrace
      - py3-supported-build-base-dev
      - python3-dev
      - readline-dev
      - samurai
      - tiff-dev
      - woff2-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/fontforge/fontforge
      expected-commit: a1dad3e81da03d5d5f3c4c1c1b9b5ca5ebcfcecf
      tag: ${{package.version}}

  - uses: patch
    with:
      patches: gettext-0.22.patch

  - runs: |
      mkdir -p build
      export CFLAGS="$CFLAGS -flto=auto -I/usr/include/gnu-libiconv"
      export CXXFLAGS="$CXXFLAGS -flto=auto -I/usr/include/gnu-libiconv"
      cd build
      cmake \
      	-DCMAKE_BUILD_TYPE=Release \
      	-DCMAKE_INSTALL_PREFIX=/usr \
      	-DENABLE_MAINTAINER_TOOLS=TRUE \
      	-DENABLE_FONTFORGE_EXTRAS=TRUE \
        -DENABLE_GUI=OFF \
        -DENABLE_LIBSPIRO=ON \
        -DENABLE_LIBREADLINE=ON \
        -DENABLE_WOFF2=ON \
        -DENABLE_DOCS=OFF \
      	-DUNIX=TRUE \
      	..
      make

      make DESTDIR="${{targets.destdir}}" install

  - uses: strip

subpackages:
  - name: fontforge-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - fontforge
    description: fontforge dev

  - name: fontforge-doc
    pipeline:
      - uses: split/manpages
    description: fontforge manpages
    test:
      pipeline:
        - uses: test/docs

  - range: py-versions
    name: py${{range.key}}-fontforge
    description: Python ${{range.key}} bindings for fontforge
    dependencies:
      provider-priority: ${{range.value}}
      provides:
        - py3-fontforge
    pipeline:
      - runs: |
          PYVER="${{range.key}}"
          # See
          # https://github.com/wolfi-dev/os/issues/41647#issuecomment-2655627111
          # for an explanation on why this is done.
          cd build
          cmake \
            -DPython3_EXECUTABLE=/usr/bin/python${PYVER} \
            -DPYHOOK_INSTALL_DIR=lib/python${PYVER}/site-packages . || true
          # The first invocation of cmake can fail, but calling it
          # again works
          cmake \
            -DPython3_EXECUTABLE=/usr/bin/python${PYVER} \
            -DPYHOOK_INSTALL_DIR=lib/python${PYVER}/site-packages .
          make
          make DESTDIR="${{targets.destdir}}" install
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages
          mkdir -p "${{targets.subpkgdir}}"/usr/share/fontforge/python
          # use find and exec to move them to the right place
          find ${{targets.destdir}}/usr/lib/python${PYVER}/site-packages -name "fontforge.so" -exec mv {} "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages \;
          find ${{targets.destdir}}/usr/lib/python${PYVER}/site-packages -name "psMat.so" -exec mv {} "${{targets.subpkgdir}}"/usr/lib/python${PYVER}/site-packages \;
          mv ${{targets.destdir}}/usr/share/fontforge/python "${{targets.subpkgdir}}"/usr/share/fontforge/python
    test:
      pipeline:
        - uses: python/import
          with:
            python: python${{range.key}}
            import: ${{vars.import}}

  - name: py3-supported-fontforge
    description: meta package providing fontforge bindings for supported Python versions
    dependencies:
      runtime:
        - py3.10-fontforge
        - py3.11-fontforge
        - py3.12-fontforge
        - py3.13-fontforge

update:
  enabled: true
  github:
    identifier: fontforge/fontforge

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        acorn2sfd --version
        dewoff --version
        fontforge --version
        fontimage --version
        fontlint --help
        pcl2ttf --version
        pfadecrypt --version
        sfddiff --version
        woff --version
        acorn2sfd --help
        dewoff --help
        fontforge --help
        fontimage --help
        pcl2ttf --help
        pfadecrypt --help
        sfddiff --help
        woff --help
    - uses: test/tw/ldd-check
