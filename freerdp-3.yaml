package:
  name: freerdp-3
  version: 3.1.0
  epoch: 0
  description: FreeRDP client
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - freerdp=${{package.full-version}}

environment:
  contents:
    packages:
      - alsa-lib-dev
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - cairo-dev
      # - bsd-compat-headers
      - cmake
      - cups-dev
      - docbook-xml
      - ffmpeg-dev
      - fuse3-dev
      - gsm-dev
      - gst-plugins-base-dev
      - icu-dev
      - krb5-dev
      - libjpeg-turbo-dev
      - libswscale7
      - libusb-dev
      - libx11-dev
      - libxcursor-dev
      - libxdamage-dev
      - libxext-dev
      - libxi-dev
      - libxinerama-dev
      # - libxkbfile-dev
      - libxkb-dev
      - libxkbcommon-dev
      - libxrender-dev
      - libxslt
      - libxv-dev
      - linux-headers
      - openssl-dev>3
      - pkcs11-helper-dev
      - samurai
      - wayland-dev

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/FreeRDP/FreeRDP/archive/${{package.version}}.tar.gz
      expected-sha512: 0a463c241d09ea354fdd943c010a2ecca1ad20f6ba5ea037422884f3b668ac6c4c30f73d12077368cd54f74418ef65b267628934a050fcbb3ff1e96d84ae954e

  - runs: |
      CFLAGS="$CFLAGS -fPIC" \
      CXXFLAGS="$CXXFLAGS -fPIC" \
      cmake -B build -G Ninja \
        -DCMAKE_BUILD_TYPE=MinSizeRel \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DWITH_ALSA=ON \
        -DWITH_CUPS=ON \
        -DWITH_CHANNELS=ON \
        -DWITH_DIRECTFB=OFF \
        -DWITH_FFMPEG=OFF \
        -DWITH_GSM=ON \
        -DWITH_GSTREAMER_1_0=ON \
        -DWITH_IPP=OFF \
        -DWITH_JPEG=ON \
        -DWITH_OPENSSL=ON \
        -DWITH_PCSC=OFF \
        -DWITH_PULSE=OFF \
        -DWITH_WAYLAND=ON \
        -DWITH_SERVER=ON \
        -DWITH_X11=ON \
        -DWITH_XCURSOR=ON \
        -DWITH_XEXT=ON \
        -DWITH_XKBFILE=ON \
        -DWITH_XI=ON \
        -DWITH_XINERAMA=ON \
        -DWITH_XRENDER=ON \
        -DWITH_XV=ON \
        -DWITH_ZLIB=ON \
        -DWITH_NEON=OFF
       cmake --build build

  - runs: |
      DESTDIR="${{targets.destdir}}" cmake --install build

  - uses: strip

subpackages:
  - name: ${{package.name}}-doc
    description: freerdp man pages
    pipeline:
      - uses: split/manpages

  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - freerdp-3
    description: freerdp dev

  - name: ${{package.name}}-libs
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/* ${{targets.subpkgdir}}/usr/lib
    description: freerdp library

update:
  enabled: true
  github:
    identifier: FreeRDP/FreeRDP
    tag-filter-prefix: 3.
