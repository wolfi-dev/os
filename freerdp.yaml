package:
  name: freerdp
  version: 2.11.7
  epoch: 4
  description: FreeRDP client
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - alsa-lib-dev
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - cups-dev
      - gsm-dev
      - gst-plugins-base-dev
      - libjpeg-turbo-dev
      - libusb-dev
      - libx11-dev
      - libxcursor-dev
      - libxdamage-dev
      - libxext-dev
      - libxi-dev
      - libxinerama-dev
      - libxkb-dev
      - libxkbcommon-dev
      - libxrender-dev
      - libxv-dev
      - linux-headers
      - openssl-dev>3
      - samurai
  environment:
    CFLAGS: -Wno-unused-variable -Wno-int-conversion -Wno-incompatible-pointer-types

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/FreeRDP/FreeRDP
      tag: ${{package.version}}
      expected-commit: 7f6cc93c21d7f0faad6daacca06f494f29ce882c

  - runs: |
      CFLAGS="$CFLAGS -fPIC -Wno-incompatible-pointer-types -Wno-int-conversion" \
      CXXFLAGS="$CXXFLAGS -fPIC -Wno-incompatible-pointer-types -Wno-int-conversion" \
      cmake -B build -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DWITH_ALSA=ON \
        -DWITH_CUPS=ON \
        -DWITH_CHANNELS=ON \
        -DBUILTIN_CHANNELS=OFF \
        -DWITH_DIRECTFB=OFF \
        -DWITH_FFMPEG=OFF \
        -DWITH_GSM=ON \
        -DWITH_GSTREAMER_1_0=ON \
        -DWITH_IPP=OFF \
        -DWITH_JPEG=ON \
        -DWITH_OPENSSL=ON \
        -DWITH_PCSC=OFF \
        -DWITH_PULSE=OFF \
        -DWITH_WAYLAND=ON \
        -DWITH_SERVER=ON \
        -DWITH_X11=ON \
        -DWITH_XCURSOR=ON \
        -DWITH_XEXT=ON \
        -DWITH_XKBFILE=ON \
        -DWITH_XI=ON \
        -DWITH_XINERAMA=ON \
        -DWITH_XRENDER=ON \
        -DWITH_XV=ON \
        -DWITH_ZLIB=ON \
        -DWITH_NEON=OFF
       cmake --build build

  - runs: |
      DESTDIR="${{targets.destdir}}" cmake --install build

  - uses: strip

subpackages:
  - name: freerdp-doc
    description: freerdp man pages
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

  - name: freerdp-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - freerdp
    description: freerdp dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: freerdp-libs
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/* ${{targets.subpkgdir}}/usr/lib
    description: freerdp library
    test:
      pipeline:
        - uses: test/tw/ldd-check
          with:
            extra-library-paths: "/usr/lib/freerdp2/"

update:
  enabled: true
  github:
    identifier: FreeRDP/FreeRDP
    tag-filter-prefix: 2.

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        freerdp-proxy --help
        freerdp-proxy --version
        sdl-freerdp --help
        sdl-freerdp --version
        sfreerdp --help
        sfreerdp --version
        winpr-makecert --version
        winpr-makecert --help
        xfreerdp --help
        xfreerdp --version
