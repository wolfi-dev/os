package:
  name: ghostscript
  version: "10.06.0"
  epoch: 1
  description: Interpreter for the PostScript language and for PDF
  copyright:
    - license: AGPL-3.0-or-later

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - cups-dev
      - expat-dev
      - freetype-dev
      - gtk-3-dev
      - jbig2dec-dev
      - lcms2-dev
      - libjpeg-turbo
      - libpng-dev
      - libtool
      - libx11-dev
      - libxext-dev
      - libxt-dev
      - openjpeg-dev
      - tiff-dev
      - zlib-dev

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: ''
    to: mangled-package-version

pipeline:
  - uses: fetch
    with:
      expected-sha512: 21ba2110693cfb98126f06daff410b0a94ae9b1690b867a383aa82b56a817ffd237044e024c2cf26daa6efe4d5cf8903db8e637c4629f0c8a0eb325a30fdc0cb
      uri: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs${{vars.mangled-package-version}}/ghostscript-${{package.version}}.tar.gz

  - uses: patch
    with:
      patches: fix-sprintf.patch

  - uses: patch
    with:
      patches: ghostscript-system-zlib.patch

  - runs: |
      rm -r jpeg libpng zlib tiff lcms2mt cups/libs jbig2dec \
      freetype

      # fix parallel builds
      sed -i -e 's/ECHO_XE/ECHOGS_XE/g' \
      	-e 's/^\($(GLOBJ)md5.$(OBJ) :.*\)/\1 $(ECHOGS_XE)/' \
      	base/lib.mak
      aclocal && autoconf --force

      cd ./ijs
      libtoolize --force && aclocal && autoconf && automake --add-missing

  - uses: autoconf/configure
    with:
      dir: ijs
      opts: |
        CFLAGS="$CFLAGS -flto=auto" \
        --enable-shared \
        --disable-static

  - uses: autoconf/make
    with:
      dir: ijs

  - uses: autoconf/make-install
    with:
      dir: ijs

  - uses: autoconf/configure
    with:
      dir: .
      opts: |
        CFLAGS="$CFLAGS -fPIC" \
        CXXFLAGS="$CXXFLAGS -fPIC" \
        --docdir=/usr/share/doc/ghostscript \
        --with-system-libtiff \
        --with-ijs \
        --with-jbig2dec \
        --without-libpaper \
        --without-versioned-path \
        --enable-gtk \
        --with-drivers=ALL \
        --with-fontpath=/usr/share/fonts/Type1:/usr/share/fonts \
        --disable-compile-inits

  - runs: |
      make so all
      make -j1 DESTDIR="${{targets.destdir}}" install soinstall
      # create empty dir for future fonts
      mkdir -p "${{targets.destdir}}"/usr/share/fonts/Type1

  - uses: strip

subpackages:
  - name: ghostscript-doc
    pipeline:
      - uses: split/manpages
    description: ghostscript manpages
    test:
      pipeline:
        - uses: test/docs

  - name: "ghostscript-dbg"
    description: "ghostscript Debug Symbols"
    pipeline:
      - uses: split/debug
    dependencies:
      runtime:
        - ghostscript
    test:
      pipeline:
        - runs: find /usr/lib/debug -name "*.debug" -type f | grep -q .

  - name: ghostscript-dev
    pipeline:
      - uses: split/dev
    description: ghostscript dev
    dependencies:
      runtime:
        - ghostscript
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

update:
  enabled: true
  release-monitor:
    identifier: 1157

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        dvipdf version
        gs --version
        gsbj --version
        gsc --version
        gsdj --version
        gsdj500 --version
        gslj --version
        gslp --version
        gsnd --version
        gsx --version
        pf2afm --version
        printafm --version
        ps2ascii --version
        ps2epsi --version
        unix-lpr.sh --version
        dvipdf help
        gs --help
        gsbj --help
        gsc --help
        gsdj --help
        gsdj500 --help
        gslj --help
        gslp --help
        gsnd --help
        gsx --help
        pf2afm --help
        printafm --help
        ps2ascii --help
        ps2epsi --help
        unix-lpr.sh --help
    - uses: test/tw/ldd-check
