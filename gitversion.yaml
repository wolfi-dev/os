package:
  name: gitversion
  version: "6.5.0"
  epoch: 0
  description: Derives SemVer information from git history
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - dotnet-${{vars.dotnet-version}}-runtime
      - git

environment:
  contents:
    packages:
      - busybox
      - dotnet-${{vars.dotnet-version}}-sdk
      - git

vars:
  dotnet-version: 9

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/GitTools/GitVersion
      tag: ${{package.version}}
      expected-commit: 3a7e6557d2bf6dd18eca1c3bd7cd20fd792f0c3f

  - runs: |
      # Set runtime arch
      ARCH=${{build.arch}}
      if [[ "$ARCH" == "aarch64" ]]; then
        runtime_arch="arm64"
      elif [[ "$ARCH" == "x86_64" ]]; then
        runtime_arch="x64"
      fi

      # Remove global.json to avoid SDK version conflicts
      rm -f global.json

      # Build Configuration
      dotnet publish src/GitVersion.App/GitVersion.App.csproj \
        --configuration Release \
        --framework net${{vars.dotnet-version}}.0 \
        --no-self-contained \
        --output publish \
        --runtime linux-"$runtime_arch" \
        -p:DebugSymbols=false \
        -p:DebugType=none
      
      # Install to destination
      mkdir -p "${{targets.destdir}}"/usr/lib
      cp -dr publish "${{targets.destdir}}"/usr/lib/gitversion

      # Create binary symlink
      mkdir -p "${{targets.destdir}}"/usr/bin
      ln -s /usr/lib/gitversion/gitversion "${{targets.destdir}}"/usr/bin/gitversion

  - uses: strip

update:
  enabled: true
  github:
    identifier: GitTools/GitVersion
    use-tag: true

test:
  pipeline:
    - name: "Test GitVersion version command"
      runs: |
        gitversion /version
    - name: "Test GitVersion in a git repository"
      runs: | 
       # Create a test git repository
       mkdir -p /tmp/test-repo
       cd /tmp/test-repo
       git init
       git config user.email "test@example.com"
       git config user.name "Test User"
       
       # Create initial commit
       echo "test" > README.md
       git add README.md
       git commit -m "Initial commit"

       # Test GitVersion can calulate version
       gitversion /showvariable SemVer
    - uses: test/tw/ldd-check
