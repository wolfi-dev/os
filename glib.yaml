package:
  name: glib
  version: "2.84.1"
  epoch: 0
  description: Common C routines used by Gtk+ and other libs
  copyright:
    - license: LGPL-2.1-or-later

vars:
  # build uses rst2man from py3-docutils and also invokes 'python3'
  # installed /usr/bin/gtester-report gets correct shbang (/usr/bin/python3.XX)
  py-version: 3.13

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - bzip2-dev
      - ca-certificates-bundle
      - docbook-xml
      - gettext-dev
      - libffi-dev
      - libmount
      - libxml2-utils
      - libxslt
      - libxslt-dev
      - meson
      - pcre2-dev
      - py${{vars.py-version}}-docutils-bin
      - python-${{vars.py-version}}
      - util-linux-dev
      - zlib-dev

# creates a new var that contains only the major and minor version to be used in the fetch URL
# e.g. 2.74.3 will create a new var mangled-package-version=2.74
var-transforms:
  - from: ${{package.version}}
    match: (\d+\.\d+)\.\d+
    replace: $1
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://gitlab.gnome.org/GNOME/glib.git
      tag: ${{package.version}}
      expected-commit: eaa7e5bdfd2739a58d832362cb8dd1b11af29be0

  - uses: meson/configure
    with:
      opts: |
        --default-library=both \
        -Dman=true \
        -Dtests=false

  - uses: meson/compile

  - uses: meson/install

  - name: update shbang
    runs: |
      # replace usr/bin/env python3
      d=${{targets.destdir}}/usr/bin
      # change '/usr/bin/env python3' or '/usr/bin/python3' to /usr/bin/python3.XX
      op='1s,^#!/usr/bin/\(env python3\|python3\)$,#!/usr/bin/python${{vars.py-version}},'
      for f in "$d"/*; do
         [ -f "$f" ] || continue
         sed -i -e "$op" "$f";
      done

  - uses: strip

subpackages:
  - name: glib-static
    pipeline:
      - uses: split/static
    dependencies:
      runtime:
        - gettext-static
    description: glib static

  - name: glib-dev
    pipeline:
      - uses: split/dev
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mkdir -p ${{targets.subpkgdir}}/usr/share
          find ${{targets.destdir}}/usr/bin ! -name "glib-compile-schemas" -a \( \
              -name "gdbus-codegen" -o \
              -name "gobject-query" -o \
              -name "gresource" -o \
              -name "gtester*" -o \
              -name "glib-*" \) \
              -exec mv {} ${{targets.subpkgdir}}/usr/bin \;
          mv ${{targets.destdir}}/usr/share/gdb ${{targets.subpkgdir}}/usr/share/
          mv ${{targets.destdir}}/usr/share/glib-2.0 ${{targets.subpkgdir}}/usr/share/
    dependencies:
      runtime:
        - glib
        - bzip2-dev
        - gettext-dev
        - libxml2-utils
        - libxslt
        - libffi-dev # needed by gobject-2.0 when building gobject-introspection
        - pcre2-dev # needed by glib-2.0 when building gobject-introspection
        - util-linux-dev # needed by gio-2.0 when building gobject-introspection
        - docbook-xml
      provides:
        - gio=${{package.full-version}}
        - gobject=${{package.full-version}}
        - gthread=${{package.full-version}}
    description: glib dev
    test:
      pipeline:
        - runs: |
            gdbus-codegen --help
            glib-compile-resources --version
            glib-compile-resources --help
            glib-genmarshal --version
            glib-genmarshal --help
            glib-gettextize --version
            glib-gettextize --help
            glib-mkenums --version
            glib-mkenums --help
            gobject-query --version
            gobject-query --help
            gresource help
            gtester --version
            gtester --help
            gtester-report --version
            gtester-report --help
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
          with:
            packages: ${{subpkg.name}}

  - name: glib-lang
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share
          mv ${{targets.destdir}}/usr/share/locale ${{targets.subpkgdir}}/usr/share/
    description: glib lang

update:
  enabled: true
  git: {}

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        gapplication version
        gdbus help
        gi-compile-repository --version
        gi-decompile-typelib --version
        gi-inspect-typelib --help
        gio --version
        gio-querymodules --version
        glib-compile-schemas --version
        gapplication help
        gi-compile-repository --help
        gi-decompile-typelib --help
        gio --help
        gio-querymodules --help
        glib-compile-schemas --help
    - uses: test/tw/ldd-check
