# Generated from https://git.alpinelinux.org/aports/plain/main/glslang/APKBUILD
package:
  name: glslang
  version: 1.3.261.1
  epoch: 3
  description: Khronos reference front-end for GLSL, ESSL, and sample SPIR-V generator
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - python3
      - samurai
      - spirv-tools-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 76b52ebf77833908dc4c0dd6c70a9c357ac720bd
      repository: https://github.com/KhronosGroup/glslang
      tag: sdk-${{package.version}}

  - runs: |
      cmake -B build-shared -G Ninja \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_BUILD_TYPE=MinSizeRel \
        -DBUILD_SHARED_LIBS=ON \
        -DENABLE_CTEST=ON
      cmake --build build-shared

      sed -i '/add_library(glslang-default-resource-limits/ s/$/ STATIC/' StandAlone/CMakeLists.txt
      cmake -B build-static -G Ninja \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_BUILD_TYPE=MinSizeRel \
        -DBUILD_SHARED_LIBS=OFF \
        -DENABLE_CTEST=ON
      cmake --build build-static

      DESTDIR="${{targets.destdir}}" cmake --install build-static
      DESTDIR="${{targets.destdir}}" cmake --install build-shared

  - uses: strip

subpackages:
  - name: glslang-static
    pipeline:
      - uses: split/static
    description: glslang static

  - name: glslang-libs
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib
          find ${{targets.destdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/libglslang.so* ${{targets.subpkgdir}}/usr/lib/
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})
    description: aom libs

  - name: glslang-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - glslang
        - glslang
    description: glslang dev

update:
  enabled: true
  ignore-regex-patterns:
    - vulkan-sdk
    - candidate
  github:
    identifier: KhronosGroup/glslang
    use-tag: true
    strip-prefix: sdk-
    tag-filter: sdk-

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        glslang --version
        glslangValidator --version
        spirv-remap --version
