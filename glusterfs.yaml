package:
  name: glusterfs-11
  version: "11.2"
  epoch: 1
  description: Gluster is a software defined distributed storage that can scale to several petabytes. It provides interfaces for object, block and file storage.
  copyright:
    - license: LGPL-3.0 AND GPL-2.0
  dependencies:
    runtime:
      - merged-usrsbin
    provides:
      - glusterfs=${{package.full-version}}

environment:
  contents:
    packages:
      - acl-dev
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - flex
      - gperftools-dev
      - intltool
      - libtirpc-dev
      - libtool
      - liburcu-dev
      - liburing-dev
      - libuuid
      - libxml2-dev
      - nfs-utils-dev
      - openssl
      - openssl-dev
      - pkgconf-dev
      - rpcgen
      - tcmalloc
      - tcmalloc-minimal
      - util-linux-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/gluster/glusterfs
      tag: v${{package.version}}
      expected-commit: 15d3c0f8435814fdb7242a8a82fa5db140013d0a

  - runs: |
      ./autogen.sh

  - uses: autoconf/configure
    with:
      opts: |
        --sbindir=/usr/bin \
        --with-mountutildir=/usr/bin

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

  - name: Cleanup
    runs: |
      find ${{targets.contextdir}} -type d -name '__pycache__' -exec rm -rf {} +
      find ${{targets.contextdir}} -type f -name '*.pyc' -exec rm -rf {} +

subpackages:
  - name: ${{package.name}}-dev
    description: Development files for glusterfs
    dependencies:
      provides:
        - glusterfs-dev=${{package.full-version}}
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ${{package.name}}-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share
          mv "${{targets.destdir}}"/usr/share/doc "${{targets.contextdir}}"/usr/share/
    description: ${{package.name}} manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  ignore-regex-patterns:
    - 'rc*'
    - 'alpha'
    - 'dev'
  github:
    identifier: gluster/glusterfs
    strip-prefix: v
    use-tag: true
