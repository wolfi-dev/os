package:
  name: gnupg
  version: 2.4.8
  epoch: 4
  description: GNU Privacy Guard 2 - meta package for full GnuPG suite
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - merged-lib
      - merged-usrsbin
      - wolfi-baselayout

vars:
  gpg-package: gpg

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - bzip2-dev
      - ca-certificates-bundle
      - gettext-dev
      - glibc-iconv
      # - pinentry TODO skipping for now as seems to require gtk+3.0, gcr, libproxy and mesa
      - gnutls-dev
      - libassuan-dev
      - libgcrypt-dev
      - libgpg-error-dev
      - libksba-dev
      - libtool
      - libusb-dev
      - npth-dev
      - openldap-dev
      - readline-dev
      - sqlite-dev
      - texinfo
      - zlib-dev
  environment:
    CPPFLAGS: -Wp,-DLDAP_DEPRECATED=1

pipeline:
  - uses: fetch
    with:
      expected-sha256: b58c80d79b04d3243ff49c1c3fc6b5f83138eb3784689563bcdd060595318616
      uri: https://gnupg.org/ftp/gcrypt/gnupg/gnupg-${{package.version}}.tar.bz2

  - uses: patch
    with:
      patches: |
        libassun-version.patch
        0010-avoid-beta-warning.patch
        0110-avoid-simple-memory-dumps-via-ptrace.patch
        0210-dirmngr-hkp-avoid-potential-race-condition-when-some-host-die.patch
        0330-gpg-default-to-sha512-for-all-signature-types-on-rsa-keys.patch
        0340-gpg-prefer-sha512-and-sha384-in-personal-digest.patch
        fix-i18n.patch
        make-aes-default-for-fips.patch

  - uses: autoconf/configure
    with:
      opts: |
        --prefix=/usr \
        --disable-nls \
        --disable-docs \
        --enable-bzip2 \
        --enable-tofu \
        --enable-scdaemon \
        --enable-ccid-driver \
        --sbindir=/usr/bin

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      install -Dm644 -t ${{targets.destdir}}/usr/lib/udev/rules.d/ 60-scdaemon.rules

      cd ${{targets.destdir}}

      # install compat symlink
      ln -s gpg  usr/bin/gpg2
      ln -s gpgv usr/bin/gpgv2

      # Remove docs for systemd-user
      rm -rf usr/share/doc/gnupg/examples/systemd-user

      # Remove gpg scheme interpreter - an internal tool used in gpg tests
      rm -rf usr/bin/gpgscm

  - uses: strip

subpackages:
  - name: ${{package.name}}-doc
    pipeline:
      - uses: split/manpages
    description: gnupg manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout

  - name: ${{package.name}}-lang
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share/gnupg
          mv ${{targets.destdir}}/usr/share/gnupg/help.*.txt ${{targets.subpkgdir}}/usr/share/gnupg/
    description: Languages for package gnupg
    dependencies:
      runtime:
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout

  - name: ${{package.name}}-dirmngr
    dependencies:
      runtime:
        - ${{package.name}}-gpgconf
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mkdir -p "${{targets.subpkgdir}}"/usr/libexec
          mkdir -p "${{targets.subpkgdir}}"/usr/share/gnupg

          mv ${{targets.destdir}}/usr/bin/dirmngr* ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/libexec/dirmngr_ldap ${{targets.subpkgdir}}/usr/libexec/
          mv ${{targets.destdir}}/usr/share/gnupg/sks-keyservers.netCA.pem ${{targets.subpkgdir}}/usr/share/gnupg/
    description: GNU Privacy Guard 2 - network certificate management service
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: dirmngr dirmngr-client
        - uses: test/tw/help-check
          with:
            bins: dirmngr dirmngr-client

  - name: ${{package.name}}-gpgconf
    dependencies:
      runtime:
        - ${{package.name}}-gpgconf
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mkdir -p "${{targets.subpkgdir}}"/usr/share/gnupg

          mv ${{targets.destdir}}/usr/bin/gpg-connect-agent ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/bin/gpgconf ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/share/gnupg/distsigkey.gpg ${{targets.subpkgdir}}/usr/share/gnupg/
    description: GNU Privacy Guard 2 - core configuration utilities
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpg-connect-agent gpgconf
        - uses: test/tw/help-check
          with:
            bins: gpg-connect-agent gpgconf

  - name: ${{package.name}}-scdaemon
    dependencies:
      runtime:
        - ${{vars.gpg-package}}-agent
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/libexec
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/udev
          mv ${{targets.destdir}}/usr/libexec/scdaemon ${{targets.subpkgdir}}/usr/libexec/
          mv ${{targets.destdir}}/usr/lib/udev/rules.d ${{targets.subpkgdir}}/usr/lib/udev/
    description: GNU Privacy Guard 2 - smart card support
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ${{package.name}}-wks-client
    dependencies:
      runtime:
        - ${{vars.gpg-package}}
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/libexec
          mv ${{targets.destdir}}/usr/libexec/gpg-wks-client ${{targets.subpkgdir}}/usr/libexec/
    description: GNU Privacy Guard 2 - Web Key Service client
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ${{vars.gpg-package}}
    description: GNU Privacy Guard 2 - public key operations only
    dependencies:
      runtime:
        - ${{package.name}}-gpgconf
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin "${{targets.subpkgdir}}"/usr/libexec

          mv ${{targets.destdir}}/usr/bin/gpg ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/bin/gpg2 ${{targets.subpkgdir}}/usr/bin/
          mv "${{targets.destdir}}"/usr/libexec/keyboxd "${{targets.subpkgdir}}"/usr/libexec
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpg gpg2 /usr/libexec/keyboxd
        - uses: test/tw/help-check
          with:
            bins: gpg gpg2 /usr/libexec/keyboxd
        - runs: |
            gpg --list-keys

  - name: ${{vars.gpg-package}}-agent
    dependencies:
      runtime:
        - ${{package.name}}-gpgconf
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mkdir -p "${{targets.subpkgdir}}"/usr/libexec
          mkdir -p "${{targets.subpkgdir}}"/usr/share/gnupg

          mv ${{targets.destdir}}/usr/bin/gpg-agent ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/libexec/gpg-check-pattern ${{targets.subpkgdir}}/usr/libexec/
          mv ${{targets.destdir}}/usr/libexec/gpg-preset-passphrase ${{targets.subpkgdir}}/usr/libexec/
          mv ${{targets.destdir}}/usr/libexec/gpg-protect-tool ${{targets.subpkgdir}}/usr/libexec/
          mv ${{targets.destdir}}/usr/share/gnupg/help.txt ${{targets.subpkgdir}}/usr/share/gnupg/
    description: GNU Privacy Guard 2 - cryptographic agent
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpg-agent
        - uses: test/tw/help-check
          with:
            bins: gpg-agent

  - name: ${{vars.gpg-package}}-wks-server
    dependencies:
      runtime:
        - ${{vars.gpg-package}}
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv ${{targets.destdir}}/usr/bin/gpg-wks-server ${{targets.subpkgdir}}/usr/bin/
    description: GNU Privacy Guard 2 - Web Key Service server
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpg-wks-server
        - uses: test/tw/help-check
          with:
            bins: gpg-wks-server

  - name: ${{vars.gpg-package}}sm
    description: GNU Privacy Guard 2 - S/MIME version
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv ${{targets.destdir}}/usr/bin/gpgsm ${{targets.subpkgdir}}/usr/bin/
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpgsm
        - uses: test/tw/help-check
          with:
            bins: gpgsm
    dependencies:
      runtime:
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout

  - name: ${{vars.gpg-package}}v
    description: GNU Privacy Guard 2 - signature verification only
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv ${{targets.destdir}}/usr/bin/gpgv ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/bin/gpgv2 ${{targets.subpkgdir}}/usr/bin/
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpgv gpgv2
        - uses: test/tw/help-check
          with:
            bins: gpgv gpgv2
    dependencies:
      runtime:
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout

  - name: ${{package.name}}-utils
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr
          mv ${{targets.destdir}}/usr/* ${{targets.subpkgdir}}/usr/
    description: GNU Privacy Guard 2 - utility programs
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/tw/ver-check
          with:
            bins: gpgsplit gpgtar kbxutil watchgnupg
        - uses: test/tw/help-check
          with:
            bins: gpgparsemail gpgsplit gpgtar kbxutil watchgnupg
    dependencies:
      runtime:
        - merged-usrsbin
        - merged-lib
        - wolfi-baselayout

update:
  enabled: true
  release-monitor:
    identifier: 1215

test:
  environment:
    contents:
      packages:
        - ${{vars.gpg-package}}
  pipeline:
    - uses: test/tw/ldd-check
    - uses: test/hardening-check
    - uses: test/tw/ver-check
      with:
        bins: gpg
    - uses: test/tw/help-check
      with:
        bins: gpg
