package:
  name: go-jsonnet
  version: 0.21.0
  epoch: 2 # CVE-2025-61729
  description: The data templating language Implementation in go.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/google/go-jsonnet
      tag: v${{package.version}}
      expected-commit: 67968688d9952f50662e979fab1bef889d0d3e57

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: examples/bazel

  - uses: go/build
    with:
      packages: ./cmd/jsonnet
      output: jsonnet

  - uses: go/build
    with:
      packages: ./cmd/jsonnetfmt
      output: jsonnetfmt

  - uses: go/build
    with:
      packages: ./cmd/jsonnet-lint
      output: jsonnet-lint

  - uses: go/build
    with:
      packages: ./cmd/jsonnet-deps
      output: jsonnet-deps

test:
  pipeline:
    - runs: |
        cat <<EOF > test.jsonnet
        # Edit me!

            local f(x,y)=x+y;


        local Template = {z: "foo"};

        Template + {
        "f": ((3)) ,
        "g g":
        f(4,2),
        arr: [[
          1, 2,
          ],
          3,
          ]
        }
        EOF

        cat <<EOF > test_init.jsonnet
        std.manifestIni({
          sections: {
            main: {
              host: "127.0.0.1",
              port: "9000",
            },
            database: {
              path: "/var/data",
            },
          },
        })
        EOF

        jsonnetfmt --version
        jsonnetfmt -i test.jsonnet
        jsonnetfmt -i test_init.jsonnet

        jsonnet --version
        jsonnet -e '{ x: 1 , y: self.x + 1 } { x: 10 }'
        jsonnet test.jsonnet
        jsonnet -S test_init.jsonnet

        jsonnet-deps --version
        jsonnet-deps test.jsonnet
        jsonnet-deps test_init.jsonnet

        jsonnet-lint --version
        jsonnet-lint test.jsonnet
        jsonnet-lint test_init.jsonnet

update:
  enabled: true
  github:
    identifier: google/go-jsonnet
    strip-prefix: v
