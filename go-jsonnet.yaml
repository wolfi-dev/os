package:
  name: go-jsonnet
  version: 0.20.0
  epoch: 0
  description: A feature-complete, production-ready implementation of Jsonnet in pure Go.
  copyright:
    - license: Apache-2.0

environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/edge/main
      - https://dl-cdn.alpinelinux.org/alpine/edge/community
    packages:
      - busybox
      - curl
      - go
      - git

pipeline:
  - name: Fetch source
    runs: |
      curl -L -o go-jsonnet.tar.gz https://github.com/google/go-jsonnet/archive/refs/tags/v0.20.0.tar.gz
      echo "bf9923a848dba65fa99f6e926221ab4222c2f259ba837d279b43917962bc7d70  go-jsonnet.tar.gz" | sha256sum -c
      mkdir src
      tar -xzf go-jsonnet.tar.gz -C src --strip-components=1

  - name: Build binaries
    working-directory: src
    runs: |
      export CGO_ENABLED=0
      export GOFLAGS="-buildvcs=false"
      go build -o jsonnet ./cmd/jsonnet
      go build -o jsonnetfmt ./cmd/jsonnetfmt
      go build -o jsonnet-deps ./cmd/jsonnet-deps

  - name: Install binaries
    runs: |
      install -Dm755 src/jsonnet "${{targets.destdir}}/usr/bin/jsonnet"
      install -Dm755 src/jsonnetfmt "${{targets.destdir}}/usr/bin/jsonnetfmt"
      install -Dm755 src/jsonnet-deps "${{targets.destdir}}/usr/bin/jsonnet-deps"
      install -Dm644 src/LICENSE "${{targets.destdir}}/usr/share/licenses/go-jsonnet/LICENSE"

test:
  pipeline:
    - name: Binaries installation test
      runs: |
        ${{targets.destdir}}/usr/bin/jsonnet --version
        ${{targets.destdir}}/usr/bin/jsonnetfmt --version
        ${{targets.destdir}}/usr/bin/jsonnet-deps --help
    - name: Run Go test suite
      working-directory: src
      runs: |
        export CGO_ENABLED=0
        go test ./...
