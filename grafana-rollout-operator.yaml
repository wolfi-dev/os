package:
  name: grafana-rollout-operator
  version: "0.34.0"
  epoch: 0 # go/wolfi-rsc/grafana-rollout-operator
  description: Kubernetes Rollout Operator
  copyright:
    - license: Apache-2.0
  dependencies:
    # REMOVE_POST_USRMERGE - https://github.com/orgs/wolfi-dev/discussions/40270
    provides:
      - ${{package.name}}-compat=${{package.full-version}}
    runtime:
      - merged-bin
      - wolfi-baselayout
  resources:
    cpu: "4"
    memory: 8Gi

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/grafana/rollout-operator
      tag: v${{package.version}}
      expected-commit: b7d11ab32bf918a9c8de54639c7533b99328591f

  - uses: go/build
    with:
      packages: ./cmd/rollout-operator
      output: rollout-operator

test:
  environment:
    contents:
      packages:
        - curl
    environment:
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: "32764"
  pipeline:
    - runs: |
        rollout-operator --help
    - uses: test/kwok/cluster
      with:
        serviceaccount: true
    - name: Launch operator with kwok cluster
      uses: test/daemon-check-output
      with:
        setup: |
          kubectl apply -f https://raw.githubusercontent.com/grafana/rollout-operator/refs/tags/v${{package.version}}/operations/rollout-operator/crds/replica-templates.yaml
          kubectl apply -f https://raw.githubusercontent.com/grafana/rollout-operator/refs/tags/v${{package.version}}/operations/rollout-operator/crds/zone-aware-pod-disruption-budget.yaml
          kubectl create clusterrolebinding default --clusterrole=cluster-admin --serviceaccount=default:default
        start: rollout-operator -kubernetes.namespace=default -server.port 8080
        timeout: 30
        expected_output: |
          zpdb config informer caches have synced
          zpdb pod informer caches have synced
          informer caches have synced
        post: |
          curl --fail --silent http://127.0.0.1:8080/metrics
          curl --fail --silent http://127.0.0.1:8080/ready

update:
  enabled: true
  github:
    identifier: grafana/rollout-operator
    strip-prefix: v
