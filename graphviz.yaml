package:
  name: graphviz
  version: "13.1.0"
  epoch: 1
  description: Graph Visualization Tools
  copyright:
    - license: EPL-1.0

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - cairo-dev
      - expat-dev
      - flex
      - fontconfig-dev
      - freetype-dev
      - gd-dev
      - gmp-dev
      - libjpeg-turbo-dev
      - libltdl
      - libpng-dev
      - libsm-dev
      - libxaw-dev
      - libxext-dev
      - lua5.4-dev
      - m4
      - pango-dev
      - python3-dev
      - swig
      - tcl
      - zlib-dev

pipeline:
  - uses: fetch
    with:
      expected-sha256: 13339b83ee5467001a035cfacd175702ac4b14f5d390f0d34e89437b29881278
      uri: https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/${{package.version}}/graphviz-${{package.version}}.tar.xz

  - runs: |
      LUA=lua5.4 \
      lua_suffix=5.4 \
      ./configure \
        --prefix=/usr \
        --libdir=/usr/lib \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --localstatedir=/var \
        --host=${{host.triplet.gnu}} \
        --build=${{host.triplet.gnu}} \
        --sysconfdir=/etc \
        --disable-python \
        --disable-silent-rules \
        --disable-static \
        --disable-dependency-tracking \
        --disable-ltdl-install \
        --enable-ltdl \
        --enable-sharp=no \
        --enable-go=no \
        --enable-guile=no \
        --enable-java=no \
        --enable-lua=yes \
        --enable-ocaml=no \
        --enable-perl=no \
        --enable-php=no \
        --enable-python3 \
        --enable-r=no \
        --enable-ruby=no \
        --enable-tcl=no \
        --without-included-ltdl \
        --with-gdk-pixbuf=yes \
        --with-ipsepcola=yes \
        --with-jpeg \
        --with-libgd=yes \
        --with-pangocairo=yes \
        --with-rsvg=yes \
        --with-x

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: graphviz-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - graphviz
        - cairo-dev
        - expat-dev
        - fontconfig-dev
        - freetype-dev
        - gd-dev
        - gmp-dev
        - libjpeg-turbo-dev
        - libpng-dev
        - libsm-dev
        - libxext-dev
        - pango-dev
        - python3-dev
        - zlib-dev
    description: graphviz dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
          with:
            packages: ${{subpkg.name}}

  - name: graphviz-doc
    pipeline:
      - uses: split/manpages
    description: graphviz manpages
    test:
      pipeline:
        - uses: test/docs

  - name: py3-gv
    dependencies:
      runtime:
        - python3
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/graphviz
          mv ${{targets.destdir}}/usr/lib/graphviz/python3* ${{targets.subpkgdir}}/usr/lib/graphviz/
          mv ${{targets.destdir}}/usr/lib/python3* ${{targets.subpkgdir}}/usr/lib/
    description: Python3 extension for graphviz

  - name: lua5.4-graphviz
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/lua/5.4
          mkdir -p ${{targets.subpkgdir}}/usr/lib/graphviz

          mv ${{targets.destdir}}/usr/lib/lua5.4/lua/* ${{targets.subpkgdir}}/usr/lib/lua/5.4/
          mv ${{targets.destdir}}/usr/lib/graphviz/lua ${{targets.subpkgdir}}/usr/lib/graphviz/
    description: Lua5.4 extension for graphviz
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: graphviz-graphs
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/graphviz
          mv ${{targets.destdir}}/usr/share/graphviz/graphs/* ${{targets.subpkgdir}}/usr/share/graphviz/
    description: Demo graphs for graphviz

update:
  enabled: true
  release-monitor:
    identifier: 1249

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        acyclic -?
        circo --version
        diffimg -?
        dot --version
        dot_builtins --version
        edgepaint --version
        fdp --version
        gvgen -?
        gvpr -V
        mm2gv -?
        neato --version
        nop -?
        osage --version
        patchwork --version
        sfdp --version
        twopi --version
        bcomps -?
        ccomps -?
        circo --help
        cluster -?
        dijkstra -?
        dot --help
        dot2gxl -?
        dot_builtins --help
        edgepaint --help
        fdp --help
        gc -?
        gml2gv -?
        graphml2gv -?
        gv2gml -?
        gv2gxl -?
        gvcolor -?
        gvmap -?
        gvmap.sh -?
        gvpack -?
        gxl2dot -?
        gxl2gv -?
        neato --help
        osage --help
        patchwork --help
        prune -?
        sccmap -?
        sfdp --help
        tred -?
        twopi --help
        unflatten -?
    - uses: test/tw/ldd-check
