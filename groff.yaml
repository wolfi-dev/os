package:
  name: groff
  version: 1.23.0
  epoch: 8
  description: GNU troff text-formatting system
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - groff-base

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils
      - libtool
      - libuuid
      - perl
      - pkgconf-dev
      - texinfo
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.savannah.gnu.org/git/groff.git
      tag: ${{package.version}}
      expected-commit: 198346d187de9e340bbf9d4f80c2dc4d42f5f74e

  - name: git.savannah.gnu.org is flaky
    runs: git submodule set-url gnulib https://github.com/coreutils/gnulib.git

  # Building this requires netpbm, which isn't currently packaged, and the
  # pixmap hasn't changed since 2002.  We just ship a copy of the file found
  # in the 1.23.0 distribution tarball.
  - runs: cp gnu.eps doc/gnu.eps

  # Avoid git-version-gen describing the version as "dirty".
  - runs: echo "${{package.version}}" >.tarball-version

  - runs: ./bootstrap

  - uses: autoconf/configure
    with:
      opts: |
        --without-x \
        --disable-rpath

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      rm -rf ${{targets.destdir}}/usr/lib/charset.alias
      rmdir -p ${{targets.destdir}}/usr/lib 2>/dev/null || true

      # Prevent conflict with mandoc-doc
      rm -f ${{targets.destdir}}/usr/share/man/man1/soelim.1 \
        ${{targets.destdir}}/usr/share/man/man7/roff.7
      # Remove the Swedish translation of a man page
      # https://github.com/wolfi-dev/os/issues/43212
      rm -f ${{targets.destdir}}/usr/share/man/man7/groff_mmse.7

  - uses: strip

subpackages:
  - name: groff-base
    pipeline:
      - runs: |
          # contents of groff-base copied from debian (1.23.0) has these bins
          # wolfi 1.23 did not have binaries geqn gpic or gtbl, so they are removed from the list.
          # 'grog' is shipped by debian, but it is a perl script and I want to avoid the perl dep.
          ver=${{package.version}}
          moves="
          usr/bin/eqn
          usr/bin/groff
          usr/bin/grops
          usr/bin/grotty
          usr/bin/neqn
          usr/bin/nroff
          usr/bin/pic
          usr/bin/preconv
          usr/bin/soelim
          usr/bin/tbl
          usr/bin/troff
          usr/lib/groff/site-tmac
          usr/share/groff/$ver/eign
          usr/share/groff/$ver/font/devascii
          usr/share/groff/$ver/font/devlatin1
          usr/share/groff/$ver/font/devps
          usr/share/groff/$ver/font/devutf8
          usr/share/groff/current
          usr/share/groff/site-tmac"

          src=${{targets.destdir}}
          dest=${{targets.contextdir}}
          for move in ${moves}; do
            d=${move%/*}
            [ -d "$dest/$d" ] || mkdir -p "$dest/$d" || exit 1
            echo "mv <destdir>/$move -> <contextdir>/$d"
            mv "$src/$move" "$dest/$d"
          done
    test:
      pipeline:
        - name: "check --version for groff-base binaries"
          runs: |
            set +x
            bins="eqn groff grops grotty neqn nroff pic preconv soelim tbl troff"
            ver="${{package.version}}"
            for bin in ${bins}; do
              out=$($bin --version) ||
                { echo "FAIL: $bin --version exited $?"; exit 1; }
              echo "$out" | grep -q -F "$ver" || {
                echo "FAIL: $bin --version did not include '$ver'"
                echo "output: $out"
                exit 1
              }
              echo "PASS: '$bin --version' contained version '$ver'"
            done
        - name: "check --help for groff-base binaries"
          runs: |
            set +x
            bins="eqn groff grops grotty neqn nroff pic preconv soelim tbl troff"
            for bin in ${bins}; do
              echo "$ $bin --help"
              $bin --help 2>&1 || { echo "FAIL: '$bin --help' exited $?"; exit 1; }
            done

  - name: groff-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share
          mv ${{targets.destdir}}/usr/share/doc ${{targets.contextdir}}/usr/share/
    description: groff manpages and doc
    test:
      pipeline:
        - uses: test/docs

  - name: groff-info
    pipeline:
      - uses: split/infodir
    description: groff info

update:
  enabled: true
  release-monitor:
    identifier: 1253

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        addftinfo --version
        afmtodit --version
        chem --version
        eqn2graph --version
        gdiffmk --version
        gperl --version
        gpinyin --version
        grap2graph --version
        grn --version
        grodvi --version
        grolbp --version
        grolj4 --version
        gropdf --version
        hpftodit --version
        indxbib --version
        lkbib --version
        lookbib --version
        mmroff --version
        pdfmom --version
        pdfroff --version
        pfbtops --version
        pic2graph --version
        post-grohtml --version
        pre-grohtml --version
        refer --version
        tfmtodit --version
        addftinfo --help
        afmtodit --help
        chem --help
        eqn2graph --help
        gperl --help
        gpinyin --help
        grap2graph --help
        grn --help
        grodvi --help
        grog --help
        grolbp --help
        grolj4 --help
        gropdf --help
        hpftodit --help
        indxbib --help
        lkbib --help
        lookbib --help
        mmroff --help
        pdfmom --help
        pdfroff --help
        pfbtops --help
        pic2graph --help
        post-grohtml --help
        pre-grohtml --help
        refer --help
        tfmtodit --help
