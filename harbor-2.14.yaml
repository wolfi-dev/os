package:
  name: harbor-2.14
  version: "2.14.2"
  epoch: 2
  description: An open source trusted cloud native registry project that stores, signs, and scans content
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - harbor=${{package.full-version}}

# To be updated as upstream harbor distribution requirements, when drift check fails for harbor-distribution subpackage.
vars:
  # https://github.com/goharbor/harbor/blob/main/make/photon/prepare/Pipfile#L15
  python-version: "3.13"
  custom-distribution-version: 2.8.3
  harbor-distribution-release-branch: 2.8
  harbor-distribution-expected-commit: 0c62ec3ec8df7ea91c819448236a67f0777f929f # needs to be updated with each package release

# Create a new major-minor-version variable that contains only the major version
# to use in the bitnami/compat pipeline to find out the correct folder for the image.
# e.g. 2.14.2 will create a new var major-minor-version=2.14
var-transforms:
  - from: ${{package.version}}
    match: ^(\d+\.\d+)\.\d+$
    replace: $1
    to: major-minor-version
  - from: ${{package.version}}
    match: ^(\d+)\.\d+\.\d+$
    replace: "$1"
    to: major-version

environment:
  contents:
    packages:
      - nginx-config
      - nodejs
      - npm
      - py3-setuptools
      - python3
      - shadow
      - swagger<0.33
  environment:
    CGO_ENABLED: "0"
    DISTRIBUTION_PKG: "github.com/docker/distribution"
    DISTRIBUTION_DIR: "/usr/lib/go/src/github.com/docker/distribution"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/goharbor/harbor
      tag: v${{package.version}}
      expected-commit: 3a2df66dc30b9e6b2c100fcd2c6047889e553072

  - runs: |
      # Fixes CVE-2025-24358, can not use go/bump block doing so from modroot of dependency breaks build.
      sed -i 's|\(github.com/gorilla/csrf \)v1\.7\.2|\1v1.7.3|' src/go.mod

      mkdir -p ${{targets.destdir}}/harbor
      # Copy views, migrations, and icons
      cp -rf ./src/core/views ${{targets.destdir}}/harbor/views
      cp -rf ./make/migrations ${{targets.destdir}}/harbor/migrations
      cp -rf ./icons ${{targets.destdir}}/harbor/icons

      # Generate API
      swagger generate server --template-dir=tools/swagger/templates --exclude-main --additional-initialism=CVE --additional-initialism=GC --additional-initialism=OIDC -f api/v2.0/swagger.yaml -A harbor --target src/server/v2.0

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: ./src

  - uses: go/build
    with:
      packages: ./core
      output: harbor-core
      modroot: ./src
      deps: github.com/go-openapi/errors github.com/go-openapi/runtime

  - runs: ln -sf /usr/bin/harbor-core ${{targets.destdir}}/harbor/harbor_core

  - uses: strip

subpackages:
  - name: ${{package.name}}-harbor-core-iamguarded-compat
    dependencies:
      runtime:
        - ${{package.name}}
        # Required by startup scripts
        - bash
        - busybox
        - coreutils
        - posix-libc-utils
      provides:
        - harbor-core-iamguarded-compat=${{package.full-version}}
    description: "Iamguarded compat for Harbor core"
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-core
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p /opt/iamguarded
          mkdir -p /iamguarded
          mkdir -p /opt/iamguarded/harbor-core/bin
          mkdir -p /opt/iamguarded/harbor-core/etc/core

          # Access needed during runtime
          chmod g+rwX /opt/iamguarded
          chmod g+rwX /iamguarded
          ln -sf /usr/bin/harbor-core /opt/iamguarded/harbor-core/bin/harbor-core
          ln -sf /harbor/harbor_core /opt/iamguarded/harbor-core/bin/harbor-core

          # Disable some commands used in iamguarded scripts. These commands more likely fail in this since this image take non root approach
          sed -i 's/ensure_user_exists/# ensure_user_exists/g' /opt/iamguarded/scripts/harbor-core/postunpack.sh
          sed -i 's/chown -R "$HARBOR_CORE_DAEMON_USER" "$dir"/# chown -R "$HARBOR_CORE_DAEMON_USER" "$dir"/g' /opt/iamguarded/scripts/harbor-core/postunpack.sh

          /opt/iamguarded/scripts/harbor-core/postunpack.sh
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-core
          version: ${{vars.major-minor-version}}
    test:
      environment:
        accounts:
          groups:
            - groupname: harbor
              gid: 1001
          users:
            - username: harbor
              gid: 1001
              uid: 1001
          run-as: 0
        contents:
          packages:
            - ${{package.name}}
            - wait-for-it
            - shadow
            - sudo
            - redis
            - postgresql
            - postgresql-client
            - tini
            - ini-file
        environment:
          BITNAMI_APP_NAME: harbor-core
          # PostgreSQL configuration
          HARBOR_DATABASE_DBNAME: registry
          HARBOR_DATABASE_HOST: 127.0.0.1
          HARBOR_DATABASE_PORT: "5432"
          HARBOR_DATABASE_USERNAME: postgres
          HARBOR_DATABASE_PASSWORD: postgres
          HARBOR_DATABASE_SSLMODE: disable
          # Redis configuration
          _REDIS_URL_CORE: redis://127.0.0.1:6379/0
          _REDIS_URL_REG: redis://127.0.0.1:6379/1
          # Core service configuration
          CORE_URL: http://127.0.0.1:8080
          CORE_LOCAL_URL: http://127.0.0.1:8080
          EXT_ENDPOINT: http://127.0.0.1:8080
          PORTAL_URL: http://127.0.0.1:8080
          REGISTRY_URL: http://127.0.0.1:5000
          REGISTRYCTL_URL: http://127.0.0.1:8082
          JOBSERVICE_URL: http://127.0.0.1:8081
          TOKEN_SERVICE_URL: http://127.0.0.1:8080/service/token
          CFG_EXPIRATION: "5"
          CORE_SECRET: core-secret-test
          JOBSERVICE_SECRET: jobservice-secret-test
          # CORE_KEY is required - 16 character key for encryption
          CORE_KEY: "0123456789abcdef"
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-core-iamguarded-compat
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-core
            version: ${{vars.major-minor-version}}
        - name: "Test entrypoint files"
          runs: |
            stat /opt/iamguarded/scripts/harbor-core/entrypoint.sh
            stat /opt/iamguarded/scripts/harbor-core/run.sh
        - name: "Test binaries"
          runs: |
            stat /opt/iamguarded/harbor-core/bin/harbor-core
            /opt/iamguarded/harbor-core/bin/harbor-core -h
        - name: "Start redis instance"
          runs: |
            redis-server --daemonize yes > /dev/null 2>&1
            wait-for-it -t 10 127.0.0.1:6379
        - name: "Start postgresql instance"
          runs: |
            id -u postgres >/dev/null 2>&1 || useradd postgres
            sudo -u postgres initdb -D /tmp/test_db
            sudo -u postgres pg_ctl -D /tmp/test_db -l /tmp/logfile \
              -o "-c listen_addresses=127.0.0.1" start
            wait-for-it -t 10 127.0.0.1:5432
            sudo -u postgres createdb -h 127.0.0.1 -p 5432 registry
        - name: "Setup core configuration files"
          runs: |
            # Create the key file at the iamguarded compat path
            mkdir -p /opt/iamguarded/harbor-core/etc/core
            echo -n "0123456789abcdef" > /opt/iamguarded/harbor-core/etc/core/key
            chmod 600 /opt/iamguarded/harbor-core/etc/core/key

            # Also create at /etc/core as setup.sh expects files there
            mkdir -p /etc/core

            # Create the key file
            echo -n "0123456789abcdef" > /etc/core/key
            chmod 600 /etc/core/key

            # Create minimal app.conf for harbor-core using printf to avoid YAML parsing issues
            printf '%s\n' \
              "appname = Harbor" \
              "runmode = prod" \
              "enablegzip = true" \
              "httpport = 8080" \
              "" \
              "[dev]" \
              "httpport = 8080" \
              "" \
              "[prod]" \
              "httpport = 8080" \
              > /etc/core/app.conf
        - name: run entrypoint
          uses: test/daemon-check-output
          with:
            # Using tini to properly forward signals to the child process
            # otherwise test/daemon-check-output doesn't forward SIGTERM and it hangs
            start: /sbin/tini -s -- bash -x /opt/iamguarded/scripts/harbor-core/entrypoint.sh /opt/iamguarded/scripts/harbor-core/run.sh
            timeout: 60
            # Harbor core requires full infrastructure (registry, jobservice, etc.) to be
            # fully functional. In test environment, we validate that the entrypoint scripts
            # execute correctly and the service attempts to start.
            error_strings: |
              FAIL
              FATAL
              Traceback.*most.recent.call
              Exception in thread
              java.lang.NullPointerException
              java.lang.RuntimeException
              Gem::MissingSpecError
              command not found
            expected_output: |
              Validating Core settings...
              harbor-core setup finished!
            post: |
              # Harbor core requires the full Harbor ecosystem (registry, jobservice,
              # portal, etc.) to respond on HTTP endpoints. In isolation, the setup
              # and configuration validation complete successfully but HTTP endpoints
              # may not be available without the full orchestration.
              true

  - name: ${{package.name}}-jobservice
    description: harbor jobservice
    dependencies:
      provides:
        - harbor-jobservice=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          packages: ./jobservice
          output: harbor-jobservice
          modroot: ./src
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/harbor
          ln -sf /usr/bin/harbor-jobservice ${{targets.subpkgdir}}/harbor/harbor_jobservice
    test:
      pipeline:
        - runs: |
            # jobservice fails outside environment, verify adaptor for harbor registered
            /harbor/harbor_jobservice 2>/dev/null | grep "harbor registered"

  - name: ${{package.name}}-jobservice-iamguarded-compat
    description: "compat package with iamguarded harbor-jobservice image"
    dependencies:
      provides:
        - harbor-jobservice-iamguarded-compat=${{package.full-version}}
      runtime:
        - ${{package.name}}-jobservice
        - bash
        - bash-binsh
        - busybox
        - coreutils
        - curl
        - yq
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-jobservice
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p /opt/iamguarded/harbor-jobservice/bin/
          chmod g+rwX /opt/iamguarded
          ln -sf /usr/bin/harbor-jobservice /opt/iamguarded/harbor-jobservice/bin/harbor-jobservice
      - name: Install config
        runs: |
          mkdir -p ${{targets.subpkgdir}}/etc/jobservice
          curl -L -o ${{targets.subpkgdir}}/etc/jobservice/config.yml https://raw.githubusercontent.com/chainguard-dev/iamguarded-containers/refs/heads/main/bitnami/harbor-jobservice/${{vars.major-version}}/debian-12/config/jobservice/config.yml
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-jobservice
          version: ${{vars.major-minor-version}}
    test:
      environment:
        accounts:
          groups:
            - groupname: iamguarded
              gid: 1001
          users:
            - username: iamguarded
              gid: 1001
              uid: 1001
          run-as: 0
        contents:
          packages:
            - ${{package.name}}
            - yq
            - wait-for-it
            - redis
            - postgresql-16
            - postgresql-16-client
            - shadow
            - sudo
            - tini
        environment:
          BITNAMI_APP_NAME: harbor-jobservice
          JOB_SERVICE_PROTOCOL: http
          JOB_SERVICE_PORT: "8081"
          JOB_SERVICE_HOST: localhost
          JOB_SERVICE_POOL_WORKERS: "1"
          JOB_SERVICE_POOL_BACKEND: redis
          CORE_URL: http://localhost:8080
          # Harbor core configuration
          _REDIS_URL_CORE: redis://localhost:6379/0
          _REDIS_URL_HARBOR: redis://localhost:6379/1
          POSTGRESQL_HOST: localhost
          POSTGRESQL_PORT: "5432"
          POSTGRESQL_USERNAME: postgres
          POSTGRESQL_PASSWORD: postgres
          POSTGRESQL_DATABASE: registry
          POSTGRESQL_SSLMODE: disable
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-jobservice-iamguarded-compat
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-jobservice
            version: ${{vars.major-minor-version}}
        - name: "Start redis instance"
          runs: |
            redis-server --daemonize yes > /dev/null 2>&1
            wait-for-it -t 10 localhost:6379
        - name: "Start postgresql instance"
          runs: |
            useradd postgres
            sudo -u postgres initdb -D /tmp/test_db
            sudo -u postgres pg_ctl -D /tmp/test_db -l /tmp/logfile start
            wait-for-it -t 10 localhost:5432
            sudo -u postgres createdb registry
        - name: run entrypoint
          uses: test/daemon-check-output
          with:
            # I know its a bit messy but this is only we can do it, otherwise test/daemon-check-output
            # doesn't forward the SIGTERM to the child process started by harbor-core, and it hangs forever
            # in the post step; so we used tini in the start command instead of setup.
            start: /sbin/tini -s -- sh -c 'cd /harbor && ./harbor_core & exec bash -x /opt/iamguarded/scripts/harbor-jobservice/entrypoint.sh /opt/iamguarded/scripts/harbor-jobservice/run.sh'
            timeout: 60
            expected_output: |
              Validating harbor-jobservice settings
              harbor-jobservice setup finished
            post: |
              # In a real Harbor deployment, Jobservice's HTTP API is enabled and exposed only
              # when running under full orchestration (docker-compose or Kubernetes) with mounted
              # configuration files (such as conf/app.conf) and coordinated startup with Harbor Core
              # and Registry. In the melange packaging test environment, Jobservice runs in a minimal
              # worker mode where setup and configuration validation complete successfully, but no
              # HTTP listener is started by design.
              true

  - name: ${{package.name}}-portal
    description: harbor portal
    dependencies:
      provides:
        - harbor-portal=${{package.full-version}}
      runtime:
        - ${{package.name}}-portal-nginx-config
        - nginx
        - render-template
    pipeline:
      - runs: |
          # Copy over swagger configuration
          cp api/v2.0/swagger.yaml src/portal/swagger.yaml
          cd src/portal

          # Build portal
          npm install --unsafe-perm
          npm run generate-build-timestamp
          node --max_old_space_size=2048 'node_modules/@angular/cli/bin/ng' build --configuration production

          # Generate swagger.json
          npm install js-yaml@4.1.0
          node -e "const yaml = require('js-yaml'); const fs = require('fs'); const swagger = yaml.load(fs.readFileSync('swagger.yaml', 'utf8')); fs.writeFileSync('swagger.json', JSON.stringify(swagger));"

          # Copy license
          cp ../../LICENSE dist

          # Build swagger UI
          cd app-swagger-ui
          npm install --unsafe-perm
          npm run build
          cd ../

          # Install
          mkdir -p ${{targets.subpkgdir}}/usr/share/nginx/html
          cp -rf dist/* ${{targets.subpkgdir}}/usr/share/nginx/html
          cp swagger.json ${{targets.subpkgdir}}/usr/share/nginx/html
          cp -rf app-swagger-ui/dist/* ${{targets.subpkgdir}}/usr/share/nginx/html
    test:
      environment:
        contents:
          packages:
            - curl
            - shadow
      pipeline:
        - runs: |
            useradd nginx
            # The endpoint created by nginx is forbidden in CI
            nginx -g "daemon off;" & sleep 5; kill $! 2>&1

  - name: ${{package.name}}-portal-nginx-config
    description: nginx config for harbor portal
    dependencies:
      provides:
        - harbor-portal-nginx-config=${{package.full-version}}
        - nginx-config=0.${{package.full-version}}
    pipeline:
      - runs: |
          # Copy nginx config
          mkdir -p ${{targets.subpkgdir}}/etc/nginx
          # Apply configuration changes to /etc/nginx/nginx.conf before copying to package.
          # This allows the iamguarded-compat package to access the modified config as well.
          cp src/portal/docker-build/nginx.conf.example /etc/nginx/nginx.conf
          # Default error logs to stderr
          sed -i 's/#error_log  logs\/error.log;$/error_log  stderr  notice;/' /etc/nginx/nginx.conf
          # And access logs to stdout
          sed -i 's/#access_log.*;$/access_log  \/dev\/stdout;/' /etc/nginx/nginx.conf
          cp -rf /etc/nginx/* ${{targets.subpkgdir}}/etc/nginx/

  - name: ${{package.name}}-portal-iamguarded-compat
    description: "compat package with iamguarded harbor-portal image"
    dependencies:
      provides:
        - harbor-portal-iamguarded-compat=${{package.full-version}}
      runtime:
        - ${{package.name}}-portal
        - bash
        - coreutils
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-portal
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p /opt/iamguarded/harbor/nginx-conf
          cp -r /etc/nginx/* /opt/iamguarded/harbor/nginx-conf/
          chmod g+rwX /opt/iamguarded

          /opt/iamguarded/scripts/nginx/postunpack.sh
          /opt/iamguarded/scripts/harbor-portal/postunpack.sh

          mkdir -p /opt/iamguarded/nginx/sbin
          ln -sf /usr/sbin/nginx /opt/iamguarded/nginx/sbin/nginx

          # /opt/iamguarded/harbor is expected to have portal content
          rm -rf /opt/iamguarded/harbor
          ln -sf /usr/share/nginx/html /opt/iamguarded/harbor
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-portal
          version: ${{vars.major-minor-version}}
    test:
      environment:
        accounts:
          groups:
            - groupname: nginx
              gid: 101
          users:
            - username: nginx
              gid: 101
              uid: 101
          run-as: 0
        contents:
          packages:
            - shadow
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-portal-iamguarded-compat
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-portal
            version: ${{vars.major-minor-version}}
        - uses: test/daemon-check-output
          with:
            start: /opt/iamguarded/scripts/harbor-portal/entrypoint.sh /opt/iamguarded/scripts/nginx/run.sh
            expected_output: |
              Starting harbor-portal setup
              harbor-portal setup finished
              Starting NGINX
            post: |
              #!/bin/sh -e
              # cannot test further without full harbor setup
              curl localhost:8080 | grep "harbor-app"

  - name: ${{package.name}}-registryctl
    description: harbor registryctl
    dependencies:
      provides:
        - harbor-registryctl=${{package.full-version}}
      runtime:
        - harbor-registry
    pipeline:
      - uses: go/build
        with:
          packages: ./registryctl
          output: harbor-registryctl
          modroot: ./src
          tags: include_oss,include_gcs
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/etc/registryctl
          mkdir -p ${{targets.subpkgdir}}/harbor
          ln -sf /usr/bin/harbor-registryctl ${{targets.subpkgdir}}/harbor/harbor_registryctl
    test:
      pipeline:
        - runs: |
            harbor-registryctl --help

  - name: ${{package.name}}-redis-compat
    description: Compat package for running redis with harbor
    dependencies:
      provides:
        - harbor-redis-compat=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mkdir -p ${{targets.subpkgdir}}/etc

          cp ./make/photon/redis/docker-healthcheck ${{targets.subpkgdir}}/usr/bin/
          cp ./make/photon/redis/redis.conf ${{targets.subpkgdir}}/etc/
    test:
      pipeline:
        - runs: |
            set -e
            stat /usr/bin/docker-healthcheck
            stat /etc/redis.conf

  - name: ${{package.name}}-exporter
    description: harbor exporter
    dependencies:
      provides:
        - harbor-exporter=${{package.full-version}}
      runtime:
        - bash-binsh
        - grep
    pipeline:
      - uses: go/build
        with:
          packages: ./cmd/exporter
          output: harbor_exporter
          modroot: ./src
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/harbor
          ln -sf /usr/bin/harbor_exporter ${{targets.subpkgdir}}/harbor/harbor_exporter
          install -Dm755 make/photon/exporter/entrypoint.sh ${{targets.subpkgdir}}/harbor/
          install -Dm755 make/photon/common/install_cert.sh ${{targets.subpkgdir}}/harbor/
    test:
      pipeline:
        - runs: test "$(readlink /harbor/harbor_exporter)" = "/usr/bin/harbor_exporter"
        - name: "Test entrypoint /harbor/entrypoint.sh"
          runs: |
            stat /harbor/entrypoint.sh
            test -x /harbor/entrypoint.sh
        - name: "Test exporter"
          uses: test/daemon-check-output
          with:
            start: harbor_exporter
            timeout: 15
            # Overriding error strings as it needs a real Harbor registry to be up and running
            error_strings: |
              FAIL
              FATAL
              Error
            expected_output: |
              artifact annotation version v1alpha1 registered
              Registering database: type-PostgreSQL

  - name: ${{package.name}}-prepare
    description: Harbor prepare - configuration generator for Harbor deployment
    dependencies:
      provides:
        - harbor-prepare=${{package.full-version}}
      runtime:
        - apache2-utils
        # entrypoint script needs busybox because it uses /usr/bin/which, also needs bash
        - bash
        - busybox
        - openssl
        - py${{vars.python-version}}-click
        - py${{vars.python-version}}-jinja2
        - py${{vars.python-version}}-packaging
        - py${{vars.python-version}}-setuptools
        - py${{vars.python-version}}-pyyaml
        - python-${{vars.python-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/src/app"
          mkdir -p "${{targets.subpkgdir}}/harbor_make"
          cp -rf ./make/photon/prepare/* "${{targets.subpkgdir}}/usr/src/app/"
    test:
      pipeline:
        - uses: test/tw/contains-files
          with:
            files: /usr/src/app/main.py
        - runs: |
            cd /usr/src/app && python3 main.py --help | grep -F "Commands"
        - uses: test/tw/pip-check

  # Sub-package to serve harbor-registry/distribution version from goharbor/distribution repo(Harbor's Fork for distribution)
  # To be updated when the drift check fails.
  # If the drift check test fails, this means that the upstream images no longer use older Distribution version and have succesfully migrated to using the next release branch.
  - name: ${{package.name}}-photon-registry
    description: harbor registry custom package built using Distribution v2.8.3
    dependencies:
      provides:
        - harbor-photon-registry=${{package.full-version}}
    pipeline:
      - name: "Drift Check"
        runs: |
          # https://github.com/goharbor/harbor/blob/main/Makefile#L113
          grep -qF "REGISTRY_SRC_TAG=release/${{vars.harbor-distribution-release-branch}}" Makefile
      - name: "Add entrypoint scripts to match upstream"
        runs: |
          # As per upstream: https://github.com/goharbor/harbor/blob/v2.14.1/make/photon/registry/Dockerfile#L5-L6
          # This script basically triggers option install_cert.sh script which will be skipped if the OS is not Photon and run registry binary
          mkdir -p ${{targets.subpkgdir}}/home/harbor
          cp ./make/photon/common/install_cert.sh ${{targets.subpkgdir}}/home/harbor/install_cert.sh
          cp ./make/photon/registry/entrypoint.sh ${{targets.subpkgdir}}/home/harbor/entrypoint.sh
      - uses: git-checkout
        with:
          repository: https://github.com/goharbor/distribution
          branch: release/${{vars.harbor-distribution-release-branch}}
          expected-commit: ${{vars.harbor-distribution-expected-commit}} # needs to be updated with each package release
      - name: "Build"
        runs: |
          # distribution v2.8.3 does not have go.mod file and therefore, it's not supported by Melange's go/build pipelines
          set -eux
          # GOPATH-style build
          # We can't use melange's go/build pipeline because it primarily requires go.mod file which does not exist in source code for Distribution v2.8.3
          install_dir="${{targets.subpkgdir}}/usr/bin"
          mkdir -p "${install_dir}"

          # Set up GOPATH structure for old-style Go build
          # GOPATH is already configured, create symlink to expected location
          mkdir -p ${GOPATH}/src/github.com/docker
          ln -sf $(pwd) ${GOPATH}/src/${DISTRIBUTION_PKG}

          # As per upstream: https://github.com/goharbor/distribution/blob/release/2.8/Makefile#L5-L6
          REVISION=$(git rev-parse HEAD)$(if ! git diff --no-ext-diff --quiet --exit-code; then echo .m; fi)
          VERSION=$(git describe --match 'v[0-9]*' --dirty='.m' --always)

          GO111MODULE="off" go build \
            -tags "include_oss,include_gcs" \
            -ldflags "-w -X ${DISTRIBUTION_PKG}/version.Version=${VERSION} -X ${DISTRIBUTION_PKG}/version.Revision=${REVISION} -X ${DISTRIBUTION_PKG}/version.Package=${DISTRIBUTION_PKG}" \
            -o "${install_dir}/harbor-registry" \
            ./cmd/registry
      - uses: strip
      - name: "Add components for registry"
        runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mkdir -p ${{targets.subpkgdir}}/etc/registry
          # Create compatibility symlink for legacy registry binary name
          ln -sf /usr/bin/harbor-registry ${{targets.subpkgdir}}/usr/bin/registry_DO_NOT_USE_GC
          # Use example config as registry config
          cp ./cmd/registry/config-example.yml ${{targets.subpkgdir}}/etc/registry/config.yml
    test:
      environment:
        contents:
          packages:
            - curl
            - wait-for-it
      pipeline:
        - name: "Basic checks"
          runs: |
            # Basic version and help validation
            harbor-registry --version | grep -qF ${{vars.custom-distribution-version}}
            harbor-registry --help | grep -qF "Available Commands"

            # Test compatibility symlink
            [ "$(readlink -f /usr/bin/registry_DO_NOT_USE_GC)" = "/usr/bin/harbor-registry" ]
            registry_DO_NOT_USE_GC --version | grep -q ${{vars.custom-distribution-version}}
            registry_DO_NOT_USE_GC --help | grep -q "Available Commands"
        - name: "Check Entrypoint files"
          runs: |
            stat /home/harbor/install_cert.sh
            stat /home/harbor/entrypoint.sh
        - uses: test/daemon-check-output
          with:
            start: "harbor-registry serve /etc/registry/config.yml"
            expected_output: |
              level=info
              service=registry
              listening on
            post: |
              set -o pipefail
              wait-for-it localhost:5000 -t 10
              curl -fsSL -I localhost:5000 | grep -q "HTTP/1.1 200"

  - name: ${{package.name}}-adapter-trivy
    description: Use Trivy as a plug-in vulnerability scanner in the Harbor registry
    dependencies:
      runtime:
        - harbor-scanner-trivy
      provides:
        - harbor-trivy-adapter=${{package.full-version}}

  - name: ${{package.name}}-adapter-trivy-iamguarded
    description: Iamguarded compat for ${{package.name}}-adapter-trivy
    dependencies:
      runtime:
        - ${{package.name}}-adapter-trivy
        - trivy
        - bash
        - bash-binsh
        - busybox
        - coreutils
        - procps
      provides:
        - harbor-adapter-trivy-iamguarded=${{package.full-version}}
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-adapter-trivy
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/opt/iamguarded/harbor-adapter-trivy/bin/
          mkdir -p ${{targets.subpkgdir}}/iamguarded/harbor-adapter-trivy/.cache/reports
          mkdir -p ${{targets.subpkgdir}}/iamguarded/harbor-adapter-trivy/.cache/trivy
          chmod g+rwX /opt/iamguarded
          ln -sf /usr/bin/scanner-trivy ${{targets.subpkgdir}}/opt/iamguarded/harbor-adapter-trivy/bin/scanner-trivy
          ln -sf /usr/bin/trivy ${{targets.subpkgdir}}/opt/iamguarded/harbor-adapter-trivy/bin/trivy
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-adapter-trivy
          version: ${{vars.major-minor-version}}
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-adapter-trivy-iamguarded
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-adapter-trivy
            version: ${{vars.major-minor-version}}
        - uses: test/daemon-check-output
          with:
            start: /opt/iamguarded/scripts/harbor-adapter-trivy/entrypoint.sh /opt/iamguarded/scripts/harbor-adapter-trivy/run.sh
            timeout: 30
            expected_output: |
              Starting harbor-adapter-trivy

  - name: ${{package.name}}-registry-iamguarded-compat
    description: Iamguarded Compat for Harbor-registry
    dependencies:
      provides:
        - harbor-registry-iamguarded-compat=${{package.full-version}}
      runtime:
        - ${{package.name}}-photon-registry
        - bash
        - bash-binsh
        - busybox
        - coreutils
        - curl
        - yq
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-registry
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p /opt/iamguarded/harbor-registry/bin/
          chmod g+rwX /opt/iamguarded
          ln -sf /usr/bin/harbor-registry ${{targets.subpkgdir}}/usr/bin/registry
          ln -sf /usr/bin/harbor-registry /opt/iamguarded/harbor-registry/bin/registry
          ln -sf /usr/bin/harbor-registry /opt/iamguarded/harbor-registry/bin/registry_DO_NOT_USE_GC
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-registry
          version: ${{vars.major-minor-version}}
    test:
      environment:
        accounts:
          groups:
            - groupname: harbor
              gid: 1001
          users:
            - username: harbor
              gid: 1001
              uid: 1001
          run-as: 0
        contents:
          packages:
            - ${{package.name}}
            - wait-for-it
            - curl
        environment:
          BITNAMI_APP_NAME: harbor-registry
          HARBOR_DATABASE_DBNAME: registry
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-registry-iamguarded-compat
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-registry
            version: ${{vars.major-minor-version}}
        - name: run entrypoint
          uses: test/daemon-check-output
          with:
            start: bash -x /opt/iamguarded/scripts/harbor-registry/entrypoint.sh /opt/iamguarded/scripts/harbor-registry/run.sh
            timeout: 60
            expected_output: |
              INFO
              service=registry
              listening on
            post: |
              set -o pipefail
              wait-for-it localhost:5000 -t 10
              curl -fsSL -I localhost:5000 | grep -q "HTTP/1.1 200"

  - name: ${{package.name}}-exporter-iamguarded-compat
    description: "compat package with iamguarded harbor-exporter image"
    dependencies:
      provides:
        - harbor-exporter-iamguarded-compat=${{package.full-version}}
      runtime:
        - ${{package.name}}-exporter
        - bash
        - bash-binsh
        - busybox
        - coreutils
        - curl
        - yq
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: harbor-exporter
          version: ${{vars.major-minor-version}}
      - runs: |
          mkdir -p /opt/iamguarded/harbor-exporter/bin/
          chmod g+rwX /opt/iamguarded
          ln -sf /usr/bin/harbor-exporter /opt/iamguarded/harbor-exporter/bin/harbor-exporter
      - uses: iamguarded/finalize-compat
        with:
          package: harbor-exporter
          version: ${{vars.major-minor-version}}
    test:
      environment:
        accounts:
          groups:
            - groupname: harbor
              gid: 1001
          users:
            - username: harbor
              gid: 1001
              uid: 1001
          run-as: 0
        contents:
          packages:
            - ${{package.name}}
            - wait-for-it
            - shadow
            - sudo
            - redis
            - postgresql-16
            - postgresql-16-client
            - prometheus
        environment:
          BITNAMI_APP_NAME: harbor-exporter
          HARBOR_DATABASE_DBNAME: registry
          HARBOR_DATABASE_HOST: 127.0.0.1
          HARBOR_DATABASE_PORT: "5432"
          HARBOR_DATABASE_USERNAME: postgres
          HARBOR_DATABASE_SSLMODE: disable
          HARBOR_REDIS_URL: redis://127.0.0.1:6379/0
          HARBOR_SERVICE_HOST: 127.0.0.1
          HARBOR_SERVICE_PORT: "8080"
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: harbor-exporter-iamguarded-compat
            real-pkg-name: ${{subpkg.name}}
        - uses: iamguarded/test-compat
          with:
            package: harbor-exporter
            version: ${{vars.major-minor-version}}
        - name: "Start redis instance"
          runs: |
            redis-server --daemonize yes > /dev/null 2>&1
            wait-for-it -t 10 localhost:6379
        - name: "Start postgresql instance"
          runs: |
            id -u postgres >/dev/null 2>&1 || useradd postgres
            sudo -u postgres initdb -D /tmp/test_db
            sudo -u postgres pg_ctl -D /tmp/test_db -l /tmp/logfile \
              -o "-c listen_addresses=127.0.0.1" start
            wait-for-it -t 10 127.0.0.1:5432
            sudo -u postgres createdb -h 127.0.0.1 -p 5432 registry
        - name: run entrypoint
          uses: test/daemon-check-output
          with:
            start: bash -x /opt/iamguarded/scripts/harbor-exporter/entrypoint.sh /opt/iamguarded/scripts/harbor-exporter/run.sh
            timeout: 60
            # When we do call :9090, exporter throws some logs like:
            # "[ERROR] DB failure" those errors are expected as we don't
            # have real Harbor running with database fully populated. So
            # exclude the ERROR strings from the default error_strings list.
            error_strings: |
              FAIL
              FATAL
              Traceback.*most.recent.call
              Exception in thread
              java.lang.NullPointerException
              java.lang.RuntimeException
              Gem::MissingSpecError
              command not found
            expected_output: |
              Register database completed
              Starting harbor_exporter with port
            post: |
              set -euo pipefail
              wait-for-it -t 10 localhost:9090
              curl -sf http://localhost:9090/metrics | grep -iqF "harbor_statistics"

test:
  pipeline:
    - runs: |
        harbor-core --help

update:
  enabled: true
  ignore-regex-patterns:
    - "-rc"
    - "-beta"
  github:
    identifier: goharbor/harbor
    strip-prefix: v
    tag-filter-prefix: v2.14.
    use-tag: true
