package:
  name: harbor-2.14
  version: "2.14.1"
  epoch: 2
  description: An open source trusted cloud native registry project that stores, signs, and scans content
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - harbor=${{package.full-version}}

# To be updated as upstream harbor distribution requirements, when drift check fails for harbor-distribution subpackage.
vars:
  custom-distribution-version: 2.8.3
  harbor-distribution-release-branch: 2.8

environment:
  contents:
    packages:
      - nginx-config
      - nodejs
      - npm
      - py3-setuptools
      - python3
      - swagger<0.33
  environment:
    CGO_ENABLED: "0"
    DISTRIBUTION_PKG: "github.com/goharbor/distribution"
    DISTRIBUTION_DIR: "/usr/lib/go/src/github.com/goharbor/distribution"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/goharbor/harbor
      tag: v${{package.version}}
      expected-commit: f1393edcdb24f734f9dd77f5b18895deff0d1f1b

  - runs: |
      # Fixes CVE-2025-24358, can not use go/bump block doing so from modroot of dependency breaks build.
      sed -i 's|\(github.com/gorilla/csrf \)v1\.7\.2|\1v1.7.3|' src/go.mod

      mkdir -p ${{targets.destdir}}/harbor
      # Copy views, migrations, and icons
      cp -rf ./src/core/views ${{targets.destdir}}/harbor/views
      cp -rf ./make/migrations ${{targets.destdir}}/harbor/migrations
      cp -rf ./icons ${{targets.destdir}}/harbor/icons

      # Generate API
      swagger generate server --template-dir=tools/swagger/templates --exclude-main --additional-initialism=CVE --additional-initialism=GC --additional-initialism=OIDC -f api/v2.0/swagger.yaml -A harbor --target src/server/v2.0

  - uses: go/build
    with:
      packages: ./core
      output: harbor-core
      modroot: ./src
      deps: github.com/go-openapi/errors github.com/go-openapi/runtime

  - runs: ln -sf /usr/bin/harbor-core ${{targets.destdir}}/harbor/harbor_core

  - uses: strip

subpackages:
  # Sub-package to serve harbor-registry/distribution version from goharbor/distribution repo(Harbor's Fork for distribution)
  # To be updated when the drift check fails.
  # If the drift check test fails, this means that the upstream images no longer use older Distribution version and have succesfully migrated to using the next release branch.
  - name: ${{package.name}}-distribution
    description: harbor registry custom package built using Distribution v2.8.3
    dependencies:
      provides:
        - harbor-distribution=${{package.full-version}}
    pipeline:
      - name: "Drift Check"
        runs: |
          # https://github.com/goharbor/harbor/blob/main/Makefile#L113
          grep -qF "REGISTRYVERSION=v${{vars.harbor-distribution-release-branch}}" Makefile
      - uses: git-checkout
        with:
          repository: https://github.com/goharbor/distribution
          branch: release/${{vars.harbor-distribution-release-branch}}
          expected-commit: 0c62ec3ec8df7ea91c819448236a67f0777f929f # needs to be updated with each package release
      - runs: |
          # Adds source modules to $GOPATH
          mkdir -p "${DISTRIBUTION_DIR}"
          cp -rf . "${DISTRIBUTION_DIR}"
      - runs: |
          set -eux
          # GOPATH-style build
          # We can't use melange's go/build pipeline because it primarily requires go.mod file which does not exist in source code for Distribution v2.8.3
          install_dir="${{targets.subpkgdir}}/usr/bin"
          mkdir -p "${install_dir}"

          cd "${DISTRIBUTION_DIR}"
          # Copy vendored dependencies to GOPATH so Go can find them
          # The vendor directory uses old-style vendoring that's incompatible with newer Go
          cp -r vendor/* /usr/lib/go/src/
          rm -rf vendor

          GO111MODULE="off" go build \
            -tags "include_oss,include_gcs" \
            -ldflags "-w -X ${DISTRIBUTION_DIR}/version.Version=${{vars.custom-distribution-version}} -X ${DISTRIBUTION_DIR}/version.Revision=$(git rev-parse --short HEAD) -X ${DISTRIBUTION_DIR}/version.Package=${DISTRIBUTION_PKG}" \
            -o "${install_dir}/harbor-registry" \
            ./cmd/registry
      - uses: strip
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mkdir -p ${{targets.subpkgdir}}/etc/registry

          # Create compatibility symlink for legacy registry binary name
          ln -sf /usr/bin/harbor-registry ${{targets.subpkgdir}}/usr/bin/registry_DO_NOT_USE_GC
          # Use example config as registry config
          cp ./cmd/registry/config-example.yml ${{targets.subpkgdir}}/etc/registry/config.yml
    test:
      environment:
        contents:
          packages:
            - curl
            - wait-for-it
      pipeline:
        - name: "Basic checks"
          runs: |
            # Basic version and help validation
            harbor-registry --version | grep -qF ${{vars.custom-distribution-version}}
            harbor-registry --help | grep -qF "Available Commands"

            # Test compatibility symlink
            [ "$(readlink -f /usr/bin/registry_DO_NOT_USE_GC)" = "/usr/bin/harbor-registry" ]
            registry_DO_NOT_USE_GC --version | grep -q ${{vars.custom-distribution-version}}
            registry_DO_NOT_USE_GC --help | grep -q "Available Commands"
        - uses: test/daemon-check-output
          with:
            start: "harbor-registry serve /etc/registry/config.yml"
            expected_output: |
              level=info
              service=registry
              listening on
            post: |
              set -o pipefail
              wait-for-it localhost:5000 -t 10
              curl -fsSL -I localhost:5000 | grep -q "HTTP/1.1 200"

test:
  pipeline:
    - runs: |
        harbor-core --help

update:
  enabled: true
  ignore-regex-patterns:
    - "-rc"
    - "-beta"
  github:
    identifier: goharbor/harbor
    strip-prefix: v
    tag-filter-prefix: v2.14.
    use-tag: true
