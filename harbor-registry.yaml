package:
  name: harbor-registry
  version: "3.0.0"
  epoch: 9 # CVE-2025-47907
  description: An open source trusted cloud native registry project that stores, signs, and scans content (registry)
  copyright:
    - license: Apache-2.0

environment:
  environment:
    DISTRIBUTION_DIR: "/usr/lib/go/src/github.com/docker/distribution"
    CGO_ENABLED: "0"
    GO111MODULE: "auto"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/distribution/distribution
      tag: v${{package.version}}
      expected-commit: 9ed95e7365224025ee89365e12cf128e1f1bf965

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/net@v0.38.0

  - runs: |
      # Adds source modules to $GOPATH
      mkdir -p "${DISTRIBUTION_DIR}"
      cp -rf . "${DISTRIBUTION_DIR}"

  - uses: go/build
    with:
      packages: ./cmd/registry
      output: harbor-registry
      tags: include_oss,include_gcs
      ldflags: -X github.com/distribution/distribution/v3/version.version=${{package.version}}

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/etc/registry

      # Create compatibility symlink for legacy registry binary name
      ln -sf /usr/bin/harbor-registry ${{targets.destdir}}/usr/bin/registry_DO_NOT_USE_GC
      # Use example config as registry config
      cp ./cmd/registry/config-example.yml ${{targets.destdir}}/etc/registry/config.yml

test:
  environment:
    contents:
      packages:
        - curl
        - procps
        - wait-for-it
  pipeline:
    - runs: |
        # Basic version and help validation
        harbor-registry --version | grep ${{package.version}}
        harbor-registry --help | grep "Available Commands"

        # Test compatibility symlink
        [ "$(readlink -f /usr/bin/registry_DO_NOT_USE_GC)" = "/usr/bin/harbor-registry" ]
        registry_DO_NOT_USE_GC --version | grep ${{package.version}}
        registry_DO_NOT_USE_GC --help | grep "Available Commands"
    - uses: test/daemon-check-output
      with:
        start: "harbor-registry serve /etc/registry/config.yml"
        expected_output: |
          level=info
          service=registry
        post: |
          wait-for-it localhost:5000 -t 10
          curl -fsSL -I localhost:5000 | grep "HTTP/1.1 200"

update:
  enabled: true
  github:
    identifier: distribution/distribution
    strip-prefix: v
  ignore-regex-patterns:
    - ".*alpha.*"
    - ".*beta.*"
    - ".*rc.*"
