package:
  name: headlamp-plugin-flux
  version: "0.4.0"
  epoch: 0
  description: Flux plugin for Headlamp that provides a way to visualize Flux resources.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - nodejs

environment:
  contents:
    packages:
      - busybox
      - nodejs
      - npm

var-transforms:
  - from: ${{package.version}}
    match: '^(.+)$'
    replace: 'flux-$1'
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/headlamp-k8s/plugins
      tag: ${{vars.mangled-package-version}}
      expected-commit: fb090a0ee368bae009a05408ab0652a0c58b86d4

  - runs: |
      cd flux
      npm ci
      npm run build
      mkdir -p "${{targets.destdir}}"/plugins
      cp -r dist/* "${{targets.destdir}}"/plugins/

  - uses: strip

update:
  enabled: true
  manual: true
  github:
    identifier: headlamp-k8s/plugins
    strip-prefix: v
    use-tag: true
    strip-suffix: -.*

test:
  pipeline:
    - name: "Test headlamp flux plugin"
      runs: |
        grep -q '"name": "@headlamp-k8s/flux"' /plugins/package.json
        test -f /plugins/package.json
