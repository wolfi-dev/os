package:
  name: hurl
  version: "6.1.1"
  epoch: 0
  description: "Hurl is a command-line tool that runs HTTP requests defined in a simple plain text format"
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cargo-auditable
      - curl-dev
      - libxml2-dev
      - openssl-dev
      - pkg-config
      - pkgconf
      - rust

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Orange-OpenSource/hurl
      tag: ${{package.version}}
      expected-commit: 376b7e0e45a4a5fa7c5c7d3a2b4a564498bb854e

  - uses: patch$
    with:
      patches: 0001-Replace-deprecated-libxml2-initGenericErrorDefaultFu.patch

  - name: Build
    runs: |
      cargo auditable build --release

      mkdir -p ${{targets.destdir}}/usr/bin/

      cp target/release/hurl ${{targets.destdir}}/usr/bin/
      cp target/release/hurlfmt ${{targets.destdir}}/usr/bin/

  - uses: strip

update:
  enabled: true
  github:
    identifier: Orange-OpenSource/hurl

test:
  environment:
    contents:
      packages:
        - ca-certificates-bundle
  pipeline:
    - name: "Version and help check"
      runs: |
        hurl --version
        hurl --help
        hurlfmt --version
        hurlfmt --help
    - name: "Basic HTTP request test"
      runs: |
        # Create a simple Hurl file
        cat > test.hurl << 'EOF'
        GET https://example.org
        HTTP/1.1 200
        [Asserts]
        header "Content-Type" == "text/html; charset=UTF-8"
        EOF

        # Run the test
        hurl --test test.hurl
    - name: "Test hurlfmt"
      runs: |-
        # Create a simple Hurl file
        cat > format-test.hurl << 'EOF'
        GET   https://example.org
        HTTP/1.1 200
        EOF

        # Format the file
        hurlfmt format-test.hurl > formatted.hurl

        # Check that formatting was applied
        cat formatted.hurl
