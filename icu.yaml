package:
  name: icu
  version: "75.1"
  epoch: 6
  description: "International Components for Unicode library"
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - icu-libs

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
  environment:
    ICU_DATA_FILTER_FILE: "./data-filter-en.json"

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: '-'
    to: dash-package-version
  - from: ${{package.version}}
    match: \.
    replace: _
    to: underscore-package-version
  - from: ${{package.version}}
    match: ^(\d+).*
    replace: $1
    to: major-version

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/unicode-org/icu/releases/download/release-${{vars.dash-package-version}}/icu4c-${{vars.underscore-package-version}}-src.tgz
      expected-sha256: cb968df3e4d2e87e8b11c49a5d01c787bd13b9545280fc6642f826527618caef
      strip-components: 0

  - runs: |
      # JSON-ified version of https://git.alpinelinux.org/aports/plain/main/icu/data-filter-en.yml?id=8db8f1a746ebc18ac3b56c91ed14224e424f57ec
      echo '{"localeFilter":{"filterType":"locale","includeChildren":false,"includelist":["en_US","en_GB"]},"featureFilters":{"brkitr_dictionaries":"exclude","brkitr_rules":{"filterType":"regex","excludelist":["^.*_cj$"]},"coll_tree":{"filterType":"language","includelist":["be","cs","de","el","en","es","ff","fr","ha","hu","ig","it","kk","ms","nl","pl","pt","ro","ru","tr","uk","xh","zu"]},"conversion_mappings":"exclude","stringprep":{"excludelist":["rfc3722","rfc3920node","rfc3920res"]}},"resourceFilters":[{"categories":["coll_tree"],"rules":["-/collations/emoji","-/collations/private-unihan"]},{"categories":["translit"],"rules":["-/","+/%%Parent","+/%%ALIAS","+/*/ASCII-Latin","+/*/Latin-ASCII","+/*/Accents-Any","+/*/Any-Accents","+/*/Publishing-Any","+/*/Any-Publishing","+/*/Cyrillic-Latin","+/*/Cyrl-Latn","+/*/Latin-Cyrillic","+/*/Latn-Cyrl","+/*/Greek-Latin","+/*/Grek-Latn","+/*/Greek-Latin/BGN","+/*/el-el_Latn/BGN","+/*/Latin-Greek","+/*/Latn-Grek","+/*/Russian-Latin/BGN","+/*/ru-ru_Latn/BGN","+/*/Latin-Russian/BGN","+/*/ru_Latn-ru/BGN","+/*/Ukrainian-Latin/BGN","+/*/uk-uk_Latn/BGN","+/*/de-ASCII","+/*/de-t-de-d0-ascii"]}],"collationUCAData":"implicithan"}' > ./icu/source/data-filter-en.json

  - uses: autoconf/configure
    with:
      dir: icu/source
      opts: |
        --sysconfdir=/etc \
        --with-data-packaging=archive \
        --disable-samples \
        --enable-static \
        --mandir=/usr/share/man

  - uses: autoconf/make
    with:
      dir: icu/source

  - uses: autoconf/make-install
    with:
      dir: icu/source

  - uses: strip

subpackages:
  - name: icu-dev
    description: icu development headers
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - icu
    test:
      pipeline:
        - runs: |
            icu-config --version
            icu-config --help
        - uses: test/pkgconf

  - name: icu-libs
    description: International Components for Unicode library (libs)
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          for ll in 'libicudata' 'libicui18n' 'libicuio' 'libicuuc'; do
            mv ${{targets.destdir}}/usr/lib/"$ll".so.* ${{targets.contextdir}}/usr/lib/
          done
    dependencies:
      runtime:
        - icu-data-full
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})

  - name: icu-data-full
    description: Full ICU data
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share/icu/${{package.version}}
          mv ${{targets.destdir}}/usr/share/icu/${{package.version}}/icudt${{vars.major-version}}l.dat ${{targets.contextdir}}/usr/share/icu/${{package.version}}/

  - name: icu-doc
    description: icu docs
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

# switch back to this once the GitHub release stops saying pre-release
# github:
#   identifier: unicode-org/icu
#   strip-prefix: release-
update:
  enabled: true
  manual: true # ICU updates contain ABI breaking changes which require manual intervention
  version-transform:
    - match: \-
      replace: .
  release-monitor:
    identifier: 16134

# test:
#   pipeline:
#     # AUTOGENERATED
test:
  environment:
    contents:
      packages:
        - bash
        - coreutils
  pipeline:
    - runs: |
        derb --version
        genbrk --help
        gencfu --help
        gencnval --help
        gendict --help
        icuexportdata --version
        icuinfo --version
        makeconv --version
        uconv --version
        genccode --version
        gencmn version
        gensprep --help
        icupkg --help
        derb --help
        icuexportdata --help
        icuinfo --help
        uconv --help
        genccode --help
        gencmn help
        gensprep version
    - name: "Test basic character conversion"
      runs: |
        # Test UTF-8 to ASCII conversion with skip callback
        echo "Hello" | uconv -f UTF-8 -t ASCII
        # Test round-trip conversion
        echo "Test" | uconv -f UTF-8 -t UTF-16LE | uconv -f UTF-16LE -t UTF-8
    - name: "Test ICU resource bundle compilation"
      runs: |
        cat > test.txt << 'EOF'
        root:table{
          hello { "Hello!" }
        }
        EOF
        genrb -d . test.txt
    - name: "Test transliteration rules"
      runs: |
        # Test basic Latin transliteration
        echo "Hello" | uconv -x any-latin
    - name: "Verify default locale and encoding"
      runs: |
        icuinfo | grep "locale.default"
        icuinfo | grep "converter.default" | grep "UTF-8"
