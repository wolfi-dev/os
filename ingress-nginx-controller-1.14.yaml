#nolint:valid-pipeline-fetch-digest,valid-pipeline-git-checkout-commit,valid-pipeline-git-checkout-tag
package:
  name: ingress-nginx-controller-1.14
  version: "1.14.1"
  # There are manual changes to review between each package update. See 'vars:' section.
  epoch: 0
  description: "Ingress-NGINX Controller for Kubernetes"
  copyright:
    - license: Apache-2.0
  resources:
    cpu: 16
    memory: 16Gi
  dependencies:
    provides:
      - ingress-nginx-controller=${{package.full-version}}
    runtime:
      - brotli
      - ca-certificates
      - ca-certificates-bundle
      - dumb-init-privileged-netbindservice
      - gd
      - libcrypt1
      - libmaxminddb
      - libxml2
      - libxslt
      - lua-cjson
      - lua-resty-balancer
      - lua-resty-cache
      - lua-resty-cookie
      - lua-resty-core
      - lua-resty-dns
      - lua-resty-global-throttle
      - lua-resty-http
      - lua-resty-ipmatcher
      - lua-resty-lock
      - lua-resty-memcached
      - lua-resty-redis
      - lua-resty-string
      - lua-resty-upload
      - luajit
      - merged-usrsbin
      - mimalloc
      - modsecurity
      - msgpack
      - openssl
      - openssl-dev
      - pcre
      - ssdeep
      - wolfi-baselayout
      - yaml-cpp

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - autoconf
      - automake
      - bash
      - bison
      - brotli-dev
      - busybox
      - c-ares-dev
      - ca-certificates
      - ca-certificates-bundle
      - clang-15
      - cmake
      - curl
      - curl-dev
      - doxygen
      - findutils
      - flex
      - gcc
      - gd-dev
      - git
      - glibc-dev
      - go
      - grpc
      - grpc-dev
      - icu-dev
      - libaio-dev
      - libcap
      - libcap-utils
      - libedit-dev
      - libmaxminddb-dev
      - libsrt
      - libtool
      - libxml2
      - libxml2-dev
      - libxslt-dev
      - linux-headers
      - lmdb-dev
      - lmdb-tools
      - lua-cjson
      - lua-resty-balancer
      - lua-resty-cache
      - lua-resty-cookie
      - lua-resty-core
      - lua-resty-dns
      - lua-resty-global-throttle
      - lua-resty-http
      - lua-resty-ipmatcher
      - lua-resty-lock
      - lua-resty-memcached
      - lua-resty-redis
      - lua-resty-string
      - lua-resty-upload
      - luajit
      - luajit-dev
      - make
      - mercurial
      - mimalloc
      - modsecurity
      - msgpack
      - openssh-client
      - openssl
      - openssl-dev
      - opentelemetry-cpp-dev
      - patch
      - pcre-dev
      - perl-dev
      - pkgconf
      - protobuf-dev
      - python3
      - re2-dev
      - scanelf
      - ssdeep
      - systemd-dev
      - util-linux
      - wget
      - wolfi-base
      - yajl-dev
      - yaml-cpp
      - zeromq-dev
      - zlib-dev

var-transforms:
  - from: ${{package.version}}
    match: ^(\d+\.\d+)\.\d+$
    replace: "$1"
    to: nginx-ingress-major-minor

vars:
  # These environment variables need updated for each new release. Retrieve their
  # correct values from here, replacing <package-version> with the package version.
  #   - https://github.com/kubernetes/ingress-nginx/blob/controller-v<package-version>/images/nginx/rootfs/build.sh
  # A script will validate the melange yaml values against upstream info; watch the early build logs for warnings.
  # On occasion, these versions may be bumped ahead of upstream (above link), to
  # remediate vulnerabilities.
  # NOTE: When updating this, the hardcoded string downstream in images-private
  # also needs to be updated: https://github.com/chainguard-images/images-private/blob/ea364a2ecc436c035765d3b45564f8597cf9b09a/images/ingress-nginx-controller/main.tf#L14
  NGINX_VERSION: "1.27.1"
  NDK_VERSION: "0.3.3"
  SETMISC_VERSION: "0.33"
  MORE_HEADERS_VERSION: "0.37"
  NGINX_DIGEST_AUTH: "1.0.0"
  OWASP_MODSECURITY_CRS_VERSION: "4.15.0"
  LUA_NGX_VERSION: "0.10.29"
  LUA_STREAM_NGX_VERSION: "0.0.17.1rc1"
  LUA_UPSTREAM_VERSION: "0.07"
  GEOIP2_VERSION: "445df24ef3781e488cee3dfe8a1e111997fc1dfe"
  PKG: "k8s.io/ingress-nginx"
  # Does not do versioning, and repo is seldom updated. Grab the latest master
  # branch git commit SHA: https://github.com/google/ngx_brotli/commits/master
  NGX_BROTLI_SHA: "a71f9312c2deb28875acc7bacfdd5695a111aa53"
  # MODSECURITY_NGINX_VERSION in build.sh, then find the commit from the tag.
  # see https://github.com/owasp-modsecurity/ModSecurity-nginx/
  # This could be converted back to directly pulling the tag from the build.sh file, but finding and setting the commit
  # here and now will save you from having to update the expected-commit deep in this file.
  MODSECURITY_NGINX_VERSION: "3f4b57df10ce43b1f1c722141f7621dc64838be8"
  # Instrumentation for nginx plugin: https://github.com/open-telemetry/opentelemetry-cpp-contrib
  # NOTE: THIS IS REALLY REALLY REALLY CRITICAL AND THE CONFIG CAN BREAK IN BACKWARDS COMPATIBLE WAY!!
  # WE SHOULD ALWAYS USE THE SHA AVAILABLE IN RELEASE-X.Y BRANCH OF UPSTREAM PROJECT (e.g. https://github.com/kubernetes/ingress-nginx/blob/controller-v1.13.x/images/nginx/rootfs/build.sh#L528)
  OTEL_SHA: "8933841f0a7f8737f61404cf0a64acf6b079c8a5"
  NJS_VERSION: "0.9.0"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kubernetes/ingress-nginx
      tag: controller-v${{package.version}}
      expected-commit: e832d044efc57ccae15e93ea26a169f64238bf6b

  - name: Verify all the vars are up to date with the upstream
    runs: |
      # Extract and verify all versions from upstream build.sh file
      # https://github.com/kubernetes/ingress-nginx/blob/controller-v${{package.version}}/images/nginx/rootfs/build.sh

      for var_pair in \
        "NGINX_VERSION:${{vars.NGINX_VERSION}}" \
        "NDK_VERSION:${{vars.NDK_VERSION}}" \
        "SETMISC_VERSION:${{vars.SETMISC_VERSION}}" \
        "MORE_HEADERS_VERSION:${{vars.MORE_HEADERS_VERSION}}" \
        "NGINX_DIGEST_AUTH:${{vars.NGINX_DIGEST_AUTH}}" \
        "OWASP_MODSECURITY_CRS_VERSION:${{vars.OWASP_MODSECURITY_CRS_VERSION}}" \
        "LUA_NGX_VERSION:${{vars.LUA_NGX_VERSION}}" \
        "LUA_STREAM_NGX_VERSION:${{vars.LUA_STREAM_NGX_VERSION}}" \
        "LUA_UPSTREAM_VERSION:${{vars.LUA_UPSTREAM_VERSION}}" \
        "GEOIP2_VERSION:${{vars.GEOIP2_VERSION}}" \
        "NGX_BROTLI_SHA:${{vars.NGX_BROTLI_SHA}}" \
        "MODSECURITY_NGINX_VERSION:${{vars.MODSECURITY_NGINX_VERSION}}" \
        "OTEL_SHA:${{vars.OTEL_SHA}}" \
        "NJS_VERSION:${{vars.NJS_VERSION}}"; do

        var_name="${var_pair%:*}"
        expected_value="${var_pair#*:}"

        # Handle special cases with custom verification logic
        case "$var_name" in
          "NGX_BROTLI_SHA")
            # Get latest master commit from ngx_brotli repo
            upstream_value=$(curl -s https://api.github.com/repos/google/ngx_brotli/commits/master | grep '"sha"' | head -1 | cut -d'"' -f4)
            ;;
          "MODSECURITY_NGINX_VERSION")
            # Get MODSECURITY_VERSION tag from upstream build.sh, then resolve to commit SHA
            upstream_tag=$(grep "^export MODSECURITY_VERSION=" ./images/nginx/rootfs/build.sh | cut -d= -f2)
            # Use the tags API which includes commit info directly
            upstream_value=$(curl -s "https://api.github.com/repos/owasp-modsecurity/ModSecurity-nginx/tags" | grep -A5 "\"name\": \"$upstream_tag\"" | grep '"sha"' | cut -d'"' -f4)
            ;;
          "OTEL_SHA")
            # Extract OTEL_SHA from upstream build.sh using OPENTELEMETRY_CONTRIB_COMMIT variable
            upstream_value=$(grep "^export OPENTELEMETRY_CONTRIB_COMMIT=" ./images/nginx/rootfs/build.sh | cut -d= -f2)
            ;;
          "LUA_STREAM_NGX_VERSION")
            # Get commit SHA from upstream build.sh, then resolve to tag
            upstream_commit=$(grep "^export ${var_name}=" ./images/nginx/rootfs/build.sh | cut -d= -f2)
            # Find which tag contains this commit as an ancestor
            upstream_value=""
            for tag in $(curl -s "https://api.github.com/repos/openresty/stream-lua-nginx-module/tags" | grep '"name"' | head -10 | cut -d'"' -f4); do
              # Check if this commit is reachable from the tag (commit is ancestor of tag)
              compare_result=$(curl -s "https://api.github.com/repos/openresty/stream-lua-nginx-module/compare/$upstream_commit...$tag" 2>/dev/null)
              if echo "$compare_result" | grep -q '"status": "ahead"' || echo "$compare_result" | grep -q '"status": "identical"'; then
                # The tag contains this commit (either identical or tag is ahead)
                upstream_value=$(echo "$tag" | sed 's/^v//')
                break
              fi
            done
            ;;
          *)
            # Standard extraction from build.sh
            upstream_value=$(grep "^export ${var_name}=" ./images/nginx/rootfs/build.sh | cut -d= -f2)
            # Strip leading 'v' from upstream value if it's a version triple (x.y.z) or double (x.y)
            if echo "$upstream_value" | grep -q "^v[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?$"; then
              upstream_value="${upstream_value#v}"
            fi
            ;;
        esac

        if [ "$expected_value" != "$upstream_value" ]; then
          echo "WARNING: Expected $var_name: $expected_value from melange.yaml but found $upstream_value upstream" >&2
          # We avoid failing the build because sometimes we bump versions higher than upstream
          sleep 5 # To make it more noticeable
        fi
      done

  - uses: git-checkout
    with:
      repository: https://github.com/owasp-modsecurity/ModSecurity-nginx
      branch: master
      expected-commit: ${{vars.MODSECURITY_NGINX_VERSION}}
      destination: ModSecurity-nginx-${{vars.MODSECURITY_NGINX_VERSION}}
      depth: -1

  # need to retag the repo because we've made changes and the module builds based on the git tags
  - runs: git tag v${{package.version}}

  - uses: go/build
    with:
      packages: ${{vars.PKG}}/cmd/dbg
      output: nginx-dbg
      ldflags: -X ${{vars.PKG}}/version.RELEASE=controller-v${{package.version}} -X ${{vars.PKG}}/version.COMMIT=$(git rev-parse --short HEAD) -X ${{vars.PKG}}/version.REPO=$(git config --get remote.origin.url)

  - uses: go/build
    with:
      packages: ${{vars.PKG}}/cmd/waitshutdown
      output: waitshutdown
      ldflags: -X ${{vars.PKG}}/version.RELEASE=controller-v${{package.version}} -X ${{vars.PKG}}/version.COMMIT=$(git rev-parse --short HEAD) -X ${{vars.PKG}}/version.REPO=$(git config --get remote.origin.url)

  - uses: go/build
    with:
      packages: ${{vars.PKG}}/cmd/nginx
      output: nginx-ingress-controller
      ldflags: -X ${{vars.PKG}}/version.RELEASE=controller-v${{package.version}} -X ${{vars.PKG}}/version.COMMIT=$(git rev-parse --short HEAD) -X ${{vars.PKG}}/version.REPO=$(git config --get remote.origin.url)

  - uses: fetch
    with:
      uri: https://nginx.org/download/nginx-${{vars.NGINX_VERSION}}.tar.gz
      expected-sha256: bd7ba68a6ce1ea3768b771c7e2ab4955a59fb1b1ae8d554fedb6c2304104bdfc
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/simpl/ngx_devel_kit/archive/v${{vars.NDK_VERSION}}.tar.gz
      expected-sha256: faa2fcd5168b10764d35081356511d5f84db5c526a1aa4b6add2db94b6853b2b
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/openresty/set-misc-nginx-module/archive/v${{vars.SETMISC_VERSION}}.tar.gz
      expected-sha256: cd5e2cc834bcfa30149e7511f2b5a2183baf0b70dc091af717a89a64e44a2985
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/openresty/headers-more-nginx-module/archive/v${{vars.MORE_HEADERS_VERSION}}.tar.gz
      expected-sha256: cf6e169d6b350c06d0c730b0eaf4973394026ad40094cddd3b3a5b346577019d
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/openresty/lua-nginx-module/archive/v${{vars.LUA_NGX_VERSION}}.tar.gz
      expected-sha256: ca2c2122b909529bf9d1a89e9a5763835a2bd2629def8cb279c550f638f0a78f
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/openresty/stream-lua-nginx-module/archive/v${{vars.LUA_STREAM_NGX_VERSION}}.tar.gz
      expected-sha256: cdcbafc9b97810cde3ca1a820d293082b44e013f59f5f425b1547422b5491a37
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/openresty/lua-upstream-nginx-module/archive/v${{vars.LUA_UPSTREAM_VERSION}}.tar.gz
      expected-sha256: 2a69815e4ae01aa8b170941a8e1a10b6f6a9aab699dee485d58f021dd933829a
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/atomx/nginx-http-auth-digest/archive/v${{vars.NGINX_DIGEST_AUTH}}.tar.gz
      expected-sha256: f09851e6309560a8ff3e901548405066c83f1f6ff88aa7171e0763bd9514762b
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/leev/ngx_http_geoip2_module/archive/${{vars.GEOIP2_VERSION}}.tar.gz
      expected-sha256: 5e2113ed09cdd710908df8c6d1630616eeacb9216ef8705a06c25733394ddf28
      strip-components: 0

  - uses: fetch
    with:
      uri: https://github.com/nginx/njs/archive/${{vars.NJS_VERSION}}.tar.gz
      expected-sha256: 7b0446f0b3e0b63b57883e0464d883f0ac4eab82ec7746599d37563dc6808203
      strip-components: 0

  - runs: |
      git clone https://github.com/google/ngx_brotli.git
      cd ngx_brotli
      git checkout ${{vars.NGX_BROTLI_SHA}}
      git submodule init
      git submodule update

  - name: Build NGINX
    runs: |
      export BUILD_PATH="${PWD}"
      echo "BUILD_PATH $BUILD_PATH"
      echo "Arch: $(uname -m)"
      # improve compilation times
      CORES=$(($(grep -c ^processor /proc/cpuinfo) - 1))

      export LUAJIT_LIB="$(pkgconf --variable=libdir luajit)"
      export LUAJIT_INC="$(pkgconf --variable=includedir luajit)"
      export LUA_LIB_DIR="$LUAJIT_LIB/lua"
      ln -s "$LUAJIT_INC" /usr/include/lua
      export LUA_INCLUDE_DIR=/usr/include/luajit-2.1
      ln -s $LUA_INCLUDE_DIR /usr/include/lua5.1
      ARCH=$(uname -m)

      ls -lah ${BUILD_PATH}/lua-nginx-module-${{vars.LUA_NGX_VERSION}}

      mkdir -p ${{targets.destdir}}/etc/nginx/

      # Lua code copied into the target
      cp -ar rootfs/etc/nginx/. ${{targets.destdir}}/etc/nginx/

      # Download owasp modsecurity crs
      cd ${{targets.destdir}}/etc/nginx/

      git clone -b v${{vars.OWASP_MODSECURITY_CRS_VERSION}} https://github.com/coreruleset/coreruleset owasp-modsecurity-crs
      cd owasp-modsecurity-crs

      # The OWASP portion was sourced from the following link and should be periodically checked for changes.
      # https://github.com/kubernetes/ingress-nginx/blob/controller-v1.13.0/images/nginx/rootfs/build.sh#L376-L411
      mv crs-setup.conf.example crs-setup.conf
      mv rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
      mv rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
      cd ..

      # OWASP CRS v4 rules
      echo "
      Include /etc/nginx/owasp-modsecurity-crs/crs-setup.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-901-INITIALIZATION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-905-COMMON-EXCEPTIONS.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-911-METHOD-ENFORCEMENT.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-913-SCANNER-DETECTION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-921-PROTOCOL-ATTACK.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-922-MULTIPART-ATTACK.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-934-APPLICATION-ATTACK-GENERIC.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-944-APPLICATION-ATTACK-JAVA.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-950-DATA-LEAKAGES.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-955-WEB-SHELLS.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-959-BLOCKING-EVALUATION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf
      Include /etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
      " > ${{targets.destdir}}/etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf


      echo "::::::::::::::::::::::::::::::::::::::"
      echo ":::: nginx-${{vars.NGINX_VERSION}} ::::"
      echo "::::::::::::::::::::::::::::::::::::::"

      # This portion was sourced from the following link and should be periodically checked for changes.
      # https://github.com/kubernetes/ingress-nginx/blob/controller-v1.14.0/images/nginx/rootfs/build.sh#L429-L524

      cd "$BUILD_PATH/nginx-${{vars.NGINX_VERSION}}"

      # Differs slightly from upstream to match our setup
      # apply nginx patches
      for PATCH in "$BUILD_PATH/images/nginx/rootfs/patches"/*.patch; do
        [ -f "$PATCH" ] || continue

        echo "Patch: $PATCH"
        case "$PATCH" in
          *.txt) patch -p0 < "$PATCH" || exit 1 ;;
          *)     patch -p1 < "$PATCH" || exit 1 ;;
        esac
      done

      WITH_FLAGS="--with-debug \
        --with-compat \
        --with-pcre-jit \
        --with-http_ssl_module \
        --with-http_stub_status_module \
        --with-http_realip_module \
        --with-http_auth_request_module \
        --with-http_addition_module \
        --with-http_gzip_static_module \
        --with-http_sub_module \
        --with-http_v2_module \
        --with-http_v3_module \
        --with-stream \
        --with-stream_ssl_module \
        --with-stream_realip_module \
        --with-stream_ssl_preread_module \
        --with-threads \
        --with-http_secure_link_module \
        --with-http_gunzip_module"

      # "Combining -flto with -g is currently experimental and expected to produce unexpected results."
      # https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html
      CC_OPT="-g -O2 -fPIE -fstack-protector-strong \
      -Wformat \
      -Werror=format-security \
      -Wno-deprecated-declarations \
      -fno-strict-aliasing \
      -D_FORTIFY_SOURCE=2 \
      --param=ssp-buffer-size=4 \
      -DTCP_FASTOPEN=23 \
      -fPIC \
      -Wno-cast-function-type \
      -Wno-error=unterminated-string-initialization"
      # The above unterminated string line is necessary to avoid a build failure

      LD_OPT="-fPIE -fPIC -pie -Wl,-z,relro -Wl,-z,now"

      if [[ ${ARCH} != "aarch64" ]]; then
        WITH_FLAGS="${WITH_FLAGS} --with-file-aio"
      fi

      if [[ ${ARCH} == "x86_64" ]]; then
        CC_OPT="${CC_OPT} -m64 -mtune=generic"
      fi

      WITH_MODULES=" \
        --add-module=${BUILD_PATH}/ngx_devel_kit-${{vars.NDK_VERSION}} \
        --add-module=${BUILD_PATH}/set-misc-nginx-module-${{vars.SETMISC_VERSION}} \
        --add-module=${BUILD_PATH}/headers-more-nginx-module-${{vars.MORE_HEADERS_VERSION}} \
        --add-module=${BUILD_PATH}/lua-nginx-module-${{vars.LUA_NGX_VERSION}} \
        --add-module=${BUILD_PATH}/stream-lua-nginx-module-${{vars.LUA_STREAM_NGX_VERSION}} \
        --add-module=${BUILD_PATH}/lua-upstream-nginx-module-${{vars.LUA_UPSTREAM_VERSION}} \
        --add-dynamic-module=${BUILD_PATH}/nginx-http-auth-digest-${{vars.NGINX_DIGEST_AUTH}} \
        --add-dynamic-module=${BUILD_PATH}/ModSecurity-nginx-${{vars.MODSECURITY_NGINX_VERSION}} \
        --add-dynamic-module=${BUILD_PATH}/ngx_http_geoip2_module-${{vars.GEOIP2_VERSION}} \
        --add-dynamic-module=${BUILD_PATH}/ngx_brotli \
        --add-dynamic-module=${BUILD_PATH}/njs-${{vars.NJS_VERSION}}/nginx"

      echo "::::::::::::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: Configuring nginx-${{vars.NGINX_VERSION }} ::::"
      echo "::::::::::::::::::::::::::::::::::::::::::::::::::"

      # Note: The prefix line differs from upstream
      ./configure \
        --prefix=/usr \
        --conf-path=/etc/nginx/nginx.conf \
        --modules-path=/etc/nginx/modules \
        --http-log-path=/var/log/nginx/access.log \
        --error-log-path=/var/log/nginx/error.log \
        --lock-path=/run/nginx.lock \
        --pid-path=/run/nginx.pid \
        --http-client-body-temp-path=/var/lib/nginx/body \
        --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \
        --http-proxy-temp-path=/var/lib/nginx/proxy \
        --http-scgi-temp-path=/var/lib/nginx/scgi \
        --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
        ${WITH_FLAGS} \
        --without-mail_pop3_module \
        --without-mail_smtp_module \
        --without-mail_imap_module \
        --without-http_uwsgi_module \
        --without-http_scgi_module \
        --with-cc-opt="${CC_OPT}" \
        --with-ld-opt="${LD_OPT}" \
        --user=www-data \
        --group=www-data \
        ${WITH_MODULES}

      echo "::::::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: MAKE nginx-${{vars.NGINX_VERSION }} ::::"
      echo "::::::::::::::::::::::::::::::::::::::::::::"
      make -j$(nproc)

      echo ":::::::::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: MODULES nginx-${{vars.NGINX_VERSION }}  ::::"
      echo ":::::::::::::::::::::::::::::::::::::::::::::::::"
      make DESTDIR="${{targets.destdir}}" modules

      echo "::::::::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: INSTALL nginx-${{vars.NGINX_VERSION }} ::::"
      echo "::::::::::::::::::::::::::::::::::::::::::::::"
      make DESTDIR="${{targets.destdir}}" install

      mkdir -p ${{targets.destdir}}/usr/bin
      mv ${{targets.destdir}}/usr/sbin/nginx ${{targets.destdir}}/usr/bin/
      rm -rf ${{targets.destdir}}/usr/html
      rm -rf ${{targets.destdir}}/usr/sbin

      echo "::::::::::::::::::::::::::::::::::::::::::::"
      echo ":::::::::::::::: CLEANUP :::::::::::::::::::"
      echo "::::::::::::::::::::::::::::::::::::::::::::"

      echo "Clean up owasp-modsecurity-crs"
      rm -rf ${{targets.destdir}}/etc/nginx/owasp-modsecurity-crs/.git
      rm -rf ${{targets.destdir}}/etc/nginx/owasp-modsecurity-crs/util/regression-tests
      rm -rf ${{targets.destdir}}/etc/nginx/owasp-modsecurity-crs/tests

  - uses: strip

  - runs: |
      echo "::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: SETCAP NGINX CONTROLLER           ::::"
      echo "::::::::::::::::::::::::::::::::::::::::::"

      setcap cap_net_bind_service=+ep ${{targets.destdir}}/usr/bin/nginx-ingress-controller \
      && setcap -v cap_net_bind_service=+ep ${{targets.destdir}}/usr/bin/nginx-ingress-controller

      echo "::::::::::::::::::::::::::::::::::::::::::"
      echo ":::: SETCAP NGINX                      ::::"
      echo "::::::::::::::::::::::::::::::::::::::::::"

      setcap cap_net_bind_service=+ep ${{targets.destdir}}/usr/bin/nginx \
        && setcap -v cap_net_bind_service=+ep ${{targets.destdir}}/usr/bin/nginx

subpackages:
  - name: ingress-nginx-controller-iamguarded-compat-${{vars.nginx-ingress-major-minor}}
    description: Compatibility package with iamguarded nginx-ingress-controller image
    dependencies:
      provides:
        - ingress-nginx-controller-iamguarded-compat=${{package.full-version}}
      runtime:
        - bash # https://github.com/bitnami/charts/blob/db53e622ecf1be5a78d1ce683cec8baa41110fa3/bitnami/nginx-ingress-controller/templates/controller-deployment.yaml#L89
        - coreutils
        - curl
        - findutils
        - gmp
        - gnutls
        - grep
        - ingress-nginx-controller-compat-${{vars.nginx-ingress-major-minor}} # We depend on generic compat because it ships some symlinks that also Bitnami needs, like symlinks to /nginx-ingress-controller, /dev/stdout and /dev/stderr.
        - libffi
        #- libhogweed6 missing pkg/so # https://github.com/bitnami/containers/blob/942861e0cea74a6a07bceafb299180a2733c0bfe/bitnami/nginx-ingress-controller/1/debian-12/Dockerfile#L29
        - libmaxminddb-dev
        - librtmp
        - libssh
        - libtasn1
        - merged-usrsbin
        - nettle
        - p11-kit
        - procps
        - sed
        - wolfi-baselayout
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: nginx-ingress-controller
          version: ${{vars.nginx-ingress-major-minor}}
      - name: Ensure symlinks
        runs: |
          mkdir -p /opt/iamguarded/common/bin
          ln -s /usr/bin/mmdblookup /opt/iamguarded/common/bin/mmdblookup
          ln -s /usr/lib /opt/iamguarded/common/lib
          ln -s /usr/include /opt/iamguarded/common/include
      - uses: iamguarded/finalize-compat
        with:
          package: nginx-ingress-controller
          version: ${{vars.nginx-ingress-major-minor}}
    test:
      environment:
        contents:
          packages:
            - libmaxminddb
            - ${{package.name}}
      pipeline:
        - uses: iamguarded/test-compat
          with:
            package: nginx-ingress-controller
            version: ${{vars.nginx-ingress-major-minor}}
        - uses: test/tw/ldd-check
        - name: Test symlinks
          runs: |
            set -e
            test -f $(readlink -f /opt/iamguarded/common/bin/mmdblookup)
            test -d $(readlink -f /opt/iamguarded/common/lib)
            test -d $(readlink -f /opt/iamguarded/common/include)
        - name: Run KwoK
          uses: test/kwok/cluster
        - name: Test entrypoint and controller logs
          uses: test/daemon-check-output
          with:
            start: |
              /nginx-ingress-controller --kubeconfig ~/.kube/config
            timeout: 30
            expected_output: |
              NGINX Ingress controller
              Release:       controller-v${{package.version}}
              nginx version: nginx/${{vars.NGINX_VERSION}}
              Running in Kubernetes cluster

  - name: ingress-nginx-controller-compat-${{vars.nginx-ingress-major-minor}}
    description: Compatibility package for ingress-nginx-controller
    dependencies:
      provides:
        - ingress-nginx-controller-compat=${{package.full-version}}
      runtime:
        - ingress-nginx-opentelemetry-plugin-${{vars.nginx-ingress-major-minor}}
        - merged-usrsbin
        - modsecurity-config
        - wolfi-baselayout
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/local/bin
          ln -s /usr/bin/nginx ${{targets.subpkgdir}}/usr/local/bin/nginx

          mkdir -p ${{targets.subpkgdir}}/usr/bin
          ln -s /usr/bin/nginx-ingress-controller ${{targets.subpkgdir}}/nginx-ingress-controller
          ln -s /usr/bin/waitshutdown ${{targets.subpkgdir}}/waitshutdown
          ln -s /usr/bin/nginx-dbg ${{targets.subpkgdir}}/dbg

          mkdir -p ${{targets.subpkgdir}}/etc/nginx/modsecurity
          ln -s /etc/modsecurity/modsecurity.conf-concurrent ${{targets.subpkgdir}}/etc/nginx/modsecurity/modsecurity.conf
          ln -s /etc/modsecurity/unicode.mapping ${{targets.subpkgdir}}/etc/nginx/modsecurity/unicode.mapping

          mkdir -p ${{targets.subpkgdir}}/var/log/nginx
          # Create symlinks to redirect nginx logs to stdout and stderr docker log collector
          ln -sf /dev/stdout ${{targets.subpkgdir}}/var/log/nginx/access.log
          ln -sf /dev/stderr ${{targets.subpkgdir}}/var/log/nginx/error.log

          # symlink to satisfy hard coded path to mimalloc
          # https://github.com/kubernetes/ingress-nginx/blob/8f54b538d9b32649411d9e507ca38fbee55ce51c/charts/ingress-nginx/templates/controller-daemonset.yaml#L99-L100
          mkdir -p ${{targets.subpkgdir}}/usr/local/lib
          ln -s /usr/lib/libmimalloc.so.1 ${{targets.subpkgdir}}/usr/local/lib/libmimalloc.so
    test:
      pipeline:
        - uses: test/tw/ldd-check

  # This is a maintained fork of the unmaintained
  # https://github.com/jet/kube-webhook-certgen/. We keep it as a
  # subpackage of ingress-nginx-controller since the one use
  # (kube-prometheus-stack charts) points to a hybrid tag of the
  # $ingress-nginx-$kube-webhook-certgen version.    # $ingress-nginx-$kube-webhook-certgen version.
  - name: kube-webhook-certgen-${{vars.nginx-ingress-major-minor}}
    description: Tools to help with self signed cert generation for Kubernetes test environment
    dependencies:
      provides:
        - kube-webhook-certgen=${{package.full-version}}
      runtime:
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - uses: go/build
        with:
          ldflags: -X 'github.com/jet/kube-webhook-certgen/core.Version=v${{package.version}}'
          output: kube-webhook-certgen
          modroot: ./images/kube-webhook-certgen/rootfs
          packages: .
    test:
      pipeline:
        - runs: |
            /usr/bin/kube-webhook-certgen version

  - name: ingress-nginx-opentelemetry-plugin-${{vars.nginx-ingress-major-minor}}
    description: OTel plugin for ingress nginx controller ${{vars.nginx-ingress-major-minor}}
    dependencies:
      provides:
        - ingress-nginx-opentelemetry-plugin=${{package.full-version}}
      runtime:
        - grpc
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - name: Validate Open Telemetry version
        runs: |
          expected_sha=$(grep -E "^export OPENTELEMETRY_CONTRIB_COMMIT" images/nginx/rootfs/build.sh | awk -F '=' '{print $2}')
          [[ "${{vars.OTEL_SHA}}" == "${expected_sha}" ]] || \
            { echo "OTel version does not match. Expected ${expected_sha}, found ${{vars.OTEL_SHA}}"; exit 1; }
      - uses: git-checkout
        with:
          repository: https://github.com/open-telemetry/opentelemetry-cpp-contrib
          branch: main
          expected-commit: ${{vars.OTEL_SHA}}
          depth: -1
      - working-directory: instrumentation/nginx
        runs: |
          mkdir build
          cd build

          # This must be set to whatever ingress nginx is using
          cmake -DNGINX_VERSION=${{vars.NGINX_VERSION}} ..
          make

          # Copy over plugin
          mkdir -p ${{targets.contextdir}}/etc/nginx/modules
          cp -p otel_ngx_module.so ${{targets.contextdir}}/etc/nginx/modules/
      - uses: strip
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ingress-nginx-custom-error-pages-${{vars.nginx-ingress-major-minor}}
    description: Custom error pages for ingress nginx controller ${{vars.nginx-ingress-major-minor}}
    dependencies:
      provides:
        - ingress-nginx-custom-error-pages=${{package.full-version}}
      runtime:
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - working-directory: images/custom-error-pages/rootfs/
        pipeline:
          - runs: |
              mkdir -p ${{targets.contextdir}}/usr/bin
              mkdir -p /go/src/k8s.io/ingress-nginx/images/custom-error-pages
              cp -r * /go/src/k8s.io/ingress-nginx/images/custom-error-pages/
              cd /go/src/k8s.io/ingress-nginx/images/custom-error-pages
              go get . && \
              go build -o ${{targets.contextdir}}/usr/bin/nginx-errors .
    test:
      environment:
        contents:
          packages:
            - wait-for-it
            - curl
            - ingress-nginx-custom-error-pages-compat-${{vars.nginx-ingress-major-minor}}
      pipeline:
        - runs: |
            /usr/bin/nginx-errors > /dev/null 2>&1 &
            wait-for-it -t 10 localhost:8080

            # check healthz endpoint make sure it returns 200
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/healthz)

            if [ "$http_code" != "200" ]; then
              echo "Healthz endpoint returned $http_code"
              exit 1
            fi

            # I already checked that the following error exists in the upstream custom error pages image
            # unexpected error reading return code: strconv.Atoi: parsing "": invalid syntax. Using 404
            # serving custom error response for code 404 and format text/html from file /www/404.html
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)

            if [ "$http_code" != "404" ]; then
              echo "Custom error page did not return 404"
              exit 1
            fi

            # also check the message
            message=$(curl -s http://localhost:8080/)

            # Trim message (removes leading/trailing spaces & newlines)
            message=$(echo "$message" | tr -d '\n' | sed 's/^[ \t]*//;s/[ \t]*$//')

            if [[ "$message" != "<span>The page you're looking for could not be found.</span>" ]]; then
                echo "Custom error page did not return expected message"
                exit 1
            fi

  - name: ingress-nginx-custom-error-pages-compat-${{vars.nginx-ingress-major-minor}}
    description: OTel plugin for ingress nginx controller ${{vars.nginx-ingress-major-minor}}
    dependencies:
      provides:
        - ingress-nginx-custom-error-pages-compat=${{package.full-version}}
      runtime:
        - merged-usrsbin
        - wolfi-baselayout
    pipeline:
      - working-directory: images/custom-error-pages/rootfs/
        pipeline:
          - runs: |
              mkdir -p ${{targets.contextdir}}/www
              mkdir -p ${{targets.contextdir}}/etc/
              cp -r www/* ${{targets.contextdir}}/www/
              cp -r etc/* ${{targets.contextdir}}/etc/
              ln -sf /usr/bin/nginx-errors ${{targets.contextdir}}/nginx-errors
    test:
      pipeline:
        - runs: |
            ls -lah /www/404.html
            ls -lah /www/500.html
            ls -lah /www/404.json
            ls -lah /etc/mime.types

update:
  enabled: true
  manual: true
  github:
    identifier: kubernetes/ingress-nginx
    strip-prefix: controller-v
    tag-filter: "controller-v1.14"

test:
  environment:
    contents:
      packages:
        - ingress-nginx-controller-compat-${{vars.nginx-ingress-major-minor}}
        - libcap-utils
  pipeline:
    - runs: |
        /usr/bin/nginx -v
        /usr/bin/nginx-ingress-controller --version
        nginx -v
        nginx -h
        nginx-dbg --help
        nginx-ingress-controller --version
    - runs: |
        cat <<EOF > /etc/nginx/nginx.conf
        load_module /etc/nginx/modules/otel_ngx_module.so;

        events {}
        http {
          opentelemetry_operation_name otel_example;
          opentelemetry_ignore_paths ignored.php;
          server {
            listen 80;
            server_name otel_example;

            location = / {
              opentelemetry_operation_name my_example_backend;
              opentelemetry_propagate;
              proxy_pass http://localhost:3501/;
            }
          }
        }
        EOF

        # Not sure why this isn't included in main package.
        mkdir -p /var/lib/nginx/tmp/
        adduser -D -H -s /sbin/nologin www-data
    # -T: test the configuration file: nginx checks the configuration for correct syntax, and then tries to open files referred in the configuration.
    # additionally dump configuration files to standard output (1.9.2).
    - runs: nginx -T
    - name: Test opentelemetry_config directive
      runs: |
        touch empty
        cat <<"EOF" >/etc/nginx/nginx.conf
        pid /tmp/nginx/nginx.pid;
        load_module /etc/nginx/modules/otel_ngx_module.so;
        error_log stderr;
        events {}
        http {
        opentelemetry_config empty;
        }
        daemon off;
        EOF
        nginx -T 2>&1 | grep "Missing required exporter field"
    - uses: test/tw/ldd-check
    - name: Test file capabilities
      runs: |
        getcap /usr/bin/nginx-ingress-controller | cut -d ' ' -f2 | grep -q -E '^cap_net_bind_service=ep$'
        getcap /usr/bin/nginx | cut -d ' ' -f2 | grep -q -E '^cap_net_bind_service=ep$'
    - name: Run KwoK
      uses: test/kwok/cluster
    - name: Check controller logs
      uses: test/daemon-check-output
      with:
        start: |
          nginx-ingress-controller --kubeconfig ~/.kube/config
        timeout: 30
        expected_output: |
          NGINX Ingress controller
          Release:       controller-v${{package.version}}
          nginx version: nginx/${{vars.NGINX_VERSION}}
          Running in Kubernetes cluster
