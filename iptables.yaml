package:
  name: iptables
  version: 1.8.11
  epoch: 0
  description: Linux kernel firewall, NAT and packet mangling tools
  copyright:
    - license: GPL-2.0-or-later

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - flex
      - libcap-utils
      - libmnl-dev
      - libnftnl-dev
      - libtool
      - linux-headers
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.netfilter.org/iptables
      tag: v${{package.version}}
      expected-commit: 0506bea1dcc8f12d94e7c32bf2fb04abb3fdd269
      depth: "-1"

  - runs: |
      ./autogen.sh

  - runs: |
      export CFLAGS="$CFLAGS -D_GNU_SOURCE"
      ./configure \
        --build="$CBUILD" \
        --host="$CHOST" \
        --prefix=/usr \
        --mandir=/usr/share/man \
        --sbindir=/sbin \
        --sysconfdir=/etc \
        --without-kernel \
        --enable-devel \
        --enable-libipq \
        --enable-shared

      # do not use rpath
      sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
      sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/include/libiptc \
      "${{targets.destdir}}"/usr/lib \
      "${{targets.destdir}}"/var/lib/iptables \
      "${{targets.destdir}}"/etc/iptables

      install -m644 include/iptables.h include/ip6tables.h \
      "${{targets.destdir}}"/usr/include/
      install include/libiptc/*.h "${{targets.destdir}}"/usr/include/libiptc/

      install -D -m644 iptables.confd "${{targets.destdir}}"/etc/conf.d/iptables
      install -D -m644 ebtables.confd "${{targets.destdir}}"/etc/conf.d/ebtables

subpackages:
  - name: iptables-xtables-privileged
    description: iptables with cap_net_raw and cap_net_admin capabilities set for xtables
    options:
      no-provides: true
    pipeline:
      - runs: |
          cp -r ${{targets.destdir}} ${{targets.contextdir}}
          setcap cap_net_raw,cap_net_admin+eip ${{targets.contextdir}}/sbin/xtables-legacy-multi
          setcap cap_net_raw,cap_net_admin+eip ${{targets.contextdir}}/sbin/xtables-nft-multi
    test:
      environment:
        contents:
          packages:
            - libcap-utils
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})
        - name: Test file capabilities
          runs: |
            getcap /sbin/xtables-legacy-multi | cut -d ' ' -f2 | grep -q -E '^cap_net_raw,cap_net_admin+eip$'
            getcap /sbin/xtables-nft-multi | cut -d ' ' -f2 | grep -q -E '^cap_net_raw,cap_net_admin+eip$'

  - name: iptables-doc
    description: iptables documentation
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

  - name: iptables-dev
    description: iptables development files
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

  - name: ip6tables
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}
          cd "${{targets.subpkgdir}}"

          mkdir -p sbin \
            var/lib/ip6tables \
            usr/lib/xtables

          mv "${{targets.destdir}}"/sbin/ip6* sbin/
          mv "${{targets.destdir}}"/usr/lib/xtables/libip6* usr/lib/xtables/
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})
        - runs: |
            ip6tables --version
            ip6tables --help
            ip6tables-legacy --version
            ip6tables-legacy --help
            ip6tables-legacy-restore --version
            ip6tables-legacy-restore --help
            ip6tables-legacy-save --version
            ip6tables-nft --version
            ip6tables-nft --help
            ip6tables-nft-restore --version
            ip6tables-nft-restore --help
            ip6tables-nft-save --version
            ip6tables-restore --version
            ip6tables-restore --help
            ip6tables-restore-translate --version
            ip6tables-save --version
            ip6tables-translate --version
            ip6tables-translate --help

update:
  enabled: true
  release-monitor:
    identifier: 1394

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        arptables --version
        arptables-nft --version
        arptables-nft-restore --version
        arptables-nft-save --version
        arptables-restore --version
        arptables-save --version
        ebtables --version
        ebtables-nft --version
        ebtables-nft-restore version
        ebtables-nft-save --version
        ebtables-restore version
        ebtables-save --version
        ebtables-translate --version
        iptables --version
        iptables-legacy --version
        iptables-legacy-restore --version
        iptables-legacy-save --version
        iptables-nft --version
        iptables-nft-restore --version
        iptables-nft-save --version
        iptables-restore --version
        iptables-restore-translate --version
        iptables-save --version
        iptables-translate --version
        xtables-monitor --version
        iptables-xml --version
        arptables --help
        arptables-nft --help
        arptables-nft-restore --help
        arptables-restore --help
        ebtables-nft-restore help
        ebtables-restore help
        ebtables-translate --help
        iptables --help
        iptables-legacy --help
        iptables-legacy-restore --help
        iptables-nft --help
        iptables-nft-restore --help
        iptables-restore --help
        iptables-translate --help
    - uses: test/ldd-check
      with:
        packages: ${{package.name}}
