package:
  name: jaeger-2
  version: "2.14.1"
  epoch: 3
  description: Jaeger, a Distributed Tracing Platform
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - jaeger=${{package.full-version}}

var-transforms:
  - from: ${{package.version}}
    match: ^(\d+)\.\d+\.\d+$
    replace: "$1"
    to: major-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/jaegertracing/jaeger
      tag: v${{package.version}}
      expected-commit: 9173e343bfabb4ce8ff04d5b60c4d34058e5744a
      recurse-submodules: true

  - uses: go/bump
    with:
      deps: |-
        github.com/expr-lang/expr@v1.17.7

  - working-directory: jaeger-ui
    runs: |
      npm pkg set resolutions.react-icons=5.0.1

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - nodejs-24
      - npm

data:
  - name: jaeger-components
    items:
      anonymizer: "."
      es-index-cleaner: "."
      es-rollover: "."
      esmapping-generator: "."
      jaeger: "."
      remote-storage: "."
      tracegen: "."

subpackages:
  - range: jaeger-components
    name: "${{package.name}}-${{range.key}}"
    dependencies:
      provides:
        - jaeger-${{range.key}}=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          packages: ./cmd/${{range.key}}
          ldflags: -X github.com/jaegertracing/jaeger/internal/version.latestVersion=v${{package.version}} -X github.com/jaegertracing/jaeger/internal/version.commitSHA=$(git rev-parse HEAD) -X github.com/jaegertracing/jaeger/internal/version.date=$(date -u -d "@${SOURCE_DATE_EPOCH:-$(date +%s)}" "+%Y-%m-%dT%H:%M:%SZ")
          output: ${{range.key}}
    test:
      pipeline:
        - name: "basic binary check"
          runs: ${{range.key}} --help
        - name: "basic version check"
          runs: |
            COMPONENT="${{range.key}}"
            if [[ "$COMPONENT" != "es-index-cleaner" && "$COMPONENT" != "es-rollover" ]]; then
              echo "Checking version of ${{range.key}}"
              ${{range.key}} version 2>&1| grep ${{package.version}}
            fi
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: "jaeger-${{range.key}}"
            real-pkg-name: "${{subpkg.name}}"

  - range: jaeger-components
    name: "${{package.name}}-${{range.key}}-compat"
    dependencies:
      provides:
        - jaeger-${{range.key}}-compat=${{package.full-version}}
    description: "Compatibility package to place binaries in the location expected by upstream helm charts for all Jaeger components"
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/go/bin"
          ln -sf /usr/bin/${{range.key}} ${{targets.contextdir}}/go/bin/${{range.key}}-linux
    test:
      pipeline:
        - name: "verify compat binary is in place"
          runs: readlink -v /go/bin/${{range.key}}-linux
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: "jaeger-${{range.key}}-compat"
            real-pkg-name: "${{subpkg.name}}"

  - name: ${{package.name}}-iamguarded-compat
    description: "compat package with iamguarded jaeger image"
    dependencies:
      provides:
        - jaeger-iamguarded-compat=${{package.full-version}}
      runtime:
        - ${{package.name}}
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: jaeger
          version: ${{vars.major-version}}
      - runs: |
          mkdir -p /opt/iamguarded/jaeger/bin/
          chmod g+rwX /opt/iamguarded
          ln -sf /usr/bin/jaeger /opt/iamguarded/jaeger/bin/jaeger
      - uses: iamguarded/finalize-compat
        with:
          package: jaeger
          version: ${{vars.major-version}}
    test:
      pipeline:
        - uses: iamguarded/test-compat
          with:
            package: jaeger
            version: ${{vars.major-version}}

  - name: ${{package.name}}-iamguarded-cassandra-schema
    description: "Cassandra schema files for Jaeger"
    dependencies:
      provides:
        - jaeger-iamguarded-cassandra-schema=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/opt/iamguarded/jaeger/cassandra-schema
          cp -r internal/storage/v1/cassandra/schema/* "${{targets.contextdir}}"/opt/iamguarded/jaeger/cassandra-schema/
    test:
      pipeline:
        - name: Verify cassandra schema files
          runs: |
            stat /opt/iamguarded/jaeger/cassandra-schema/README.md
            stat /opt/iamguarded/jaeger/cassandra-schema/create.sh
            stat /opt/iamguarded/jaeger/cassandra-schema/docker.sh
            stat /opt/iamguarded/jaeger/cassandra-schema/v001.cql.tmpl
            stat /opt/iamguarded/jaeger/cassandra-schema/migration/v001tov002part1.sh

test:
  environment:
    contents:
      packages:
        - ${{package.name}}-anonymizer
        - ${{package.name}}-es-index-cleaner
        - ${{package.name}}-es-rollover
        - ${{package.name}}-esmapping-generator
        - ${{package.name}}-jaeger
        - ${{package.name}}-remote-storage
        - ${{package.name}}-tracegen
        - jq
  pipeline:
    - runs: |
        echo "hello"

update:
  enabled: true
  github:
    use-tag: true
    identifier: jaegertracing/jaeger
    strip-prefix: v
    tag-filter-prefix: v2
