package:
  name: jenkins-docker-agent
  version: "3309.v27b_9314fd1a_4-4"
  epoch: 0
  description: Jenkins agent script for connecting to Jenkins controllers
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - bash-binsh
      - openjdk-17-default-jvm

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/jenkinsci/docker-agent
      tag: ${{package.version}}
      expected-commit: f32936a960018fff98e7253eebda131d3ad37f42

  - runs: |
      # Create directory structure
      mkdir -p ${{targets.contextdir}}/usr/bin

      # Install the jenkins-agent script
      install -Dm755 jenkins-agent ${{targets.contextdir}}/usr/bin/jenkins-agent

      # Create backward compatibility symlink for jenkins-slave
      ln -sf /usr/bin/jenkins-agent ${{targets.contextdir}}/usr/bin/jenkins-slave

subpackages:
  - name: ${{package.name}}-compat
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/local/bin

          ln -sf /usr/bin/jenkins-agent ${{targets.contextdir}}/usr/local/bin/jenkins-agent
          ln -sf /usr/bin/jenkins-slave ${{targets.contextdir}}/usr/local/bin/jenkins-slave
    test:
      pipeline:
        - runs: |
            readlink -f /usr/local/bin/jenkins-agent | grep /usr/bin/jenkins-agent
            readlink -f /usr/local/bin/jenkins-slave | grep /usr/bin/jenkins-slave

test:
  pipeline:
    - name: "Check Jenkins agent script installation"
      runs: |
        if [ -x "/usr/bin/jenkins-agent" ]; then
          echo "Jenkins agent script is executable."
        else
          echo "Jenkins agent script is not executable!" && exit 1
        fi

        readlink -f /usr/bin/jenkins-slave | grep /usr/bin/jenkins-agent

update:
  enabled: true
  github:
    identifier: jenkinsci/docker-agent
