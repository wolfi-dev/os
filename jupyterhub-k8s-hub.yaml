package:
  name: jupyterhub-k8s-hub
  version: "4.3.1"
  epoch: 1
  description: Zero to JupyterHub with Kubernetes
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - configurable-http-proxy
      - iptables
      - py${{vars.py-version}}-jupyterhub
      - py${{vars.py-version}}-jupyterhub-firstuseauthenticator
      - py${{vars.py-version}}-jupyterhub-hmacauthenticator
      - py${{vars.py-version}}-jupyterhub-idle-culler
      - py${{vars.py-version}}-jupyterhub-kubespawner
      - py${{vars.py-version}}-jupyterhub-ldapauthenticator
      - py${{vars.py-version}}-jupyterhub-ltiauthenticator
      - py${{vars.py-version}}-jupyterhub-nativeauthenticator
      - py${{vars.py-version}}-jupyterhub-tmpauthenticator
      - py${{vars.py-version}}-kubernetes-asyncio
      - py${{vars.py-version}}-mwoauth
      - py${{vars.py-version}}-nullauthenticator
      - py${{vars.py-version}}-oauthenticator
      - py${{vars.py-version}}-psycopg2
      - py${{vars.py-version}}-pycurl
      - py${{vars.py-version}}-pyjwt
      - py${{vars.py-version}}-pymysql
      - py${{vars.py-version}}-python-dateutil
      - py${{vars.py-version}}-sqlalchemy-cockroachdb
      - py${{vars.py-version}}-statsd
      - py${{vars.py-version}}-tornado
      - python-${{vars.py-version}}
      - tini

vars:
  py-version: '3.13'

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/jupyterhub/zero-to-jupyterhub-k8s
      tag: ${{package.version}}
      expected-commit: b2cad68443c4e600cd97fea92f051220b0b836db

  - runs: |
      mkdir -p "${{targets.destdir}}"/etc/jupyterhub
      cp -r jupyterhub/files/hub/* "${{targets.destdir}}"/etc/jupyterhub/

  - uses: strip

subpackages:
  - name: ${{package.name}}-compat
    description: "Compatibility package to place binaries in the location expected by jupyterhub-k8s-hub"
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/local/etc/jupyterhub
          ln -sf /etc/jupyterhub/jupyterhub_config.py ${{targets.subpkgdir}}/usr/local/etc/jupyterhub/jupyterhub_config.py
          ln -sf /etc/jupyterhub/z2jh.py ${{targets.subpkgdir}}/usr/local/etc/jupyterhub/z2jh.py
    dependencies:
      runtime:
        - jupyterhub-k8s-hub
    # test added by a robot (compat)
    test:
      pipeline:
        - runs: |
            readlink -v /usr/local/etc/jupyterhub/jupyterhub_config.py
            readlink -v /usr/local/etc/jupyterhub/z2jh.py

update:
  enabled: true
  github:
    identifier: jupyterhub/zero-to-jupyterhub-k8s

test:
  environment:
    contents:
      packages:
        - openssl # Fixes: RuntimeError: OpenSSL 3.0's legacy provider failed to load.
        - curl
  pipeline:
    - name: Jupyterhub daemon test.
      uses: test/daemon-check-output
      with:
        start: /usr/bin/jupyterhub
        setup: echo "127.0.0.1 $(hostname)" >> /etc/hosts
        expected_output: "JupyterHub is now running"
        post: |
          #!/bin/sh -e
          url=http://127.0.0.1:8000/_chp_healthz
          response=$(curl -s "$url") || {
            echo "curl ${url} failed $?"
            exit 1
          }
          echo "$response" | grep -qi OK || {
            echo "response from $url did not contain \"OK\""
            echo "response: $response"
            exit 1
          }
          echo "$url had expected output: $response"
