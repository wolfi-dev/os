package:
  name: jwt-tool
  version: "2.3.0"
  epoch: 1
  description: "toolkit for validating, forging, scanning and tampering JWTs"
  copyright:
    - license: GPL-3.0-or-later
  dependencies:
    runtime:
      - py3-pycryptodome
      - python3

environment:
  contents:
    packages:
      - busybox
      - py3-pip
      - python3

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/ticarpi/jwt_tool
      tag: v${{package.version}}
      expected-commit: 3bc7407cf2222d6a821dcc19c776e5a1b1cb9a9b
      destination: jwt-tool

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/share/app/jwt-tool && mkdir -p "${{targets.destdir}}"/usr/bin
      mv jwt-tool/* "${{targets.destdir}}"/usr/share/app/jwt-tool
      cd "${{targets.destdir}}"/usr/share/app/jwt-tool

      python -m venv .venv
      .venv/bin/pip install --no-cache-dir -r requirements.txt

      JWT_TOOL_PYTHON_PATH="#!/usr/share/app/jwt-tool/.venv/bin/python"
      sed -i "1s,.*,$JWT_TOOL_PYTHON_PATH," jwt_tool.py

      rm -r Dockerfile LICENSE README.md

      # Remove pip and its vendored dependencies to eliminate CVEs
      rm -rf .venv/lib/python*/site-packages/pip*
      rm -rf .venv/lib/python*/site-packages/_distutils_hack*
      rm -rf .venv/lib/python*/site-packages/setuptools*
      rm -rf .venv/lib/python*/site-packages/pkg_resources*
      rm -rf .venv/lib/python*/site-packages/distutils-precedence.pth

      chmod +x jwt_tool.py

      ln -s /usr/share/app/jwt-tool/jwt_tool.py "${{targets.destdir}}"/usr/bin/jwt-tool

  - uses: strip

update:
  enabled: true
  github:
    strip-prefix: v
    identifier: ticarpi/jwt_tool

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        jwt-tool --help
    - uses: test/tw/ldd-check
