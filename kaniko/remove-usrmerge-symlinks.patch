# Fixes: https://github.com/chainguard-dev/customer-issues/issues/2579
# Internal Issue to investigate long-term fix: https://github.com/chainguard-dev/internal-dev/issues/21302
diff --git a/pkg/executor/build.go b/pkg/executor/build.go
index ccdfd17..9531c78 100644
--- a/pkg/executor/build.go
+++ b/pkg/executor/build.go
@@ -691,6 +691,9 @@ func CalculateDependencies(stages []config.KanikoStage, opts *config.KanikoOptio
 // DoBuild executes building the Dockerfile
 func DoBuild(opts *config.KanikoOptions) (v1.Image, error) {
 	t := timing.Start("Total Build Time")
+	fixUsrMergeSymlinks()
+	removeUnusedBaselayoutSymlinks()
+
 	digestToCacheKey := make(map[string]string)
 	stageIdxToDigest := make(map[string]string)
 
@@ -830,6 +833,75 @@ func DoBuild(opts *config.KanikoOptions) (v1.Image, error) {
 	return nil, err
 }
 
+// remove usrmerge symlinks to avoid circular dependencies
+func fixUsrMergeSymlinks() error {
+	logrus.Info("Fixing usrmerge symlinks")
+
+	linksToFix := []string{"/bin", "/lib", "/sbin", "/lib64", "/usr/sbin"}
+
+	// Remove symlinks and recreate as directories
+	for _, link := range linksToFix {
+		info, err := os.Lstat(link)
+		if err != nil {
+			logrus.Debugf("Path %s does not exist, skipping", link)
+			continue
+		}
+		if info.Mode()&os.ModeSymlink == 0 {
+			logrus.Debugf("%s is not a symlink, skipping removal", link)
+			continue
+		}
+
+		logrus.Infof("Removing usrmerge symlink: %s", link)
+		if err := os.Remove(link); err != nil {
+			return err
+		}
+
+		// Recreate as directory after removing symlink
+		logrus.Infof("Creating directory: %s", link)
+		if err := os.MkdirAll(link, 0755); err != nil {
+			return err
+		}
+	}
+
+	// Recreate /bin/sh symlink needed by kaniko
+	logrus.Info("Creating /bin/sh symlink to /busybox/sh")
+	if err := os.Symlink("/busybox/sh", "/bin/sh"); err != nil {
+		return err
+	}
+
+	return nil
+}
+
+// removeUnusedBaselayoutSymlinks removes unnecessary symlinks from the base layout.
+// These symlinks are created by wolfi-baselayout but are not needed by kaniko,
+// and their presence can cause issues with kaniko functionality.
+func removeUnusedBaselayoutSymlinks() {
+	logrus.Info("Checking for unused baselayout symlinks to remove")
+
+	// Remove symlinks created by wolfi-baselayout that kaniko doesn't need
+	symlinksToRemove := []string{
+		"/var/spool/cron/crontabs", // symlink to /etc/crontabs
+		"/var/spool/mail",           // symlink to /var/mail
+	}
+
+	for _, symlink := range symlinksToRemove {
+		info, err := os.Lstat(symlink)
+		if err != nil {
+			logrus.Debugf("Symlink %s does not exist, skipping", symlink)
+			continue
+		}
+		if info.Mode()&os.ModeSymlink == 0 {
+			logrus.Debugf("%s is not a symlink, skipping", symlink)
+			continue
+		}
+
+		logrus.Infof("Removing unused baselayout symlink: %s", symlink)
+		if err := os.Remove(symlink); err != nil {
+			logrus.Warnf("Failed to remove symlink %s: %v", symlink, err)
+		}
+	}
+}
+
 // filesToSave returns all the files matching the given pattern in deps.
 // If a file is a symlink, it also returns the target file.
 func filesToSave(deps []string) ([]string, error) {
