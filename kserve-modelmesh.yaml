# Do not bump Netty. It pulls in an incompatible version of gRPC
package:
  name: kserve-modelmesh
  version: 0.12.0
  epoch: 16 # GHSA-4cx2-fc23-5wg6, GHSA-3p8m-j85q-pgmj
  description: The ModelMesh framework is a mature, general-purpose model serving management/routing layer designed for high-scale, high-density and frequently-changing model use cases.
  dependencies:
    runtime:
      - bash # entrypoint script uses bash
      - openjdk-${{vars.java-version}}-default-jvm
  copyright:
    - license: Apache-2.0

vars:
  java-version: '17'

environment:
  contents:
    packages:
      - build-base
      - busybox
      - maven
      - openjdk-${{vars.java-version}}
  environment:
    JAVA_HOME: "/usr/lib/jvm/java-${{vars.java-version}}-openjdk"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kserve/modelmesh.git
      tag: v${{package.version}}
      expected-commit: f8212c75fffba9af22c3f3831ea0a8caade518d2

  - uses: patch
    with:
      patches: netty-dep-additions.patch

  - uses: maven/pombump

  - uses: maven/pombump
    with:
      properties-file: pombump-properties.yaml

  - name: Compile
    runs: |
      mvn -B package -Dfile.encoding=UTF8 -DskipTests=true --file pom.xml
      mkdir -p ${{targets.destdir}}/opt/kserve/mmesh
      mv /home/build/target/dockerhome/* ${{targets.destdir}}/opt/kserve/mmesh/

      # Remove boringssl windows jar/DLLs
      find ${{targets.destdir}}/opt/kserve/mmesh -name '*boringssl*windows*' -exec rm {} \;

      echo "$(date -d@${SOURCE_DATE_EPOCH} +%Y%m%d)-$(git rev-parse --short HEAD)" > ${{targets.destdir}}/opt/kserve/mmesh/build-version
      mkdir -p ${{targets.destdir}}/etc
      mkdir -p ${{targets.destdir}}/opt/kserve/mmesh/log
      chmod -R 775 ${{targets.destdir}}/opt/kserve/mmesh/
      touch ${{targets.destdir}}/etc/environment

subpackages:
  - name: kserve-modelmesh-compat
    description: "compat package with kserve/modelmesh image"
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/opt/kserve"
          ln -sf /opt/kserve/mmesh "${{targets.contextdir}}/opt/kserve/tas"

test:
  pipeline:
    - name: Verify compat packages exist at the right directories
      runs: |
        ls /opt/kserve/mmesh/lib/ | grep -q  'model-.*\.jar'
        ls /opt/kserve/mmesh/ | grep -q 'start.sh'

update:
  enabled: true
  github:
    identifier: kserve/modelmesh
    strip-prefix: v
