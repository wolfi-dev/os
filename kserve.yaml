package:
  name: kserve
  version: "0.16.0"
  epoch: 7 # GHSA-c4p6-qg4m-9jmr
  description: "Standardized Serverless ML Inference Platform on Kubernetes"
  copyright:
    - license: Apache-2.0

vars:
  python-version: 3.11 # Upstream https://github.com/kserve/kserve/blob/release-0.15/python/storage-initializer.Dockerfile uses python-3.11

environment:
  contents:
    packages:
      - go
      - py${{vars.python-version}}-pip
      - python-${{vars.python-version}}-dev
      - uv

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kserve/kserve
      tag: v${{package.version}}
      expected-commit: 5b033a4024429302440b72180472ae2d26b44086

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
        github.com/expr-lang/expr@v1.17.7
        github.com/kedacore/keda/v2@v2.17.3

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: docs/samples/graph/bgtest/bgtest

  # kserve project puts this at the bottom of the go.mod so updating it with go/bump isn't possible
  - runs: |
      sed -i 's|replace golang.org/x/net => golang.org/x/net v0.33.0|replace golang.org/x/net => golang.org/x/net v0.36.0|g' go.mod

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/net@v0.38.0
      modroot: qpext

  - uses: patch
    with:
      patches: bump-python-version.patch

data:
  - name: go-components
    items:
      agent: "."
      router: "."
      manager: "."
      qpext: "qpext"

subpackages:
  - range: go-components
    name: kserve-${{range.key}}
    pipeline:
      - uses: go/build
        working-directory: ${{range.value}}
        with:
          modroot: .
          packages: ./cmd/${{range.key}}
          output: ${{range.key}}

  - range: go-components
    name: kserve-${{range.key}}-compat
    dependencies:
      runtime:
        - kserve-${{range.key}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/"
          ln -s ../usr/bin/${{range.key}} "${{targets.contextdir}}/${{range.key}}"
    test:
      environment:
        contents:
          packages:
            - busybox
      pipeline:
        - name: "check paths"
          runs: |
            [ -x /${{range.key}} -a -f /${{range.key}} ]

  - name: kserve-storage-controller
    options:
      no-commands: true
    pipeline:
      - name: uv-build-storage-library
        working-directory: ./python/storage
        runs: |
          # Install dependencies and build the package using uv
          uv sync

          # filelock: CVE-2025-47273 GHSA-w853-jp5j-5j7f
          uv add \
            "filelock>=3.20.1"

          # urllib3: GHSA-gm62-xv2j-4w53 GHSA-2xpw-w6gg-jr37
          uv add \
            "urllib3>=2.6.0"

          uv pip freeze | grep -v kserve > requirements.txt
          uv build

          # Install runtime deps and wheel with the root directory set to ${{targets.contextdir}}
          python3 -m pip install --root ${{targets.contextdir}} -I -r requirements.txt --no-compile
          python3 -m pip install --verbose --prefix=/usr --root=${{targets.contextdir}} dist/*.whl
      - name: uv-build-storage-controller
        working-directory: ./python/kserve
        runs: |
          # Due to bump-python-version.patch, we need to re-lock dependencies
          uv lock

          # h11: CVE-2025-43859 GHSA-vqfr-h8mv-ghfj
          uv add \
            "h11>=0.16.0"

          # cryptography: CVE-2024-12797 GHSA-79v4-65xg-pq4g
          uv add \
            "cryptography>=44.0.1"

          # protobuf: CVE-2025-4565 GHSA-8qvm-5x2c-j2w7
          uv add \
            "protobuf>=4.25.8"

          # setuptools: CVE-2025-47273 GHSA-5rjg-fvgr-3xxf
          uv add \
            "setuptools>=78.1.1"

          # filelock: CVE-2025-47273 GHSA-w853-jp5j-5j7f
          uv add \
            "filelock>=3.20.1"

          # urllib3: GHSA-gm62-xv2j-4w53 GHSA-2xpw-w6gg-jr37
          uv add \
            "urllib3>=2.6.0"

          # typing-extensions: pydantic-core requires >=4.14.1 (Sentinel added in 4.14.0)
          uv add \
            "typing-extensions>=4.14.1"

          # Remediate GHSA-7f5h-v6xp-fcq8
          #
          # We have to pass a different index url because starlette depends on
          # fastapi which appears to have a broken package description
          # https://github.com/fastapi/fastapi/discussions/11173
          uv add \
             "starlette>=0.49.1" -i https://pypi.org/simple

          # Upgrade requests to fix GHSA-9hjg-9r4m-mvj7
          uv add \
             "requests>=2.32.4"

          # Install dependencies and build the package using uv
          # NB: exclude 'ray' extras since that brings unwanted cuda/nv deps
          uv sync --extra storage

          uv pip freeze | grep -v kserve > requirements.txt
          uv build

          # Install runtime deps and wheel with the root directory set to ${{targets.contextdir}}
          python3 -m pip install --root ${{targets.contextdir}} -I -r requirements.txt --no-compile
          python3 -m pip install --verbose --prefix=/usr --root=${{targets.contextdir}} dist/*.whl
      - name: install storage-initializer entrypoint
        working-directory: ./python/storage-initializer
        runs: |
          mkdir -p ${{targets.contextdir}}/storage-initializer/scripts/

          cp ./scripts/initializer-entrypoint ${{targets.contextdir}}/storage-initializer/scripts/
          chmod 755 ${{targets.contextdir}}/storage-initializer/scripts/initializer-entrypoint

          cd ${{targets.contextdir}}/storage-initializer/scripts/
          # update shbang to point to the python used rather than '/usr/bin/env python'
          sed -i.dist "1s,#!/usr/bin/env python[^ ]*,#!$(which python${{vars.python-version}})," initializer-entrypoint
          # exit fail if it did not change anything
          diff -u initializer-entrypoint.dist initializer-entrypoint && exit 1
          rm initializer-entrypoint.dist
      - uses: strip
    test:
      environment:
        contents:
          packages:
            - busybox
      pipeline:
        - name: "test entrypoint usage"
          runs: |
            /storage-initializer/scripts/initializer-entrypoint --help
        - uses: test/tw/ldd-check

test:
  pipeline:
    - uses: test/tw/ldd-check

update:
  enabled: true
  github:
    identifier: kserve/kserve
    strip-prefix: v
