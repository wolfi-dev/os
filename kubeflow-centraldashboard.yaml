package:
  name: kubeflow-centraldashboard
  version: "1.10.0"
  epoch: 10 # go/wolfi-rsc/kubeflow-centraldashboard
  description: Landing page and central dashboard for Kubeflow deployments
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - npm
  resources:
    cpu: "3"
    memory: 8Gi

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - jq
      - nodejs-18
      - npm
      - openssl
      - openssl-provider-legacy
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kubeflow/kubeflow
      tag: v${{package.version}}
      expected-commit: 90e987bf87d3e7c900926310b00bfa16b59e41eb

  - uses: patch
    with:
      patches: GHSA-rhx6-c78j-4q9w.patch

  - working-directory: components/centraldashboard
    runs: |
      # Create "overrides" section of package.json
      jq '.overrides |= (if . then . else {} end)' package.json > temp.json && mv temp.json package.json

      # Define the overrides
      overrides='{
        "ajv": "^6.12.3",
        "node-fetch": "^2.6.7",
        "node-forge": "^1.3.2",
        "axios": "^1.12.0",
        "qs": "^6.14.1",
        "underscore": "^1.12.1",
        "minimatch": "^3.0.5",
        "path-parse": "^1.0.7",
        "word-wrap": "^1.2.4",
        "protobufjs": "^6.11.4",
        "request": "^2.88.0",
        "monorepo-symlink-test": "^0.0.0",
        "tough-cookie": "^4.1.3",
        "ws": "^8.17.1",
        "follow-redirects": "^1.15.6",
        "express": "^4.20.0",
        "@grpc/grpc-js": "^1.10.9",
        "serve-static": "^1.16.0",
        "cookie": "0.7.0",
        "on-headers": "1.1.0",
        "jsonpath-plus": "10.3.0",
        "jws": "4.0.1",
        "tar": "^7.5.7",
        "lodash": "^4.17.23",
        "js-yaml": "^4.1.1",
        "form-data": "^2.5.4",
        "tmp": "^0.2.4"
      }'

      # Apply the overrides
      jq --argjson overrides "$overrides" '.overrides += $overrides' package.json > temp.json && mv temp.json package.json

      # Define the dependencies
      dependencies='{
        "express": "^4.20.0",
        "@grpc/grpc-js": "^1.10.9"
      }'

      # Apply the dependencies
      jq --argjson dependencies "$dependencies" '.dependencies += $dependencies' package.json > temp.json && mv temp.json package.json

  - working-directory: components/centraldashboard
    runs: |
      export NODE_OPTIONS=--openssl-legacy-provider
      # Build the frontend and copy the common package into it
      npm rebuild && \
      npm install --force --legacy-peer-deps && \
      # Fix vulnerabilities in protobufjs vendored dependencies
      if [ -d "node_modules/protobufjs/cli/node_modules" ]; then \
        cd node_modules/protobufjs/cli/node_modules && \
        rm -rf brace-expansion && npm install brace-expansion@1.1.12 --no-save && \
        rm -rf lodash && npm install lodash@4.17.23 --no-save && \
        rm -rf tmp && npm install tmp@0.2.4 --no-save && \
        cd -; \
      fi && \
      npm run build --force --legacy-peer-deps && \
      npm prune --production --force --legacy-peer-deps
      # Now move it all into place
      mkdir -p "${{targets.destdir}}/app"
      mv * "${{targets.destdir}}/app"

test:
  environment:
    contents:
      packages:
        - nodejs-18
        - npm
  pipeline:
    - runs: |
        cd /app
        # Start the server in the background and redirect output to a log file
        npm start > server.log 2>&1 &
        SERVER_PID=$!
        sleep 5

        # Check the log file for the expected output
        if ! grep -q 'Server listening on port' server.log; then
          echo "Error: Server did not start correctly"
          cat server.log
          kill $SERVER_PID
          exit 1
        fi
        kill $SERVER_PID
    - name: Verify protobufjs vendored dependencies are fixed
      runs: |
        cd /app
        FAILED=0
        PROTOBUFJS_MODULES="node_modules/protobufjs/cli/node_modules"

        # Check brace-expansion version (CVE fix)
        if [ -f "$PROTOBUFJS_MODULES/brace-expansion/package.json" ]; then
          VERSION=$(grep '"version"' "$PROTOBUFJS_MODULES/brace-expansion/package.json" | cut -d'"' -f4)
          echo "brace-expansion version: $VERSION"
          if [ "$VERSION" = "1.1.11" ]; then
            echo "ERROR: Vulnerable brace-expansion 1.1.11 found!"
            FAILED=1
          fi
        fi

        # Check lodash version (CVE-2025-13465 fix)
        if [ -f "$PROTOBUFJS_MODULES/lodash/package.json" ]; then
          VERSION=$(grep '"version"' "$PROTOBUFJS_MODULES/lodash/package.json" | cut -d'"' -f4)
          echo "lodash version: $VERSION"
          if [ "$VERSION" = "4.17.21" ]; then
            echo "ERROR: Vulnerable lodash 4.17.21 found!"
            FAILED=1
          fi
        fi

        # Check tmp version (CVE-2025-54798 fix)
        if [ -f "$PROTOBUFJS_MODULES/tmp/package.json" ]; then
          VERSION=$(grep '"version"' "$PROTOBUFJS_MODULES/tmp/package.json" | cut -d'"' -f4)
          echo "tmp version: $VERSION"
          if [ "$VERSION" = "0.2.1" ]; then
            echo "ERROR: Vulnerable tmp 0.2.1 found!"
            FAILED=1
          fi
        fi

        if [ $FAILED -eq 1 ]; then
          echo "FAIL: Vulnerability checks failed!"
          exit 1
        else
          echo "PASS: All protobufjs vendored dependency checks passed"
        fi

update:
  enabled: true
  github:
    identifier: kubeflow/kubeflow
    use-tag: true
    # There were some malformed early tags
    tag-filter: v1
    strip-prefix: v
