package:
  name: kubernetes-reflector
  version: "9.1.12"
  epoch: 0
  description: Custom Kubernetes controller that can be used to replicate secrets, configmaps and certificates.
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - aspnet-${{vars.dotnet_version}}-runtime
      - dotnet-${{vars.dotnet_version}}

# Should be bumped according to https://github.com/emberstack/kubernetes-reflector/blob/6e7a64250c49058266d75be822e9417a06f53856/src/ES.Kubernetes.Reflector/ES.Kubernetes.Reflector.csproj#L4
vars:
  dotnet_version: 9

environment:
  contents:
    packages:
      - aspnet-${{vars.dotnet_version}}-runtime
      - busybox
      - dotnet-${{vars.dotnet_version}}-sdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/emberstack/kubernetes-reflector.git
      tag: v${{package.version}}
      expected-commit: 6e7a64250c49058266d75be822e9417a06f53856

  - runs: |
      runtime_arch="$(arch | sed -e 's/x86_64/x64/ ; s/aarch64/arm64/')"

      dotnet publish "src/ES.Kubernetes.Reflector/ES.Kubernetes.Reflector.csproj" -c Release -o publish /p:UseAppHost=false --runtime linux-$runtime_arch

      install -d "${{targets.destdir}}"/usr/lib
      cp -dr publish "${{targets.destdir}}"/usr/lib/kubernetes-reflector

subpackages:
  - name: ${{package.name}}-compat
    description: Compatilibity entrypoint from upstream image
    pipeline:
      - runs: |
          install -d ${{targets.subpkgdir}}
          ln -s /usr/lib/kubernetes-reflector/ ${{targets.subpkgdir}}/app
    test:
      pipeline:
        - name: Check if symlinks are being correctly applied
          runs: |
            stat /app
            test -L /app
            test "$(readlink /app)" = "/usr/lib/kubernetes-reflector/"
            test "$(realpath /app)/ES.Kubernetes.Reflector.dll" = "/usr/lib/kubernetes-reflector/ES.Kubernetes.Reflector.dll"

test:
  environment:
    environment:
      ASPNETCORE_URLS: http://localhost:8080
      ES_Serilog__MinimumLevel__Default: Debug
      ES_Serilog__MinimumLevel__Override__System: Information
      ES_Serilog__MinimumLevel__Override__Microsoft: Information
      ES_KubernetesClientConfiguration__VerifyConnection: false
      ES_KubernetesClientConfiguration__SkipTlsVerify: true
      ES_KubernetesClientConfiguration__WatchReconnectTimeoutSeconds: 5
      ES_KubernetesClientConfiguration__ConnectionRetryIntervalMs: 500
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: "8080"
    contents:
      packages:
        - aspnet-${{vars.dotnet_version}}-runtime
        - dotnet-${{vars.dotnet_version}}
        - kubectl
  pipeline:
    - name: Validate kubernetes-reflector package contents
      runs: |
        # Check if the reflector DLL exists
        echo "Checking reflector package contents..."
        ls -la /usr/lib/kubernetes-reflector/
        
        # Verify the required files exist
        if [ -f /usr/lib/kubernetes-reflector/ES.Kubernetes.Reflector.dll ] && \
           [ -f /usr/lib/kubernetes-reflector/ES.Kubernetes.Reflector.deps.json ] && \
           [ -f /usr/lib/kubernetes-reflector/ES.Kubernetes.Reflector.runtimeconfig.json ]; then
          echo "All required files found in the package"
        else
          echo "Some required files are missing"
          exit 1
        fi
        
        # Verify the reflector can be started (but will fail due to no Kubernetes API)
        echo "Testing reflector startup..."
        cd /usr/lib/kubernetes-reflector/
        timeout 3 dotnet ES.Kubernetes.Reflector.dll 2>&1 | grep -q "Requesting V1Namespace resources"
        if [ $? -eq 0 ]; then
          echo "Reflector starts and attempts to connect to Kubernetes API"
          exit 0
        else
          echo "Reflector failed to start properly"
          exit 1
        fi

update:
  enabled: true
  github:
    identifier: emberstack/kubernetes-reflector
    strip-prefix: v
