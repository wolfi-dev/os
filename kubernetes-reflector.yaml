package:
  name: kubernetes-reflector
  version: "9.1.12"
  epoch: 0
  description: Custom Kubernetes controller that can be used to replicate secrets, configmaps and certificates.
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - aspnet-${{vars.dotnet_version}}-runtime
      - dotnet-${{vars.dotnet_version}}

# Should be bumped according to https://github.com/emberstack/kubernetes-reflector/blob/6e7a64250c49058266d75be822e9417a06f53856/src/ES.Kubernetes.Reflector/ES.Kubernetes.Reflector.csproj#L4
vars:
  dotnet_version: 9

environment:
  contents:
    packages:
      - aspnet-${{vars.dotnet_version}}-runtime
      - busybox
      - dotnet-${{vars.dotnet_version}}-sdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/emberstack/kubernetes-reflector.git
      tag: v${{package.version}}
      expected-commit: 6e7a64250c49058266d75be822e9417a06f53856

  - runs: |
      runtime_arch="$(arch | sed -e 's/x86_64/x64/ ; s/aarch64/arm64/')"

      dotnet publish "src/ES.Kubernetes.Reflector/ES.Kubernetes.Reflector.csproj" -c Release -o publish /p:UseAppHost=false --runtime linux-$runtime_arch

      install -d "${{targets.destdir}}"/usr/lib
      cp -dr publish "${{targets.destdir}}"/usr/lib/kubernetes-reflector

subpackages:
  - name: ${{package.name}}-compat
    description: Compatilibity entrypoint from upstream image
    pipeline:
      - runs: |
          install -d ${{targets.subpkgdir}}
          ln -s /usr/lib/kubernetes-reflector/ ${{targets.subpkgdir}}/app
    test:
      pipeline:
        - name: Check if symlinks are being correctly applied
          runs: |
            stat /app
            test -L /app
            test "$(readlink /app)" = "/usr/lib/kubernetes-reflector/"
            test "$(readlink /app)" = "/usr/lib/kubernetes-reflector/"
            test "$(realpath /app)/ES.Kubernetes.Reflector.dll" = "/usr/lib/kubernetes-reflector/ES.Kubernetes.Reflector.dll"

update:
  enabled: true
  github:
    identifier: emberstack/kubernetes-reflector
    strip-prefix: v
