package:
  name: kubescape-storage
  version: "0.0.185"
  epoch: 0
  description: An Aggregated APIServer for the Kubescape internal storage services.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kubescape/storage
      expected-commit: 342eb9da9bbc8e54e780ca3d2b5faae35d7deedf
      tag: v${{package.version}}

  - uses: go/build
    with:
      packages: .
      output: storage

update:
  enabled: true
  ignore-regex-patterns:
    - 'rc\d+$'
  github:
    identifier: kubescape/storage
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - kustomize
        - kubectl
        - mkcert
  pipeline:
    - uses: test/kwok/cluster
    - runs: |
        storage --help
    - name: "Setup minimum config"
      runs: |
        mkdir -p /etc/config
        cat > /etc/config/config <<EOF
        {
          "someConfig": "value"
        }
        EOF
        # Cluster data file
        cat > /etc/config/clusterData.json <<EOF
        {
          "clusterName": "test-cluster",
          "region": "us-test1"
        }
        EOF
    - uses: test/daemon-check-output
      with:
        start: storage serve
        expected_output: |
          APIServer started
