From f68f4c5a8f9566613042b6a74d7b8fbf8c5c8bd4 Mon Sep 17 00:00:00 2001
From: Eoghan Conlon O'Neill <eoghan.conlononeill@chainguard.dev>
Date: Wed, 25 Sep 2024 14:20:27 -0600
Subject: [PATCH] Update otel semconv to 1.26.0

diff --git a/pkg/metrics/http.go b/pkg/metrics/http.go
index d1ba110..8aedee4 100644
--- a/pkg/metrics/http.go
+++ b/pkg/metrics/http.go
@@ -7,7 +7,7 @@ import (
 	"github.com/go-logr/logr"
 	"go.opentelemetry.io/otel/attribute"
 	"go.opentelemetry.io/otel/metric"
-	semconv "go.opentelemetry.io/otel/semconv/v1.4.0"
+	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
 )
 
 func GetHTTPMetrics() HTTPMetrics {
@@ -54,8 +54,8 @@ func (m *httpMetrics) RecordRequest(ctx context.Context, method string, uri stri
 	}
 
 	attributes := append([]attribute.KeyValue{
-		semconv.HTTPMethodKey.String(method),
-		semconv.HTTPURLKey.String(uri),
+		semconv.HTTPRequestMethodKey.String(method),
+		semconv.URLFullKey.String(uri),
 	}, attrs...)
 
 	m.requestsMetric.Add(ctx, 1, metric.WithAttributes(attributes...))
diff --git a/pkg/metrics/metrics.go b/pkg/metrics/metrics.go
index 499051f..58f74c0 100644
--- a/pkg/metrics/metrics.go
+++ b/pkg/metrics/metrics.go
@@ -15,7 +15,7 @@ import (
 	"go.opentelemetry.io/otel/metric"
 	sdkmetric "go.opentelemetry.io/otel/sdk/metric"
 	"go.opentelemetry.io/otel/sdk/resource"
-	semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
+	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
 	"k8s.io/client-go/kubernetes"
 )
 
diff --git a/pkg/tracing/config.go b/pkg/tracing/config.go
index 6f6a25e..b3de3ab 100644
--- a/pkg/tracing/config.go
+++ b/pkg/tracing/config.go
@@ -13,7 +13,7 @@ import (
 	"go.opentelemetry.io/otel/propagation"
 	"go.opentelemetry.io/otel/sdk/resource"
 	sdktrace "go.opentelemetry.io/otel/sdk/trace"
-	semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
+	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
 	"k8s.io/client-go/kubernetes"
 )
 
diff --git a/pkg/tracing/helpers.go b/pkg/tracing/helpers.go
index 57ff265..a96fb8e 100644
--- a/pkg/tracing/helpers.go
+++ b/pkg/tracing/helpers.go
@@ -6,7 +6,7 @@ import (
 
 	"go.opentelemetry.io/otel/attribute"
 	"go.opentelemetry.io/otel/codes"
-	semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
+	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
 	"go.opentelemetry.io/otel/trace"
 )
 
@@ -28,7 +28,7 @@ func SetHttpStatus(ctx context.Context, err error, code int) {
 	if err != nil {
 		span.RecordError(err)
 	}
-	span.SetAttributes(semconv.HTTPStatusCodeKey.Int(code))
+	span.SetAttributes(semconv.HTTPResponseStatusCodeKey.Int(code))
 	if code >= 400 {
 		span.SetStatus(codes.Error, http.StatusText(code))
 	} else {
diff --git a/pkg/webhooks/handlers/trace.go b/pkg/webhooks/handlers/trace.go
index 6083bbe..3508071 100644
--- a/pkg/webhooks/handlers/trace.go
+++ b/pkg/webhooks/handlers/trace.go
@@ -9,7 +9,8 @@ import (
 	"github.com/go-logr/logr"
 	"github.com/kyverno/kyverno/pkg/tracing"
 	admissionutils "github.com/kyverno/kyverno/pkg/utils/admission"
-	semconv "go.opentelemetry.io/otel/semconv/v1.24.0"
+	"go.opentelemetry.io/otel/attribute"
+	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"
 	"go.opentelemetry.io/otel/trace"
 )
 
@@ -23,10 +24,10 @@ func (inner HttpHandler) WithTrace(name string) HttpHandler {
 				inner(writer, request.WithContext(ctx))
 			},
 			trace.WithAttributes(
-				semconv.HTTPRequestContentLengthKey.Int64(request.ContentLength),
-				semconv.NetSockPeerAddrKey.String(tracing.StringValue(request.Host)),
-				semconv.HTTPMethodKey.String(tracing.StringValue(request.Method)),
-				semconv.HTTPURLKey.String(tracing.StringValue(request.RequestURI)),
+				attribute.Key("http.request.header.content-length").Int64(request.ContentLength),
+				semconv.NetworkPeerAddressKey.String(tracing.StringValue(request.Host)),
+				semconv.HTTPRequestMethodKey.String(tracing.StringValue(request.Method)),
+				semconv.URLFullKey.String(tracing.StringValue(request.RequestURI)),
 			),
 			trace.WithSpanKind(trace.SpanKindServer),
