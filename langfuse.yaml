package:
  name: langfuse
  version: "3.52.0" # Adjust to match the Langfuse version discovered
  epoch: 0
  description: "Langfuse - a tool for observability in LLM applications"
  copyright:
    - license: "MIT"
  dependencies:
    runtime:
      - dumb-init
      - nodejs-20

environment:
  contents:
    packages:
      - build-base
      - busybox
      - corepack
      - libcrypto3
      - nodejs-20
      - npm
      - openssl-dev
      - pnpm
  environment:
    LANG: "en_US.UTF-8"
    LC_ALL: "en_US.UTF-8"
    NODE_OPTIONS: "--max-old-space-size=4096"
    NEXTAUTH_SECRET: "test"
    NEXTAUTH_URL: "http://localhost:3000"
    CLICKHOUSE_USER: "default"
    CLICKHOUSE_PASSWORD: "test"
    SALT: "test"
    DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/postgres"
    CLICKHOUSE_URL: "http://localhost:8123"
    LANGFUSE_S3_EVENT_UPLOAD_BUCKET: "langfuse-event-upload-test"
    NEXT_TELEMETRY_DISABLED: "1"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/langfuse/langfuse.git
      tag: v${{package.version}}
      expected-commit: 5b77e5835b10aa20ac3e61411baa7413dbbebc11

  - runs: |
      npm install turbo@^2.5.0 --global
      npm install --no-package-lock prisma@6.3.0 dd-trace@5.36.0

  - runs: |
      corepack enable
      corepack prepare pnpm@latest --activate
      pnpm install

  - runs: |
      # Build the web application
      pnpm run build --filter=web

  - runs: |
      # Install the web build into the target directory

      mkdir -p "${{targets.destdir}}"/app/
      mkdir -p "${{targets.destdir}}"/app/web/.next/static
      install -m755 web/next.config.mjs "${{targets.destdir}}"/app/
      install -m755 web/package.json "${{targets.destdir}}"/app/
      cp -r web/.next/standalone/. "${{targets.destdir}}"/app/
      cp -r web/.next/static "${{targets.destdir}}"/app/web/.next/
      cp -r web/public "${{targets.destdir}}"/app/web/
      cp -r packages/shared/prisma "${{targets.destdir}}"/app/packages/shared/prisma
      cp -r packages/shared/clickhouse "${{targets.destdir}}"/app/packages/shared/clickhouse
      install -m755 web/entrypoint.sh "${{targets.destdir}}"/app/web/entrypoint.sh
      install -Dm755 packages/shared/scripts/cleanup.sql "${{targets.destdir}}"/app/packages/shared/scripts/cleanup.sql

subpackages:
  - name: ${{package.name}}-worker
    pipeline:
      - runs: |
          # Build the worker application
          pnpm run build --filter=worker

update:
  enabled: true
  github:
    identifier: langfuse/langfuse
    strip-prefix: v
