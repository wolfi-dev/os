package:
  name: lerna
  version: "9.0.3"
  epoch: 0 # GHSA-5j98-mcp5-4vw2 and GHSA-mh29-5h37-fv8m
  description: "Lerna is a fast, modern build system for managing and publishing multiple JavaScript/TypeScript packages from the same repository."
  copyright:
    - license: MIT
  checks:
    disabled:
      - usrlocal
  dependencies:
    runtime:
      - nodejs

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - nodejs
      - npm

pipeline:
  - name: npm install
    runs: |
      npm install -g ${{package.name}}@${{package.version}} -prefix ${{targets.destdir}}/usr/local/

      # GHSA-5j98-mcp5-4vw2
      npm install glob@11.1.0 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/

      # CVE-2025-27152 GHSA-jr5f-v2jv-69x6 GHSA-rm8p-cx58-hcvx
      npm install axios@1.12.0 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/

      # CVE GHSA-3xgq-45jj-v275
      npm install cross-spawn@7.0.5 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/

      # Fix tmp CVE GHSA-52f5-9888-hmc6
      npm install tmp@0.2.4 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/

      # GHSA-mh29-5h37-fv8m
      npm install js-yaml@4.1.1 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/
      npm install js-yaml@4.1.1 -prefix ${{targets.destdir}}/usr/local/lib/node_modules/lerna/node_modules/@lerna/create/

      # https://github.com/browserify/resolve/issues/288
      sed -i 's/monorepo-symlink-test/false-positive/g' ${{targets.destdir}}/usr/local/lib/node_modules/lerna/node_modules/resolve/test/resolver/multirepo/package.json

  - name: Remove musl related files
    runs: |
      # remove musl deps that end up polluting our SCA-generated dependencies with unresolveable deps.
      find ${{targets.contextdir}} -type d -name '*musl*' -print -exec rm -rf {} + 2>/dev/null || true

update:
  enabled: true
  github:
    identifier: lerna/lerna
    use-tag: true
    tag-filter: v
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - npm
        - git
  pipeline:
    - name: Check Lerna version
      runs: |
        # Verify that Lerna is installed and the version command works
        lerna --version
        lerna --help
    - name: Initialize a Lerna repository
      runs: |
        # Initialize a new Lerna repository and check for success message
        lerna init --independent
    - uses: test/tw/ldd-check
