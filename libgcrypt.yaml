package:
  name: libgcrypt
  version: "1.12.0"
  epoch: 0
  description: General purpose crypto library based on the code used in GnuPG
  copyright:
    - license: LGPL-2.1-or-later

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - libgpg-error-dev
      - libtool
      - texinfo

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/gpg/libgcrypt
      tag: libgcrypt-${{package.version}}
      expected-commit: efd5e1e7b4e7861b53eafdbf197fd6d4ff6f45e1

  - uses: autoconf/configure
    with:
      opts: |
        CFLAGS="$CFLAGS -O0" \
        CPPFLAGS="$CPPFLAGS -O0" \
        CXXFLAGS="$CXXLAGS -O0" \
        --disable-doc

  - uses: autoconf/make

  # Build doc/version.texi, which is in the distributed tarball but not in the repository.
  - uses: autoconf/make
    with:
      dir: doc
      opts: stamp-vti

  - uses: autoconf/make
    with:
      dir: doc
      opts: all-am

  - uses: autoconf/make-install

  - uses: autoconf/make
    with:
      dir: doc
      opts: install-am DESTDIR="${{targets.contextdir}}"

  - runs: |
      rm -f "${{targets.destdir}}"/usr/share/info/dir

  - uses: strip

subpackages:
  - name: libgcrypt-dev
    pipeline:
      - uses: split/dev
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin/
          cp -f ./src/libgcrypt-config "${{targets.subpkgdir}}"/usr/bin/
    dependencies:
      runtime:
        - libgcrypt
        - libgpg-error-dev
    description: libgcrypt dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: libgcrypt-doc
    pipeline:
      - uses: split/manpages
      - uses: split/infodir
    description: libgcrypt documentation
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: gpg/libgcrypt
    strip-prefix: libgcrypt-
    use-tag: true

test:
  environment:
    contents:
      packages:
        - pkgconf
        - libgcrypt-dev
  pipeline:
    - runs: |
        libgcrypt-config --version
        dumpsexp --version
        dumpsexp --help
        hmac256 --version
        hmac256 --help
        mpicalc --version
        mpicalc --help
    - uses: test/tw/ldd-check
    - uses: test/no-docs
