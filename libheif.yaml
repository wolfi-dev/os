package:
  name: libheif
  version: "1.20.2"
  epoch: 2
  description: libheif is an HEIF and AVIF file format decoder and encoder.
  copyright:
    - license: LGPL-3.0-or-later AND MIT

environment:
  contents:
    packages:
      - aom-dev
      - brotli-dev
      - build-base
      - dav1d-dev
      - doxygen
      - ffmpeg-7-dev
      - gdk-pixbuf-dev
      - libde256-dev
      - libsdl2-dev
      - openh264-dev
      - openjpeg-dev
      - openjpeg-tools
      - openjph-dev
      - rav1e-dev
      - svt-av1-dev
      - tiff-dev
      - x265-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/strukturag/libheif.git
      tag: v${{package.version}}
      expected-commit: 35dad50a9145332a7bfdf1ff6aef6801fb613d68

  - uses: cmake/configure
    with:
      opts: |
        -DBUILD_TESTING=ON \
        -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF \
        -DPLUGIN_DIRECTORY=${{targets.destdir}}/usr/lib \
        -DWITH_DAV1D=ON \
        -DWITH_DAV1D_PLUGIN=OFF \
        -DWITH_JPEG_DECODER=ON \
        -DWITH_JPEG_ENCODER=ON \
        -DWITH_OpenH264_DECODER=ON \
        -DWITH_OpenH264_ENCODER=ON \
        -DWITH_OpenJPEG_DECODER=ON \
        -DWITH_OpenJPEG_DECODER_PLUGIN=OFF \
        -DWITH_OpenJPEG_ENCODER=ON \
        -DWITH_OpenJPEG_ENCODER_PLUGIN=OFF \
        -DWITH_OPENJPH_DECODER=ON \
        -DWITH_OPENJPH_ENCODER=ON \
        -DWITH_OPENJPH_ENCODER_PLUGIN=OFF \
        -DWITH_RAV1E=ON \
        -DWITH_RAV1E_PLUGIN=OFF \
        -DWITH_SvtEnc=ON \
        -DWITH_SvtEnc_PLUGIN=OFF \
        -DWITH_UNCOMPRESSED_CODEC=ON

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

update:
  enabled: true
  github:
    identifier: strukturag/libheif
    strip-prefix: v

subpackages:
  - name: ${{package.name}}-dev
    description: ${{package.name}} development libraries and headers
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - uses: test/pkgconf

  - name: ${{package.name}}-doc
    description: ${{package.name}} documentation and manpages
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

test:
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        set -o pipefail
        heif-convert --help 2>&1 | grep -F -e "Usage: heif-convert [options]"
        heif-convert --version | grep -F -e "${{package.version}}"
        heif-dec --help 2>&1 | grep -F -e "Usage: heif-dec [options]"
        heif-dec --version | grep -F -e "${{package.version}}"
        heif-enc --help 2>&1 | grep -F -e "Usage: heif-enc [options]"
        heif-enc --version | grep -F -e "${{package.version}}"
        heif-info --help 2>&1 | grep -F -e "Usage: heif-info [options]"
        heif-info --version | grep -F -e "${{package.version}}"
        heif-view --help 2>&1 | grep -F -e "Usage: heif-view [options]"
        heif-view --version | grep -F -e "${{package.version}}"
        {
          heif-thumbnailer 2>&1 || true
        } | grep -F -e "usage: heif-thumbnailer [-s size]"
