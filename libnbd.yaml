package:
  name: libnbd
  description: NBD client library in userspace
  url: https://gitlab.com/nbdkit/libnbd
  version: "1.23.13"
  epoch: 1
  copyright:
    - license: LGPL-2.1-only

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - libtool
      - wolfi-baselayout

vars:
  channel: "development"

var-transforms:
  - from: ${{package.version}}
    match: ^(\d.\d+).*
    replace: $1
    to: major_version

pipeline:
  # NOTE: not using git checkout because we would need ocalmc to generate some source files
  - uses: fetch
    with:
      uri: https://download.libguestfs.org/libnbd/${{vars.major_version}}-${{vars.channel}}/${{package.name}}-${{package.version}}.tar.gz
      expected-sha512: 7dc39938332446be61e20c8068c2a66e862fa3b17e6422dc283a42e8161d4b9c1b93077125e6310de15c69cbc02cbc250b5bff2485f130b84a7d783278333565
      strip-components: 1

  - runs: |
      # 1.23.13 only builds if TLS_PRIORITY is set even though it's only
      # #define'd by the build system when building against gnutls (which we
      # don't): we set it to some value here to unblock the build
      sed -i 's/#undef TLS_PRIORITY/#define TLS_PRIORITY "unused-but-expected-by-build"/' ./config.h.in

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: "libnbd-static"
    description: "libnbd static libraries"
    pipeline:
      - uses: split/static

  - name: "libnbd-dev"
    description: "libnbd development headers"
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

test:
  pipeline:
    - uses: test/tw/ldd-check

update:
  enabled: true
  release-monitor:
    identifier: 371504
