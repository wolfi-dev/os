package:
  name: libnvidia-container
  version: 1.17.2
  epoch: 0
  description: NVIDIA container runtime library
  copyright:
    - license: Apache-2.0
    - license: GPL-3.0-only
    - license: LGPL-3.0-or-later

environment:
  contents:
    packages:
      - automake
      - bmake
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils # for GNU date
      - curl
      - glibc-dev
      - go
      - libcap-dev # for sys/capability.h
      - libseccomp
      - libseccomp-dev
      - libtirpc-dev # for rpc/rpc.h
      - libtool
      - linux-headers
      - lsb-release-minimal
      - m4
      - nfs-utils # for rpcgen
      - openssf-compiler-options
      - patch
      - pkgconf-dev
      - rpcgen
  environment:
    CPATH: /usr/include/tirpc

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/NVIDIA/libnvidia-container
      tag: v${{package.version}}
      expected-commit: 63d366ee3b4183513c310ac557bf31b05b83328f

  # Fix prefix to /usr instead of /usr/local
  - runs: sed -i 's|export prefix *= */usr/local|export prefix = /usr|' Makefile

  - uses: autoconf/make
    with:
      opts: |
        WITH_TIRPC=yes \

  - uses: autoconf/make-install

  - uses: strip

update:
  enabled: true
  ignore-regex-patterns:
    - rc*
  github:
    identifier: NVIDIA/libnvidia-container
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - posix-libc-utils
        - sudo-rs
        - shadow # for useradd
  pipeline:
    - name: Ensure the libraries are linked correctly
      runs: |
        ldd /usr/lib/libnvidia-container.so
        ldd /usr/lib/libnvidia-container-go.so
        nvidia-container-cli --help
    - uses: test/pkgconf
    - name: Test nvidia-container-cli
      runs: nvidia-container-cli --version
    - name: Test nvidia-container-cli with privileged mode
      runs: |
        set +e
        useradd nvidia
        # This is the expected error since `libnvidia-ml.so` must be available on the host system. Library can be found in the CUDA.
        sudo -u nvidia nvidia-container-cli --user=nvidia info | grep -qi "load library failed: libnvidia-ml.so.1"
