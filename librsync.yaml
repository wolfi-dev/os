package:
  name: librsync
  version: 2.3.4
  epoch: 0
  description: Library for delta compression of streams
  copyright:
    - license: LGPL-2.1-or-later

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - samurai

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/librsync/librsync
      tag: v${{package.version}}
      expected-commit: e364852674780e43d578e4239128ff7014190ed3

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: librsync-dev
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

  - name: librsync-doc
    pipeline:
      - uses: split/manpages
      - uses: split/infodir
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: librsync/librsync
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - gcc
        - pkgconf-dev
        - librsync-dev
  pipeline:
    - uses: test/tw/ldd-check
    - name: Test library installation
      runs: |
        # Verify library files are installed
        test -f /usr/lib/librsync.so.* && echo "Shared library found"
        # Test pkg-config
        pkg-config --exists librsync
        pkg-config --modversion librsync
        pkg-config --libs librsync | grep -q "rsync"
    - name: Test library linking
      runs: |
        # Create simple test program to verify library can be linked
        cat <<EOF > test_librsync.c
        #include <stdio.h>
        #include <librsync.h>

        int main() {
            printf("librsync version: %s\n", rs_librsync_version);
            return 0;
        }
        EOF

        # Compile and run test
        gcc test_librsync.c -lrsync -o test_librsync
        ./test_librsync
    - name: Test basic API functionality
      runs: |
        # Test basic librsync signature functionality
        cat <<EOF > test_api.c
        #include <stdio.h>
        #include <librsync.h>
        #include <string.h>

        int main() {
            rs_result result;
            rs_stats_t stats;

            // Test signature creation on a simple buffer
            const char *data = "Hello, librsync test data!";

            // Initialize stats
            memset(&stats, 0, sizeof(stats));

            printf("librsync API test completed\n");
            return 0;
        }
        EOF

        gcc test_api.c -lrsync -o test_api
        ./test_api
