package:
  name: libv8
  version: 13.6.158
  epoch: 0
  description: V8 is Google's open source JavaScript engine.
  copyright:
    - license: Apache-2.0
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - bash-binsh
      - busybox
      - clang
      - compiler-rt
      - curl
      - git
      - pkgconf
      - python3
      - wolfi-base

vars:
  llvm-version: 19

pipeline:
  - runs: |
      git clone --depth=1 https://chromium.googlesource.com/chromium/tools/depot_tools.git /home/depot_tools
      export PATH=/home/depot_tools:$PATH

      mkdir -p /home/libv8
      cd /home/libv8
      fetch v8
      cd v8

      git checkout tags/${{package.version}} -b ${{package.version}}
      gclient sync

      gn gen out/${{build.arch}}.release --args='clang_base_path="/usr/lib/llvm-${{vars.llvm-version}}" clang_version=${{vars.llvm-version}}, is_debug=false'
  
  - if: ${{build.arch}} == "x86_64"
    working-directory: /home/libv8/v8
    runs: |
      cat >> out/${{build.arch}}.release <<EOF
      target_cpu = "x86"
      v8_target_cpu = "x86"
      EOF

  - if: ${{build.arch}} == "aarch64"
    working-directory: /home/libv8/v8
    runs: |
      cat >> out/${{build.arch}}.release <<EOF
      target_cpu = "arm64"
      v8_target_cpu = "arm64"
      EOF

  - working-directory: /home/libv8/v8
    runs: ninja -C out/${{build.arch}}.release

# subpackages:
#   - name: ${{package.name}}-dev
#     pipeline:
#       - uses: split/dev
#     test:
#       pipeline:
#         - uses: test/tw/ldd-check
#     description: libv8 dev

update:
  enabled: true
  github:
    identifier: v8/v8

test:
  pipeline:
    - uses: test/tw/ldd-check
