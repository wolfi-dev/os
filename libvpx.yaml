package:
  name: libvpx
  version: 1.15.2
  epoch: 0
  description: VP8 and VP9 codec library
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - coreutils
      - diffutils
      - linux-headers
      - nasm
      - perl

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/webmproject/libvpx
      tag: v${{package.version}}
      expected-commit: d168454ecd099805c675d4a98c66f4891373302a

  - runs: |
      ./configure \
        --prefix=/usr \
        --disable-install-srcs \
        --disable-static \
        --enable-libs \
        --enable-multithread \
        --enable-pic \
        --enable-postproc \
        --enable-runtime-cpu-detect \
        --enable-shared \
        --enable-temporal-denoising \
        --enable-unit-tests \
        --enable-vp8 \
        --enable-vp9 \
        --enable-vp9-highbitdepth \
        --enable-vp9-postproc \
        --enable-vp9-temporal-denoising

  - runs: |
      make -j$(nproc)

  - runs: |
      make DESTDIR="${{targets.destdir}}" install

  - uses: strip

subpackages:
  - name: libvpx-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - libvpx
    description: Development files for libvpx
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: libvpx-utils
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr
          mv "${{targets.destdir}}"/usr/bin "${{targets.subpkgdir}}"/usr/
    description: Command-line tools for libvpx
    test:
      environment:
        contents:
          packages:
            - libvpx
      pipeline:
        - name: Verify vpxenc and vpxdec help
          runs: |
            vpxenc --help
            vpxdec --help
        - uses: test/tw/ldd-check

update:
  enabled: true
  ignore-regex-patterns:
    - ".*-rc.*"
  github:
    identifier: webmproject/libvpx
    strip-prefix: v
    use-tag: true

test:
  pipeline:
    - uses: test/tw/ldd-check
