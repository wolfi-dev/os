# Generated from https://git.alpinelinux.org/aports/plain/community/libvpx/APKBUILD
package:
  name: libvpx
  version: 1.15.2
  epoch: 0
  description: Library for the vp8/vp9 codecs
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils
      - diffutils
      - linux-headers
      - nasm
      - perl

pipeline:
  - uses: fetch
    with:
      expected-sha512: 824fe8719e4115ec359ae0642f5e1cea051d458f09eb8c24d60858cf082f66e411215e23228173ab154044bafbdfbb2d93b589bb726f55b233939b91f928aae0
      uri: https://github.com/webmproject/libvpx/archive/v${{package.version}}/libvpx-v${{package.version}}.tar.gz

  - uses: patch
    with:
      patches: libvpx/fix-arm-float-abi.patch

  - runs: |
      # build fix for arm
      export CROSS=" "
      export CFLAGS="$CFLAGS -O2 -flto=auto -ffat-lto-objects"
      export CXXFLAGS="$CXXFLAGS -O2 -flto=auto -ffat-lto-objects"

      ./configure \
        --prefix=/usr \
        --disable-install-srcs \
        --disable-static \
        --enable-libs \
        --enable-multithread \
        --enable-pic \
        --enable-postproc \
        --enable-runtime-cpu-detect \
        --enable-shared \
        --enable-temporal-denoising \
        --enable-unit-tests \
        --enable-vp8 \
        --enable-vp9 \
        --enable-vp9-highbitdepth \
        --enable-vp9-postproc \
        --enable-vp9-temporal-denoising

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: libvpx-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - libvpx
    description: libvpx dev

  - name: libvpx-utils
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/* ${{targets.subpkgdir}}/usr/bin/
    description: libvpx (tools)

update:
  enabled: true
  github:
    identifier: webmproject/libvpx
    strip-prefix: v
    use-tag: true

test:
  pipeline:
    - name: Verify shared library exists
      runs: |
        test -f /usr/lib/libvpx.so
    - name: Test vpxenc tool
      runs: |
        vpxenc --help
    - name: Test vpxdec tool
      runs: |
        vpxdec --help
