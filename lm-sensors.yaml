package:
  name: lm-sensors
  version: 3.6.0
  epoch: 40
  description: Collection of user space tools for general SMBus access and hardware monitoring.
  copyright:
    - license: LGPL-2.1-or-later AND GPL-2.0-or-later
  dependencies:
    runtime:
      - merged-usrsbin
      - wolfi-baselayout

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - flex
      - perl
      - rrdtool-dev
      - sysfsutils

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: '-'
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/lm-sensors/lm-sensors
      expected-commit: 1667b850a1ce38151dae17156276f981be6fb557
      tag: V${{vars.mangled-package-version}}
      cherry-picks: |
        pull/483/head/7a6170f07d05cc6601b4668f211e9389f2e75286: Backport gcc fixes

  - runs: |
      export CFLAGS="$CFLAGS -fno-stack-protector"
      make PREFIX=/usr user

  - runs: |
      make PROG_EXTRA:=sensord user_install \
      PREFIX=/usr \
      MANDIR=/usr/share/man \
      SBINDIR=/usr/bin \
      DESTDIR="${{targets.destdir}}"

  - uses: strip

subpackages:
  - name: lm-sensors-detect
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/sensors-conf-convert "${{targets.subpkgdir}}"/usr/bin/
          mv "${{targets.destdir}}"/usr/bin/sensors-detect "${{targets.subpkgdir}}"/usr/bin/
    description: Detection/migration scripts for lm-sensors
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: lm-sensors-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - lm-sensors
        - merged-usrsbin
        - sysfsutils
        - wolfi-baselayout
    description: lm-sensors dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: lm-sensors-doc
    pipeline:
      - uses: split/manpages
    description: lm-sensors manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: lm-sensors-fancontrol-openrc
    pipeline:
      - runs: install -Dm755 ./fancontrol.initd "${{targets.subpkgdir}}"/etc/init.d/fancontrol
    description: fancontrol daemon (OpenRC init scripts)
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: lm-sensors-sensord
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/sensord "${{targets.subpkgdir}}"/usr/bin/sensord
    description: sensord daemon
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: lm-sensors-sensord-openrc
    pipeline:
      - runs: |
          install -Dm755 ./sensord.initd "${{targets.subpkgdir}}"/etc/init.d/sensord
          install -Dm644 ./sensord.confd "${{targets.subpkgdir}}"/etc/conf.d/sensord
    description: sensord daemon (OpenRC init scripts)
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

update:
  enabled: true
  version-transform:
    - match: \-
      replace: .
  ignore-regex-patterns:
    - POST.*
    - i2c.*
  github:
    identifier: lm-sensors/lm-sensors
    use-tag: true
    strip-prefix: V

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        sensors --version
    - uses: test/tw/ldd-check
