package:
  name: lua-haproxy-auth-request
  version: 0.0_git20230822
  epoch: 2
  description: Control your HTTP services based on a subrequest to a configured HAProxy backend
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - lua-json4

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/TimWolla/haproxy-auth-request/archive/530cdda68ac682c8d3d4e676f7f6ef72e76b3cbe.tar.gz
      expected-sha256: fde22861f8a889aa36dfe415548af8e7ab0c26901cc22c50fd02993d986d1e99
      strip-components: 1

  - uses: fetch
    with:
      uri: https://github.com/haproxytech/haproxy-lua-http/archive/4ac4483142c4f12445d47e55c8ecf155d9be0904.tar.gz
      expected-sha256: 4ffe26b614fcffa54ae7499e15c4db63589e144f55b6998ec3c5ffce172ef1d2
      strip-components: 1

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/share/lua/common
      install -D -m 644 auth-request.lua ${{targets.destdir}}/usr/share/lua/common/
      install -D -m 644 http.lua ${{targets.destdir}}/usr/share/lua/common/haproxy-lua-http.lua

  - uses: strip

update:
  enabled: false
  exclude-reason: no releases or tags available

test:
  environment:
    contents:
      packages:
        - curl
        - haproxy-3.3
  pipeline:
    - uses: test/daemon-check-output
      with:
        setup: |
          set -euo pipefail
          tee /tmp/haproxy.cfg << 'EOF'
          global
              tune.lua.bool-sample-conversion normal
              lua-load /usr/share/lua/common/auth-request.lua

          defaults
              mode http
              timeout connect 5s
              timeout client 10s
              timeout server 10s

          frontend test
              bind *:8080
              default_backend test-backend

          backend test-backend
              http-request return status 200 content-type "text/plain" string "ok"
          EOF
        start: haproxy -f /tmp/haproxy.cfg
        expected_output: "Proxy"
        post: |-
          set -euo pipefail
          curl -sf http://localhost:8080/ | grep -F "ok"
