package:
  name: mercurial
  version: "7.1.2"
  epoch: 0
  description: "Scalable distributed SCM tool"
  copyright:
    - license: GPL-2.0-or-later
  dependencies:
    provider-priority: 0

vars:
  pypi-package: mercurial

data:
  - name: py-versions
    items:
      3.10: '310'
      3.11: '311'
      3.12: '312'
      3.13: '313'

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - gettext-dev
      - py3-supported-flit-core
      - py3-supported-gpep517
      - py3-supported-python-dev
      - py3-supported-setuptools
      - py3-supported-setuptools-scm
      - py3-supported-wheel
      - wolfi-base
      - zlib-dev

pipeline:
  - uses: fetch
    with:
      uri: https://www.mercurial-scm.org/release/mercurial-${{package.version}}.tar.gz
      expected-sha256: ce27b9a4767cf2ea496b51468bae512fa6a6eaf0891e49f8961dc694b4dc81ca

subpackages:
  - range: py-versions
    name: py${{range.key}}-${{vars.pypi-package}}
    description: ${{vars.pypi-package}} installed for python${{range.key}}
    dependencies:
      provider-priority: ${{range.value}}
      provides:
        - py3-${{vars.pypi-package}}
        - mercurial
      runtime:
        - python-${{range.key}}
    pipeline:
      - runs: |
          # Build the wheel for this python version
          python${{range.key}} -m gpep517 build-wheel \
            --wheel-dir dist \
            --output-fd 3 3>&1 >&2

          # Install the built wheel
          python${{range.key}} -m installer -d "${{targets.subpkgdir}}" dist/mercurial-${{package.version}}-cp*.whl

          # Copy the hg bins to the right location
          install -Dm755 contrib/hg-ssh hgeditor -t "${{targets.subpkgdir}}/usr/bin"

          # Cleanup the wheel so the other subpackages don't try to install it too
          rm -f dist/mercurial-${{package.version}}-cp*.whl
      - uses: strip
    test:
      pipeline:
        - runs: |
            hg --version
            hg --help

  - name: "mercurial-doc"
    description: "mercurial documentation"
    pipeline:
      - runs: |
          for man in doc/*.?; do
            install -Dm644 "$man" \
              "${{targets.subpkgdir}}"/usr/share/man/man${man##*.}/${man##*/}
          done
      - uses: strip
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  release-monitor:
    identifier: 1969

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        hg --version
        hg --help
