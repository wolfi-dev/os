# this package does not mean anything on its own, it is a
# placeholder for the mesosphere-vsphere-csi-driver package
# which is split into two subpackages
# vsphere-csi and vsphere-syncer
package:
  name: mesosphere-vsphere-csi
  version: "3.5.0"
  epoch: 5 # CVE-2025-61729
  description: Simple, fast container image builder for Go applications.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 94641895f2c8c70cbf14887986aa5aa95816e8ac
      repository: https://github.com/mesosphere/vsphere-csi-driver
      tag: v${{package.version}}-nkp.0

  - uses: go/bump
    with:
      deps: |-
        k8s.io/kubernetes@v1.33.4
        github.com/opencontainers/selinux@v1.13.0

subpackages:
  - name: ${{package.name}}-driver
    description: The vSphere CSI driver binary
    pipeline:
      - uses: go/build
        with:
          ldflags: |
            -X sigs.k8s.io/vsphere-csi-driver/v3/pkg/csi/service.Version=${{package.version}}
          output: vsphere-csi
          packages: ./cmd/vsphere-csi
    test:
      pipeline:
        - runs: |
            vsphere-csi --help
            vsphere-csi -version | grep -q ${{package.version}}
            /bin/vsphere-csi --help

  - name: ${{package.name}}-syncer
    description: The vSphere CSI syncer binary
    pipeline:
      - uses: go/build
        with:
          ldflags: |
            -X sigs.k8s.io/vsphere-csi-driver/v3/pkg/syncer.Version=${{package.version}}
          output: vsphere-syncer
          packages: ./cmd/syncer
    test:
      pipeline:
        - runs: |
            vsphere-syncer --help
            vsphere-syncer -version | grep -q ${{package.version}}
            /bin/vsphere-syncer --help

update:
  enabled: true
  github:
    identifier: mesosphere/vsphere-csi-driver
    strip-prefix: v
    use-tag: true
  version-transform:
    - match: (\d+)\.(\d+)\.(\d+)-nkp\.0$
      replace: $1.$2.$3

test:
  pipeline:
    - uses: test/emptypackage
