package:
  name: mod-auth-openidc
  version: 2.4.17.2
  epoch: 0
  description: "Apache module for OpenID Connect authentication"
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - apache2-dev
      - apr-util-dev
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - cjose-dev
      - curl-dev
      - git
      - hiredis-dev
      - jansson-dev
      - libapr-dev
      - libtool
      - openssl-dev
      - pcre2-dev
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openidc/mod_auth_openidc
      tag: v${{package.version}}
      expected-commit: 72304a45eb3d3b5caa42ec5ee2e0cc81ad5b1f38

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

test:
  environment:
    contents:
      packages:
        - apache2
        - apache2-dev
        - curl
        - pkgconf
        - mod-auth-openidc-dev
        - wait-for-it
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        # set -euo pipefail
        # Create a simple oidc response to parse with the module
        echo '{"issuer":"", "authorization_endpoint":"http://localhost:8081"}' > /tmp/index.html

        cat > /tmp/test.conf << 'EOF'
        ServerName localhost
        ErrorLog /tmp/error.log
        LogLevel warn
        LoadModule mpm_event_module /usr/lib/apache2/modules/mod_mpm_event.so
        LoadModule authz_core_module /usr/lib/apache2/modules/mod_authz_core.so
        LoadModule authn_core_module /usr/lib/apache2/modules/mod_authn_core.so
        LoadModule authz_user_module /usr/lib/apache2/modules/mod_authz_user.so
        LoadModule dir_module /usr/lib/apache2/modules/mod_dir.so
        LoadModule unixd_module /usr/lib/apache2/modules/mod_unixd.so
        LoadModule auth_openidc_module /usr/lib/apache2/modules/mod_auth_openidc.so
        DirectoryIndex index.html
        Listen 8080
        Listen 8081
        <VirtualHost *:8080>
          DocumentRoot /tmp
          OIDCProviderMetadataURL http://localhost:8081
          OIDCClientID test
          OIDCClientSecret secret
          OIDCRedirectURI http://localhost:8080/redirect_uri
          OIDCCryptoPassphrase test
          <Location />
            AuthType openid-connect
            Require valid-user
          </Location>
        </VirtualHost>
        <VirtualHost *:8081>
          DocumentRoot /tmp
        </VirtualHost>
        EOF

        apachectl -f /tmp/test.conf -k start
        wait-for-it localhost:8080 -t 10

        # Test OIDC headers - cookie and redirect can only come from working module
        RESPONSE=$(curl -f -s -i http://localhost:8080)
        echo "$RESPONSE" | grep 'Set-Cookie: mod_auth_openidc_state'
        echo "$RESPONSE" | grep 'Location: http://localhost:8081?response_type=code&scope=openid'

        apachectl -f /tmp/test.conf -k stop

subpackages:
  - name: mod-auth-openidc-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - mod-auth-openidc
        - apache2-dev
        - cjose-dev
        - jansson-dev
        - openssl-dev
    description: mod-auth-openidc dev

update:
  enabled: true
  github:
    identifier: openidc/mod_auth_openidc
    strip-prefix: v
    use-tag: true
