#nolint:valid-pipeline-git-checkout-commit,valid-pipeline-git-checkout-tag
package:
  name: mongodb-kubernetes-operator
  version: "0.0.0_git20250325"
  epoch: 0
  description: Kubernetes Operator which deploys MongoDB Community into Kubernetes clusters.
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - bash
      - coreutils

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/mongodb/mongodb-kubernetes-operator
      branch: master

  - runs: |
      mkdir -p ${{targets.contextdir}}/usr/local/bin
      CGO_ENABLED=0 go build -o manager cmd/manager/main.go
      cp -av manager ${{targets.contextdir}}/
      cp -av build/bin/* ${{targets.contextdir}}/usr/local/bin/


test:
  environment:
    environment:
      OPERATOR: manager
      USER_UID: 2000
      USER_NAME: mongodb-kubernetes-operator
      MONGODB_REPO_URL: "quay.io/mongodb"
      MONGODB_IMAGE: "mongodb-community-server"
      AGENT_IMAGE: "quay.io/mongodb/mongodb-agent-ubi:108.0.2.8729-1"
      VERSION_UPGRADE_HOOK_IMAGE: "quay.io/mongodb/mongodb-kubernetes-operator-version-upgrade-post-start-hook:1.0.9"
      READINESS_PROBE_IMAGE: "quay.io/mongodb/mongodb-kubernetes-readinessprobe:1.0.22"
      WATCH_NAMESPACE: "*"
      SKIP_IPTABLES: 1
    contents:
      packages:
        - curl
        - iptables
        - kind
        - systemd
        - shadow-subids
  pipeline:
  - name: "Setup KWOK cluster"
    uses: test/kwok/cluster
  - name: "Test"
    working-directory: /
    runs: |
      kubectl apply -f https://raw.githubusercontent.com/mongodb/mongodb-kubernetes-operator/51761b993543fb4865741bf4ef15f7b1c99a2e72/config/manager/manager.yaml
      kubectl wait --for=condition=Ready nodes --all

update:
  enabled: true
  git: {}
  schedule:
    period: weekly
    reason: This project doesn't do releases and everything is commit based
