package:
  name: mosh
  version: "1.4.0"
  epoch: 0
  description: "Mosh: the mobile shell"
  copyright:
    - license: GPL-3.0-or-later

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - libprotoc
      - ncurses-dev
      - openssl-dev
      - protobuf-c-dev
      - protobuf-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: bc73a26316ede2a79259d859f8ee309b32412420
      repository: https://github.com/mobile-shell/mosh
      tag: mosh-${{package.version}}
      cherry-picks: |
        master/eee1a8cf413051c2a9104e8158e699028ff56b26: Bump C++ version to C++17

  - runs: |
      # wolfi perl does not have diagnostics built
      sed -i 's,perl -Mdiagnostics,perl,' scripts/Makefile.am

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: ${{package.name}}-doc
    description: "mosh documentation"
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

test:
  environment:
    contents:
      packages:
        - busybox
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        set +x
        set -o pipefail
        tpass() { echo "PASS:" "$@" 1>&2; }
        tfail() { echo "FAIL:" "$@" 1>&2; fails="$fails $*"; }
        for bin in mosh mosh-client mosh-server ; do
          $bin --help && tpass "$bin --help" || tfail "$bin --help exited $?"
          $bin --version | grep -q -F "${{package.version}}" &&
            tpass "$bin --version" || tfail "$bin --version"
        done
        if [ "${fails# }" != "" ]; then
          echo "FATAL: $fails"
          exit 1
        fi

update:
  enabled: true
  github:
    identifier: mobile-shell/mosh
    use-tag: true
    strip-prefix: mosh-
