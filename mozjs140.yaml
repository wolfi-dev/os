package:
  name: mozjs140
  version: "140.1.0"
  epoch: 0
  description: Mozilla JavaScript interpreter and library
  copyright:
    - license: MPL-2.0

vars:
  llvm-vers: 20
  # FIXME: use vars-transform for this instead of manually setting it
  major-version: 140

environment:
  environment:
    MOZ_OBJDIR: /home/build/objdir
  contents:
    packages:
      - build-base
      - busybox
      - python3
      - llvm-${{vars.llvm-vers}}
      - llvm-lld-${{vars.llvm-vers}}
      - libnspr-dev
      - rust
      - cbindgen
      - libffi-dev
      - readline-dev
      - icu-dev
      - zlib-dev
      - autoconf
      - automake

pipeline:
  - uses: fetch
    with:
      uri: https://ftp.mozilla.org/pub/firefox/releases/${{package.version}}esr/source/firefox-${{package.version}}esr.source.tar.xz
      expected-sha256: d15c65d790e0c371b5c95332141b1bdeb29fefc27f852d22a5f542b6d1bc1922

  - uses: patch
    with:
      patches: public-usage.patch

  - working-directory: objdir
    runs: |
      ../mach configure \
        --disable-hardening \
        --disable-install-strip \
        --disable-strip \
        --enable-application=js \
        --enable-linker=lld \
        --enable-optimize \
        --enable-release \
        --with-system-icu \
        --with-system-nspr \
        --with-system-zlib \
        --enable-ctypes \
        --enable-readline \
        --enable-shared-js \
        --enable-system-ffi \
        --enable-tests \
        --with-intl-api \
        --disable-debug \
        --disable-jemalloc

  - working-directory: objdir
    runs: ../mach build --priority normal

  - runs: make -C objdir install DESTDIR=${{targets.destdir}}

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/lib
      mv ${{targets.destdir}}/usr/local/lib/* ${{targets.destdir}}/usr/lib/
      mv ${{targets.destdir}}/usr/lib/libmozjs-${{vars.major-version}}.so ${{targets.destdir}}/usr/lib/libmozjs-${{vars.major-version}}.so.0
      ln -s /usr/lib/libmozjs-${{vars.major-version}}.so.0 ${{targets.destdir}}/usr/lib/libmozjs-${{vars.major-version}}.so

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: ${{package.name}} development libraries
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf
  - name: ${{package.name}}-static
    description: ${{package.name}} static libraries
    pipeline:
      - uses: split/static

update:
  enabled: true
  release-monitor:
    identifier: 369151

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        js${{vars.major-version}} --version
        js${{vars.major-version}} --help
    - uses: test/tw/ldd-check
