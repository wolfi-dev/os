package:
  name: mozjs91
  version: 91.13.0
  epoch: 6
  description:
  copyright:
    - license: MPL-2.0

vars:
  llvm-vers: 18

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - clang-${{vars.llvm-vers}}
      - curl
      - erlang-dev
      - icu
      - icu-dev
      - jemalloc-dev
      - llvm-${{vars.llvm-vers}}
      - llvm-lld-${{vars.llvm-vers}}
      - m4
      - perl
      - python-3.10 # Uses imp deprecated in 12 & uses file mode U in 3.11
      - readline-dev
      - rust
      - zlib-dev

pipeline:
  - uses: fetch
    with:
      expected-sha256: 53be2bcde0b5ee3ec106bd8ba06b8ae95e7d489c484e881dfbe5360e4c920762
      uri: https://ftp.mozilla.org/pub/firefox/releases/${{package.version}}esr/source/firefox-${{package.version}}esr.source.tar.xz

  - uses: patch
    with:
      patches: drop-obsolete-clang-flags.path

  - runs: |
      cat > .mozconfig <<- END
      ac_add_options --enable-project=js
      mk_add_options MOZ_OBJDIR='${PWD}'/obj
      ac_add_options --prefix=/usr
      ac_add_options --enable-release
      ac_add_options --enable-hardening
      ac_add_options --enable-optimize
      ac_add_options --enable-linker=lld
      ac_add_options --disable-bootstrap
      ac_add_options --disable-debug
      ac_add_options --disable-debug-symbols
      ac_add_options --disable-strip

      # System libraries
      ac_add_options --with-system-icu
      ac_add_options --with-system-zlib

      # Features
      ac_add_options --enable-readline
      ac_add_options --enable-shared-js
      ac_add_options --enable-tests
      ac_add_options --with-intl-api
      END

      # disable rust-simd on aarch64
      if [ "${{build.arch}}" = "aarch64" ]; then
        echo "ac_add_options --disable-rust-simd" >> .mozconfig
      fi

      export MACH_USE_SYSTEM_PYTHON=1
      export MOZ_NOSPAM=1

      ./mach build


      cd obj
      make DESTDIR=${{targets.destdir}} install

      rm -f "${{targets.destdir}}"/usr/lib/*.ajs

  - uses: strip

subpackages:
  - name: mozjs91-dev
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - runs: |
            js91-config --version
        - uses: test/pkgconf

update:
  enabled: true
  release-monitor:
    identifier: 369151

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        js91 --version
        js91 --help
    - uses: test/tw/ldd-check
