package:
  name: nats-top
  version: 0.6.3
  epoch: 0
  description: A top-like tool for monitoring NATS servers.
  copyright:
    - license: MIT

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/nats-io/nats-top
      tag: v${{package.version}}
      expected-commit: 812d35cc991232d7606816a15b2ea0b12fb129e7

  - uses: go/build
    with:
      packages: ./nats-top.go
      output: nats-top
      extra-args: -cover
      ldflags: |
        -X main.version=${{package.version}}
        -X main.commit=$(git rev-parse HEAD)
        -X main.date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

subpackages:
  - name: ${{package.name}}-compat
    description: Compat package for ${{package.name}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/local/bin
          ln -s /usr/bin/nats-top "${{targets.contextdir}}"/usr/local/bin/nats-top

update:
  enabled: true
  github:
    identifier: nats-io/nats-top
    strip-prefix: v

test:
  environment:
    environment:
      GOCOVERDIR: /home/build
    contents:
      packages:
        - nats-server
  pipeline:
    - name: version test
      runs: |
        nats-top --version 2>&1 | grep ${{package.version}}
    - name: run nats-server and nats-top
      runs: |
        nats-server -m 8222 &
        sleep 2
        nats-top -o nats-top-output
        cat nats-top-output | grep -Ei 'server|bytes|sec'
    - uses: go/covdata
