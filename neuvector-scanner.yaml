package:
  name: neuvector-scanner
  version: "3.877"
  epoch: 1
  description: NeuVector vulnerability scanner for the SUSE NeuVector Container Security Platform
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates
      - neuvector-db
      - neuvector-scanner-monitor
      - neuvector-scanner-task
      - neuvector-sigstore-interface

environment:
  contents:
    packages:
      - busybox
      - crane

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/neuvector/scanner
      tag: v${{package.version}}
      expected-commit: 6ee44fc73f7c1574475b242925190ab6ab5b202e

  - uses: go/build
    with:
      modroot: .
      packages: .
      output: scanner
      prefix: usr/local
      vendor: true

  # Empty file that tells NV that the scanner is running in a container
  - runs: touch ${{targets.contextdir}}/usr/local/bin/.nvcontainer

  - uses: strip

subpackages:
  - name: ${{package.name}}-task
    description: NeuVector Scanner Task
    pipeline:
      - uses: go/build
        with:
          modroot: .
          packages: .
          output: scannerTask
          prefix: usr/local
          vendor: true

  # Need a separate monitor subpackage for neuvector/scanner/monitor different from neuvector/neuvector/monitor
  - name: ${{package.name}}-monitor
    description: NeuVector Scanner Monitor
    pipeline:
      - runs: |
          make -C monitor
          mkdir -p ${{targets.contextdir}}/usr/local/bin
          install -Dm755 monitor/monitor ${{targets.contextdir}}/usr/local/bin/monitor

  - name: neuvector-db
    description: NeuVector vulnerability database for the SUSE NeuVector Container Security Platform
    pipeline:
      - runs: |
          # Fetch NeuVector scanner from docker hub
          # https://hub.docker.com/r/neuvector/scanner/tags
          # we don't use the dbgen tool for this since it's very slow and
          # super flaky. Extracting is faster and is more reliable.
          # This may change in the future if neuvector isn't published to DH

          crane export neuvector/scanner:${{package.version}} scanner.tar

          # Extract cvedb file
          mkdir -p ${{targets.contextdir}}
          tar xvf scanner.tar -C ${{targets.contextdir}} etc/neuvector/db/cvedb
    test:
      pipeline:
        - runs: |
            if [[ -f "/etc/neuvector/db/cvedb" ]]; then
              echo "CVE DB found!" && exit 0
            else
              echo "CVE DB not found!" && exit 1
            fi

test:
  pipeline:
    - runs: |
        if scanner --help | grep -q "usage: scan [OPTIONS]"; then
           exit 0;
        fi
    - runs: |
        scanner -v -d /etc/neuvector/db/ | grep -q 'CVE database version: ${{package.version}}' && echo "Match" || echo "No match"

update:
  enabled: true
  git:
    tag-filter-prefix: v
    strip-prefix: v
