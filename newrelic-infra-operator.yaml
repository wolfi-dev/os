package:
  name: newrelic-infra-operator
  version: "0.26.2"
  epoch: 0 # CVE-2025-61729
  description: Newrelic kubernetes operator of infrastructure
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/newrelic/newrelic-infra-operator
      tag: v${{package.version}}
      expected-commit: cf25ef91136c868d1554b509d99f02a7b7214242

  - runs: |
      make build
      mkdir -p ${{targets.destdir}}/usr/bin
      mv newrelic-infra-operator ${{targets.destdir}}/usr/bin/newrelic-infra-operator

  - uses: strip

update:
  enabled: true
  github:
    identifier: newrelic/newrelic-infra-operator
    strip-prefix: v
    tag-filter: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - openssl
    environment:
      CLUSTER_NAME: test-cluster
      NRIA_LICENSE_KEY: "000000000000000000000000000000000000FFFF"
  pipeline:
    - uses: test/kwok/cluster
    - name: Launch operator with kwok cluster
      uses: test/daemon-check-output
      with:
        setup: |
          kubectl config view --minify --raw > /tmp/kubeconfig.yaml
          mkdir -p /etc/newrelic/newrelic-infra-operator
          cat <<EOF >/etc/newrelic/newrelic-infra-operator/operator.yaml
          infraAgentInjection:
            agentConfig:
              Image:
                Repository: ciao
                Tag: ciao
              customAttributes:
              - name: computeType
                defaultValue: serverless
            ResourcePrefix: ciao
            policies:
              - namespaceName: default
                # inject into pods in namespaces with this label
                namespaceSelector:
                  matchLabels:
                    newrelic.com/infra-injection: "enabled"
                # you can leave podSelector empty to match all pods in those namespaces
                podSelector: {}
          EOF
          mkdir -p /tmp/k8s-webhook-server/serving-certs
          openssl req -x509 -newkey rsa:2048 -nodes -days 365 -keyout /tmp/k8s-webhook-server/serving-certs/tls.key -out /tmp/k8s-webhook-server/serving-certs/tls.crt -subj "/CN=newrelic-infra-operator-webhook-service.default.svc" -addext "subjectAltName=DNS:newrelic-infra-operator-webhook-service.default.svc"
        start: newrelic-infra-operator
        timeout: 30
        expected_output: |
          Starting NewRelic infra operator
          Serving webhook server
          Starting certificate poll+watcher
        post: |
          curl --fail --silent http://127.0.0.1:8080/metrics
          curl --fail --silent http://127.0.0.1:9440/healthz
