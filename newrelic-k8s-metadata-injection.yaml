package:
  name: newrelic-k8s-metadata-injection
  version: "1.32.2"
  epoch: 1
  description: Kubernetes metadata injection for New Relic APM to make a linkage between APM and Infrastructure data.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      expected-commit: f244a7ee7dea9b80b39efd3c315126fec521f164
      repository: https://github.com/newrelic/k8s-metadata-injection
      tag: v${{package.version}}

  - runs: |
      mkdir -p ${{targets.contextdir}}/app
      install -Dm755 entrypoint.sh ${{targets.contextdir}}/app/entrypoint.sh

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/net@v0.38.0

  - uses: go/build
    with:
      output: k8s-metadata-injection
      packages: ./cmd/server

update:
  enabled: true
  github:
    identifier: newrelic/k8s-metadata-injection
    strip-prefix: v

subpackages:
  - name: ${{package.name}}-compat
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/app
          ln -sf /usr/bin/k8s-metadata-injection ${{targets.contextdir}}/app/k8s-metadata-injection
    description: Compatibility symlink for ${{package.name}}

test:
  environment:
    contents:
      packages:
        - mkcert
        - curl
  pipeline:
    - uses: test/kwok/cluster
    - name: test the webhook
      runs: |
        mkdir -p /etc/tls-key-cert-pair
        mkcert -install
        mkcert -key-file /etc/tls-key-cert-pair/tls.key -cert-file /etc/tls-key-cert-pair/tls.crt localhost
        k8s-metadata-injection &
        sleep 1
        STATUS=$(curl -v -k -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
        # if the status code is 200, exit 0, otherwise exit 1
        if [ "$STATUS" -eq 200 ]; then
            echo "Health check passed with status code 200"
            exit 0
        else
            echo "Health check failed with status code $STATUS"
            exit 1
        fi
