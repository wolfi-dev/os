package:
  name: newrelic-nri-kube-events
  version: "2.16.1"
  epoch: 0 # CVE-2025-47907
  description: New Relic integration that forwards Kubernetes events to New Relic
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - wolfi-baselayout

pipeline:
  # We can't use go/install because this requires specific ldflags to set the version
  - uses: git-checkout
    with:
      repository: https://github.com/newrelic/nri-kube-events
      tag: v${{package.version}}
      expected-commit: fddacdc728e1e3f9b5a22e7d24bb61673f0e5dbe

  - uses: go/build
    with:
      packages: ./cmd/nri-kube-events
      ldflags: -X main.integrationVersion=v${{ package.version }}
      output: nri-kube-events

update:
  enabled: true
  github:
    identifier: newrelic/nri-kube-events
    strip-prefix: v
    tag-filter: v

test:
  environment:
    contents:
      packages:
        - kubectl
        - wait-for-it
        - curl
    environment:
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: "32764"
  pipeline:
    - uses: test/tw/help-check
      with:
        bins: nri-kube-events
    - uses: test/kwok/cluster
      with:
        serviceaccount: true
    - name: Basic Functional test
      uses: test/daemon-check-output
      with:
        setup: |
          # RBAC so the SA can list/watch core/v1 events cluster-wide
          kubectl create clusterrole nri-kube-events-reader \
            --verb=get,list,watch \
            --resource=events,services,pods,nodes,namespaces,persistentvolumes,persistentvolumeclaims \
            --resource=deployments,daemonsets.apps \
            --resource=jobs,cronjobs.batch \
            --resource=events.events.k8s.io
          kubectl create clusterrolebinding nri-kube-events-reader \
            --clusterrole=nri-kube-events-reader \
            --serviceaccount=default:default
          # Minimal config for nri-kube-events : stdout sink
          cat > /tmp/test-config.yaml <<'YAML'
          log:
            level: info
          sinks:
            - name: stdout
              kind: stdout
          YAML
        start: nri-kube-events --config /tmp/test-config.yaml -promaddr 127.0.0.1:80
        timeout: 10
        expected_output: |
          New Relic Kube Events integration
          ${{package.version}}
          Router started
          Serving Prometheus metrics
          ADDED
          Active
        post: |
          # Validate Metrics
          wait-for-it 127.0.0.1:80
          curl -fsSL 127.0.0.1:80 > metrics.txt
          grep -q "nr_k8s_descriptions_workqueue_length" metrics.txt
          grep -q "nr_kube_events_sink_request_duration_seconds_bucket" metrics.txt
          grep -q "nr_kube_events_workqueue_length" metrics.txt
