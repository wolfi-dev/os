package:
  # we were historically only building njs against mainline versions of nginx (1.27.x, 1.29.x)
  # we've a provides in place now which does provide `njs-mainline`
  # njs package is actually mainline and is only compatible with nginx-mainline versions.
  name: njs
  version: "0.9.0"
  epoch: 3
  description: njs scripting language CLI utility
  dependencies:
    provides:
      - njs-mainline=${{package.full-version}}
  copyright:
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - libedit-dev
      - libxml2-dev
      - libxslt-dev
      - nginx-mainline-src # this is source code of nginx-mainline which is versioned with odd minor versions (1.27.x, 1.29.x)
      - openssl-dev
      - pcre-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/nginx/njs
      tag: ${{package.version}}
      expected-commit: fcb99b68f86a72c96e21b81b3b78251174dbd3bf
      destination: njs

  - runs: |
      builddir=$(pwd)
      mkdir -p build
      cd build
      ln -sf /usr/src/nginx/auto
      ln -sf /usr/src/nginx/src

      cd $builddir/njs

      CFLAGS="$CFLAGS -Wno-dangling-pointer -Wno-maybe-uninitialized" ./configure --debug=YES

      make njs

      mv build/njs ../build/

      cd $builddir/build

      /usr/src/nginx/auto/configure \
        --with-compat \
        --with-stream \
        --with-http_ssl_module \
        --with-http_v2_module \
        --add-dynamic-module=../njs/nginx

      make modules

      cd ..

      mkdir -p "${{targets.contextdir}}"/usr/bin
      install -m 755 -D build/njs "${{targets.contextdir}}"/usr/bin/njs

      cd build/objs
      mkdir -p "${{targets.contextdir}}"/usr/lib/nginx/modules
      for mod in *.so; do
          install -Dm755 $mod "${{targets.contextdir}}"/usr/lib/nginx/modules/$mod
      done

  - uses: strip

subpackages:
  - name: njs-debug
    pipeline:
      - runs: |
          builddir=$(pwd)
          mkdir -p "${{targets.contextdir}}"/usr/bin
          install -m 755 -D "$builddir"/build/njs "${{targets.contextdir}}"/usr/bin/njs-debug
    description: njs built with additional runtime checks and debug symbols

  - name: njs-libs-static
    pipeline:
      - uses: split/static
    description: njs static

test:
  environment:
    contents:
      packages:
        - nginx-mainline
        - njs-debug
  pipeline:
    - runs: |
        njs -v
        njs-debug -v
    - uses: test/tw/ldd-check
    - name: nginx config test
      runs: |
        cat <<EOF > /etc/nginx/nginx.conf
        user build;
        load_module /usr/lib/nginx/modules/ngx_http_js_module.so;
        events {}
        EOF
    - runs: nginx -T

update:
  enabled: true
  github:
    identifier: nginx/njs
    use-tag: true
