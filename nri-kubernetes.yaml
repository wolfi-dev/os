package:
  name: nri-kubernetes
  version: "3.48.0"
  epoch: 1 # GHSA-2464-8j7c-4cjm
  description: New Relic integration for Kubernetes
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      # Dependencies from upstream Dockerfile: https://github.com/newrelic/nri-kubernetes/blob/main/Dockerfile#L6
      - bind-tools # DNS tools for service discovery and cluster connectivity
      - curl # Used by nri-flex integration for Pixie Cloud Connector health checks (charts/newrelic-infrastructure/templates/kubelet/integrations-configmap.yaml:64)
      - dash-binsh
      - tini # Init process manager used in container ENTRYPOINT (Dockerfile:10)

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/newrelic/nri-kubernetes
      tag: v${{package.version}}
      expected-commit: e14683be30cdf03d6d9bc718d38a8b00200df355

  - uses: go/build
    with:
      packages: ./cmd/nri-kubernetes
      output: nri-kubernetes
      ldflags: |
        -X main.integrationVersion="${{package.version}}"
        -X main.gitCommit="$(git rev-parse HEAD)"
        -X main.buildDate="$(date -d@$SOURCE_DATE_EPOCH +%Y%m%d-%H:%M:%S)"

test:
  environment:
    contents:
      packages:
        - curl
        - python3
        - wait-for-it
    environment:
      AGENT_PORT: "8001"
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: "32764"
  pipeline:
    - uses: test/kwok/cluster
      with:
        serviceaccount: true
    - uses: test/daemon-check-output
      with:
        setup: |
          set -eo pipefail

          # Start mock agent to mimic newrelic-infra agent
          # nri-kubernetes sends metrics to agent (not directly to cloud)
          python3 test_metrics_server.py > /tmp/agent.log 2>&1 &
          AGENT_PID=$!
          echo "${AGENT_PID}" > /tmp/agent.pid

          # Wait for mock agent to be ready
          wait-for-it "localhost:${AGENT_PORT}" -t 30

          curl -sf "http://localhost:${AGENT_PORT}/" | grep -F "ready"

          mkdir -p /etc/newrelic-infra
          cp test-configs/nri-kubernetes-config.yml /etc/newrelic-infra/nri-kubernetes.yml
        start: nri-kubernetes
        timeout: 30
        expected_output: |
          Waiting for agent container to be ready...
          New Relic Kubernetes integration Version
        post: |
          set -eo pipefail

          # Kill the mock agent
          kill -9 "$(cat /tmp/agent.pid)" 2>/dev/null || true

          # Verify nri-kubernetes sent data to mock agent
          # becuase nri-kubernetes sends data to the New Relic agent
          # the log should contain POST requests with kubernetes metrics

          test -f /tmp/agent_received.log
          grep -F "Received POST to /v1/data" /tmp/agent_received.log
          grep -F "com.newrelic.kubernetes" /tmp/agent_received.log

update:
  enabled: true
  github:
    identifier: newrelic/nri-kubernetes
    strip-prefix: v
    tag-filter: v
    use-tag: true
  ignore-regex-patterns:
    - 'newrelic-infrastructure-'
    - 'e2e-resources-'
