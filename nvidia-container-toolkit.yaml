package:
  name: nvidia-container-toolkit
  version: "1.18.0"
  epoch: 1 # GHSA-qw9x-cqr3-wc7r
  description: Build and run containers leveraging NVIDIA GPUs
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - libnvidia-container

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go
  environment:
    GCC_SPEC_FILE: no-hardening.spec

pipeline:
  - uses: git-checkout
    with:
      expected-commit: f8daa5e26de9fd7eb79259040b6dd5a52060048c
      repository: https://github.com/NVIDIA/nvidia-container-toolkit
      tag: v${{package.version}}

  - uses: go/bump
    with:
      deps: |-
        github.com/opencontainers/runc@v1.3.3

data:
  - name: commands
    items:
      nvidia-container-runtime-hook: nvidia-container-runtime-hook
      nvidia-container-runtime-cdi: nvidia-container-runtime.cdi
      nvidia-container-runtime-legacy: nvidia-container-runtime.legacy
      nvidia-container-runtime: nvidia-container-runtime
      nvidia-cdi-hook: nvidia-cdi-hook
      nvidia-ctk: nvidia-ctk
      nvidia-ctk-installer: nvidia-ctk-installer

subpackages:
  - range: commands
    name: "${{package.name}}-${{range.key}}"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          packages: ./cmd/${{range.value}}
          ldflags: -s -w '-extldflags=-Wl,-undefined,dynamic_lookup' -X github.com/NVIDIA/nvidia-container-toolkit/internal/info.gitCommit=$(git rev-parse HEAD) -X github.com/NVIDIA/nvidia-container-toolkit/internal/info.version=${{package.version}}
          output: ${{range.value}}
          vendor: true
    test:
      pipeline:
        - runs: |
            apk add runc # runc is just a placeholder, the actual runtime binary is TBD by the user
            ${{range.value}} --help

  - name: "${{package.name}}-nvidia-toolkit"
    pipeline:
      - runs: |
          # Ref: https://github.com/NVIDIA/nvidia-container-toolkit/blob/v1.15.0/deployments/container/Dockerfile.ubi8#L74
          mkdir -p ${{targets.contextdir}}/work
          ln -sf /usr/bin/nvidia-ctk-installer ${{targets.contextdir}}/work/nvidia-toolkit
          ln -sf /usr/bin/nvidia-ctk-installer ${{targets.contextdir}}/work/nvidia-ctk-installer
    dependencies:
      runtime:
        - ${{package.name}}-nvidia-ctk-installer
    test:
      pipeline:
        - runs: |
            /work/nvidia-toolkit --version
            /work/nvidia-ctk-installer --version

update:
  enabled: true
  ignore-regex-patterns:
    - -rc
  github:
    identifier: NVIDIA/nvidia-container-toolkit
    strip-prefix: v

# Based on package contents inspection, it was found that this origin package is empty apart from its own SBOM and this test was added to confirm it is empty and will fail if the package is no longer empty (contains more than an SBOM)
test:
  pipeline:
    - uses: test/emptypackage
