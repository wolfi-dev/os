package:
  name: nvidia-container-toolkit
  version: "1.18.2"
  epoch: 1 # CVE-2025-61732
  description: Build and run containers leveraging NVIDIA GPUs
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - libnvidia-container

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go
  environment:
    GCC_SPEC_FILE: no-hardening.spec

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 9e88ed39710fd94c7e49fbb26d96492c45e574fb
      repository: https://github.com/NVIDIA/nvidia-container-toolkit
      tag: v${{package.version}}

data:
  - name: commands
    items:
      nvidia-container-runtime-hook: nvidia-container-runtime-hook
      nvidia-container-runtime-cdi: nvidia-container-runtime.cdi
      nvidia-container-runtime-legacy: nvidia-container-runtime.legacy
      nvidia-container-runtime: nvidia-container-runtime
      nvidia-cdi-hook: nvidia-cdi-hook
      nvidia-ctk: nvidia-ctk
      nvidia-ctk-installer: nvidia-ctk-installer

subpackages:
  - range: commands
    name: "${{package.name}}-${{range.key}}"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          packages: ./cmd/${{range.value}}
          ldflags: -s -w '-extldflags=-Wl,-undefined,dynamic_lookup' -X github.com/NVIDIA/nvidia-container-toolkit/internal/info.gitCommit=$(git rev-parse HEAD) -X github.com/NVIDIA/nvidia-container-toolkit/internal/info.version=${{package.version}}
          output: ${{range.value}}
          vendor: true
    test:
      pipeline:
        - runs: |
            apk add runc # runc is just a placeholder, the actual runtime binary is TBD by the user
            ${{range.value}} --help

  - name: "${{package.name}}-nvidia-toolkit"
    pipeline:
      - runs: |
          # Ref: https://github.com/NVIDIA/nvidia-container-toolkit/blob/v1.15.0/deployments/container/Dockerfile.ubi8#L74
          mkdir -p ${{targets.contextdir}}/work
          ln -sf /usr/bin/nvidia-ctk-installer ${{targets.contextdir}}/work/nvidia-toolkit
          ln -sf /usr/bin/nvidia-ctk-installer ${{targets.contextdir}}/work/nvidia-ctk-installer
    dependencies:
      runtime:
        - ${{package.name}}-nvidia-ctk-installer
    test:
      pipeline:
        - runs: |
            /work/nvidia-toolkit --version
            /work/nvidia-ctk-installer --version

  - name: "${{package.name}}-nvidia-ctk-systemd-service"
    description: Systemd services to configure NVIDIA Container Toolkit for container runtimes
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/lib/systemd/system"
          install -m644 nvidia-ctk-configure-crio.service "${{targets.contextdir}}/usr/lib/systemd/system/"
          install -m644 nvidia-ctk-configure-containerd.service "${{targets.contextdir}}/usr/lib/systemd/system/"
          install -m644 nvidia-ctk-configure-docker.service "${{targets.contextdir}}/usr/lib/systemd/system/"
    dependencies:
      runtime:
        - ${{package.name}}-nvidia-ctk
    test:
      pipeline:
        - uses: test/verify-service
        - runs: |
            [ -f /usr/lib/systemd/system/nvidia-ctk-configure-crio.service ]
            [ -f /usr/lib/systemd/system/nvidia-ctk-configure-containerd.service ]
            [ -f /usr/lib/systemd/system/nvidia-ctk-configure-docker.service ]

update:
  enabled: true
  ignore-regex-patterns:
    - -rc
  github:
    identifier: NVIDIA/nvidia-container-toolkit
    strip-prefix: v

# Based on package contents inspection, it was found that this origin package is empty apart from its own SBOM and this test was added to confirm it is empty and will fail if the package is no longer empty (contains more than an SBOM)
test:
  pipeline:
    - uses: test/emptypackage
