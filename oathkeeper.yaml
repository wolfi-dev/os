package:
  name: oathkeeper
  version: "25.4.0"
  epoch: 0
  description: Cloud‑native Identity & Access Proxy with Zero‑Trust access control
  copyright:
    - license: Apache‑2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/ory/oathkeeper
      tag: v${{package.version}}
      expected-commit: 2020997ed914fbc8c4b048effbe28841c34ac23d

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: oryx

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0

  - uses: go/build
    with:
      packages: .
      output: oathkeeper
      ldflags: |-
        -s -w
        -X 'github.com/ory/oathkeeper/x.Version=$(git describe --abbrev=0 --tags)'
        -X 'github.com/ory/oathkeeper/x.Date=$(TZ=UTC date -u -d "@$SOURCE_DATE_EPOCH" "+%Y-%m-%dT%H:%M:%SZ")'
        -X 'github.com/ory/oathkeeper/x.Commit=$(git rev-parse HEAD)'
      tags: sqlite,json1

update:
  enabled: true
  ignore-regex-patterns:
    - rc*
    - pre*
  github:
    identifier: ory/oathkeeper
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - curl

  pipeline:
    - runs: |
        set -ex
        /usr/bin/oathkeeper version | grep ${{package.version}}
        /usr/bin/oathkeeper help

    - name: Start server and test
      uses: test/daemon-check-output
      with:
        start: /usr/bin/oathkeeper serve --config /dev/null
        timeout: "30"
        expected_output: Listening
        post: curl -s http://localhost:4455/health/alive
