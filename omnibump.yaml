package:
  name: omnibump
  version: 0.5.2
  epoch: 0
  description: Dependency version bumping tool
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/chainguard-dev/omnibump
      tag: v${{package.version}}
      expected-commit: 14e35a315aea5304064ebe987b2521c04beba384

  - uses: go/build
    with:
      go-package: go-1.26
      packages: .
      output: omnibump

  - uses: strip

update:
  enabled: true
  github:
    identifier: chainguard-dev/omnibump
    strip-prefix: v
    use-tag: true

test:
  pipeline:
    - name: Verify omnibump version command
      runs: |
        set -euo pipefail
        omnibump version
    - name: Verify omnibump help
      runs: |
        set -euo pipefail
        omnibump --help
    - name: Test supported command
      runs: |
        set -euo pipefail
        omnibump supported | grep -F "go"
        omnibump supported | grep -F "java"
        omnibump supported | grep -F "rust"
    - name: Test analyze command help
      runs: |
        set -euo pipefail
        omnibump analyze --help
    - name: Setup test projects
      runs: |
        set -euo pipefail

        # Go project
        mkdir -p /tmp/test-go
        cd /tmp/test-go
        tee go.mod << 'EOF'
        module example.com/test

        go 1.24

        require (
        	github.com/spf13/cobra v1.8.0
        	golang.org/x/sys v0.20.0
        )
        EOF

        # Rust project
        mkdir -p /tmp/test-rust
        cd /tmp/test-rust
        tee Cargo.toml << 'EOF'
        [package]
        name = "test"
        version = "0.1.0"
        edition = "2021"

        [dependencies]
        serde = "1.0"
        EOF

        # Create a minimal Cargo.lock for detection
        tee Cargo.lock << 'EOF'
        # This file is automatically @generated by Cargo.
        # It is not intended for manual editing.
        version = 3

        [[package]]
        name = "test"
        version = "0.1.0"
        dependencies = [
         "serde",
        ]

        [[package]]
        name = "serde"
        version = "1.0.217"
        source = "registry+https://github.com/rust-lang/crates.io-index"
        checksum = "abc123"
        EOF

        # Maven project
        mkdir -p /tmp/test-maven
        cd /tmp/test-maven
        tee pom.xml << 'EOF'
        <project>
          <modelVersion>4.0.0</modelVersion>
          <groupId>com.example</groupId>
          <artifactId>test</artifactId>
          <version>1.0.0</version>
          <dependencies>
            <dependency>
              <groupId>junit</groupId>
              <artifactId>junit</artifactId>
              <version>4.13.2</version>
            </dependency>
          </dependencies>
        </project>
        EOF

        # Gradle project
        mkdir -p /tmp/test-gradle
        cd /tmp/test-gradle
        tee build.gradle << 'EOF'
        plugins {
            id 'java'
        }

        dependencies {
            implementation 'org.apache.commons:commons-lang3:3.12.0'
            testImplementation 'junit:junit:4.13.2'
        }
        EOF
    - name: Test Go language detection and analysis
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump analyze .
        OUTPUT=$(omnibump analyze . 2>&1)
        echo "$OUTPUT" | grep -F "go"
    - name: Test Rust language detection
      runs: |
        set -euo pipefail
        cd /tmp/test-rust
        OUTPUT=$(omnibump analyze . 2>&1)
        echo "$OUTPUT" | grep -F "rust"
    - name: Test Maven language detection
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        OUTPUT=$(omnibump analyze . 2>&1)
        echo "$OUTPUT" | grep -F "java"
    - name: Test Gradle language detection
      runs: |
        set -euo pipefail
        cd /tmp/test-gradle
        OUTPUT=$(omnibump analyze . 2>&1)
        echo "$OUTPUT" | grep -F "java"
    - name: Test explicit language selection for Go
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump --language go analyze . | grep -F "go"
    - name: Test explicit language selection for Rust
      runs: |
        set -euo pipefail
        cd /tmp/test-rust
        omnibump --language rust analyze . | grep -F "rust"
    - name: Test explicit language selection for Java
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        OUTPUT=$(omnibump --language java analyze . 2>&1)
        echo "$OUTPUT" | grep -F "maven"
    - name: Test deprecated maven language warning
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        omnibump --language maven analyze . 2>&1 | grep -F "deprecated"
    - name: Test JSON output format
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        OUTPUT=$(omnibump analyze . --output json)
        echo "$OUTPUT" | grep -F '"Language"'
    - name: Test YAML output format
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        OUTPUT=$(omnibump analyze . --output yaml)
        echo "$OUTPUT" | grep -F "Language:"
    - name: Test dry-run mode with deps file
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        tee deps.yaml << 'EOF'
        packages:
          - name: golang.org/x/sys
            version: v0.21.0
        EOF
        omnibump --deps deps.yaml --dry-run
    - name: Test inline package specification for Go
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump --packages "golang.org/x/sys@v0.21.0" --dry-run
    - name: Test Maven inline package format
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        omnibump --packages "junit@junit@4.13.3" --dry-run
    - name: Test Maven inline with scope
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        omnibump --packages "junit@junit@4.13.3@test" --dry-run
    - name: Test show-diff option
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump --packages "golang.org/x/sys@v0.21.0" --dry-run --show-diff
    - name: Test custom directory option
      runs: |
        set -euo pipefail
        mkdir -p /tmp/test-dir-go
        cd /tmp/test-dir-go
        tee go.mod << 'EOF'
        module example.com/dirtest

        go 1.24

        require golang.org/x/sys v0.20.0
        EOF
        omnibump --dir /tmp/test-dir-go --packages "golang.org/x/sys@v0.21.0" --dry-run
    - name: Test analyze with package recommendation
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        OUTPUT=$(omnibump analyze --packages "golang.org/x/sys@v0.22.0")
        echo "$OUTPUT" | grep -F "Update Strategy"
    - name: Test Go replaces file
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        tee replaces.yaml << 'EOF'
        replaces:
          - oldName: github.com/old/pkg
            name: github.com/new/pkg
            version: v1.0.0
        EOF
        omnibump --deps replaces.yaml --dry-run
    - name: Test legacy gobump-deps.yaml compatibility
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        tee gobump-deps.yaml << 'EOF'
        packages:
          - name: golang.org/x/sys
            version: v0.21.0
        EOF
        omnibump --deps gobump-deps.yaml --dry-run
    - name: Test legacy cargobump-deps.yaml compatibility
      runs: |
        set -euo pipefail
        cd /tmp/test-rust
        tee cargobump-deps.yaml << 'EOF'
        packages:
          - name: serde
            version: 1.0.217
        EOF
        omnibump --deps cargobump-deps.yaml --dry-run
    - name: Test legacy pombump-deps.yaml compatibility
      runs: |
        set -euo pipefail
        cd /tmp/test-maven
        tee pombump-deps.yaml << 'EOF'
        packages:
          - groupId: junit
            artifactId: junit
            version: 4.13.3
        EOF
        omnibump --deps pombump-deps.yaml --dry-run
    - name: Test combined dry-run and show-diff
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump --packages "golang.org/x/sys@v0.21.0" --dry-run --show-diff
    - name: Test multiple inline packages
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        omnibump --packages "golang.org/x/sys@v0.21.0 github.com/spf13/cobra@v1.9.0" --dry-run
    - name: Test language field in config file
      runs: |
        set -euo pipefail
        cd /tmp/test-go
        tee deps-with-lang.yaml << 'EOF'
        language: go
        packages:
          - name: golang.org/x/sys
            version: v0.21.0
        EOF
        omnibump --deps deps-with-lang.yaml --dry-run
    - name: Test Gradle version catalog detection
      runs: |
        set -euo pipefail
        mkdir -p /tmp/test-gradle-toml/gradle
        cd /tmp/test-gradle-toml
        tee build.gradle << 'EOF'
        plugins {
            id 'java'
        }
        EOF
        tee gradle/libs.versions.toml << 'EOF'
        [versions]
        commons = "3.12.0"

        [libraries]
        commons-lang3 = { group = "org.apache.commons", name = "commons-lang3", version.ref = "commons" }
        EOF
        omnibump analyze .
