#nolint:valid-pipeline-git-checkout-tag
# FIXME: REMOVE NOLINT
package:
  name: onnxruntime
  version: 1.22.0
  epoch: 0
  description: Cross-platform, high performance ML inferencing and training accelerator
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - coreutils
      - curl
      - eigen-dev
      - gcc-14-default
      - gtest-dev
      - patch
      - py3-build-base-dev
      - py3-flatbuffers
      - py3-numpy
      - py3-packaging
      - py3-protobuf
      - py3-setuptools
      - py3-wheel
      - python3
      - re2-dev
      - zlib-dev
  environment:
    CXXFLAGS: "-fdelete-null-pointer-checks"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/microsoft/onnxruntime.git
      # tag: v${{package.version}}
      # expected-commit: f217402897f40ebba457e2421bc0a4702771968e
      branch: main
      expected-commit: d29328588e00bf2e578d904403fa5c6627754346

  # - uses: patch
  #   with:
  #     patches: onnxruntime-use-system-flatbuffers.patch

  - runs: |
      # Find system nlohmann-json
      sed 's|3.10 ||g' \
        -i cmake/external/onnxruntime_external_deps.cmake

      # Find system chrono-date
      sed -e 's|${DEP_SHA1_date}|&\n \ \ \ \ \ \FIND_PACKAGE_ARGS NAMES date|g' \
          -e 's|date_interface|date::date-tz|g' \
          -i cmake/external/onnxruntime_external_deps.cmake \
          -i cmake/onnxruntime_common.cmake \
          -i cmake/onnxruntime_unittests.cmake

      # Find system abseil-cpp
      sed 's|ABSL_PATCH_COMMAND}|&\n\ \ \ \ \FIND_PACKAGE_ARGS NAMES absl|g' \
        -i cmake/external/abseil-cpp.cmake

      # Find system cxxopts
      sed 's|${DEP_SHA1_cxxopts}|&\n\ \ \ \ \FIND_PACKAGE_ARGS NAMES cxxopts|g' \
        -i cmake/external/onnxruntime_external_deps.cmake

      # Find system nsync
      # NOTE check line number after every release
      sed -e 's|NAMES nsync|&_cpp|g' \
          -e '368aadd_library(nsync::nsync_cpp ALIAS nsync_cpp)' \
          -i cmake/external/onnxruntime_external_deps.cmake

  - runs: |
      ./build.sh \
        --allow_running_as_root \
        --skip_submodule_sync \
        --config Release \
        --update --build --parallel $(nproc --ignore=2) \
        --build_shared_lib \
        --cmake_extra_defines CMAKE_INSTALL_PREFIX=/usr BUILD_TESTING=off CMAKE_CXX_STANDARD=17
      # Fixes a build issue where date-build's cmake_install.cmake file cannot be found. FIXME: remove the need for this somehow
      cp ./build/Linux/Release/_deps/date-subbuild/cmake_install.cmake ./build/Linux/Release/_deps/date-build/
      make install -C ./build/Linux/Release/ DESTDIR=${{targets.contextdir}}

update:
  enabled: true
  github:
    identifier: microsoft/onnxruntime
    strip-prefix: v

subpackages:
  - name: ${{package.name}}-dev
    description: ${{package.name}} development libraries
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - ${{package.name}}
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: ${{package.name}}-dev
