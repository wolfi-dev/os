package:
  name: onnxruntime
  version: 1.22.0
  epoch: 0
  description: Cross-platform, high performance ML inferencing and training accelerator
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - cmake
      - py3-numpy
      - python3
      - python3-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/microsoft/onnxruntime.git
      tag: v${{package.version}}
      expected-commit: dafa7f9365b1ed9c9e27a9806fef6e7275c5d9c6

  - runs: |
      # Find system nlohmann-json
      sed 's|3.10 ||g' \
        -i cmake/external/onnxruntime_external_deps.cmake

      # Find system chrono-date
      sed -e 's|${DEP_SHA1_date}|&\n \ \ \ \ \ \FIND_PACKAGE_ARGS NAMES date|g' \
          -e 's|date_interface|date::date-tz|g' \
          -i cmake/external/onnxruntime_external_deps.cmake \
          -i cmake/onnxruntime_common.cmake \
          -i cmake/onnxruntime_unittests.cmake

      # Find system abseil-cpp
      sed 's|ABSL_PATCH_COMMAND}|&\n\ \ \ \ \FIND_PACKAGE_ARGS NAMES absl|g' \
        -i cmake/external/abseil-cpp.cmake

      # Find system cxxopts
      sed 's|${DEP_SHA1_cxxopts}|&\n\ \ \ \ \FIND_PACKAGE_ARGS NAMES cxxopts|g' \
        -i cmake/external/onnxruntime_external_deps.cmake

      # Find system nsync
      # NOTE check line number after every release
      sed -e 's|NAMES nsync|&_cpp|g' \
          -e '368aadd_library(nsync::nsync_cpp ALIAS nsync_cpp)' \
          -i cmake/external/onnxruntime_external_deps.cmake

  - uses: cmake/configure
    with:
      opts: |
        -S cmake \
        -Donnxruntime_ENABLE_PYTHON=ON \
        -Donnxruntime_BUILD_SHARED_LIB=ON \
        -Donnxruntime_BUILD_UNIT_TESTS=OFF \
        -Donnxruntime_ENABLE_TRAINING=ON \
        -Donnxruntime_ENABLE_LAZY_TENSOR=OFF \
        -Donnxruntime_USE_DNNL=ON \
        -Donnxruntime_USE_PREINSTALLED_EIGEN=OFF \
        -DCMAKE_POLICY_VERSION_MINIMUM=3.5

  - uses: cmake/build

  - uses: cmake/install

update:
  enabled: true
  github:
    identifier: microsoft/onnxruntime
    strip-prefix: v
