# Generated from https://git.alpinelinux.org/aports/plain/community/openblas/APKBUILD
package:
  name: openblas
  version: "0.3.31"
  epoch: 2
  description: fast BSD-licensed BLAS based on gotoBLAS2, with LAPACK
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - libopenblas-0
  resources:
    cpu: "12"
    memory: 9Gi

data:
  # Build variants: 64 first so standard runs last for lapack
  - name: variants
    items:
      "64": "INTERFACE64=1 LIBNAMESUFFIX=64"
      "": "INTERFACE64=0"

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - gfortran
      - linux-headers
      - perl

pipeline:
  - uses: fetch
    with:
      expected-sha256: 6dd2a63ac9d32643b7cc636eab57bf4e57d0ed1fff926dfbc5d3d97f2d2be3a6
      uri: https://github.com/xianyi/OpenBLAS/archive/v${{package.version}}/openblas-${{package.version}}.tar.gz

  - uses: patch
    with:
      patches: blas-lapack.patch

  # Save source for variant builds
  - runs: |
      cp -a . /home/openblas-src

subpackages:
  - range: variants
    name: libopenblas${{range.key}}-0
    description: OpenBLAS shared library${{range.key == "64" && " (ILP64 interface)" || ""}}
    pipeline:
      - runs: |
          cp -a /home/openblas-src /home/build/build${{range.key}}
      - working-directory: /home/build/build${{range.key}}
        runs: |
          _flags="
            MAJOR_VERSION=3
            NO_AFFINITY=1
            USE_OPENMP=0
            PREFIX=/usr
            ${{range.value}}
            "
          ARCH=${{build.arch}}
          if [ "$ARCH" = "x86_64" ]; then
            _flags="$_flags DYNAMIC_ARCH=1"
            _flags="$_flags TARGET=CORE2"
          elif [ "$ARCH" = "aarch64" ]; then
            _flags="$_flags DYNAMIC_ARCH=0"
            _flags="$_flags TARGET=ARMV8"
          fi

          export CFLAGS=${CFLAGS/-Os/-O2}

          make $_flags CFLAGS="$CFLAGS"

          # Build lapack only for standard (non-64) variant
          if [ "${{range.key}}" != "64" ]; then
            make -C interface $_flags CFLAGS="$CFLAGS" shared-blas-lapack
          fi

          make $_flags DESTDIR="${{targets.contextdir}}" install

          # Install lapack only for standard variant
          if [ "${{range.key}}" != "64" ]; then
            install -Dm755 interface/liblapack.so.3 \
              "${{targets.contextdir}}"/usr/lib/liblapack.so.3
            ln -s liblapack.so.3 "${{targets.contextdir}}"/usr/lib/liblapack.so
            install -Dm755 interface/liblapacke.so.3 \
              "${{targets.contextdir}}"/usr/lib/liblapacke.so.3
            ln -s liblapacke.so.3 "${{targets.contextdir}}"/usr/lib/liblapacke.so

            install -Dm 0644 Changelog.txt TargetList.txt USAGE.md \
              -t "${{targets.contextdir}}"/usr/share/doc/${{package.name}}/
          fi
      - uses: strip
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            ls -la /usr/lib/libopenblas${{range.key}}*.so*

  - range: variants
    name: openblas${{range.key}}-static
    description: OpenBLAS static libraries${{range.key == "64" && " (ILP64 interface)" || ""}}
    pipeline:
      - uses: split/static
        with:
          package: libopenblas${{range.key}}-0

  - range: variants
    name: openblas${{range.key}}-dev
    description: OpenBLAS development headers and libraries${{range.key == "64" && " (ILP64 interface)" || ""}}
    dependencies:
      runtime:
        - libopenblas${{range.key}}-0
        - openblas${{range.key}}-static
    pipeline:
      - uses: split/dev
        with:
          package: libopenblas${{range.key}}-0
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
        - runs: |
            # Verify pkgconfig has ILP64 configuration for 64-bit variant
            if [ "${{range.key}}" = "64" ]; then
              pkg-config --variable=openblas_config openblas64 | grep -F "USE_64BITINT=1"
            fi

  - name: openblas-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share/doc/${{package.name}}
          mv "${{targets.outdir}}/libopenblas-0"/usr/share/doc/${{package.name}}/* "${{targets.contextdir}}"/usr/share/doc/${{package.name}}/
    description: openblas manpages
    test:
      pipeline:
        - uses: test/docs

  - name: liblapack
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv "${{targets.outdir}}/libopenblas-0"/usr/lib/liblapack.so* "${{targets.subpkgdir}}"/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: liblapacke
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv "${{targets.outdir}}/libopenblas-0"/usr/lib/liblapacke.so* "${{targets.subpkgdir}}"/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  # Compatibility alias for openblas64
  - name: openblas64
    description: fast BSD-licensed BLAS based on gotoBLAS2 (ILP64 interface)
    dependencies:
      runtime:
        - libopenblas64-0
    pipeline:
      - runs: mkdir -p "${{targets.contextdir}}"
    test:
      pipeline:
        - uses: test/emptypackage

test:
  pipeline:
    - uses: test/emptypackage

update:
  enabled: true
  github:
    identifier: xianyi/OpenBLAS
    strip-prefix: v
