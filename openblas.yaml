# Generated from https://git.alpinelinux.org/aports/plain/community/openblas/APKBUILD
package:
  name: openblas
  version: "0.3.31"
  epoch: 3
  description: fast BSD-licensed BLAS based on gotoBLAS2, with LAPACK
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - libopenblas-0=${{package.full-version}}
  resources:
    cpu: "12"
    memory: 9Gi

data:
  # Build variants: 64 first so standard runs last for lapack
  - name: variants
    items:
      "64": "INTERFACE64=1 LIBNAMESUFFIX=64"
      "": "INTERFACE64=0"

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - gfortran
      - linux-headers
      - perl
  environment:
    OPENBLAS_FLAGS: "MAJOR_VERSION=3 NO_AFFINITY=1 PREFIX=/usr USE_OPENMP=0"

pipeline:
  - uses: fetch
    with:
      expected-sha256: 6dd2a63ac9d32643b7cc636eab57bf4e57d0ed1fff926dfbc5d3d97f2d2be3a6
      uri: https://github.com/xianyi/OpenBLAS/archive/v${{package.version}}/openblas-${{package.version}}.tar.gz
    working-directory: openblas-src

  - uses: patch
    with:
      patches: ../blas-lapack.patch
    working-directory: openblas-src

  - assertions:
      required-steps: 1
    pipeline:
      - name: Set x86_64-specific flags
        if: ${{build.arch}} == 'x86_64'
        runs: |
          echo 'export ARCH_FLAGS="DYNAMIC_ARCH=1 TARGET=CORE2"' > .env
      - name: Set aarch64-specific flags
        if: ${{build.arch}} == 'aarch64'
        runs: |
          echo 'export ARCH_FLAGS="DYNAMIC_ARCH=0 TARGET=ARMV8"' > .env

subpackages:
  - range: variants
    name: libopenblas${{range.key}}-0
    description: OpenBLAS shared library${{range.key == "64" && " (ILP64 interface)" || ""}}
    pipeline:
      - runs: |
          cp -a openblas-src build${{range.key}}
      - name: Build OpenBLAS
        working-directory: /home/build/build${{range.key}}
        runs: |
          . ../.env
          make ${{range.value}} $OPENBLAS_FLAGS $ARCH_FLAGS CFLAGS="${CFLAGS/-Os/-O2}"
      - if: '"${{range.key}}" == ""'
        name: Build lapack for standard variant
        working-directory: /home/build/build${{range.key}}
        runs: |
          . ../.env
          make -C interface ${{range.value}} $OPENBLAS_FLAGS $ARCH_FLAGS CFLAGS="${CFLAGS/-Os/-O2}" shared-blas-lapack
      - name: Install OpenBLAS
        working-directory: /home/build/build${{range.key}}
        runs: |
          . ../.env
          make ${{range.value}} $OPENBLAS_FLAGS $ARCH_FLAGS DESTDIR="${{targets.contextdir}}" install
      - if: '"${{range.key}}" == ""'
        name: Install lapack for standard variant
        working-directory: /home/build/build${{range.key}}
        runs: |
          install -Dm755 interface/liblapack.so.3 \
            "${{targets.contextdir}}"/usr/lib/liblapack.so.3
          ln -s liblapack.so.3 "${{targets.contextdir}}"/usr/lib/liblapack.so
          install -Dm755 interface/liblapacke.so.3 \
            "${{targets.contextdir}}"/usr/lib/liblapacke.so.3
          ln -s liblapacke.so.3 "${{targets.contextdir}}"/usr/lib/liblapacke.so

          install -Dm 0644 Changelog.txt TargetList.txt USAGE.md \
            -t "${{targets.contextdir}}"/usr/share/doc/${{package.name}}/
      - uses: strip
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            ls -la /usr/lib/libopenblas${{range.key}}*.so*

  - range: variants
    name: openblas${{range.key}}-static
    description: OpenBLAS static libraries${{range.key == "64" && " (ILP64 interface)" || ""}}
    pipeline:
      - uses: split/static
        with:
          package: libopenblas${{range.key}}-0

  - range: variants
    name: openblas${{range.key}}-dev
    description: OpenBLAS development headers and libraries${{range.key == "64" && " (ILP64 interface)" || ""}}
    dependencies:
      runtime:
        - libopenblas${{range.key}}-0
        - openblas${{range.key}}-static
    pipeline:
      - uses: split/dev
        with:
          package: libopenblas${{range.key}}-0
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
        - if: '"${{range.key}}" == "64"'
          name: Verify pkgconfig has ILP64 configuration
          runs: |
            pkg-config --variable=openblas_config openblas64 | grep -F "USE_64BITINT=1"

  - name: openblas-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share/doc/${{package.name}}
          mv "${{targets.outdir}}/libopenblas-0"/usr/share/doc/${{package.name}}/* "${{targets.contextdir}}"/usr/share/doc/${{package.name}}/
    description: openblas manpages
    test:
      pipeline:
        - uses: test/docs

  - name: liblapack
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv "${{targets.outdir}}/libopenblas-0"/usr/lib/liblapack.so* "${{targets.subpkgdir}}"/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: liblapacke
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv "${{targets.outdir}}/libopenblas-0"/usr/lib/liblapacke.so* "${{targets.subpkgdir}}"/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  # Compatibility alias for openblas64, for parity with openblas
  - name: openblas64
    description: fast BSD-licensed BLAS based on gotoBLAS2 (ILP64 interface)
    dependencies:
      runtime:
        - libopenblas64-0=${{package.full-version}}
    test:
      pipeline:
        - uses: test/emptypackage

test:
  pipeline:
    - uses: test/emptypackage

update:
  enabled: true
  github:
    identifier: xianyi/OpenBLAS
    strip-prefix: v
