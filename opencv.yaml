package:
  name: opencv
  version: "4.12.0"
  epoch: 2
  description: Open source computer vision and machine learning library
  copyright:
    - license: BSD-3-Clause

vars:
  cmake-opts: |
    -DENABLE_BUILD_HARDENING=ON \
    -DCMAKE_BUILD_TYPE=RELEASE \
    -DCMAKE_INSTALL_PREFIX=/usr/ \
    -DOPENCV_EXTRA_MODULES_PATH=./opencv_contrib/modules \
    -DWITH_QT=OFF \
    -DWITH_TBB=ON \
    -DBUILD_JPEG=ON \
    -DBUILD_DOCS=OFF \
    -DBUILD_EXAMPLES=OFF \
    -DBUILD_TESTS=OFF \
    -DBUILD_PERF_TESTS=OFF \
    -DBUILD_opencv_java=NO \
    -DBUILD_opencv_python=NO \
    -DBUILD_opencv_python2=NO \
    -DBUILD_opencv_python3=NO \
    -DOPENCV_GENERATE_PKGCONFIG=ON \

environment:
  environment:
    CFLAGS: "$CFLAGS -g1"
    CXXFLAGS: "$CXXFLAGS -g1"
    CC: clang
    CXX: clang++
  contents:
    packages:
      - binutils
      - build-base
      - busybox
      - ca-certificates-bundle
      - clang
      - cmake
      - eigen-dev
      - glibc
      - harfbuzz-dev
      - hdf5-dev
      - libtbb-dev
      - lld
      - nasm
      - ninja-build
      - openblas-dev
      - opencl-dev
      - python3-dev
      - samurai

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/opencv/opencv
      expected-commit: 49486f61fb25722cbcf586b7f4320921d46fb38e
      tag: ${{package.version}}

  - working-directory: /home/build/opencv_contrib
    uses: git-checkout
    with:
      repository: https://github.com/opencv/opencv_contrib
      expected-commit: d943e1d61c8bc556a13783e1546ee7c1a9e0b1cf
      tag: ${{package.version}}

  # resolves this https://github.com/opencv/opencv/issues/27530
  - uses: patch
    with:
      patches: eigen-version-detection.patch

  - if: ${{build.arch}} == 'x86_64'
    uses: cmake/configure
    name: Cmake Configure
    with:
      output-dir: build
      opts: |
        ${{vars.cmake-opts}} \
        -DCMAKE_C_FLAGS="-g1 -mwaitpkg" \
        -DCMAKE_CXX_FLAGS="-g1 -mwaitpkg" \
        -DWITH_IPP=OFF \
        -DWITH_OPENGL=OFF \
        -DWITH_FREETYPE=ON \
        -DWITH_JASPER=OFF \
        -DWITH_SIMD=ON \
        -DENABLE_LIBJPEG_TURBO_SIMD=ON

  - if: ${{build.arch}} == 'aarch64'
    uses: cmake/configure
    name: Cmake Configure
    with:
      output-dir: build
      opts: |
        ${{vars.cmake-opts}} \
        -DENABLE_NEON=ON \
        -DWITH_FFMPEG=ON \
        -DBUILD_TBB=ON \
        -DWITH_EIGEN=OFF \
        -DWITH_GSTREAMER=OFF \
        -DWITH_V4L=ON \
        -DWITH_LIBV4L=ON \
        -DWITH_VTK=OFF \
        -DCMAKE_TOOLCHAIN_FILE=../platforms/linux/aarch64-gnu.toolchain.cmake

  - runs: ninja -C build -j $(nproc)

  - runs: |
      ctest --test-dir build --output-on-failure

  - uses: cmake/install
    name: Install opencv
    with:
      output-dir: build

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: "Open source computer vision and machine learning library (development files)"
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

test:
  environment:
    contents:
      packages:
        - gcc
        - opencv-dev
        - pkgconf
  pipeline:
    - uses: test/tw/ldd-check
    - name: Verify opencv installation, please improve the test as needed
      runs: |
        g++ test_opencv.cpp `pkg-config --cflags --libs opencv4` -o test_opencv
        ./test_opencv || { echo "OpenCV runtime test failed"; exit 1; }

update:
  enabled: true
  github:
    identifier: opencv/opencv
    use-tag: true
