package:
  name: opencv
  version: "4.12.0"
  epoch: 2
  description: Open source computer vision and machine learning library
  copyright:
    - license: BSD-3-Clause

data:
  - name: libs
    items:
      calib3d: Camera calibration and 3D reconstruction.
      core: Essential structures and functions.
      dnn: Deep neural network inference.
      features2d: Keypoint detection and description.
      flann: Fast nearest neighbor searches.
      highgui: Basic GUI and image display.
      imgcodecs: Image file read/write.
      imgproc: Core image processing routines.
      ml: Traditional machine learning algorithms.
      objdetect: Object detection methods.
      photo: Image enhancement and denoising.
      stitching: Panorama image stitching.
      video: Video analysis and processing.
      videoio: Video capture and output.
      gapi: graph API

environment:
  environment:
    CFLAGS: "$CFLAGS -g1 -mwaitpkg"
    CXXFLAGS: "$CXXFLAGS -g1 -mwaitpkg"
    CC: clang
    CXX: clang++
  contents:
    packages:
      - binutils
      - build-base
      - busybox
      - ca-certificates-bundle
      - clang
      - cmake
      - eigen-dev
      - glibc
      - harfbuzz-dev
      - hdf5-dev
      - libtbb-dev
      - lld
      - nasm
      - ninja-build
      - openblas-dev
      - opencl-dev
      - python3-dev
      - samurai

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/opencv/opencv
      expected-commit: 49486f61fb25722cbcf586b7f4320921d46fb38e
      tag: ${{package.version}}

  - working-directory: /home/build/opencv_contrib
    uses: git-checkout
    with:
      repository: https://github.com/opencv/opencv_contrib
      expected-commit: d943e1d61c8bc556a13783e1546ee7c1a9e0b1cf
      tag: ${{package.version}}

  - uses: patch
    with:
      patches: eigen-version-detection.patch
      # resolves https://github.com/opencv/opencv/issues/27530

  - uses: cmake/configure
    name: Cmake Configure
    with:
      output-dir: build
      opts: |
        -DENABLE_BUILD_HARDENING=ON \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_STANDARD=14 \
        -DOPENCV_EXTRA_MODULES_PATH=./opencv_contrib/modules \
        -DWITH_TBB=ON \
        -DBUILD_TBB=ON \
        -DBUILD_JPEG=ON \
        -DENABLE_LIBJPEG_TURBO_SIMD=ON \
        -DBUILD_EXAMPLES=OFF \
        -DBUILD_TESTS=OFF \
        -DBUILD_PERF_TESTS=ON \
        -DBUILD_opencv_java=NO \
        -DBUILD_opencv_python=NO \
        -DBUILD_opencv_python2=NO \
        -DBUILD_opencv_python3=NO \
        -DOPENCV_GENERATE_PKGCONFIG=ON \

  - runs: ninja -C build -j $(nproc)

  - runs: |
      ctest --test-dir build --output-on-failure

  - uses: cmake/install
    name: Install opencv
    with:
      output-dir: build

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: "Open source computer vision and machine learning library (development files)"
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - range: libs
    name: libopencv-${{range.key}}
    description: opencv's ${{range.value}} library
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/libopencv_${{range.key}}.so.* ${{targets.subpkgdir}}/usr/lib
    test:
      pipeline:
        - runs: stat /usr/lib/libopencv_${{range.key}}.so.* || exit 1
        - uses: test/tw/ldd-check

test:
  environment:
    contents:
      packages:
        - gcc
        - opencv-dev
        - pkgconf
  pipeline:
    - name: Verify opencv installation, please improve the test as needed
      runs: |
        g++ test_opencv.cpp `pkg-config --cflags --libs opencv4` -o test_opencv
        ./test_opencv || { echo "OpenCV runtime test failed"; exit 1; }

update:
  enabled: true
  github:
    identifier: opencv/opencv
    use-tag: true
