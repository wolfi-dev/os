package:
  name: openjdk-8
  version: 8.472.08 # this corresponds to same release as jdk8u472-ga - build number can be dropped with next GA release.
  epoch: 1
  description: "OpenJDK 8"
  copyright:
    - license: GPL-2.0-with-classpath-exception
  dependencies:
    runtime:
      - java-cacerts

var-transforms:
  - from: ${{package.version}}
    match: ^8\.(\d+).*$
    replace: $1
    to: update-version

environment:
  contents:
    packages:
      - ${{package.name}}-default-jdk
      - alsa-lib-dev
      - attr-dev
      - autoconf
      - automake
      - bash
      - build-base
      - ca-certificates
      - cairo-dev
      - coreutils
      - cups-dev
      - expat-dev
      - file
      - findutils
      - fontconfig-dev
      - freetype-dev
      - fribidi-dev
      - gawk
      - gcc-14-default
      - gdk-pixbuf-dev
      - giflib-dev
      - glib-dev
      - gtk-2.0-dev
      - harfbuzz-dev
      - krb5-dev
      - lcms2-dev
      - libffi-dev
      - libice-dev
      - libjpeg-turbo-dev
      - libpng-dev
      - libtool
      - libx11-dev
      - libxcomposite-dev
      - libxext-dev
      - libxft-dev
      - libxi-dev
      - libxinerama-dev
      - libxrandr-dev
      - libxrender-dev
      - libxslt-dev
      - libxt-dev
      - libxtst-dev
      - linux-headers
      - pango-dev
      - patch
      - pkgconf-dev
      - posix-libc-utils
      - sed
      - util-linux-dev
      - wolfi-base
      - zip
      - zlib-dev
  environment:
    EXTRA_CFLAGS: "-Wno-incompatible-pointer-types -Wno-int-conversion -Wno-complain-wrong-lang -Wformat -Wno-cpp -Wno-error -fno-delete-null-pointer-checks -fno-lifetime-dse -fno-strict-overflow"
    EXTRA_CPP_FLAGS: "-Wno-incompatible-pointer-types -Wno-int-conversion -Wno-complain-wrong-lang -Wno-cpp -fno-delete-null-pointer-checks -fno-lifetime-dse -fno-strict-overflow"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openjdk/jdk8u.git
      tag: jdk8u${{vars.update-version}}-ga
      expected-commit: d5ac2ad89a369697a48e7f3e6b889e22afa50a2f

  - uses: patch
    with:
      patches: |
        fix-as-needed-linking.patch
        fix-build-with-glibc-2.42.patch

  - runs: chmod +x configure

  # Note that despite using --with-extra-cflags, --with-extra-cxxflags, and
  # --with-extra-ldflags, the configure still produces warnings like:
  # https://github.com/wolfi-dev/os/issues/18747
  - uses: autoconf/configure
    with:
      opts: |
        --with-extra-cflags="$EXTRA_CFLAGS" \
        --with-extra-cxxflags="$EXTRA_CPP_FLAGS" \
        --with-extra-ldflags="$LDFLAGS" \
        --with-boot-jdk=/usr/lib/jvm/java-1.8-openjdk \
        --prefix=/usr/lib/jvm/java-1.8-openjdk \
        --with-vendor-name=wolfi \
        --with-vendor-url=https://wolfi.dev \
        --with-vendor-bug-url=https://github.com/wolfi-dev/os/issues \
        --with-update-version=${{vars.update-version}} \
        --with-milestone=fcs \
        --disable-precompiled-headers \
        --with-zlib=system \
        --with-debug-level=release \
        --with-native-debug-symbols=internal \
        --with-jvm-variants=server \
        --with-jtreg=no  \
        --with-giflib=system \
        --with-stdc++lib=dynamic

  - runs: make images

  - runs: |
      _java_home="usr/lib/jvm/java-1.8-openjdk"

      mkdir -p "${{targets.destdir}}"/$_java_home
      cp -r build/*-normal-server-release/images/j2sdk-image/* "${{targets.destdir}}"/$_java_home
      rm "${{targets.destdir}}"/$_java_home/src.zip

      # This archive contains absolute paths from the build environment,
      # so it does not work on the target system. User can generate it
      # running 'java -Xshare:dump'.
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/server/classes.jsa

      # symlink to shared java cacerts store
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/lib/security/cacerts
      ln -sf /etc/ssl/certs/java/cacerts \
        "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/lib/security/cacerts

      # Note: Previous to 8.452.09-r4 we had code here to remove additional
      # things as "not needed for headless installs". That code was broken
      # and was not actually removing those things. "Fixing" that bug in -r5
      # broke at least one user of an app that used libawt. So now we're
      # just removing policytool because it was the one thing actually being
      # removed before. We should consider if it too should be shipped since
      # we now know this is being used in head-full environments.
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/bin/policytool

  - uses: strip

subpackages:
  - name: "${{package.name}}-dbg"
    description: "OpenJDK 8 Java Debug Symbols"
    pipeline:
      - uses: split/debug
    dependencies:
      runtime:
        - ${{package.name}}

  - name: "${{package.name}}-jre"
    description: "OpenJDK 8 Java Runtime Environment"
    dependencies:
      runtime:
        - java-cacerts
      provider-priority: 10
    pipeline:
      - runs: |
          _java_home="usr/lib/jvm/java-1.8-openjdk"
          mkdir -p "${{targets.subpkgdir}}"/$_java_home
          cp -r build/*-normal-server-release/images/j2re-image/* "${{targets.subpkgdir}}"/$_java_home

          # symlink to shared java cacerts store
          rm -f "${{targets.subpkgdir}}"/$_java_home/lib/security/cacerts
          ln -sf /etc/ssl/certs/java/cacerts \
            "${{targets.subpkgdir}}"/$_java_home/lib/security/cacerts

          # symlink for `java-common` to work (which expects jre in $_java_home/jre)
          ln -sf . "${{targets.subpkgdir}}/$_java_home/jre"
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: "${{package.name}}-doc"
    description: "OpenJDK 8 Documentation"
    pipeline:
      - runs: |
          _java_home="usr/lib/jvm/java-1.8-openjdk"
          mkdir -p "${{targets.subpkgdir}}"/$_java_home
          if [ -d "${{targets.destdir}}"/$_java_home/man ]; then
            mv "${{targets.destdir}}"/$_java_home/man \
               "${{targets.subpkgdir}}"/$_java_home
          fi

  - name: "${{package.name}}-demos"
    description: "OpenJDK 8 Demos"
    pipeline:
      - runs: |
          _java_home="usr/lib/jvm/java-1.8-openjdk"
          mkdir -p "${{targets.subpkgdir}}"/$_java_home
          mv "${{targets.destdir}}"/$_java_home/demo \
             "${{targets.subpkgdir}}"/$_java_home

  - name: "${{package.name}}-default-jvm"
    description: "Use the openjdk-8 JVM as the default JVM"
    dependencies:
      runtime:
        - java-common-jre
        - ${{package.name}}-jre
      provides:
        - default-jvm=1.8
        - default-jvm-lts=1.8
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm
          ln -sf java-1.8-openjdk "${{targets.subpkgdir}}"/usr/lib/jvm/default-jvm
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jvm
            real-pkg-name: ${{subpkg.name}}
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jvm-lts
            real-pkg-name: ${{subpkg.name}}

  - name: "${{package.name}}-default-jdk"
    description: "Use the openjdk-8 JVM as the default JVM with the JDK installed"
    dependencies:
      runtime:
        - java-common
        - ${{package.name}}
      provides:
        - default-jdk=1.8
        - default-jdk-lts=1.8
        - ${{package.name}}-jre=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm
          ln -sf java-1.8-openjdk "${{targets.subpkgdir}}"/usr/lib/jvm/default-jvm
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jdk
            real-pkg-name: ${{subpkg.name}}
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jdk-lts
            real-pkg-name: ${{subpkg.name}}
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: ${{package.name}}-jre
            real-pkg-name: ${{subpkg.name}}

test:
  environment:
    contents:
      packages:
        - ${{package.name}}-default-jdk
        - xkbcomp
        - xkeyboard-config
        - xvfb-run
    environment:
      JAVA_HOME: /usr/lib/jvm/java-1.8-openjdk
  pipeline:
    - if: ${{build.arch}} != 'x86_64'
      uses: test/tw/ldd-check
      with:
        extra-library-paths: "/usr/lib/jvm/java-1.8-openjdk/jre/lib/${{build.arch}}:/usr/lib/jvm/java-1.8-openjdk/jre/lib/${{build.arch}}/server"
    - if: ${{build.arch}} == 'x86_64'
      uses: test/tw/ldd-check
      with:
        extra-library-paths: "/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server"
    - name: "Java version Test"
      runs: |
        java -version
    # Test a basic Hello World
    - working-directory: basic
      runs: |
        javac HelloWorld.java
        java HelloWorld | grep -qi "Hello World!"
    # Test a basic HTTP connection
    - working-directory: basic
      runs: |
        javac RequestTest.java
        java RequestTest | grep -qi "Successfully connected to example.org"
    - working-directory: awt-regression
      runs: |
        javac SimpleAWTApp.java
        xvfb-run java SimpleAWTApp

# OpenJDK 8 uses the jdk8u repository with tags like jdk8u452-ga for GA releases.
# See https://github.com/openjdk/jdk8u/tags for available tags.
update:
  enabled: true
  version-transform:
    - match: ^(\d+)$
      replace: 8.${1}
  github:
    identifier: openjdk/jdk8u
    strip-prefix: jdk8u
    strip-suffix: -ga
    tag-filter-prefix: jdk8u
    tag-filter-contains: -ga
    use-tag: true
