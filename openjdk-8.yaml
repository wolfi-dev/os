package:
  name: openjdk-8
  version: 8.452.09 # this corresponds to same release as jdk8u452-ga / jdk8u452-b09
  epoch: 9
  description: "IcedTea distribution of OpenJDK 8"
  copyright:
    - license: GPL-2.0-with-classpath-exception
  dependencies:
    runtime:
      - java-cacerts
      - openjdk-8-jre

environment:
  contents:
    packages:
      - alsa-lib-dev
      - attr-dev
      - autoconf
      - automake
      - bash
      - build-base
      - ca-certificates
      - cairo-dev
      - coreutils
      - cups-dev
      - expat-dev
      - file
      - findutils
      - fontconfig-dev
      - freetype-dev
      - fribidi-dev
      - gawk
      - gcc-14-default
      - gdk-pixbuf-dev
      - giflib-dev
      - glib-dev
      - gtk-2.0-dev
      - harfbuzz-dev
      - krb5-dev
      - lcms2-dev
      - libffi-dev
      - libice-dev
      - libjpeg-turbo-dev
      - libpng-dev
      - libtool
      - libx11-dev
      - libxcomposite-dev
      - libxext-dev
      - libxft-dev
      - libxi-dev
      - libxinerama-dev
      - libxrandr-dev
      - libxrender-dev
      - libxslt-dev
      - libxt-dev
      - libxtst-dev
      - linux-headers
      - openjdk-8-default-jdk
      - pango-dev
      - patch
      - pkgconf-dev
      - posix-libc-utils
      - sed
      - util-linux-dev
      - wolfi-base
      - zip
      - zlib-dev
  environment:
    CFLAGS: -Wno-int-conversion -Wno-incompatible-pointer-types

pipeline:
  - uses: fetch
    with:
      uri: https://icedtea.classpath.org/download/source/icedtea-3.35.0.tar.xz
      expected-sha512: 3e997c8d2aa414fab1929c0dd8ff586950bc653a574b929e5c34b6e01bea1af9259b2c9548e9187dc2b2e3e0358ffe991c460cff7a2efc33c7aa66a6812c0804

  - working-directory: /home/build/icedtea-drops
    pipeline:
      - uses: fetch
        with:
          uri: https://icedtea.classpath.org/download/drops/icedtea8/3.35.0/openjdk-git.tar.xz
          expected-sha512: a57081a2fdfcd7fff2203d82d5c4edd6e3fd7b2fcfd5ef5471173073b93bd75dfdf67b20b2cece6c4b3a249f911ba74fbdf5e08c53ef5501cf1600c54208d7ce
          extract: false
      - uses: fetch
        with:
          uri: https://icedtea.classpath.org/download/drops/icedtea8/hotspot.tar.xz
          expected-sha512: 5c8e839d2d74b0308f468d8763a69ab06920f43b92659bbac76f53b48d83ce8d7070a091ca36df99629364fc8d05b8272e7c12d04609b969d5e8db6ace6908df
          extract: false
      - runs: |
          # Here be dragons.
          #
          # We need to patch the contents of openjdk-git.tar.xz in
          # order to make it buildable with glibc 2.42.
          # Unfortunately, we cannot patch it directly because
          # icedtea's Makefile (correctly) checks if the tarball's
          # sha256sum is what it expects.  This means that we will
          # need to do the patching in stages:
          #
          # - First, perform the sha256sum verification ourselves.
          old_sha256sum=$(grep '^OPENJDK_SHA256SUM = ' ../Makefile.am | cut -d ' ' -f3)
          if [ -z "${old_sha256sum}" ]; then
            echo "Error: Empty sha256sum for openjdk-git.tar.xz.  Please check the YAML file."
            exit 1
          fi
          if ! echo "${old_sha256sum}  openjdk-git.tar.xz" | sha256sum --check; then
            echo "Error: sha256sum mismatch for openjdk-git.tar.xz."
            exit 1
          fi

          # - Second, unpack, patch the contents and re-tar it.
          tar xf openjdk-git.tar.xz
          dir=$(tar tf openjdk-git.tar.xz | head -n1 | cut -d/ -f1)
          cd "$dir"
          find . -type f | xargs grep -Fl 'uabs(' | xargs sed -i 's@uabs(@g_uabs(@g'
          cd ..
          tar cf openjdk-git.tar.xz "${dir}"
          rm -rf "${dir}"

          # - Third, calculate the new sha256sum of the tarball.
          new_sha256sum=$(sha256sum openjdk-git.tar.xz | cut -d' '  -f1)

          # - Fourth, patch icedtea's Makefile to expect the new sha256sum.
          sed -i "s@^OPENJDK_SHA256SUM = .*@OPENJDK_SHA256SUM = ${new_sha256sum}@" ../Makefile*

  - runs: |
      ./autogen.sh

  - runs: |
      export EXTRA_CFLAGS="$CFLAGS -std=gnu++98 -Wno-error -fno-delete-null-pointer-checks -fno-lifetime-dse -fno-strict-overflow"
      export EXTRA_CPP_FLAGS="$CXXFLAGS -std=gnu++98 -fno-delete-null-pointer-checks -fno-lifetime-dse -fno-strict-overflow"

      bash ./configure \
        --build=${{host.triplet.gnu}} \
        --host=${{host.triplet.gnu}} \
        --prefix=/usr/lib/jvm/java-1.8-openjdk \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --localstatedir=/var \
        --with-parallel-jobs=$(nproc) \
        --disable-dependency-tracking \
        --disable-downloading \
        --disable-precompiled-headers \
        --disable-docs \
        --disable-system-pcsc \
        --disable-system-sctp \
        --with-openjdk-src-zip=/home/build/icedtea-drops/openjdk-git.tar.xz \
        --with-hotspot-src-zip=/home/build/icedtea-drops/hotspot.tar.xz \
        --with-jdk-home=/usr/lib/jvm/default-jvm \
        --with-curves="nist+" \
        --with-pkgversion="Wolfi ${{package.version}}-r${{package.epoch}}"

      make icedtea-boot SHELL=/bin/bash
      make

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk
      cp -a /home/build/openjdk.build/images/j2sdk-image/* "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/
      rm "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/src.zip

      # This archive contains absolute paths from the build environment,
      # so it does not work on the target system. User can generate it
      # running 'java -Xshare:dump'.
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/server/classes.jsa

      # symlink to shared java cacerts store
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/lib/security/cacerts
      ln -sf /etc/ssl/certs/java/cacerts \
        "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/lib/security/cacerts

      case $(uname -m) in
      aarch64) _jarch="aarch64" ;;
      x86_64) _jarch="amd64" ;;
      *) _jarch="$(uname -m)" ;;
      esac

      # Note: Previous to 8.452.09-r4 we had code here to remove additional
      # things as "not needed for headless installs". That code was broken
      # and was not actually removing those things. "Fixing" that bug in -r5
      # broke at least one user of an app that used libawt. So now we're
      # just removing policytool because it was the one thing actually being
      # removed before. We should consider if it too should be shipped since
      # we now know this is being used in head-full environments.
      rm -f "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre/bin/policytool

  - uses: strip

subpackages:
  - name: "openjdk-8-jre"
    description: "OpenJDK 8 Java Runtime Environment"
    dependencies:
      runtime:
        - java-common
        - java-cacerts
      provides:
        - openjdk-8-jre-base=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk/
          mv "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/jre \
             "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk

          mv "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/lib/ \
             "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk/

          # move jre executables expected by java-common
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk/bin
          for file in java orbd rmid servertool unpack200 keytool \
                pack200 rmiregistry tnameserv; do
            mv "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/bin/$file "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk/bin/
          done

  - name: "openjdk-8-demos"
    description: "OpenJDK 8 Demos"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk
          mv "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/demo \
             "${{targets.destdir}}"/usr/lib/jvm/java-1.8-openjdk/sample \
             "${{targets.subpkgdir}}"/usr/lib/jvm/java-1.8-openjdk/

  - name: "openjdk-8-default-jvm"
    description: "Use the openjdk-8 JVM as the default JVM"
    dependencies:
      runtime:
        - openjdk-8-jre
      provides:
        - default-jvm=1.8
        - default-jvm-lts=1.8
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/jvm
          ln -sf java-1.8-openjdk "${{targets.subpkgdir}}"/usr/lib/jvm/default-jvm
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jvm
            real-pkg-name: ${{subpkg.name}}
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jvm-lts
            real-pkg-name: ${{subpkg.name}}

  - name: "openjdk-8-default-jdk"
    description: "Use the openjdk-8 JVM as the default JVM with the JDK installed"
    dependencies:
      runtime:
        - openjdk-8-default-jvm
        - openjdk-8
      provides:
        - default-jdk=1.8
        - default-jdk-lts=1.8
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jdk
            real-pkg-name: ${{subpkg.name}}
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: default-jdk-lts
            real-pkg-name: ${{subpkg.name}}

test:
  environment:
    contents:
      packages:
        - openjdk-8-default-jdk
        - xkbcomp
        - xkeyboard-config
        - xvfb-run
    environment:
      JAVA_HOME: /usr/lib/jvm/java-8-openjdk
  pipeline:
    - name: "Java version Test"
      runs: |
        java -version
    # Test a basic Hello World
    - working-directory: basic
      runs: |
        javac HelloWorld.java
        java HelloWorld | grep -qi "Hello World!"
    # Test a basic HTTP connection
    - working-directory: basic
      runs: |
        javac RequestTest.java
        java RequestTest | grep -qi "Successfully connected to example.org"
    - working-directory: awt-regression
      runs: |
        javac SimpleAWTApp.java
        xvfb-run java SimpleAWTApp

update:
  enabled: true
  release-monitor:
    identifier: 17307
