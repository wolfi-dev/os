# Generated from https://git.alpinelinux.org/aports/plain/main/openrc/APKBUILD
package:
  name: openrc
  version: "0.56"
  epoch: 0
  description: OpenRC is a dependency-based init system that works with the system provided init program, normally /sbin/init.
  copyright:
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - build-base
      - busybox
      - libcap-dev
      - linux-pam-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/OpenRC/openrc
      expected-commit: da04d1c9893e364b73a4954a7aa31794096421b8
      tag: ${{package.version}}

  - uses: meson/configure
    with:
      opts: |
        -Dzsh-completions=true \
        -Dbash-completions=true \
        -Dpam=false \
        -Dpkgconfig=true \
        --default-library=both \
        --prefix=/usr \
        --sysconfdir=/etc \
        --libdir=/usr/lib \
        --libexecdir=/lib \
        --bindir=/bin \
        --sbindir=/sbin

  - uses: meson/compile

  - uses: meson/install

  - runs: |
      echo "target: ${{targets.destdir}}"
      install -Dm755 "${{targets.destdir}}"/usr/share/openrc/support/deptree2dot/deptree2dot "${{targets.destdir}}"/usr/bin/deptree2dot
      ls "${{targets.destdir}}"/usr/bin/deptree2dot
      rm -r "${{targets.destdir}}"/usr/share/openrc/support/deptree2dot/deptree2dot

  - uses: strip

subpackages:
  - name: openrc-dbg
    pipeline:
      - uses: split/debug

  - name: openrc-doc
    description: openrc manpages
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share/doc/
          mkdir -p "${{targets.subpkgdir}}"/usr/share/openrc/
          mv "${{targets.destdir}}"/usr/share/openrc/support "${{targets.subpkgdir}}"/usr/share/openrc/support
    test:
      pipeline:
        - uses: test/docs

  - name: openrc-tools
    pipeline:
      - runs: |
          echo "target: ${{targets.destdir}}"
          mkdir -p "${{targets.subpkgdir}}"/usr/bin/
          mv "${{targets.destdir}}"/usr/bin/deptree2dot "${{targets.subpkgdir}}"/usr/bin/

  - name: openrc-static
    description: openrc static
    pipeline:
      - uses: split/static

  - name: openrc-dev
    dependencies:
      runtime:
        - openrc
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

  - name: agetty-openrc
    description: "agetty program from util-linux (OpenRC init scripts)"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/etc/init.d
          mkdir -p "${{targets.subpkgdir}}"/etc/conf.d
          mv "${{targets.destdir}}"/etc/init.d/agetty "${{targets.subpkgdir}}"/etc/init.d/agetty
          mv "${{targets.destdir}}"/etc/conf.d/agetty "${{targets.subpkgdir}}"/etc/conf.d/agetty

  - name: openrc-bash-completion
    description: bash completion for openrc
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/bash-completion"
          mv "${{targets.destdir}}"/usr/share/bash-completion/completions "${{targets.subpkgdir}}"/usr/share/bash-completion/completions

  - name: openrc-zsh-completion
    description: zsh completion for openrc
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/zsh"
          mv "${{targets.destdir}}/usr/share/zsh/site-functions" "${{targets.subpkgdir}}/usr/share/zsh/site-functions"

update:
  enabled: true
  github:
    identifier: OpenRC/openrc
    use-tag: true

test:
  environment:
    contents:
      packages:
        - cmd:fsck
        - cmd:grep
        - cmd:route
        - nginx-mainline
        - nginx-mainline-openrc
        - curl
    accounts:
      groups:
        - groupname: nginx
          gid: 65532
      users:
        - username: nginx
          gid: 65532
          uid: 65532
  pipeline:
    - name: Verify openrc installation
      runs: |
        openrc --help
        openrc --version | grep ${{package.version}}
        rc-status --version
        rc-status --help
        openrc-shutdown --version
        openrc-shutdown --help
        rc-service --version
        rc-service --help
        rc-update --version
        rc-update --help
        start-stop-daemon --version
        start-stop-daemon --help
    - name: Run rc-status
      runs: |
        rc-status
    - name: Run nginx
      runs: |
        mkdir -p /var/lib/nginx/tmp
        nginx -t

        touch /run/openrc/softlevel

        rc-status --servicelist

        rc-service nginx start
        rc-service nginx status

        # Should be up.
        curl -v localhost:80 | grep "Thank you for using nginx."

        rc-service nginx stop

        # Should be down.
        if curl -v localhost:80; then
          echo "expected nginx to be stopped but got success"
          exit 1
        else
          echo "nginx stopped successfully"
        fi
