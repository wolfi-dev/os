package:
  name: openscap
  version: "1.4.2"
  epoch: 0
  description: NIST Certified SCAP 1.2 toolkit
  copyright:
    - license: LGPL-2.1-or-later

vars:
  py-version: 3.13

environment:
  contents:
    packages:
      - acl-dev
      - asciidoc
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - curl-dev
      - dbus-dev
      - doxygen
      - glib-dev
      - graphviz
      - graphviz-dev
      - libbz2-1
      - libcap-dev
      - libgcrypt-dev
      - libnss-dev
      - libproc-2-0
      - libxml2-dev
      - libxslt-dev
      - openldap-dev
      - openssl-dev
      - perl-dev
      - perl-xml-parser
      - popt-dev
      - procps
      - py${{vars.py-version}}-setuptools
      - python-${{vars.py-version}}-dev
      # TODO: Needed for rpm/apt scanning
      # - perl-xml-xpath
      # - opendbx-dev
      # - rpm-dev
      # - apt-dev
      # - libselinux
      - samurai
      - swig
      - systemd-dev
      - util-linux-dev
      - xmlsec-dev
      - xmlsec-openssl
      - yaml-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/OpenSCAP/openscap
      expected-commit: e9b2a41f5796f5ead3d1e2d9df1fb06818a569ac
      tag: ${{package.version}}

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_BUILD_TYPE=None \
        -DENABLE_PERL=OFF \
        -DENABLE_TESTS=OFF \
        -DWITH_PCRE2=True

  - uses: cmake/build

  - uses: cmake/install

  - name: fix python shbang
    runs: |
      # change /usr/bin/python3 to /usr/bin/python3.XX
      for f in ${{targets.destdir}}/usr/bin/*; do
        [ -f "$f" ] || continue
        sed -i '1s,^#!/usr/bin/python3$,#!/usr/bin/python${{vars.py-version}},' "$f"
      done

  - uses: strip

subpackages:
  - name: ${{package.name}}-docker
    description: "A virtual with all the oscap-docker dependencies present"
    dependencies:
      runtime:
        - openscap
        - py${{vars.py-version}}-docker
        - docker-cli
    test:
      pipeline:
        - uses: python/import
          with:
            python: python${{vars.py-version}}
            imports: |
              import openscap_py
              import oscap_docker_python
        - runs: |
            ln -s /usr/bin/python3.13 /usr/bin/python3
            oscap-docker --help

# TODO: Requires some additional graphviz/xml packages
# - name: ${{package.name}}-doc
#   description: "OpenSCAP documentation"
#   pipeline:
#     - uses: split/manpages
update:
  enabled: true
  github:
    identifier: OpenSCAP/openscap

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        oscap --version
        oscap --help
    - uses: test/pkgconf
    - uses: test/tw/ldd-check
