package:
  name: openssf-compiler-options
  version: 20240627
  epoch: 31
  description: "Compiler Options Hardening Guide for C and C++"
  url: https://best.openssf.org/Compiler-Hardening-Guides/Compiler-Options-Hardening-Guide-for-C-and-C++.html
  copyright:
    - license: CC-BY-4.0

vars:
  clang-major-versions: 14 15 16 17 18 19 20 21
  gcc-major-versions: 11 12 13 14 15
  # Although the GCC packages install more binaries under /usr/bin/
  # than those that are listed here, only these binaries actually
  # honor/support spec files.
  gcc-wrapper-bins: c++ g++ gcc gfortran gccgo

environment:
  contents:
    packages:
      - busybox

pipeline:
  - name: Install
    runs: |
      mkdir -p "${{targets.destdir}}"
      cp -r etc usr "${{targets.destdir}}"
      for i in ${{vars.clang-major-versions}}; do
        ln -s clang "${{targets.destdir}}"/etc/clang-$i
      done
      cd ${{targets.destdir}}/usr/local/bin
      ln -s gcc-wrapper cc
      ln -s gcc-wrapper cpp
      for suffix in ${{vars.gcc-major-versions}}; do
        ln -s gcc-wrapper cpp-$suffix
      done
      for app in ${{vars.gcc-wrapper-bins}}; do
        ln -s gcc-wrapper $app
        ln -s gcc-wrapper ${{host.triplet.gnu}}-$app
        for suffix in ${{vars.gcc-major-versions}}; do
          ln -s gcc-wrapper $app-$suffix
          ln -s gcc-wrapper ${{host.triplet.gnu}}-$app-$suffix
        done
      done

test:
  environment:
    contents:
      packages:
        - clang-21
        - gcc
        - gcc-11
        - gcc-12
        - gcc-13
        - gcc-14
  pipeline:
    - uses: test/compiler/hardening-check
      with:
        cc: clang-21
    - uses: test/compiler/hardening-check
      with:
        cc: gcc
    - uses: test/compiler/hardening-check
      with:
        cc: gcc-11
    - uses: test/compiler/hardening-check
      with:
        cc: gcc-12
    - uses: test/compiler/hardening-check
      with:
        cc: gcc-13
    - uses: test/compiler/hardening-check
      with:
        cc: gcc-14
    - name: Ensure gcc_s is linked
      runs: |
        touch foo.c
        gcc -v foo.c &>stderr.log || true
        grep gcc_s stderr.log
    - name: Ensure etc specfile is used
      runs: |
        touch /etc/gcc_spec_file
        gcc -v 2>&1 | grep "/etc/gcc_spec_file"
        rm /etc/gcc_spec_file
    - name: Ensure GCC_SPEC_FILE is used over "/etc/gcc_spec_file"
      runs: |
        touch /etc/gcc_spec_file
        GCC_SPEC_FILE="/dev/null" gcc -v 2>&1 | grep "/dev/null"
        rm /etc/gcc_spec_file
    - name: Ensure gcc-wrapper is linked for all applicable binaries
      runs: |
        set -o pipefail

        check_gcc_wrapper_link() {
          fname="$1"

          stat -c "%N" "${fname}" | grep -Fxq "'${fname}' -> 'gcc-wrapper'"
        }

        for bin in ${{vars.gcc-wrapper-bins}}; do
          check_gcc_wrapper_link "/usr/local/bin/${bin}"
          check_gcc_wrapper_link "/usr/local/bin/${{host.triplet.gnu}}-${bin}"

          for suffix in ${{vars.gcc-major-versions}}; do
            check_gcc_wrapper_link "/usr/local/bin/${bin}-${suffix}"
            check_gcc_wrapper_link "/usr/local/bin/${{host.triplet.gnu}}-${bin}-${suffix}"
          done
        done

update:
  enabled: false
