package:
  name: openssl-hardened-dev
  version: 3.6.0
  epoch: 0
  description: the OpenSSL cryptography suite
  commit: 6b577e6bf909f4874694aa16659beae6778f42a4
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - openssl-dev
    replaces:
      - openssl-dev

environment:
  contents:
    # NB! accessing historic, but certified build of
    # jitterentropy-library-dev=3.5.0-r0. In a fresh bootstrap build
    # any version of jitternetropy-library and get an ESV certificate
    # for it.
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      # NB! pinned to version https://csrc.nist.gov/projects/cryptographic-module-validation-program/entropy-validations/certificate/191
      - jitterentropy-library-dev=3.5.0-r0
      - jitterentropy-library=3.5.0-r0
      - perl
  environment:
    # To support automatic discovery of source code in debug symbols
    # packaged in openssl-dbg, build with debug symbols &
    # file-prefix-map. Also see "Create dbg sourcecode" and
    # split/debug.
    CFLAGS: "-g -ffile-prefix-map=/home/build=/usr/src/${{package.name}}"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openssl/openssl
      tag: openssl-${{package.version}}
      expected-commit: 7b371d80d959ec9ab4139d09d78e83c090de9779

  - name: Configure and build
    runs: |
      perl ./Configure \
      	linux-x86_64 \
      	--prefix=/usr \
      	--libdir=lib \
      	--openssldir=/etc/ssl \
      	enable-ktls \
      	$([ -d /usr/lib/oldglibc ] || echo enable-jitter) \
      	shared \
      	enable-pie \
      	no-zlib \
      	no-async \
      	no-comp \
      	no-idea \
      	no-mdc2 \
      	no-rc5 \
      	no-ec2m \
      	no-sm2 \
      	no-sm4 \
      	no-ssl3 \
      	no-seed \
      	no-weak-ssl-ciphers \
      	no-deprecated \
      	--debug \
      	-Wa,--noexecstack
      perl configdata.pm --dump
      mkdir -p ${{targets.destdir}}/usr/include/openssl
      # Configure as closely to the stock build as possible
      # And install just the configuration header
      cp include/openssl/configuration.h ${{targets.destdir}}/usr/include/openssl

update:
  enabled: true
  manual: false
  require-sequential: false
  github:
    identifier: openssl/openssl
    strip-prefix: openssl-
    tag-filter-prefix: openssl-
