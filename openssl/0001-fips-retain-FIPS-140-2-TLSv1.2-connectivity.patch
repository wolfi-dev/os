From 9ba81d2e9d2c3d0842b4325203349a981f4a78c6 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <dimitri.ledkov@surgut.co.uk>
Date: Mon, 26 Jan 2026 13:10:54 +0000
Subject: [PATCH] fips: retain FIPS 140-2 TLSv1.2 connectivity

Retain FIPS 140-2 connectivity by setting ems_check zero indicator.
---
 ssl/t1_enc.c      | 5 ++++-
 test/sslapitest.c | 2 ++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/ssl/t1_enc.c b/ssl/t1_enc.c
index 5682861765..64a23fc541 100644
--- a/ssl/t1_enc.c
+++ b/ssl/t1_enc.c
@@ -35,7 +35,7 @@ static int tls1_PRF(SSL_CONNECTION *s,
     const EVP_MD *md = ssl_prf_md(s);
     EVP_KDF *kdf;
     EVP_KDF_CTX *kctx = NULL;
-    OSSL_PARAM params[8], *p = params;
+    OSSL_PARAM params[9], *p = params;
     const char *mdname;
 
     if (md == NULL) {
@@ -71,6 +71,9 @@ static int tls1_PRF(SSL_CONNECTION *s,
         (void *)seed4, (size_t)seed4_len);
     *p++ = OSSL_PARAM_construct_octet_string(OSSL_KDF_PARAM_SEED,
         (void *)seed5, (size_t)seed5_len);
+    // Enable connectivity with FIPS 140-2 systems by default
+    int ems_check = 0;
+    *p++ = OSSL_PARAM_construct_int(OSSL_KDF_PARAM_FIPS_EMS_CHECK, &ems_check);
     *p = OSSL_PARAM_construct_end();
     if (EVP_KDF_derive(kctx, out, olen, params)) {
         EVP_KDF_CTX_free(kctx);
diff --git a/test/sslapitest.c b/test/sslapitest.c
index ceff1671dc..348bbeddc8 100644
--- a/test/sslapitest.c
+++ b/test/sslapitest.c
@@ -833,6 +833,8 @@ static int test_no_ems(void)
     if (fips_ems_check) {
         if (status == 1) {
             printf("When FIPS uses the EMS check a connection that doesn't use EMS should fail\n");
+            printf("Chainguard patch allows this\n");
+            testresult = 1;
             goto end;
         }
     } else {
-- 
2.51.0

