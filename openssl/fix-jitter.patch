From 360adf7f54121d05a059477eb1fa90eabbde8459 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <dimitri.ledkov@surgut.co.uk>
Date: Tue, 27 Jan 2026 15:54:42 +0000
Subject: [PATCH] fix jitter

---
 crypto/provider_core.c                        | 24 +++++++++++++++----
 .../rands/seed_src_jitter.c.in                |  2 --
 2 files changed, 20 insertions(+), 6 deletions(-)

diff --git a/crypto/provider_core.c b/crypto/provider_core.c
index 649404d898..b5ca543db6 100644
--- a/crypto/provider_core.c
+++ b/crypto/provider_core.c
@@ -2450,7 +2450,7 @@ static void core_self_test_get_callback(OPENSSL_CORE_CTX *libctx,
     OSSL_SELF_TEST_get_callback((OSSL_LIB_CTX *)libctx, cb, cbarg);
 }
 
-#ifdef OPENSSL_NO_FIPS_JITTER
+#ifdef OPENSSL_NO_JITTER
 static size_t rand_get_entropy(const OSSL_CORE_HANDLE *handle,
     unsigned char **pout, int entropy,
     size_t min_len, size_t max_len)
@@ -2458,6 +2458,14 @@ static size_t rand_get_entropy(const OSSL_CORE_HANDLE *handle,
     return ossl_rand_get_entropy((OSSL_LIB_CTX *)core_get_libctx(handle),
         pout, entropy, min_len, max_len);
 }
+
+static size_t rand_get_user_entropy(const OSSL_CORE_HANDLE *handle,
+    unsigned char **pout, int entropy,
+    size_t min_len, size_t max_len)
+{
+    return ossl_rand_get_user_entropy((OSSL_LIB_CTX *)core_get_libctx(handle),
+        pout, entropy, min_len, max_len);
+}
 #else
 /*
  * OpenSSL FIPS providers prior to 3.2 call rand_get_entropy API from
@@ -2482,15 +2490,23 @@ static size_t rand_get_entropy(const OSSL_CORE_HANDLE *handle,
 {
     return ossl_rand_jitter_get_seed(pout, entropy, min_len, max_len);
 }
-#endif
 
+/*
+ * If a 3.2+ provider calls rand_get_user_entropy, the seed rng might
+ * not yet be initialised, and creating it might not be possible yet
+ * either (as providers might still be loading). In these
+ * circumstances we still want to provide JITTER entropy to those
+ * providers.
+ */
 static size_t rand_get_user_entropy(const OSSL_CORE_HANDLE *handle,
     unsigned char **pout, int entropy,
     size_t min_len, size_t max_len)
 {
-    return ossl_rand_get_user_entropy((OSSL_LIB_CTX *)core_get_libctx(handle),
-        pout, entropy, min_len, max_len);
+    size_t ret = ossl_rand_jitter_get_seed(pout, entropy, min_len, max_len);
+    OPENSSL_assert(ret > 0);
+    return ret;
 }
+#endif
 
 static void rand_cleanup_entropy(const OSSL_CORE_HANDLE *handle,
     unsigned char *buf, size_t len)
diff --git a/providers/implementations/rands/seed_src_jitter.c.in b/providers/implementations/rands/seed_src_jitter.c.in
index eb67e1047b..01f3145172 100644
--- a/providers/implementations/rands/seed_src_jitter.c.in
+++ b/providers/implementations/rands/seed_src_jitter.c.in
@@ -303,7 +303,6 @@ static size_t jitter_get_seed(void *vseed, unsigned char **pout,
     return ret;
 }
 
-#ifndef OPENSSL_NO_FIPS_JITTER
 size_t ossl_rand_jitter_get_seed(unsigned char **pout, int entropy, size_t min_len, size_t max_len)
 {
     size_t ret = 0;
@@ -319,7 +318,6 @@ end:
     jitter_free(s);
     return ret;
 }
-#endif
 
 static void jitter_clear_seed(ossl_unused void *vdrbg,
     unsigned char *out, size_t outlen)
-- 
2.51.0

