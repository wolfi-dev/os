package:
  name: opentelemetry-collector
  version: "0.132.0"
  epoch: 0 # CVE-2025-47907
  description: OpenTelemetry Collector
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox
      - curl
      - go
      - yq

pipeline:
  - runs: |
      set -x

      # Use the build config from the official otel-core release
      # https://github.com/open-telemetry/opentelemetry-collector-releases/blob/main/distributions/otelcol/manifest.yaml
      # The manifest is updated as part of the release process and so should match the
      # lastest version released from open-telemetry/opentelemetry-collector
      curl --fail -o builder-config.yaml https://raw.githubusercontent.com/open-telemetry/opentelemetry-collector-releases/v${{package.version}}/distributions/otelcol/manifest.yaml

  - uses: git-checkout
    with:
      repository: https://github.com/open-telemetry/opentelemetry-collector
      tag: v${{package.version}}
      expected-commit: eaa1a6e8129876aaaeea89845d0b5ed0967f5950

  - uses: go/build
    with:
      packages: .
      modroot: ./cmd/builder
      output: ocb

  - runs: |
      set -x
      # Use the builder to compile opentelemetry-collector
      yq eval '.replaces += ["golang.org/x/crypto => golang.org/x/crypto v0.35.0"]' builder-config.yaml -i
      yq eval '.replaces += ["golang.org/x/net => golang.org/x/net v0.38.0"]' builder-config.yaml -i
      yq eval '.replaces += ["golang.org/x/oauth2 => golang.org/x/oauth2 v0.27.0"]' builder-config.yaml -i
      yq eval '.replaces += ["github.com/golang-jwt/jwt/v5 => github.com/golang-jwt/jwt/v5 v5.2.2"]' builder-config.yaml -i
      yq eval '.replaces += ["github.com/docker/docker => github.com/docker/docker v28.3.3+incompatible"]' builder-config.yaml -i
      ${{targets.destdir}}/usr/bin/ocb --config=builder-config.yaml

      install -Dm755 ./_build/otelcol "${{targets.destdir}}"/usr/bin/otelcol
      rm -f ${{targets.destdir}}/usr/bin/ocb

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package to place binary in the location expected by upstream helm chart
    pipeline:
      - runs: |
          # The helm chart expects the binary to be /otelcol instead of /usr/bin/otelcol
          mkdir -p "${{targets.subpkgdir}}"
          ln -sf /usr/bin/otelcorecol ${{targets.subpkgdir}}/otelcol

update:
  enabled: true
  github:
    identifier: open-telemetry/opentelemetry-collector
    strip-prefix: v
    use-tag: true
    tag-filter: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        otelcol --version
        otelcol --help
