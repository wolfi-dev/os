package:
  name: opentelemetry-collector
  version: "0.145.0"
  epoch: 0 # GHSA-cfpf-hrx2-8rv6
  description: OpenTelemetry Collector
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox
      - curl
      - yq

pipeline:
  - runs: |
      set -x

      # Use the build config from the official otel-core release
      # https://github.com/open-telemetry/opentelemetry-collector-releases/blob/main/distributions/otelcol/manifest.yaml
      # The manifest is updated as part of the release process and so should match the
      # lastest version released from open-telemetry/opentelemetry-collector
      curl --fail -o builder-config.yaml https://raw.githubusercontent.com/open-telemetry/opentelemetry-collector-releases/v${{package.version}}/distributions/otelcol/manifest.yaml
      curl --fail -o config.yaml https://raw.githubusercontent.com/open-telemetry/opentelemetry-collector-releases/v${{package.version}}/distributions/otelcol/config.yaml

  - uses: git-checkout
    with:
      repository: https://github.com/open-telemetry/opentelemetry-collector
      tag: v${{package.version}}
      expected-commit: f33c609d976f2682f7d9c19cc92a05ffbe17427e

  - runs: |
      set -x
      # Use the builder to compile opentelemetry-collector
      yq eval '.replaces += ["github.com/expr-lang/expr => github.com/expr-lang/expr v1.17.7"]' builder-config.yaml -i

  - uses: go/build
    with:
      packages: .
      modroot: ./cmd/builder
      output: ocb

  - runs: |
      set -x
      # Use the builder to compile opentelemetry-collector
      ${{targets.destdir}}/usr/bin/ocb --config=builder-config.yaml

      install -Dm755 ./_build/otelcol "${{targets.destdir}}"/usr/bin/otelcol
      rm -f ${{targets.destdir}}/usr/bin/ocb

  - name: copy the config file
    runs: |
      install -Dm644 config.yaml "${{targets.contextdir}}"/etc/otelcol/config.yaml

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package to place binary in the location expected by upstream helm chart
    pipeline:
      - runs: |
          # The helm chart expects the binary to be /otelcol instead of /usr/bin/otelcol
          mkdir -p "${{targets.subpkgdir}}"
          ln -sf ./usr/bin/otelcol ${{targets.subpkgdir}}/otelcol
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check
        - uses: test/tw/ver-check
          with:
            bins: /otelcol

  - name: ${{package.name}}-ocb
    description: "Package that contains ocb binary"
    pipeline:
      - uses: go/build
        with:
          packages: .
          modroot: ./cmd/builder
          output: ocb
    test:
      pipeline:
        - uses: test/tw/help-check
          with:
            bins: ocb
        - uses: test/tw/ver-check
          with:
            bins: ocb
        - name: Test ocb can validate a minimal manifest
          runs: |
            cat > test-manifest.yaml <<EOF
            dist:
              name: otelcol-test
              description: Test OpenTelemetry Collector distribution
              output_path: /tmp/otelcol-test

            exporters:
              - gomod: go.opentelemetry.io/collector/exporter/debugexporter v${{package.version}}

            receivers:
              - gomod: go.opentelemetry.io/collector/receiver/otlpreceiver v${{package.version}}

            processors:
              - gomod: go.opentelemetry.io/collector/processor/batchprocessor v${{package.version}}
            EOF

            ocb --config test-manifest.yaml --skip-compilation --skip-get-modules

update:
  enabled: true
  github:
    identifier: open-telemetry/opentelemetry-collector
    strip-prefix: v
    use-tag: true
    tag-filter: v

test:
  pipeline:
    - uses: test/tw/ver-check
      with:
        bins: otelcol
