package:
  name: opentelemetry-cpp
  version: "1.24.0"
  epoch: 1
  description: The OpenTelemetry C++ Client
  copyright:
    - license: Apache-2.0
  dependencies:
    provider-priority: 0

var-transforms:
  - from: ${{package.version}}
    match: ^(\d+)\..*$
    replace: ${1}
    to: soversion

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - benchmark-dev
      - busybox
      - c-ares-dev
      - cmake
      - curl-dev
      - gcc
      - glibc-dev
      - grpc-dev
      - icu-dev
      - make
      - openssl-dev
      - pkgconf
      - protobuf-dev
      - re2-dev
      - systemd-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/open-telemetry/opentelemetry-cpp
      tag: v${{package.version}}
      expected-commit: a7b100834dce58c949ab9bdfccdf1613db460d1c

  - uses: cmake/configure
    with:
      # NOTE: DWITH_OTLP_GRPC=ON is required for ingress-nginx <= 1.12 versions (ref: https://github.com/open-telemetry/opentelemetry-cpp-contrib/blob/8933841f0a7f8737f61404cf0a64acf6b079c8a5/instrumentation/nginx/README.md#dependencies-for-building)
      opts: |
        -DWITH_OTLP_GRPC=ON \
        -DWITH_OTLP_HTTP=ON \
        -DWITH_PROMETHEUS=OFF \
        -DWITH_ELASTICSEARCH=OFF \
        -DBUILD_TESTING=OFF \
        -DWITH_EXAMPLES=OFF \
        -DWITH_FUNC_TESTS=OFF \
        -DOPENTELEMETRY_INSTALL=ON \
        -DBUILD_SHARED_LIBS=ON \
        -DOTELCPP_VERSIONED_LIBS=ON \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DWITH_ABSEIL=ON

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: libopentelemetry-cpp${{vars.soversion}}
    pipeline:
      - uses: split/lib
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - name: "verify .so files exist"
          runs: |
            dir="/usr/lib"
            name="*.so"
            if ! find "${dir}" -name "${name}" -type f | grep -q . ; then
              echo "FAIL: no ${name} files found in ${dir}" >&2
              exit 1
            fi
            echo "PASS: some ${name} files found in ${dir}"

  - name: opentelemetry-cpp-dev
    description: The OpenTelemetry C++ Client development files
    dependencies:
      runtime:
        - libopentelemetry-cpp${{vars.soversion}}=${{package.full-version}}
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

test:
  pipeline:
    - uses: test/tw/byproductpackage

update:
  enabled: true
  github:
    identifier: open-telemetry/opentelemetry-cpp
    strip-prefix: v
