package:
  name: openvpn
  version: "2.6.14"
  epoch: 0
  description: Robust, and highly configurable VPN (Virtual Private Network)
  copyright:
    - license: GPL-2.0-or-later
  dependencies:
    runtime:
      - busybox
      - glibc
      - iproute2
      - liblz4-1
      - libnl3
      - lzo
      - merged-usrsbin
      - openssl
      - wolfi-baselayout

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - iproute2
      - libcap-ng-dev
      - libnl3-dev
      - libtool
      - linux-headers
      - linux-pam-dev
      - lz4-dev
      - lzo-dev
      - openssl-dev
      - py3-docutils

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/OpenVPN/openvpn
      expected-commit: f588592ee6c6323b9674f470054e1638182c5b71
      tag: v${{package.version}}

  - runs: autoreconf -vif

  - uses: autoconf/configure
    with:
      opts: |
        --prefix=/usr \
        --host=${{host.triplet.gnu}} \
        --sbindir=/usr/bin \
        --sysconfdir=/etc/openvpn \
        --mandir=/usr/share/man \
        --enable-iproute2 \
        --enable-x509-alt-usernameco

  - runs: make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p "${{targets.destdir}}"/etc/init.d/
      mkdir -p "${{targets.destdir}}"/etc/conf.d/
      mkdir -p "${{targets.destdir}}"/etc/openvpn/
      install -Dm644 doc/openvpn.8 "${{targets.destdir}}"/usr/share/man/man8/openvpn.8
      install -Dm755 vendor/openvpn.initd "${{targets.destdir}}"/etc/init.d/
      install -Dm644 vendor/openvpn.confd "${{targets.destdir}}"/etc/conf.d/
      install -Dm755 vendor/up.sh "${{targets.destdir}}"/etc/openvpn/up.sh
      install -Dm755 vendor/down.sh "${{targets.destdir}}"/etc/openvpn/down.sh

  - uses: strip

subpackages:
  - name: openvpn-doc
    description: openvpn manpages
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share/doc/openvpn/samples
          install -D -m644 doc/openvpn.8 "${{targets.subpkgdir}}"/usr/share/man/man8/openvpn.8
          cp -a sample/sample-* "${{targets.subpkgdir}}"/usr/share/doc/openvpn/samples
          install -D -m644 COPYING* "${{targets.subpkgdir}}"/usr/share/licenses/openvpn/COPYING
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: openvpn-dev
    description: openvpn dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - merged-usrsbin
        - openssl-dev
        - openvpn
        - wolfi-baselayout

  - name: openvpn-openrc
    description: openvpn openrc init
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/etc/init.d/
          mkdir -p "${{targets.subpkgdir}}"/etc/conf.d/
          install -Dm755 vendor/openvpn.initd "${{targets.subpkgdir}}"/etc/init.d/
          install -Dm644 vendor/openvpn.confd "${{targets.subpkgdir}}"/etc/conf.d/
    dependencies:
      runtime:
        - merged-usrsbin
        - openssl-dev
        - wolfi-baselayout

  - name: openvpn-auth-pam
    description: openvpn dev
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib/openvpn/plugins
          mv "${{targets.destdir}}"/usr/lib/openvpn/plugins/*-auth-pam* "${{targets.subpkgdir}}"/usr/lib/openvpn/plugins/
    dependencies:
      runtime:
        - glibc
        - iproute2
        - linux-pam
        - merged-usrsbin
        - wolfi-baselayout
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: openvpn-supervisor
    description: openvpn supervisor
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/etc/supervisor.d/
          install -Dm644 vendor/openvpn.supervisord.conf "${{targets.subpkgdir}}"/etc/supervisor.d/openvpn.conf
    dependencies:
      runtime:
        - merged-usrsbin
        - openvpn-doc
        - supervisor
        - wolfi-baselayout

update:
  enabled: true
  github:
    identifier: OpenVPN/openvpn
    tag-filter: v
    strip-prefix: v
    use-tag: true

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        openvpn --version
    - uses: test/tw/ldd-check
