package:
  name: pdns-5.2
  version: "5.2.7"
  epoch: 0
  description: PowerDNS Authoritative Server
  copyright:
    - license: GPL-2.0-or-later
    - license: LicenseRef-notice
      license-path: NOTICE
  dependencies:
    provides:
      - pdns=${{package.full-version}}
  checks:
    disabled:
      # Disabled until merged-varrun is done.
      - tempdir

vars:
  python-version: 3.12 # Pinning 3.12 due to imghdr. See: https://peps.python.org/pep-0594/#imghdr
  lua-version: 5.4 # Pinning latest lua version to pass cmake

environment:
  contents:
    packages:
      - bind-dev
      - binutils
      - bison
      - boost-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl-dev
      - file
      - flex
      - fstrm-dev
      - geoip-dev
      - krb5-dev
      - libcap-dev
      - libmaxminddb-dev
      - libsodium-dev
      - libsystemd
      - libtool
      - lmdb-dev
      - lua${{vars.lua-version}}-dev
      - luajit-dev
      - mariadb-connector-c-dev
      - mariadb-dev
      - mtdev-dev
      - net-snmp-dev
      - openldap-dev
      - openssl-dev
      - pkgconf-dev
      - postgresql-dev
      - protobuf-dev
      - py${{vars.python-version}}-virtualenv
      - python-${{vars.python-version}}
      - ragel
      - rust
      - sqlite-dev
      - systemd
      - systemd-dev
      - unixodbc-dev
      - util-linux-dev
      - yaml-cpp-dev
      - zeromq-dev

data:
  - name: backends
    items:
      bind: bind
      geoip: geoip
      gmysql: gmysql
      godbc: godbc
      gpgsql: gpgsql
      gsqlite3: gsqlite3
      ldap: ldap
      lmdb: lmdb
      lua2: lua2
      pipe: pipe
      remote: remote

  - name: tools
    items:
      calidns: calidns
      dnsbulktest: dnsbulktest
      dnsgram: dnsgram
      dnspcap2calidns: dnspcap2calidns
      dnspcap2protobuf: dnspcap2protobuf
      dnsreplay: dnsreplay
      dnsscan: dnsscan
      dnsscope: dnsscope
      dnstcpbench: dnstcpbench
      dnswasher: dnswasher
      dumresp: dumresp
      ixplore: ixplore
      nproxy: nproxy
      nsec3dig: nsec3dig
      pdns_notify: pdns_notify
      saxfr: saxfr
      sdig: sdig
      stubquery: stubquery
      zone2json: zone2json
      zone2ldap: zone2ldap
      zone2sql: zone2sql

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/PowerDNS/pdns
      expected-commit: 6f6d02b1f8fa0017f34ab99889eb8cdd26171e00
      tag: rec-${{package.version}}

  - uses: autoconf/configure
    with:
      opts: |
        --sbindir=/usr/bin \
        --with-modules="" \
        --with-dynmodules="bind geoip ldap lmdb lua2 gmysql godbc pipe gpgsql remote gsqlite3" \
        --enable-tools \
        --enable-unit-tests \
        --enable-systemd \
        --disable-static \
        --enable-remotebackend-zeromq \
        --with-libcrypto=/usr \
        --enable-ixfrdist \
        --enable-reproducible

  - uses: autoconf/make

  - uses: autoconf/make-install

  - assertions:
      required-steps: 1
    pipeline:
      - if: ${{build.arch}} == "x86_64"
        runs: make check
      - if: ${{build.arch}} == "aarch64"
        runs: PDNS_TEST_NO_IPV6=1 make check # aarch64 has issues with IPv6 tests on the CI, no error logs available

  - name: Create necessary directories
    runs: |
      mkdir -p ${{targets.contextdir}}/etc/powerdns/pdns.d
      mkdir -p ${{targets.contextdir}}/var/run/pdns/
      mkdir -p ${{targets.contextdir}}/var/lib/powerdns

  - uses: strip

subpackages:
  - name: ${{package.name}}-nosodium
    description: PowerDNS Authoritative Server without libsodium
    dependencies:
      provides:
        - pdns-nosodium=${{package.full-version}}
    pipeline:
      - uses: autoconf/configure
        with:
          opts: |
            --sbindir=/usr/bin \
            --with-modules="" \
            --with-dynmodules="bind geoip ldap lmdb lua2 gmysql godbc pipe gpgsql remote gsqlite3" \
            --enable-tools \
            --enable-unit-tests \
            --enable-systemd \
            --disable-static \
            --enable-remotebackend-zeromq=no \
            --with-libcrypto=/usr \
            --enable-ixfrdist \
            --enable-reproducible \
            --with-libsodium=no \
            --with-gnutls=no
      - uses: autoconf/make
      - uses: autoconf/make-install
      - assertions:
          required-steps: 1
        pipeline:
          - if: ${{build.arch}} == "x86_64"
            runs: make check
          - if: ${{build.arch}} == "aarch64"
            runs: PDNS_TEST_NO_IPV6=1 make check # aarch64 has issues with IPv6 tests on the CI, no error logs available
      - name: Create necessary directories
        runs: |
          mkdir -p ${{targets.contextdir}}/etc/powerdns/pdns.d
          mkdir -p ${{targets.contextdir}}/var/run/pdns/
          mkdir -p ${{targets.contextdir}}/var/lib/powerdns
      - uses: strip
    test:
      pipeline:
        - runs: |
            # this is dumb, but libmariadb.so.3 is not available here in tests  - apko solves for it at the image level
            mkdir -p ${{targets.contextdir}}/usr/lib/
            ln -sf /usr/lib/pdns/libgsqlite3backend.so /usr/lib/libmariadb.so.3
        - uses: test/tw/ldd-check
        - runs: |
            set -euo pipefail
            pdns_server --help
            pdnsutil --help
        - name: "Verify libsodium and gnutls are not loaded"
          runs: |
            set -euo pipefail
            # Check that pdns_server binary does not link to libsodium or gnutls
            if ldd /usr/bin/pdns_server | grep -E "(libsodium|libgnutls)"; then
              echo "ERROR: pdns-nosodium should not link to libsodium or gnutls libraries"
              exit 1
            fi

  - name: ${{package.name}}-recursor-nosodium
    description: PowerDNS Recursive Server without libsodium
    dependencies:
      provides:
        - pdns-recursor=${{package.full-version}}
    pipeline:
      - runs: BUILDER_VERSION=${{package.version}} BUILDER_MODULES=recursor autoreconf -vfi
      - working-directory: ./pdns/recursordist
        pipeline:
          - uses: autoconf/configure
            with:
              opts: |
                --sysconfdir=/etc/powerdns \
                --sbindir=/usr/bin \
                --enable-dns-over-tls \
                --enable-unit-tests \
                --enable-snmp \
                --enable-dnstap \
                --enable-nod \
                --with-lua=lua${{vars.lua-version}} \
                --with-libcrypto=/usr \
                --with-libcap \
                --with-libsodium=no \
                --with-gnutls=no
          - uses: autoconf/make
          - uses: autoconf/make-install
          - assertions:
              required-steps: 1
            pipeline:
              - if: ${{build.arch}} == "x86_64"
                runs: make check
              - if: ${{build.arch}} == "aarch64"
                runs: PDNS_TEST_NO_IPV6=1 make check # aarch64 has issues with IPv6 tests on the CI, no error logs available
      - uses: strip
    test:
      environment:
        contents:
          packages:
            - pdns-recursor-compat
            - wait-for-it
        accounts:
          groups:
            - groupname: pdns
              gid: 953
          users:
            - username: pdns
              gid: 953
              uid: 953
          run-as: 0 # To bind :53 on the CI
        environment:
          TINI_SUBREAPER: 1
          DEBUG_CONFIG: yes
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            pdns_recursor --help
            rec_control --help
        - name: "Verify libsodium and gnutls are not loaded"
          runs: |
            set -euo pipefail
            # Check that pdns_recursor binary does not link to libsodium or gnutls
            if ldd /usr/bin/pdns_recursor | grep -E "(libsodium|libgnutls)"; then
              echo "ERROR: pdns-nosodium should not link to libsodium or gnutls libraries"
              exit 1
            fi
        - name: "start daemon on localhost"
          uses: test/daemon-check-output
          with:
            start: "/usr/bin/tini -- /usr/local/sbin/pdns_recursor-startup"
            timeout: 30
            expected_output: |
              YAML config found and processed
              Enabled TCP data-ready
              Listening for queries
              Launching worker threads
              Launching tcpworker threads
              Enabled multiplexer
            post: |
              wait-for-it -t 5 --strict localhost:8082
              wait-for-it -t 5 --strict localhost:53

  - name: ${{package.name}}-recursor
    description: PowerDNS Recursive Server
    dependencies:
      provides:
        - pdns-recursor=${{package.full-version}}
    pipeline:
      - working-directory: ./pdns/recursordist
        pipeline:
          - uses: autoconf/configure
            with:
              opts: |
                --sysconfdir=/etc/powerdns \
                --sbindir=/usr/bin \
                --enable-dns-over-tls \
                --enable-unit-tests \
                --enable-snmp \
                --enable-dnstap \
                --enable-nod \
                --enable-libsodium \
                --with-lua=lua${{vars.lua-version}} \
                --with-libcrypto=/usr \
                --with-libcap
          - uses: autoconf/make
          - uses: autoconf/make-install
          - assertions:
              required-steps: 1
            pipeline:
              - if: ${{build.arch}} == "x86_64"
                runs: make check
              - if: ${{build.arch}} == "aarch64"
                runs: PDNS_TEST_NO_IPV6=1 make check # aarch64 has issues with IPv6 tests on the CI, no error logs available
      - uses: strip
    test:
      environment:
        contents:
          packages:
            - pdns-recursor-compat
            - wait-for-it
        accounts:
          groups:
            - groupname: pdns
              gid: 953
          users:
            - username: pdns
              gid: 953
              uid: 953
          run-as: 0 # To bind :53 on the CI
        environment:
          TINI_SUBREAPER: 1
          DEBUG_CONFIG: yes
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            pdns_recursor --help
            rec_control --help
        - name: "start daemon on localhost"
          uses: test/daemon-check-output
          with:
            start: "/usr/bin/tini -- /usr/local/sbin/pdns_recursor-startup"
            timeout: 30
            expected_output: |
              YAML config found and processed
              Enabled TCP data-ready
              Listening for queries
              Launching worker threads
              Launching tcpworker threads
              Enabled multiplexer
            post: |
              wait-for-it -t 5 --strict localhost:8082
              wait-for-it -t 5 --strict localhost:53

  - name: ${{package.name}}-recursor-compat
    description: Compatibility package for pdns-recursor
    dependencies:
      provides:
        - pdns-recursor-compat=${{package.full-version}}
      runtime:
        - python-${{vars.python-version}}
        - py${{vars.python-version}}-jinja2
        - tini
        - libcap-utils
        - coreutils # For env -S support
    pipeline:
      - working-directory: ./dockerdata
        pipeline:
          - runs: |
              # https://github.com/PowerDNS/pdns/blob/master/Dockerfile-recursor
              mkdir -p ${{targets.contextdir}}/etc/powerdns
              mkdir -p ${{targets.contextdir}}/usr/local/sbin/
              mkdir -p ${{targets.contextdir}}/etc/powerdns/recursor.d
              mkdir -p ${{targets.contextdir}}/var/run/pdns-recursor
              mkdir -p ${{targets.contextdir}}/etc/powerdns/templates.d
              install -Dm755 startup.py ${{targets.contextdir}}/usr/local/sbin/pdns_recursor-startup
              install -Dm755 recursor.conf ${{targets.contextdir}}/etc/powerdns/recursor.conf
              ln -sf /usr/bin/pdns_recursor ${{targets.contextdir}}/usr/local/sbin/pdns_recursor
              ln -sf /usr/bin/rec_control ${{targets.contextdir}}/usr/local/sbin/rec_control
    test:
      pipeline:
        - runs: |
            for bin in pdns_recursor rec_control; do
              found="$(readlink -fv /usr/local/sbin/${bin})"
              expected="/usr/bin/${bin}"
              if [ $found != $expected ]; then
                echo "Invalid symlink for $bin!"
                echo "Expected: $expected"
                echo "Found: $found"
                exit 1
              fi
              echo "Valid symlink for $bin. Found: $found"
            done

  - range: backends
    name: ${{package.name}}-backend-${{range.key}}
    description: PowerDNS ${{range.key}} backend
    dependencies:
      provides:
        - pdns-backend-${{range.key}}=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib/pdns
          mv ${{targets.destdir}}/usr/lib/pdns/lib${{range.key}}backend.so ${{targets.contextdir}}/usr/lib/pdns/lib${{range.key}}backend.so
    test:
      pipeline:
        # gmysql backend needs libmariadb.so.3 on the runtime, which we can't provide runtime deps conditionally when using ranges.
        # Apko would resolve it when building anyway, so we skip the ldd check only for the gmysql backend.
        - if: '"${{range.key}}" != "gmysql"'
          uses: test/tw/ldd-check

  - range: tools
    name: ${{package.name}}-tool-${{range.key}}
    description: PowerDNS ${{range.key}} tool
    dependencies:
      provides:
        - pdns-tool-${{range.key}}=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/${{range.key}} ${{targets.contextdir}}/usr/bin/${{range.key}}
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            # saxfr is a special case, it requires IP-address, port, zone to run and does not have a --help option.
            # So we handle it separately.
            if [ "${{range.key}}" = "saxfr" ]; then
              saxfr 127.0.0.1 53 example.com
            else
              "${{range.key}}" --help
            fi

  - name: ${{package.name}}-backends-all
    dependencies:
      provides:
        - pdns-backends-all=${{package.full-version}}
      runtime:
        - ${{package.name}}-backend-bind
        - ${{package.name}}-backend-geoip
        - ${{package.name}}-backend-godbc
        - ${{package.name}}-backend-gmysql
        - ${{package.name}}-backend-gpgsql
        - ${{package.name}}-backend-gsqlite3
        - ${{package.name}}-backend-ldap
        - ${{package.name}}-backend-lmdb
        - ${{package.name}}-backend-lua2
        - ${{package.name}}-backend-pipe
        - ${{package.name}}-backend-remote
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS backends
    test:
      pipeline:
        - uses: test/emptypackage

  - name: ${{package.name}}-tools-all
    dependencies:
      provides:
        - pdns-tools-all=${{package.full-version}}
      runtime:
        - ${{package.name}}-tool-calidns
        - ${{package.name}}-tool-dnsbulktest
        - ${{package.name}}-tool-dnsgram
        - ${{package.name}}-tool-dnspcap2calidns
        - ${{package.name}}-tool-dnspcap2protobuf
        - ${{package.name}}-tool-dnsreplay
        - ${{package.name}}-tool-dnsscan
        - ${{package.name}}-tool-dnsscope
        - ${{package.name}}-tool-dnstcpbench
        - ${{package.name}}-tool-dnswasher
        - ${{package.name}}-tool-dumresp
        - ${{package.name}}-tool-ixplore
        - ${{package.name}}-tool-nproxy
        - ${{package.name}}-tool-nsec3dig
        - ${{package.name}}-tool-pdns_notify
        - ${{package.name}}-tool-saxfr
        - ${{package.name}}-tool-sdig
        - ${{package.name}}-tool-stubquery
        - ${{package.name}}-tool-zone2json
        - ${{package.name}}-tool-zone2ldap
        - ${{package.name}}-tool-zone2sql
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS tools
    test:
      pipeline:
        - uses: test/emptypackage

  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
    dependencies:
      provides:
        - pdns-dev=${{package.full-version}}
      runtime:
        - ${{package.name}}
    description: ${{package.name}} dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: ${{package.name}}-doc
    description: ${{package.name}} docs
    dependencies:
      provides:
        - pdns-doc=${{package.full-version}}
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  ignore-regex-patterns:
    - -alpha
    - -beta
    - -rc
  github:
    identifier: PowerDNS/pdns
    strip-prefix: rec-
    tag-filter: rec-5.2.
    use-tag: true

test:
  environment:
    contents:
      packages:
        - bind-tools
        - curl
        - wait-for-it
        - sqlite
        - ${{package.name}}-backends-all
        - ${{package.name}}-tools-all
    accounts:
      groups:
        - groupname: pdns
          gid: 953
      users:
        - username: pdns
          gid: 953
          uid: 953
      run-as: 0 # To bind :53 on the CI
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        pdns_control --help
        pdns_notify --help
        pdns_server --help
        pdnsutil --help
    - name: "start daemon on localhost"
      uses: test/daemon-check-output
      with:
        setup: |
          curl -fsSL https://raw.githubusercontent.com/PowerDNS/pdns/refs/tags/rec-${{package.version}}/dockerdata/pdns.conf -o /etc/pdns.conf
          curl -fsSL https://raw.githubusercontent.com/PowerDNS/pdns/refs/tags/rec-${{package.version}}/modules/gsqlite3backend/schema.sqlite3.sql -o /tmp/schema.sqlite3.sql
          sqlite3 /var/lib/powerdns/pdns.sqlite3 < /tmp/schema.sqlite3.sql
          pdnsutil create-zone example.com ns1.example.com
          pdnsutil add-record example.com ns1 A 127.0.0.1
        start: "pdns_server"
        timeout: 30
        expected_output: |
          Listening on controlsocket
          UDP server bound
          TCP server bound
          Done launching threads, ready to distribute questions
        post: |
          wait-for-it -t 5 --strict localhost:53
          dig @127.0.0.1 -p 53 example.com SOA +norecurse | grep -qi "NO ERROR"
          sdig 127.0.0.1 53 example.com SOA | grep -qi "No Error"
