package:
  name: pdns-auth-5.0
  version: "5.0.0"
  epoch: 0
  description: PowerDNS Authoritative Server
  copyright:
    - license: GPL-2.0-or-later
    - license: LicenseRef-notice
      license-path: NOTICE
  dependencies:
    provides:
      - pdns-auth=${{package.full-version}}
      - pdns=${{package.full-version}}

vars:
  python-version: 3.12 # Pinning 3.12 due to imghdr. See: https://peps.python.org/pep-0594/#imghdr
  lua-version: 5.4 # Pinning latest lua version to pass cmake

var-transforms:
  - from: ${{package.name}}
    match: '.*-(\d+\.\d+)$'
    replace: '$1'
    to: pdns-version

environment:
  contents:
    packages:
      - bind-dev
      - binutils
      - bison
      - boost-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl-dev
      - file
      - flex
      - fstrm-dev
      - geoip-dev
      - krb5-dev
      - libcap-dev
      - libmaxminddb-dev
      - libsodium-dev
      - libsystemd
      - libtool
      - lmdb-dev
      - lua${{vars.lua-version}}-dev
      - luajit-dev
      - mariadb-connector-c-dev
      - mariadb-dev
      - mtdev-dev
      - net-snmp-dev
      - openldap-dev
      - openssl-dev
      - pkgconf-dev
      - postgresql-dev
      - protobuf-dev
      - py${{vars.python-version}}-virtualenv
      - python-${{vars.python-version}}
      - ragel
      - rust
      - sqlite-dev
      - systemd
      - systemd-dev
      - unixodbc-dev
      - util-linux-dev
      - yaml-cpp-dev
      - zeromq-dev

data:
  - name: backends
    items:
      bind: bind
      geoip: geoip
      gmysql: gmysql
      godbc: godbc
      gpgsql: gpgsql
      gsqlite3: gsqlite3
      ldap: ldap
      lmdb: lmdb
      lua2: lua2
      pipe: pipe
      remote: remote

  - name: tools
    items:
      calidns: calidns
      dnsbulktest: dnsbulktest
      dnsgram: dnsgram
      dnspcap2calidns: dnspcap2calidns
      dnspcap2protobuf: dnspcap2protobuf
      dnsreplay: dnsreplay
      dnsscan: dnsscan
      dnsscope: dnsscope
      dnstcpbench: dnstcpbench
      dnswasher: dnswasher
      dumresp: dumresp
      ixplore: ixplore
      nproxy: nproxy
      nsec3dig: nsec3dig
      pdns_notify: pdns_notify
      saxfr: saxfr
      sdig: sdig
      stubquery: stubquery
      zone2json: zone2json
      zone2ldap: zone2ldap
      zone2sql: zone2sql

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/PowerDNS/pdns
      expected-commit: 0490864e4b1d364d36fbc96cfa916c3443415db2
      tag: auth-${{package.version}}
      cherry-picks: |
        master/e096f48218dd2ea82fc907ff62e4cbced121ca8b: Fix Boost system lib dependency: it is no longer available since 1.89

  - uses: autoconf/configure
    with:
      opts: |
        --sbindir=/usr/bin \
        --with-modules="" \
        --with-dynmodules="bind geoip ldap lmdb lua2 gmysql godbc pipe gpgsql remote gsqlite3" \
        --enable-tools \
        --enable-unit-tests \
        --enable-systemd \
        --disable-static \
        --enable-remotebackend-zeromq \
        --with-libcrypto=/usr \
        --enable-ixfrdist \
        --enable-reproducible

  - uses: autoconf/make

  - uses: autoconf/make-install

  - assertions:
      required-steps: 1
    pipeline:
      - if: ${{build.arch}} == "x86_64"
        runs: make check
      - if: ${{build.arch}} == "aarch64"
        runs: PDNS_TEST_NO_IPV6=1 make check # aarch64 has issues with IPv6 tests on the CI, no error logs available

  - name: Create necessary directories
    runs: |
      mkdir -p ${{targets.contextdir}}/etc/powerdns/pdns.d
      mkdir -p ${{targets.contextdir}}/var/run/pdns/
      mkdir -p ${{targets.contextdir}}/var/lib/powerdns

  - uses: strip

subpackages:
  - range: backends
    name: pdns-auth-backend-${{range.key}}-${{vars.pdns-version}}
    description: PowerDNS ${{range.key}} backend
    dependencies:
      provides:
        - pdns-auth-backend-${{range.key}}=${{package.full-version}}
        - pdns-backend-${{range.key}}=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib/pdns
          mv ${{targets.destdir}}/usr/lib/pdns/lib${{range.key}}backend.so ${{targets.contextdir}}/usr/lib/pdns/lib${{range.key}}backend.so
    test:
      pipeline:
        # gmysql backend needs libmariadb.so.3 on the runtime, which we can't provide runtime deps conditionally when using ranges.
        # Apko would resolve it when building anyway, so we skip the ldd check only for the gmysql backend.
        - if: '"${{range.key}}" != "gmysql"'
          uses: test/tw/ldd-check

  - range: tools
    name: pdns-auth-tool-${{range.key}}-${{vars.pdns-version}}
    description: PowerDNS ${{range.key}} tool
    dependencies:
      provides:
        - pdns-auth-tool-${{range.key}}=${{package.full-version}}
        - pdns-tool-${{range.key}}=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/${{range.key}} ${{targets.contextdir}}/usr/bin/${{range.key}}
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            # saxfr is a special case, it requires IP-address, port, zone to run and does not have a --help option.
            # So we handle it separately.
            if [ "${{range.key}}" = "saxfr" ]; then
              saxfr 127.0.0.1 53 example.com
            else
              "${{range.key}}" --help
            fi

  - name: pdns-auth-backends-all-${{vars.pdns-version}}
    dependencies:
      provides:
        - pdns-auth-backends-all=${{package.full-version}}
        - pdns-backends-all=${{package.full-version}}
      runtime:
        - pdns-auth-backend-bind-${{vars.pdns-version}}
        - pdns-auth-backend-geoip-${{vars.pdns-version}}
        - pdns-auth-backend-godbc-${{vars.pdns-version}}
        - pdns-auth-backend-gmysql-${{vars.pdns-version}}
        - pdns-auth-backend-gpgsql-${{vars.pdns-version}}
        - pdns-auth-backend-gsqlite3-${{vars.pdns-version}}
        - pdns-auth-backend-ldap-${{vars.pdns-version}}
        - pdns-auth-backend-lmdb-${{vars.pdns-version}}
        - pdns-auth-backend-lua2-${{vars.pdns-version}}
        - pdns-auth-backend-pipe-${{vars.pdns-version}}
        - pdns-auth-backend-remote-${{vars.pdns-version}}
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS backends
    test:
      pipeline:
        - uses: test/emptypackage

  - name: pdns-auth-tools-all-${{vars.pdns-version}}
    dependencies:
      provides:
        - pdns-auth-tools-all=${{package.full-version}}
        - pdns-tools-all=${{package.full-version}}
      runtime:
        - pdns-auth-tool-calidns-${{vars.pdns-version}}
        - pdns-auth-tool-dnsbulktest-${{vars.pdns-version}}
        - pdns-auth-tool-dnsgram-${{vars.pdns-version}}
        - pdns-auth-tool-dnspcap2calidns-${{vars.pdns-version}}
        - pdns-auth-tool-dnspcap2protobuf-${{vars.pdns-version}}
        - pdns-auth-tool-dnsreplay-${{vars.pdns-version}}
        - pdns-auth-tool-dnsscan-${{vars.pdns-version}}
        - pdns-auth-tool-dnsscope-${{vars.pdns-version}}
        - pdns-auth-tool-dnstcpbench-${{vars.pdns-version}}
        - pdns-auth-tool-dnswasher-${{vars.pdns-version}}
        - pdns-auth-tool-dumresp-${{vars.pdns-version}}
        - pdns-auth-tool-ixplore-${{vars.pdns-version}}
        - pdns-auth-tool-nproxy-${{vars.pdns-version}}
        - pdns-auth-tool-nsec3dig-${{vars.pdns-version}}
        - pdns-auth-tool-pdns_notify-${{vars.pdns-version}}
        - pdns-auth-tool-saxfr-${{vars.pdns-version}}
        - pdns-auth-tool-sdig-${{vars.pdns-version}}
        - pdns-auth-tool-stubquery-${{vars.pdns-version}}
        - pdns-auth-tool-zone2ldap-${{vars.pdns-version}}
        - pdns-auth-tool-zone2json-${{vars.pdns-version}}
        - pdns-auth-tool-zone2sql-${{vars.pdns-version}}
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS tools
    test:
      pipeline:
        - uses: test/emptypackage

  - name: pdns-auth-doc-${{vars.pdns-version}}
    description: PDNS Authoritative server docs
    dependencies:
      provides:
        - pdns-auth-doc=${{package.full-version}}
        - pdns-doc=${{package.full-version}}
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  ignore-regex-patterns:
    - -alpha
    - -beta
    - -rc
  github:
    identifier: PowerDNS/pdns
    strip-prefix: auth-
    tag-filter: auth-5.0
    use-tag: true

test:
  environment:
    contents:
      packages:
        - bind-tools
        - curl
        - wait-for-it
        - sqlite
        - pdns-auth-backends-all
        - pdns-auth-tools-all
    accounts:
      groups:
        - groupname: pdns
          gid: 953
      users:
        - username: pdns
          gid: 953
          uid: 953
      run-as: 0 # To bind :53 on the CI
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        pdns_control --help
        pdns_notify --help
        pdns_server --help
        pdnsutil --help
    - name: "start daemon on localhost"
      uses: test/daemon-check-output
      with:
        setup: |
          curl -fsSL https://raw.githubusercontent.com/PowerDNS/pdns/refs/tags/auth-${{package.version}}/dockerdata/pdns.conf -o /etc/pdns.conf
          curl -fsSL https://raw.githubusercontent.com/PowerDNS/pdns/refs/tags/auth-${{package.version}}/modules/gsqlite3backend/schema.sqlite3.sql -o /tmp/schema.sqlite3.sql
          sqlite3 /var/lib/powerdns/pdns.sqlite3 < /tmp/schema.sqlite3.sql
          pdnsutil create-zone example.com ns1.example.com
          # require NAME to be absolute, ref: https://github.com/PowerDNS/pdns/pull/14984
          pdnsutil add-record example.com ns1.example.com A 127.0.0.1
        start: "pdns_server"
        timeout: 30
        expected_output: |
          Listening on controlsocket
          UDP server bound
          TCP server bound
          Done launching threads, ready to distribute questions
        post: |
          wait-for-it -t 5 --strict localhost:53
          dig @127.0.0.1 -p 53 example.com SOA +norecurse | grep -qi "NO ERROR"
          sdig 127.0.0.1 53 example.com SOA | grep -qi "No Error"
