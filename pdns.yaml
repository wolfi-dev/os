package:
  name: pdns
  version: "5.2.5"
  epoch: 0
  description: PowerDNS Authoritative Server
  copyright:
    - license: GPL-2.0-or-later
    - license: LicenseRef-notice
      license-path: NOTICE

environment:
  contents:
    packages:
      - autoconf
      - autoconf
      - automake
      - automake
      - binutils
      - bison
      - boost-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl-dev
      - file
      - flex
      - geoip-dev
      - krb5-dev
      - libmaxminddb-dev
      - libsodium-dev
      - libtool
      - lmdb-dev
      - lua5.4-dev
      - luajit-dev
      - mariadb-connector-c-dev
      - mariadb-dev
      - mtdev-dev
      - openldap-dev
      - openssl-dev
      - pkgconf-dev
      - postgresql-dev
      - protobuf-dev
      - py3-virtualenv
      - python-3.12 # pinning due to imghdr ; see https://peps.python.org/pep-0594/#imghdr
      - ragel
      - sqlite-dev
      - unixodbc-dev
      - util-linux-dev
      - yaml-cpp-dev
      - zeromq-dev

data:
  - name: backends
    items:
      bind: bind
      geoip: geoip
      gmysql: gmysql
      godbc: godbc
      gpgsql: gpgsql
      gsqlite3: gsqlite3
      ldap: ldap
      lmdb: lmdb
      lua2: lua2
      pipe: pipe
      remote: remote

  - name: tools
    items:
      calidns: calidns
      dnsbulktest: dnsbulktest
      dnsgram: dnsgram
      dnspcap2calidns: dnspcap2calidns
      dnspcap2protobuf: dnspcap2protobuf
      dnsreplay: dnsreplay
      dnsscan: dnsscan
      dnsscope: dnsscope
      dnstcpbench: dnstcpbench
      dnswasher: dnswasher
      dumresp: dumresp
      ixplore: ixplore
      nproxy: nproxy
      nsec3dig: nsec3dig
      pdns_notify: pdns_notify
      saxfr: saxfr
      sdig: sdig
      stubquery: stubquery
      zone2json: zone2json
      zone2ldap: zone2ldap
      zone2sql: zone2sql

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/PowerDNS/pdns
      expected-commit: 3955b468e9f9cbf81590f86f8e2cc6a75f4ff889
      tag: rec-${{package.version}}

  - uses: autoconf/configure
    with:
      opts: |
        --with-modules="" \
        --with-dynmodules="bind geoip ldap lmdb lua2 gmysql godbc pipe gpgsql remote gsqlite3" \
        --enable-tools \
        --enable-unit-tests \
        --disable-static \
        --enable-remotebackend-zeromq \
        --with-libcrypto=/usr

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      PDNS_TEST_NO_IPV6=1 make check

  - name: Fix usrmerge violation
    runs: |
      mv ${{targets.destdir}}/usr/sbin/* ${{targets.destdir}}/usr/bin
      rm -rf ${{targets.destdir}}/usr/sbin

  - uses: strip

subpackages:
  - range: backends
    name: pdns-backend-${{range.key}}
    description: PowerDNS ${{range.key}} backend
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib/pdns
          mv ${{targets.destdir}}/usr/lib/pdns/lib${{range.key}}backend.so ${{targets.contextdir}}/usr/lib/pdns/lib${{range.key}}backend.so
    test:
      pipeline:
        # gmysql backend needs libmariadb.so.3 on the runtime, which we can't provide runtime deps conditionally when using ranges.
        # Apko would resolve it when building anyway, so we skip the ldd check only for the gmysql backend.
        - if: '"${{range.key}}" != "gmysql"'
          uses: test/tw/ldd-check

  - range: tools
    name: pdns-tool-${{range.key}}
    description: PowerDNS ${{range.key}} tool
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/${{range.key}} ${{targets.contextdir}}/usr/bin/${{range.key}}
    test:
      pipeline:
        - uses: test/tw/ldd-check
        - runs: |
            # saxfr is a special case, it requires IP-address, port, zone to run and does not have a --help option.
            # So we handle it separately.
            if [ "${{range.key}}" != "saxfr" ]; then
              ${{range.key}} --help
            else
              saxfr 127.0.0.1 53 example.com
            fi

  - name: pdns-backends-all
    dependencies:
      runtime:
        - pdns-backend-bind
        - pdns-backend-geoip
        - pdns-backend-godbc
        - pdns-backend-gmysql
        - pdns-backend-gpgsql
        - pdns-backend-gsqlite3
        - pdns-backend-ldap
        - pdns-backend-lmdb
        - pdns-backend-lua2
        - pdns-backend-pipe
        - pdns-backend-remote
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS backends

  - name: pdns-tools-all
    dependencies:
      runtime:
        - pdns-tool-calidns
        - pdns-tool-dnsbulktest
        - pdns-tool-dnsgram
        - pdns-tool-dnspcap2calidns
        - pdns-tool-dnspcap2protobuf
        - pdns-tool-dnsreplay
        - pdns-tool-dnsscan
        - pdns-tool-dnsscope
        - pdns-tool-dnstcpbench
        - pdns-tool-dnswasher
        - pdns-tool-dumresp
        - pdns-tool-ixplore
        - pdns-tool-nproxy
        - pdns-tool-nsec3dig
        - pdns-tool-pdns_notify
        - pdns-tool-saxfr
        - pdns-tool-sdig
        - pdns-tool-stubquery
        - pdns-tool-zone2json
        - pdns-tool-zone2ldap
        - pdns-tool-zone2sql
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all PowerDNS tools

  - name: pdns-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - pdns
    description: pdns dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: pdns-doc
    description: pdns docs
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  ignore-regex-patterns:
    - -alpha
    - -beta
    - -rc
  github:
    identifier: PowerDNS/pdns
    strip-prefix: rec
    tag-filter: rec
    use-tag: true

test:
  environment:
    contents:
      packages:
        - pdns-backends-all
        - pdns-tools-all
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        calidns --help
        dnsbulktest --help
        dnsgram --help
        dnspcap2calidns --help
        dnspcap2protobuf --help
        dnsreplay --help
        dnsscan --help
        dnsscope --help
        dnstcpbench --help
        dnswasher --help
        dumresp --help
        ixplore --help
        nproxy --help
        nsec3dig --help
        pdns_control --help
        pdns_notify --help
        pdns_server --help
        pdnsutil --help
        saxfr 127.0.0.1 53 example.com
        sdig --help
        stubquery --help
        zone2json --help
        zone2ldap --help
        zone2sql --help
