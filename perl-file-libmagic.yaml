package:
  name: perl-file-libmagic
  version: "1.23"
  epoch: 0
  description: File::LibMagic - Determine MIME types of data or files using libmagic
  copyright:
    - license: GPL-1.0-or-later OR Artistic-1.0-Perl

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - libmagic-dev
      - perl-capture-tiny
      - perl-config-autoconf
      - perl-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/houseabsolute/File-LibMagic.git
      expected-commit: ab55dcf3fef341c2bcf22c8ef497cca7b8eee4d7
      tag: v${{package.version}}

  - runs: PERL_MM_USE_DEFAULT=1 perl Makefile.PL

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: perl/cleanup

  - uses: strip

test:
  environment:
    contents:
      packages:
        - libmagic
        - perl
  pipeline:
    - name: Verify module loading
      runs: |
        perl -e "use File::LibMagic; print 'File::LibMagic loaded successfully\n'" || exit 1
    - name: Test MIME type detection
      runs: |
        perl <<-'EOF'
        use File::LibMagic;
        use strict;
        use warnings;

        # Create a File::LibMagic instance
        my $flm = File::LibMagic->new();
        unless ($flm) {
          print "FAIL: Could not create File::LibMagic instance\n";
          exit 1;
        }

        # Create test files with known content
        open(my $txt_fh, '>', '/tmp/test.txt') or die "Cannot create test.txt: $!";
        print $txt_fh "Hello, World!\n";
        close($txt_fh);

        open(my $html_fh, '>', '/tmp/test.html') or die "Cannot create test.html: $!";
        print $html_fh "<html><body><h1>Test</h1></body></html>\n";
        close($html_fh);

        # Test MIME type detection from file
        my $txt_mime = $flm->checktype_filename('/tmp/test.txt');
        print "Text file MIME type: $txt_mime\n";
        unless ($txt_mime && $txt_mime =~ /text/) {
          print "FAIL: Expected text MIME type for .txt file, got: " . ($txt_mime || "undef") . "\n";
          exit 1;
        }

        my $html_mime = $flm->checktype_filename('/tmp/test.html');
        print "HTML file MIME type: $html_mime\n";
        unless ($html_mime && $html_mime =~ /text/) {
          print "FAIL: Expected text MIME type for .html file, got: " . ($html_mime || "undef") . "\n";
          exit 1;
        }

        print "MIME type detection tests passed!\n";
        EOF
    - name: Test file description detection
      runs: |
        perl <<-'EOF'
        use File::LibMagic;
        use strict;
        use warnings;

        my $flm = File::LibMagic->new();

        # Test file description detection
        my $txt_desc = $flm->describe_filename('/tmp/test.txt');
        print "Text file description: $txt_desc\n";
        unless ($txt_desc && $txt_desc =~ /text/) {
          print "FAIL: Expected text description for .txt file, got: " . ($txt_desc || "undef") . "\n";
          exit 1;
        }

        my $html_desc = $flm->describe_filename('/tmp/test.html');
        print "HTML file description: $html_desc\n";
        unless ($html_desc && ($html_desc =~ /text/ || $html_desc =~ /HTML/i)) {
          print "FAIL: Expected text or HTML description for .html file, got: " . ($html_desc || "undef") . "\n";
          exit 1;
        }

        print "File description tests passed!\n";
        EOF
    - name: Test data detection from memory
      runs: |
        perl <<-'EOF'
        use File::LibMagic;
        use strict;
        use warnings;

        my $flm = File::LibMagic->new();

        # Test MIME detection from data in memory
        my $text_data = "This is plain text content\n";
        my $mime_from_data = $flm->checktype_contents($text_data);
        print "MIME type from text data: $mime_from_data\n";
        unless ($mime_from_data && $mime_from_data =~ /text/) {
          print "FAIL: Expected text MIME type from data, got: " . ($mime_from_data || "undef") . "\n";
          exit 1;
        }

        # Test description from data in memory
        my $desc_from_data = $flm->describe_contents($text_data);
        print "Description from text data: $desc_from_data\n";
        unless ($desc_from_data && $desc_from_data =~ /text/) {
          print "FAIL: Expected text description from data, got: " . ($desc_from_data || "undef") . "\n";
          exit 1;
        }

        # Test with HTML data
        my $html_data = "<html><head><title>Test</title></head><body>Content</body></html>";
        my $html_mime_from_data = $flm->checktype_contents($html_data);
        print "MIME type from HTML data: $html_mime_from_data\n";
        unless ($html_mime_from_data && $html_mime_from_data =~ /text/) {
          print "FAIL: Expected text MIME type from HTML data, got: " . ($html_mime_from_data || "undef") . "\n";
          exit 1;
        }

        print "Data detection tests passed!\n";
        EOF

update:
  enabled: true
  github:
    identifier: houseabsolute/File-LibMagic
    strip-prefix: v
    use-tag: true
    tag-filter: v
