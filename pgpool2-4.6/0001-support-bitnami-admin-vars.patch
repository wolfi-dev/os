From f6c4cc337f6490f37b5d5cb91ef3729a39d4ebdf Mon Sep 17 00:00:00 2001
From: Sanjay Kumar <sanjay.kumar@chainguard.dev>
Date: Thu, 20 Nov 2025 13:20:30 +0530
Subject: [PATCH] support bitnami admin vars

---
 pgpool.docker/entrypoint.sh | 21 +++++++++++++++++----
 1 file changed, 17 insertions(+), 4 deletions(-)

diff --git a/pgpool.docker/entrypoint.sh b/pgpool.docker/entrypoint.sh
index 4bb362b..ca3695d 100755
--- a/pgpool.docker/entrypoint.sh
+++ b/pgpool.docker/entrypoint.sh
@@ -83,16 +83,29 @@ generate_pcp_conf() {
     touch ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
     chmod 0600 ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
 
-    if [[ -n "${PGPOOL_PCP_USER}" ]] && [[ -n "${PGPOOL_PCP_PASSWORD}" ]]; then
+    local pcp_user="${PGPOOL_PCP_USER:-}"
+    local pcp_password="${PGPOOL_PCP_PASSWORD:-}"
+
+    if [[ -z "${pcp_user}" ]] && [[ -n "${PGPOOL_ADMIN_USERNAME:-}" ]]; then
+        pcp_user="${PGPOOL_ADMIN_USERNAME}"
+        echo "Using PGPOOL_ADMIN_USERNAME for PCP user (Bitnami compatibility mode)"
+    fi
+
+    if [[ -z "${pcp_password}" ]] && [[ -n "${PGPOOL_ADMIN_PASSWORD:-}" ]]; then
+        pcp_password="${PGPOOL_ADMIN_PASSWORD}"
+        echo "Using PGPOOL_ADMIN_PASSWORD for PCP password (Bitnami compatibility mode)"
+    fi
+
+    if [[ -n "${pcp_user}" ]] && [[ -n "${pcp_password}" ]]; then
         echo "Generating pcp.conf..."
         if [[ "${PGPOOL_SKIP_PASSWORD_ENCRYPTION}" =~ ^(yes|true|on)$ ]]; then
             echo "Skip password encryption. Use the encrypted password."
-            echo "${PGPOOL_PCP_USER}:${PGPOOL_PCP_PASSWORD}" >> ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
+            echo "${pcp_user}:${pcp_password}" >> ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
         else
-            echo "${PGPOOL_PCP_USER}:"`${PGPOOL_INSTALL_DIR}/bin/pg_md5 ${PGPOOL_PCP_PASSWORD}` >> ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
+            echo "${pcp_user}:"`${PGPOOL_INSTALL_DIR}/bin/pg_md5 ${pcp_password}` >> ${PGPOOL_INSTALL_DIR}/etc/pcp.conf
         fi
     else
-        echo "Skip generating pcp.conf. PGPOOL_PCP_USER or PGPOOL_PCP_PASSWORD isn't defined."
+        echo "Skip generating pcp.conf. PCP user or password isn't defined (neither PGPOOL_PCP_USER/PGPOOL_PCP_PASSWORD nor PGPOOL_ADMIN_USERNAME/PGPOOL_ADMIN_PASSWORD)."
     fi
 }
 
-- 
2.51.2

