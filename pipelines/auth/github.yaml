name: Setup auth to clone private repos using OctoSTS

needs:
  packages:
    - busybox
    - curl
    - git
    - jq

inputs:
  repo:
    description: which GitHub repo to clone (e.g., "chainguard-dev/ecosystems-cassandra")
    required: true
  identity:
    description: the identity to use for OctoSTS
    required: false
    default: elastic-build

pipeline:
  - runs: |
      set -xeuo pipefail

      # Check for authentication in the following order:
      # 1. GITHUB_TOKEN environment variable
      # 2. .github-token file (for local testing)
      # 3. gh CLI tool (if available)
      # 4. OctoSTS (fallback for CI/CD)

      if [ -n "${GITHUB_TOKEN:-}" ]; then
        echo "Using GITHUB_TOKEN environment variable for ${{inputs.repo}}"
        ghtoken="${GITHUB_TOKEN}"
      elif [ -f .github-token ]; then
        echo "Using .github-token to get a token for ${{inputs.repo}} -- ONLY FOR LOCAL TESTING"
        ghtoken=$(cat .github-token)
      elif command -v gh >/dev/null 2>&1; then
        echo "Using gh CLI to get a token for ${{inputs.repo}}"
        ghtoken=$(gh auth token)
      else
        echo "Using OctoSTS to get a token for ${{inputs.repo}} as ${{inputs.identity}}"
        idtoken=$(curl --fail-with-body -sSL -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity?audience=octo-sts.dev)
        ghtoken=$(curl --fail-with-body -sSL -H "Authorization: Bearer ${idtoken}" "https://octo-sts.dev/sts/exchange?scope=${{inputs.repo}}&identity=${{inputs.identity}}" | jq -r .token)

        # Validate token has access to the repository with exponential backoff
        echo "Validating GitHub token access to ${{inputs.repo}}..."
        max_attempts=3
        attempt=1
        validated=false

        while [ $attempt -le $max_attempts ]; do
          echo "Validation attempt $attempt of $max_attempts..."
          if curl -sSL -f -H "Authorization: Bearer ${ghtoken}" "https://api.github.com/repos/${{inputs.repo}}" >/dev/null 2>&1; then
            echo "Token validation successful - access to ${{inputs.repo}} confirmed"
            validated=true
          else
            echo "Token validation failed on attempt $attempt - unable to access ${{inputs.repo}}"
            if [ $attempt -lt $max_attempts ]; then
              sleep_time=$((2 ** (attempt + 1)))
              echo "Waiting ${sleep_time} seconds before retry..."
              sleep $sleep_time
            fi
          fi
          attempt=$((attempt + 1))
        done

        if [ "$validated" = "false" ]; then
          echo "ERROR: Failed to validate GitHub token access to ${{inputs.repo}} after $max_attempts attempts"
          exit 1
        fi
      fi

      git config --global credential.helper store
      echo "https://user:${ghtoken}@github.com" > ~/.git-credentials
      cat ~/.git-credentials
