name: Compile locked requirements file using uv

needs:
  packages:
    - busybox
    - uv

inputs:
  dependencies:
    description: |
      "Indirect dependencies to bundle. Provide a line or space separated list of Python packages with constraints."
    default: ""
  package:
    description: "Name of main package to install."
    required: true
  python:
    description: "Path to Python executable."
    default: "/usr/bin/python3"

pipeline:
  - runs: |
      # Set Python path
      export "UV_PYTHON=${{inputs.python}}"

      # Initialize dummy project
      project_dir=$(mktemp -d); cd $project_dir
      uv init

      # Add any indirect dependencies
      for pkg in "${{inputs.dependencies}}"; do
        uv add $pkg
      done

      # Add version-constrained main package
      # The package version must align with the version of our main package
      uv add ${{inputs.package}}==${{package.version}}

      # Export locked requirements
      echo "Copy the following into ${{package.name}}/requirements.locked:"
      uv export

      # Exit so that output can be easily copied      
      exit 1
