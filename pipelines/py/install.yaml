name: Install Python packages with UV

needs:
  packages:
    - python-${{inputs.python-version}}-base
    - uv

inputs:
  bundle:
    description: "Bundle direct Python dependencies."
    default: "false"
  dependencies:
    description: "Indirect dependencies to install."
    default: ""
  package:
    description: "Name of packages to install."
    required: true
  python-version:
    description: "Python version to use."
    required: true
  version:
    description: "Version of package to install."
    required: true

pipeline:
  - runs: |
      # Set Python version
      export "UV_PYTHON=${{inputs.python-version}}"

      # Do not bundle dependencies by default
      install_opts="--no-deps"

      # If we want to bundle dependencies, remove --no-deps
      if [ "${{inputs.bundle}}" = "true" ]; then
        install_opts=""
      fi

      # Install package
      mkdir -p ${{targets.contextdir}}
      uv pip install $install_opts \
        --config-file /etc/uv/uv.toml \
        --system --prefix ${{targets.contextdir}}/usr \
        ${{inputs.package}}==${{inputs.version}} \
        ${{inputs.dependencies}}

      # Remove lockfile
      rm ${{targets.contextdir}}/usr/.lock
