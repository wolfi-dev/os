name: Run 'pip check' to verify runtime deps.

needs:
  packages:
    - pip-zipapp

inputs:
  python:
    description: which python to use
    default: DEFAULT

pipeline:
  - name: "pip check"
    runs: |
      set +x
      python="${{inputs.python}}"
      if [ "$python" = "DEFAULT" ]; then
          glob="/usr/bin/python3.[0-9][0-9] /usr/bin/python3.[789]"
          n=0
          for p in $glob; do
            [ -x "$p" ] && n=$((n+1)) && py=$p
          done
          if [ "$n" -ne 1 ]; then
            echo "FAIL: must set inputs.python: " \
               "found $n executables matching $glob"
            [ "$n" -eq 0 ] || echo "found:" $glob
            exit 1
          fi
          echo "using python $py"
          python=$py
      fi

      pipzip=/usr/share/pip-zipapp/pip-zipapp.pyz
      [ -e "$pipzip" ] ||
          { echo "missing pip-zip - $pipzip does not exist"; exit 1; }
      [ -f "$pipzip" ] ||
          { echo "missing pip-zip - $pipzip is not a file"; exit 1; }

      info() { echo "$@"; }
      vr() { info "execute:" "$@"; "$@"; }

      pyver=$("$py" -c 'import sys; print("%s.%s" % (sys.version_info.major, sys.version_info.minor))')
      info "Using 'pip check' with $py at version '$pyver'"
      vr "$py" "$pipzip" check
