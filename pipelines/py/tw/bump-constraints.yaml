name: Bump Python constraint pins

inputs:
  constraints-file:
    description: Path to the constraints file to update
    default: constraints.txt
  packages:
    description: |
      List of package==version pairs to update (newline separated, with optional comments)
      Use the string '# future-updates' as a placeholder.
    required: true
  only-replace:
    description: Only update packages already in the constraints file (set to false to allow adding new packages)
    default: "true"

needs:
  packages:
    - tw

pipeline:
  - name: "bump constraint pins"
    runs: |
      set -euo pipefail

      # Create a temporary file with the package updates
      updates_file=$(mktemp /tmp/bump-constraints.XXXXXX)
      trap "rm -f $updates_file" EXIT

      # Write packages to the temporary file
      echo "${{inputs.packages}}" > "$updates_file"

      # Execute tw bumpconstraints command using the updates file
      tw bumpconstraints \
        --constraints-file="${{inputs.constraints-file}}" \
        --updates-file="$updates_file" \
        --only-replace=${{inputs.only-replace}}

      echo ""
      echo "Changes made:"
      if diff -u "${{inputs.constraints-file}}.bak" "${{inputs.constraints-file}}"; then
        echo "ERROR: No changes were made to ${{inputs.constraints-file}}" 1>&2
        exit 1
      fi
