name: Strip binaries

needs:
  packages:
    - binutils
    - scanelf

inputs:
  opts:
    description: |
      The option flags to pass to the strip command.
    default: -g

pipeline:
  - working-directory: ${{targets.contextdir}}
    runs: |
      check() { "$@" || { echo "[strip] FATAL: '$*' failed $?"; exit 1; }; }

      scanout=$(mktemp)
      check scanelf --recursive --nobanner --etype "ET_DYN,ET_EXEC" --format "%I %a" -o "$scanout" .

      count=0
      while read osabi arch filename; do
        # Skip foreign binaries
        case "${{build.arch}}" in
          x86_64) [ "$arch" = "EM_X86_64" ] || continue;;
          aarch64) [ "$arch" = "EM_AARCH64" ] || continue;;
        esac
        [ "$osabi" != "STANDALONE" ] || continue
        check strip ${{inputs.opts}} "$filename"
        count=$((count+1))
      done < "$scanout"

      echo "[strip] stripped $count ${{build.arch}} binaries in $PWD"
      rm -f "$scanout"
