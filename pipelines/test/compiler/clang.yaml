name: Clang-Specific Compiler Tests

needs:
  packages:
    - glibc-dev

inputs:
  cc:
    description: |
      CC compiler to use
    required: false
    default: ""
  cxx:
    description: |
      C++ compiler to use
    required: false
    default: ""

pipeline:
  - name: validate pipeline inputs
    runs: |
      test -z "${{inputs.cc}}" || exit 0
      test -z "${{inputs.cxx}}" || exit 0
      echo "ERROR: pipeline requires either cc or cxx as input" 1>&2
      exit 1

  - name: create common user config file
    runs: |
      mkdir -p ~/.config/clang
      cat > ~/.config/clang/common.cfg <<'EOF'
      -Wl,--package-metadata='{"type":"TEST_TYPE"}'
      EOF

  - name: test user config file for C driver
    runs: |
      test -n "${{inputs.cc}}" || { echo "No C compiler specified, skipping" 1>&2; exit 0; }
      clang_major="$(${{inputs.cc}} -dumpversion | cut -d. -f1)"
      [ "$clang_major" -gt 15 ] || { echo "clang-${clang_major} has user configuration files disabled due to lack of tilde expansion support, skipping" 1>&2; exit 0; }
      cfg=~/.config/clang-${clang_major}/${{build.arch}}-unknown-linux-gnu-clang.cfg
      mkdir -p "$(dirname "${cfg}")"
      echo "@../clang/common.cfg" > "$cfg"
      tmpdir="$(mktemp -d)"
      trap "rm -rf $cfg $tmpdir" EXIT
      cd "$tmpdir"

      cat > test.c <<EOF
      #include <stdio.h>
      int main() { printf("OK"); }
      EOF
      ${{inputs.cc}} test.c -o test
      readelf -n test | grep TEST_TYPE

  - name: test user config file for C++ driver
    runs: |
      test -n "${{inputs.cxx}}" || { echo "No C++ compiler specified, skipping" 1>&2; exit 0; }
      clang_major="$(${{inputs.cxx}} -dumpversion | cut -d. -f1)"
      [ "$clang_major" -gt 15 ] || { echo "clang-${clang_major} has user configuration files disabled due to lack of tilde expansion support, skipping" 1>&2; exit 0; }
      cfg=~/.config/clang-${clang_major}/${{build.arch}}-unknown-linux-gnu-clang++.cfg
      mkdir -p "$(dirname "${cfg}")"
      echo "@../clang/common.cfg" > "$cfg"
      tmpdir="$(mktemp -d)"
      trap "rm -rf $cfg $tmpdir" EXIT
      cd "$tmpdir"

      cat > test.cpp <<EOF
      #include <iostream>
      int main() { std::cout << "OK" << std::endl; }
      EOF
      ${{inputs.cxx}} test.cpp -o test
      readelf -n test | grep TEST_TYPE
