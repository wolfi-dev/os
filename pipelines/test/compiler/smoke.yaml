name: Compiler Sanity Tests

inputs:
  cc:
    description: |
      CC compiler to use
    required: false
    default: ""
  cxx:
    description: |
      C++ compiler to use
    required: false
    default: ""

pipeline:
  - name: validate pipeline inputs
    runs: |
      test -z "${{inputs.cc}}" || exit 0
      test -z "${{inputs.cxx}}" || exit 0
      echo "ERROR: pipeline requires either cc or cxx as input" 1>&2
      exit 1

  - name: smoke test C compiler
    runs: |
      test -n "${{inputs.cc}}" || { echo "No C compiler specified, skipping" 1>&2; exit 0; }
      tmpdir="$(mktemp -d)"
      trap "rm -rf $tmpdir" EXIT
      cd "$tmpdir"

      cat > smoke.c <<EOF
      #include <stdio.h>
      int main() { printf("OK"); }
      EOF
      ${{inputs.cc}} smoke.c -o smoke
      ./smoke

  - name: sanity test C++ compiler
    runs: |
      test -n "${{inputs.cxx}}" || { echo "No C++ compiler specified, skipping" 1>&2; exit 0; }
      tmpdir="$(mktemp -d)"
      trap "rm -rf $tmpdir" EXIT
      cd "$tmpdir"

      cat > smoke.cpp <<EOF
      #include <iostream>
      int main() { std::cout << "OK" << std::endl; }
      EOF
      ${{inputs.cxx}} smoke.cpp -o smoke
      ./smoke

  - name: check C++ include paths
    runs: |
      test -n "${{inputs.cxx}}" || { echo "No C++ compiler specified, skipping" 1>&2; exit 0; }
      tmpdir="$(mktemp -d)"
      trap "rm -rf $tmpdir" EXIT
      cd "$tmpdir"

      cat > smoke.cpp <<EOF
      #include <iostream>
      #include <memory>
      int main() { std::cout << "OK" << std::endl; }
      EOF
      ${{inputs.cxx}} smoke.cpp -o smoke
      ./smoke

  - name: check C system include paths
    runs: |
      # Fails if we override system paths w/o declaring them as system paths
      test -n "${{inputs.cc}}" || { echo "No C compiler specified, skipping" 1>&2; exit 0; }
      tmpdir="$(mktemp -d)"
      trap "rm -rf $tmpdir" EXIT
      cd "$tmpdir"

      cat > smoke.c <<EOF
      #include <stdio.h>
      int main() { printf("OK"); }
      EOF
      ${{inputs.cc}} -nostdinc smoke.c -o smoke || exit 0

  - name: check C++ system include paths
    runs: |
      # Fails if we override system paths w/o declaring them as system paths
      test -n "${{inputs.cxx}}" || { echo "No C++ compiler specified, skipping" 1>&2; exit 0; }
      tmpdir="$(mktemp -d)"
      trap "rm -rf $tmpdir" EXIT
      cd "$tmpdir"

      cat > smoke.cpp <<EOF
      #include <iostream>
      int main() { std::cout << "OK" << std::endl; }
      EOF
      ${{inputs.cxx}} -nostdinc++ smoke.cpp -o smoke || exit 0
