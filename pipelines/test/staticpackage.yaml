name: staticpackage

# static packages that contain only static libraries, which are linked into applications at compile time rather than at runtime.
# this packages only contains `.a` files, no other files are expected. this pipeline checks that the package contains only static libraries.
pipeline:
  - name: static package check
    runs: |
      # Get our static package name, which is usually a sub package
      static_pkg=$(basename ${{targets.contextdir}})

      # Get file list, excluding empty lines and SBOM files
      file_list="$(apk info --quiet --contents "$static_pkg" | grep -v "^$" | grep -v "^var/lib/db/sbom")"

      # Check if package contains any .a files
      static_lib_count=$(echo "$file_list" | grep "\.a$" | wc -l)
      if [ "$static_lib_count" -eq 0 ]; then
        echo "See:"
        apk info -qL "$static_pkg"
        echo "FAIL: Package [$static_pkg] does not contain any static library '.a' files"
        echo "      Please check the package build for proper static library installation, and either:"
        echo "        (a) fix the static subpackage build to actually include .a files (check the split/static pipeline), or"
        echo "        (b) remove the test/staticpackage pipeline"
        exit 1
      fi

      # Check if package contains any non-.a files
      if [ $(echo "$file_list" | grep -v "\.a$" | wc -l) -ne 0 ]; then
        echo "FAIL: Package [$static_pkg] contains unexpected files beyond static library '.a' files:"
        echo "$file_list" | grep -v "\.a$"
        echo "      Expected only .a files and .spdx.json metadata"
        exit 1
      fi

      echo "PASS: Package [$static_pkg] contains only valid static libraries, total static files: $static_lib_count"
