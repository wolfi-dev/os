name: contains-files

inputs:
  dir:
    description: |
      Directory to look into. Defaults to /usr.
      Examples:
        dir: "/usr/lib/"
    required: false
    default: "/usr/"
  name:
    description: |
      A find-like name expression. Defaults to * (i.e, match anything).
    required: false
    default: "*"
  type:
    description: |
      File type to find. Defaults to 'f' (i.e, regular file).
    required: false
    default: "f"
  files:
    description: |
      Space-separated list of file paths to check for existence.
      If present, parameters 'dir', 'name' and 'type' will be ignored.
    required: false
    default: ""

# USAGE EXAMPLES:
#
#   - uses: test/tw/contains-files
#     with:
#       dir: /usr/lib/
#       name: libre2.so
#
#   - uses: test/tw/contains-files
#     with:
#       dir: /opt/
#       name: some-binary-link
#       type: l
#
#    - uses: test/tw/contains-files
#      with:
#        dir: "/usr/lib/ruby/gems/"
#        name: "*.rbs"
#
#    - uses: test/tw/contains-files
#      with:
#        files: |
#          /usr/lib/ruby/gems/3.3.0/gems/webrick-1.9.2/Gemfile
#          /usr/lib/ruby/gems/3.3.0/gems/webrick-1.9.2/sig/cgi.rbs
#
pipeline:
  - name: "check the specified dir for file names"
    runs: |
      dir="${{inputs.dir}}"
      name="${{inputs.name}}"
      type="${{inputs.type}}"
      files="${{inputs.files}}"

      if [ ! -z "${files}" ] ; then
        # NOOP: the other run mode was requested.
        exit 0
      fi

      message="files found in [${dir}] with name [${name}] and type [${type}]"

      list="$(find ${dir} -name ${name} -type ${type})"
      if [ -z "${list}" ] ; then
        echo "FAIL: no ${message}. This is unexpected." >&2
        exit 1
      fi

      echo "PASS: ${message}. This is expected."

  - name: "check the speficied files paths"
    runs: |
      files="${{inputs.files}}"
      if [ -z "${files}" ] ; then
        # NOOP: the other run mode was requested
        exit 0
      fi

      for file in $files ; do
        if [ ! -e "$file" ] ; then
          echo "FAIL: file [${file}] is not in the package. This is unexpected." >&2
          exit 1
        fi
      done

      echo "PASS: the specified file paths are in the package. This is expected."
