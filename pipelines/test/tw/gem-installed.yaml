name: gem-installed

inputs:
  gem:
    description: |
      Gem name to verify. If not specified, auto-detected from the package
      name by stripping the leading ruby<version>- prefix.
      Example: ruby3.2-bouncy-castle-java -> bouncy-castle-java
    required: false
    default: ""

# USAGE EXAMPLES:
#
# Auto-detect gem name from ruby<version>-<gem> package name:
#   - uses: test/tw/gem-installed
#
# Specify gem name explicitly:
#   - uses: test/tw/gem-installed
#     with:
#       gem: bouncy-castle-java
pipeline:
  - name: verify gem is installed and has content
    runs: |
      set -euo pipefail
      gem_name="${{inputs.gem}}"
      if [ -z "$gem_name" ]; then
        gem_name=$(echo "${{context.name}}" | sed 's/^ruby[0-9][0-9.]*-//')
      fi
      echo "Checking gem: $gem_name"
      gem list "$gem_name" | grep -F "$gem_name"
      echo "Files installed by $gem_name:"
      files=$(gem contents "$gem_name")
      if [ -z "$files" ]; then
        echo "FAIL: gem $gem_name has no installed files" >&2
        exit 1
      fi
      echo "$files"
      echo "PASS: gem $gem_name is installed"
