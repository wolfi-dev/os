name: Dynamic Library Dependency Validator

description: |
  Checks binaries for missing runtime library dependencies using ldd.
  This test verifies that all shared libraries required by executables and shared objects
  are present and can be resolved at runtime. Critical for ensuring packages have correct
  runtime dependencies declared. Can check specific files, entire packages, or exclude files,
  with support for custom library paths.

needs:
  packages:
    - ldd-check

inputs:
  files:
    description: |
      Specific file paths to run ldd on and check for missing dependencies.
      Use this to check specific binaries or libraries instead of entire packages.
      Space-separated if multiple files.
    required: false
  exclude-files:
    description: |
      File names or patterns to exclude from ldd checking.
      Useful for skipping known problematic binaries or test files.
      Multiple file names must be space-separated.
    required: false
    default: ""
  packages:
    description: |
      Space-separated list of package names whose binaries should be checked.
      All executables and shared libraries in these packages will be validated.
      Use "none" to disable the default package check and only check specific files.
    required: false
    default: "${{context.name}}"
  extra-library-paths:
    description: |
      Additional library search paths to prepend to LD_LIBRARY_PATH.
      Use this when binaries depend on libraries in non-standard locations.
      Multiple paths should be colon-delimited (e.g., "/opt/lib:/usr/local/lib").
    required: false
    default: ""
  verbose:
    description: |
      Enable verbose output showing full ldd information for all checked binaries.
      Useful for debugging dependency issues. Set to "true" to enable.
    required: false
    default: false

# USAGE EXAMPLES:
#
# Basic check (all binaries in current package):
#   - uses: test/tw/ldd-check
#
# Check specific files:
#   - uses: test/tw/ldd-check
#     with:
#       files: "/usr/bin/myapp /usr/lib/libmylib.so"
#
# Exclude problematic binaries:
#   - uses: test/tw/ldd-check
#     with:
#       exclude-files: "test-binary debug-tool"
#
# Add custom library paths:
#   - uses: test/tw/ldd-check
#     with:
#       extra-library-paths: "/opt/cuda/lib64:/usr/local/lib"
#
pipeline:
  - name: "check for missing library dependencies using ldd"
    runs: |
      ldd-check \
          --files="${{inputs.files}}" \
          --exclude-files="${{inputs.exclude-files}}" \
          --packages="${{inputs.packages}}" \
          --extra-library-paths="${{inputs.extra-library-paths}}" \
          --verbose="${{inputs.verbose}}"
