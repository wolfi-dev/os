name: lua-syntax-check

needs:
  packages:
    - luajit

inputs:
  files:
    description: |
      Newline or space-separated list of Lua file paths to verify exist
      and syntax-check by compiling to LuaJIT bytecode.

      These files cannot be require()'d standalone (e.g. OpenResty cosocket
      libraries that reference ngx.* at module level), so bytecode compilation
      is used as a proxy for syntax validity.

      Example:
        files: |
          /usr/lib/lua/resty/cookie.lua
          /usr/lib/lua/resty/dns/resolver.lua
    required: true

# USAGE EXAMPLE:
#
#   - uses: test/tw/lua-syntax-check
#     with:
#       files: |
#         /usr/lib/lua/resty/cookie.lua

pipeline:
  - name: "check Lua files exist and compile cleanly with LuaJIT"
    runs: |
      set -euo pipefail
      files="${{inputs.files}}"
      fails=0
      for file in $files; do
        if [ ! -e "$file" ]; then
          echo "FAIL: file [$file] not found in package" >&2
          fails=$((fails+1))
          continue
        fi
        if luajit -b "$file" /dev/null; then
          echo "PASS: $file"
        else
          echo "FAIL: $file failed LuaJIT bytecode compilation" >&2
          fails=$((fails+1))
        fi
      done
      exit $fails
