name: lua-syntax-check

needs:
  packages:
    - luajit

# USAGE EXAMPLE:
#
#   - uses: test/tw/lua-syntax-check
pipeline:
  - name: "find and compile all installed Lua files with LuaJIT"
    runs: |
      set -euo pipefail
      files=$(find /usr/lib/lua /usr/share/lua -name '*.lua' 2>/dev/null) || true
      if [ -z "$files" ]; then
        echo "FAIL: no *.lua files found under /usr/lib/lua or /usr/share/lua" >&2
        exit 1
      fi
      fails=0
      for file in $files; do
        if luajit -b "$file" /dev/null; then
          echo "PASS: $file"
        else
          echo "FAIL: $file failed LuaJIT bytecode compilation" >&2
          fails=$((fails+1))
        fi
      done
      exit $fails
