name: Shell Dependencies Package Checker

description: |
  Checks an installed package's shell scripts for missing dependencies and GNU coreutils compatibility issues.
  This test ensures shell scripts have all required commands available and don't use GNU-specific flags
  that won't work with busybox. Critical for validating packages that include shell scripts in minimal
  environments where busybox is commonly used.

needs:
  packages:
    - tw

inputs:
  package:
    description: |
      The installed package name to check for shell dependency issues.
      The package must be installed in the test environment.
    required: true
  path:
    description: |
      PATH-like colon-separated directories to search for commands.
      Defaults to /usr/bin which covers most standard commands.
    required: false
    default: "/usr/bin"
  strict:
    description: |
      Exit with non-zero status if any issues are found.
      Set to false for report-only mode.
    required: false
    default: true
  verbose:
    description: |
      Enable verbose output for detailed debugging information.
    required: false
    default: false

# USAGE EXAMPLES:
#
# Basic check (strict mode by default):
#   - uses: test/tw/shell-deps-check-package
#     with:
#       package: ${{package.name}}
#
# Report-only mode:
#   - uses: test/tw/shell-deps-check-package
#     with:
#       package: nginx
#       strict: false
#
# Custom PATH with verbose output:
#   - uses: test/tw/shell-deps-check-package
#     with:
#       package: ${{package.name}}
#       path: /usr/bin:/usr/local/bin:/bin
#       verbose: true
pipeline:
  - name: "check shell script dependencies in package"
    runs: |
      VERBOSE_FLAG=""
      if [ "${{inputs.verbose}}" = "true" ]; then
        VERBOSE_FLAG="--verbose"
      fi

      tw shell-deps check-package \
          --path="${{inputs.path}}" \
          --strict="${{inputs.strict}}" \
          $VERBOSE_FLAG \
          "${{inputs.package}}"
