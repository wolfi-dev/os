name: Shell Dependencies File Checker

description: |
  Checks shell script files for missing dependencies and GNU coreutils compatibility issues.
  This test analyzes shell scripts and validates that all external command dependencies exist in the
  specified PATH and detects GNU-specific flags that won't work with busybox. Essential for ensuring
  shell scripts work correctly in minimal environments.

needs:
  packages:
    - tw

inputs:
  files:
    description: |
      Shell script file paths to check, space-separated or one per line.
      Supports glob patterns (e.g., /usr/bin/*.sh).
      Examples:
        Single file: "/usr/bin/entrypoint.sh"
        Multiple files: "/usr/bin/script1.sh /usr/bin/script2.sh"
        With globs: "/opt/scripts/*.sh"
    required: true
  path:
    description: |
      PATH-like colon-separated directories to search for commands.
      Defaults to /usr/bin for broader command coverage.
    required: false
    default: "/usr/bin"
  strict:
    description: |
      Exit with non-zero status if any issues are found.
      Set to false for report-only mode.
    required: false
    default: true
  verbose:
    description: |
      Enable verbose output for detailed debugging information.
    required: false
    default: false

# USAGE EXAMPLES:
#
# Single file check:
#   - uses: test/tw/shell-deps-check
#     with:
#       files: /usr/bin/entrypoint.sh
#
# Multiple files:
#   - uses: test/tw/shell-deps-check
#     with:
#       files: |
#         /usr/bin/script1.sh
#         /usr/bin/script2.sh
#
# With glob pattern:
#   - uses: test/tw/shell-deps-check
#     with:
#       files: /opt/scripts/*.sh
#
# Report-only mode with verbose output:
#   - uses: test/tw/shell-deps-check
#     with:
#       files: /usr/bin/*.sh
#       strict: false
#       verbose: true
pipeline:
  - name: "check shell script dependencies"
    runs: |
      VERBOSE_FLAG=""
      if [ "${{inputs.verbose}}" = "true" ]; then
        VERBOSE_FLAG="--verbose"
      fi

      tw shell-deps check \
          --path="${{inputs.path}}" \
          --strict="${{inputs.strict}}" \
          $VERBOSE_FLAG \
          ${{inputs.files}}
