name: virtualpackage

# virtual packages should never be installed - instead one of the providing packages should be installed.
# This package test ensures this remains true and does not regress.
needs:
  packages:
    - apk-tools
    - gawk
    - busybox

pipeline:
  - name: virtual package check
    description: Check that the virtual package is not installed
    runs: |
      is_installed_version() {
        pkg="$1"
        expected_version="$2"  # Example: 8.6.0-r0

        installed_information=$(apk list installed "$pkg" 2>/dev/null)

        // split the output on the first space to get the installed version
        installed_version=$(echo "$installed_information" | awk '{print $1}')
        if [ "$installed_version" = "${pkg}-${expected_version}" ]; then
          return 0  # true: version matches
        else
          return 1  # false: not installed or version mismatch
        fi
      }
      # Get our virtual package name and version
      package_name_and_version="${{package.name}}-${{package.version}}-r${{package.epoch}}"
      echo "Checking that the virtual package [${package_name_and_version}] does not install itself"
      if is_installed_version "${{package.name}}" "${{package.version}}-r${{package.epoch}}"; then
        echo "$package_name_and_version is installed. This is not expected. ${{package.name}} is a virtual package."
        exit 1
      else
        echo "$package_name_and_version is not installed. This is expected."
        exit 0
      fi
