package:
  name: pixi
  version: "0.54.0"
  epoch: 1 # GHSA-xwfj-jgwm-7wp5
  description: "Package management made easy"
  dependencies:
    runtime:
      - bash # Requires bash at runtime when trying to run `pixi add`
  copyright:
    - license: BSD-3-Clause

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/prefix-dev/pixi
      expected-commit: 885a61c3dfcb5190d3fd399c1152bf1ff24c8ab8
      tag: v${{package.version}}

  - uses: rust/cargobump

  - uses: cargo/build
    with:
      modroot: .
      output: pixi

  - uses: strip

update:
  enabled: true
  github:
    identifier: prefix-dev/pixi
    strip-prefix: v

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility subpackage for Pixi upstream image
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/local/bin"
          ln -s ../../bin/pixi "${{targets.subpkgdir}}/usr/local/bin/pixi"
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - uses: test/tw/symlink-check

test:
  pipeline:
    - name: Smoke tests
      runs: |
        set -o pipefail
        pixi --help | grep -F -e "Developer Workflow and Environment Management"
        pixi --version | grep -F -e "${{package.version}}"
    - name: Ensure functionality works
      runs: |
        set -o pipefail
        # Force directory to /tmp because it is out of the way of PIXI_HOME
        cd /tmp

        pixi init

        pixi search numpy | grep -E -e "License.*BSD-3-Clause"

        # Force conda to use system GLIBC version so that we dont get issues with that
        SOVERSION=1
        if [ "$(arch)" == "x86_64" ] ; then
          SOVERSION=2
        fi

        export CONDA_OVERRIDE_GLIBC="$("/lib/ld-linux-$(arch | tr _ -).so.${SOVERSION}" --version | head -n 1 | sed "s/.*version //" | cut -d. -f1,2)"

        pixi add flask pytest

        pixi task add test 'pytest -s'
        { pixi run test || true ; } | grep -F -e "collected 0 items"
        pixi clean

        pixi config list 2>&1 | grep -F -e "Configuration not set"

        pixi list | grep -F -e "flask"
        pixi list | grep -F -e "pytest"

        pixi exec pyright --help | grep -F -e "Usage: pyright [options]"
