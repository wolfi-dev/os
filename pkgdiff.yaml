package:
  name: pkgdiff
  version: 1.8
  epoch: 0
  description: A tool for visualizing changes in Linux software packages
  copyright:
    - license: GPL-2.0
  dependencies:
    runtime:
      - libmagic
      - perl
      - wdiff

environment:
  contents:
    packages:
      - bash
      - binutils
      - build-base
      - busybox
      - file
      - libmagic-dev
      - perl-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/lvc/pkgdiff.git
      expected-commit: 56af1b018404f6efcf05063c1db5490e77bf6b00
      tag: ${{package.version}}

  - runs: |
      # create dir structure expected by make-install
      mkdir -p "${{targets.destdir}}"/usr/bin
      mkdir -p "${{targets.destdir}}"/usr/share

  - uses: autoconf/make-install
    with:
      opts: |
        PREFIX=${{targets.destdir}}/usr

  - runs: |
      PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'install File::LibMagic' # NOTE: running with 'notest' doesn't install the module correctly for some reason
      mkdir -p ${{targets.destdir}}/usr/local/lib
      cp -r /usr/local/lib/perl5 ${{targets.destdir}}/usr/local/lib

update:
  enabled: true
  github:
    identifier: lvc/pkgdiff
    use-tag: true

test:
  pipeline:
    - name: Test help commands
      runs: |-
        pkgdiff --help
    - name: Compare different tgz files
      runs: |
        echo "This is a test file" >file1.txt
        echo "This is a test file with changes" >file2.txt
        tar czf file1.tar.gz file1.txt
        tar czf file2.tar.gz file2.txt
        pkgdiff file1.tar.gz file2.tar.gz || true  # pkgdiff returns non-0 exit when differences are found
        grep "file: 1 to 2 changes report" pkgdiff_reports/file/1_to_2/changes_report.html || exit 1
        rm file1.txt file2.txt file1.tar.gz file2.tar.gz
        rm -rf pkgdiff_reports
    - name: Compare same tgz files
      runs: |
        echo "This is a test file" >file1.txt
        tar czf file1.tar.gz file1.txt
        pkgdiff file1.tar.gz file1.tar.gz || exit 1
        rm file1.txt file1.tar.gz
