package:
  name: plugin-barman-cloud
  version: "0.6.0"
  epoch: 1 # GHSA-2464-8j7c-4cjm
  description: CloudNativePG Barman Cloud Plugin is a kubernetes operator for cloud-native PostgreSQL backup capabilities
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/cloudnative-pg/plugin-barman-cloud
      tag: v${{package.version}}
      expected-commit: b556fea179ad8c3f62d93a17f41533e275e19c86

  - uses: go/bump
    with:
      deps: |-
        github.com/go-viper/mapstructure/v2@v2.4.0

  - uses: go/build
    with:
      packages: ./cmd/manager
      output: manager

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package for cnpg-plugin-barman-cloud - provides /manager symlink
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"
          ln -s /usr/bin/manager "${{targets.subpkgdir}}"/manager
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
      pipeline:
        - name: Verify the symlink was created
          runs: |
            test "$(readlink /manager)" = "/usr/bin/manager"

update:
  enabled: true
  github:
    identifier: cloudnative-pg/plugin-barman-cloud
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - git
    environment:
      SIDECAR_IMAGE: "ghcr.io/cloudnative-pg/plugin-barman-cloud-sidecar:test"
      NAMESPACE: "default"
      CLUSTER_NAME: "test-cluster"
      POD_NAME: "test-pod"
  pipeline:
    - name: Check manager binary and help output
      runs: |
        set -o pipefail
        manager --help 2>&1 | grep -F -e "Available Commands"
    - uses: test/kwok/cluster
    - name: Install CRDs
      runs: |
        set -o pipefail
        kubectl apply -f https://raw.githubusercontent.com/cloudnative-pg/plugin-barman-cloud/v${{package.version}}/config/crd/bases/barmancloud.cnpg.io_objectstores.yaml
        kubectl wait --for=condition=Established crd objectstores.barmancloud.cnpg.io --timeout=60s
    - name: Test operator daemon startup
      uses: test/daemon-check-output
      with:
        setup: |
          mkdir -p /tmp/plugins/barman-cloud.cloudnative-pg.io
        start: manager operator --plugin-path /tmp/plugins --metrics-bind-address :8080 --metrics-secure=false
        timeout: 30
        expected_output: |
          starting manager
          Starting EventSource
          Starting Controller
          Starting workers
        post: |
          set -o pipefail
          HEALTH_PORT=8081
          METRICS_PORT=8080

          wait-for-it "localhost:${HEALTH_PORT}" -t 30
          curl -fsSL "http://127.0.0.1:${HEALTH_PORT}/healthz" | grep -F -e "ok"

          wait-for-it "localhost:${METRICS_PORT}" -t 30
          curl -fsSL "http://127.0.0.1:${METRICS_PORT}/metrics" | grep -F -e "controller_runtime_reconcile_total"
          curl -fsSL "http://127.0.0.1:${METRICS_PORT}/metrics" | grep -F -e "go_gc_duration_seconds"
          curl -fsSL "http://127.0.0.1:${METRICS_PORT}/metrics" | grep -F -e "workqueue_retries_total"
