package:
  name: pocket-id
  version: "2.2.0"
  epoch: 0
  description: A simple and easy-to-use OIDC provider that allows users to authenticate with their passkeys to your services.
  copyright:
    - license: BSD-2-Clause
  dependencies:
    runtime:
      - ca-certificates-bundle

environment:
  environment:
    NPM_CONFIG_LOGLEVEL: "warn"
    CGO_ENABLED: "0"
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - go
      - node-gyp
      - nodejs
      - npm
      - pnpm

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/pocket-id/pocket-id
      tag: "v${{package.version}}"
      expected-commit: 2c64bebf6a6c88b618c6c3569e3b26c5fcaf2d8b

  - name: Build frontend
    runs: |
      set -eux

      pnpm --filter pocket-id-frontend install --frozen-lockfile
      BUILD_OUTPUT_PATH=dist pnpm --filter pocket-id-frontend run build

      mkdir -p backend/frontend
      rm -rf backend/frontend/dist || true
      cp -r frontend/dist backend/frontend/dist

  - uses: go/build
    with:
      modroot: backend
      packages: ./cmd
      ldflags: -X github.com/pocket-id/pocket-id/backend/internal/common.Version=${{package.version}} -buildid=${{package.version}}
      prefix: /
      install-dir: app
      output: pocket-id

  - uses: strip

test:
  pipeline:
    - name: Verify pocket-id and entrypoint
      runs: |
        set -eux

        # Binary present and runnable.
        stat /app/pocket-id
        /app/pocket-id --version || /app/pocket-id --help || true

subpackages:
  - name: ${{package.name}}-oci-entrypoint
    description: Entrypoint for ${{package.name}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/app/docker
          cp -p scripts/docker/entrypoint.sh ${{targets.contextdir}}/app/docker/entrypoint.sh
          chmod +x ${{targets.contextdir}}/app/docker/entrypoint.sh
    dependencies:
      runtime:
        - busybox
        - su-exec
    test:
      pipeline:
        - runs: |
            stat /app/docker/entrypoint.sh
            test -x /app/docker/entrypoint.sh

update:
  enabled: true
  github:
    identifier: pocket-id/pocket-id
    strip-prefix: v
