package:
  name: policy-controller
  version: "0.13.1"
  epoch: 4 # CVE-2025-61729
  description: The policy admission controller used to enforce policy on a cluster on verifiable supply-chain metadata from cosign.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates-bundle

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - go
      - make

pipeline:
  - uses: git-checkout
    with:
      expected-commit: ccbb37f3009753a72c7f6ee18002406b857b2204
      repository: https://github.com/sigstore/policy-controller
      tag: v${{package.version}}

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0

  - runs: |
      mkdir -p "${{targets.destdir}}/usr/bin"
      make policy-controller && mv policy-controller "${{targets.destdir}}/usr/bin/policy-controller"
      make policy-tester && mv policy-tester "${{targets.destdir}}/usr/bin/policy-tester"

  - uses: strip

subpackages:
  - name: policy-controller-tester
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/bin"
          mv "${{targets.destdir}}/usr/bin/policy-tester" "${{targets.subpkgdir}}/usr/bin/policy-tester"
    dependencies:
      runtime:
        - ca-certificates-bundle
    description: CLI for testing ClusterImagePolicy resources
    test:
      pipeline:
        - runs: |
            policy-tester --version
            policy-tester --help

update:
  enabled: true
  manual: false
  github:
    identifier: sigstore/policy-controller
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - curl
        - git
        - openssl
    environment:
      SYSTEM_NAMESPACE: default
  pipeline:
    - runs: |
        policy-controller --help
    - uses: test/kwok/cluster
      with:
        serviceaccount: true
    - name: Launch controller with kwok cluster
      uses: test/daemon-check-output
      with:
        setup: |
          kubectl create configmap config-image-policies \
            --namespace default \
            --from-literal=policies='{}' \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create configmap config-sigstore-keys \
            --namespace default \
            --from-literal=sigstoreKeys='{}' \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create configmap config-policy-controller \
            --namespace default \
            --from-literal=config='{}' \
            --dry-run=client -o yaml | kubectl apply -f -

          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout server.key \
            -out server.crt \
            -days 365 \
            -subj "/CN=policy-webhook.default.svc"
          cp server.crt ca-cert.pem
          kubectl create secret generic webhook-certs \
            -n default \
            --type=Opaque \
            --from-file=ca-cert.pem=ca-cert.pem \
            --from-file=server-key.pem=server.key \
            --from-file=server-cert.pem=server.crt \
            --from-file=tls.crt=server.crt \
            --from-file=tls.key=server.key

          git clone --branch v${{package.version}} --depth 1 https://github.com/sigstore/policy-controller
          kubectl apply -k policy-controller/config
          sleep 1
        start: policy-controller
        timeout: 30
        expected_output: |
          Initializing TUF root
          successfully acquired lease default/policy-controller.
          Reconcile succeeded
        post: |
          curl --silent --fail localhost:9090/metrics
