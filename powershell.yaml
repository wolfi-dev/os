package:
  name: powershell
  version: 7.4.1
  epoch: 2
  description: 'cross-platform automation and configuration tool/framework'
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - aspnet-8-runtime
      - dotnet-8-runtime
      - libpsl-native
      - ncurses-terminfo-base

environment:
  contents:
    packages:
      - aspnet-8-runtime
      - aspnet-8-targeting-pack
      - build-base
      - dotnet-8-sdk
      - icu-dev
      - krb5-dev
      - libpsl-native
      - lttng-ust-dev
      - openssl-dev
      - wolfi-base
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/powershell/powershell
      tag: v${{package.version}}
      expected-commit: 5668713d3c906d63cd68e37d415206a95ac061d0
      destination: powershell

  - working-directory: /home/build/powershell
    pipeline:
      - runs: |
          rm -f global.json
          rm -f nuget.config
      - runs: |
          dotnet restore src/powershell-unix -p:NuGetAudit=false
          dotnet restore src/ResGen
          dotnet restore src/TypeCatalogGen
      - runs: |
          cp /home/build/dependency-gatherer.targets "src/Microsoft.PowerShell.SDK/obj/Microsoft.PowerShell.SDK.csproj.TypeCatalog.targets"
          dotnet msbuild src/Microsoft.PowerShell.SDK/Microsoft.PowerShell.SDK.csproj \
                /t:_GetDependencies \
                "/property:DesignTimeBuild=true;_DependencyFile=$PWD/src/TypeCatalogGen/powershell.inc" \
                /nologo
          echo v${{package.version}} > powershell.version
      - working-directory: /home/build/powershell/src/ResGen
        runs: |
          dotnet run
      - working-directory: /home/build/powershell/src/TypeCatalogGen
        runs: |
          dotnet run ../System.Management.Automation/CoreCLR/CorePsTypeCatalog.cs powershell.inc
      - runs: |
          dotnet publish --configuration Linux "src/powershell-unix/" \
                --output bin \
                --no-self-contained \
                --runtime "$(dotnet --info | awk '$1=="RID:"{print $2}')" \
                -p:NuGetAudit=false \
                -p:PublishReadyToRun=true /v:n \
                /consoleLoggerParameters:ShowTimestamp
      - runs: |
          # directory creation
          install -dm 755 "${{targets.destdir}}"/usr/lib "${{targets.destdir}}"/usr/bin

          # library copy
          cp -ar /home/build/powershell/src/powershell-unix/bin/Linux/*/wolfi* "${{targets.destdir}}"/usr/lib/${{package.name}}

          # already provided by 'libpsl-native' aport
          rm -f "${{targets.destdir}}"/usr/lib/$pkgname/libpsl-native.so
          rm -f "${{targets.destdir}}"/usr/lib/$pkgname/libSystem.IO.Ports.Native.so

          # binary link
          ln -s "/usr/lib/${{package.name}}/pwsh" "${{targets.destdir}}"/usr/bin/pwsh

update:
  enabled: true
  github:
    identifier: powershell/powershell
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        pwsh --version
        pwsh --help
