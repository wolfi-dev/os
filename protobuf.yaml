package:
  name: protobuf
  version: "3.29.4" # On update, please check if -fdelete-null-pointer-checks is still required
  epoch: 0
  description: Library for extensible, efficient structure packing
  copyright:
    - license: BSD-3-Clause

var-transforms:
  # 3.26.1 -> 26.1
  # TODO: Figure out how to make this 26.1.0
  - from: ${{package.version}}
    match: \d+\.(\d+\.\d+)
    replace: $1
    to: mangled-package-version

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - git
      - libtool
      - samurai
      - zlib-dev
  environment:
    # https://github.com/wolfi-dev/os/issues/34075
    CMAKE_CXX_FLAGS: -fdelete-null-pointer-checks

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/protocolbuffers/protobuf
      tag: v${{package.version}}
      expected-commit: 1be1c9d0ea6efa2a25bd7b76186844d1669be78a
      cherry-picks: |
        main/ced605d0e6a7ad20985375b596b2ca6720e07737: utf8_range: add version marker to library

  - runs: |
      cd third_party
      git submodule update --init --recursive

  - runs: |
      cmake -B build -G Ninja \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" \
        -DBUILD_SHARED_LIBS=True \
        -DCMAKE_BUILD_TYPE=Release \
        -Dprotobuf_ABSL_PROVIDER=package \
        -Dprotobuf_BUILD_TESTS=OFF \
        -Dprotobuf_BUILD_LIBUPB=OFF
      ninja -C build
      DESTDIR=${{targets.destdir}} ninja -C build install

  - uses: strip

subpackages:
  - name: protobuf-dev
    description: protobuf dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - abseil-cpp-dev
        - libprotoc
        - libprotobuf
        - libprotobuf-lite
        - protobuf
        - protoc
        - zlib-dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: protoc
    description: Protocol buffer compiler binary and library
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv ${{targets.destdir}}/usr/bin/protoc-${{vars.mangled-package-version}}.0 ${{targets.subpkgdir}}/usr/bin/
          mv ${{targets.destdir}}/usr/bin/protoc ${{targets.subpkgdir}}/usr/bin/protoc
    test:
      pipeline:
        - name: Verify protoc installation
          runs: |
            protoc --version || exit 1
            protoc-${{vars.mangled-package-version}}.0 --version
            protoc-${{vars.mangled-package-version}}.0 --help
        - name: Compile sample proto file
          runs: |
            echo 'syntax = "proto3"; message Test { string name = 1; }' > test.proto
            protoc --proto_path=. --python_out=. test.proto || exit 1

  - name: libprotoc
    description: Runtime library for Protocol Buffer compiler
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/libprotoc*.so.* ${{targets.subpkgdir}}/usr/lib/
          mv ${{targets.destdir}}/usr/lib/libutf8_validity*.so.* ${{targets.subpkgdir}}/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: libprotobuf
    description: Runtime library for C++ users of protocol buffers
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/libprotobuf.so.* ${{targets.subpkgdir}}/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: libprotobuf-lite
    description: Runtime library for C++ users with 'lite runtime' setting of protocol buffers
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/libprotobuf-lite.so.* ${{targets.subpkgdir}}/usr/lib/
    test:
      pipeline:
        - uses: test/tw/ldd-check

update:
  enabled: true
  github:
    identifier: protocolbuffers/protobuf
    strip-prefix: v
    use-tag: true
    tag-filter: "v3."

test:
  environment:
    contents:
      packages:
        - build-base
        - protobuf-dev
        - libprotoc
        - libprotobuf
        - libprotobuf-lite
        - python3
        - gcc
        - abseil-cpp-dev # Added this dependency
  pipeline:
    - name: "Verify protoc version and basic functionality"
      runs: |
        protoc --version
        protoc --help
    - name: "Test basic message compilation"
      runs: |
        cat > simple.proto << EOF
        syntax = "proto3";
        package test;
        message Simple {
          string data = 1;
        }
        EOF
        protoc --cpp_out=. simple.proto
    - name: "Test protocol buffer descriptor functionality"
      runs: |
        cat > test_desc.proto << EOF
        syntax = "proto3";
        package test;
        message TestMessage {
          string field1 = 1;
          int32 field2 = 2;
        }
        EOF
        protoc --descriptor_set_out=test.desc test_desc.proto
        test -f test.desc
    - name: "Verify protoc binary compatibility"
      runs: |
        protoc --version
        protoc-27.4.0 --version
    - name: "Test multiple file imports"
      runs: |
        mkdir -p protos
        cat > protos/common.proto << EOF
        syntax = "proto3";
        package test;
        message Common {
          string id = 1;
        }
        EOF

        cat > protos/main.proto << EOF
        syntax = "proto3";
        package test;
        import "common.proto";
        message Main {
          Common common = 1;
          string name = 2;
        }
        EOF

        protoc --proto_path=protos --cpp_out=. protos/*.proto
    - name: "Test protobuf-lite compilation"
      runs: |
        cat > lite.proto << EOF
        syntax = "proto3";
        option optimize_for = LITE_RUNTIME;
        package test;
        message LiteMessage {
          string data = 1;
        }
        EOF
        protoc --cpp_out=. lite.proto
    - name: "Python protobuf compilation test"
      runs: |
        cat > message.proto << EOF
        syntax = "proto3";
        package test;
        message PythonTest {
          string data = 1;
          repeated int32 numbers = 2;
        }
        EOF
        protoc --python_out=. message.proto
        test -f message_pb2.py
