package:
  name: pulumi
  version: "3.207.0"
  epoch: 1 # GHSA-j5w8-q4qc-rx2x
  description: Infrastructure as Code in any programming language
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - coreutils
      - go
      - nodejs
      - patch
      - python-3.11
      - python-3.11-dev
      - uv
      - yarn
  environment:
    CGO_ENABLED: "0"
    GO111MODULE: "on"

pipeline:
  - uses: git-checkout
    with:
      destination: ${{package.name}}
      expected-commit: 5e3a50056a84e3c5202b0bd77dce8cd5e70d7e93
      repository: https://github.com/pulumi/pulumi.git
      tag: v${{package.version}}

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/transforms/go/simple

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/transformations/go/simple

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/state_rename_parent

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/stack_outputs_resource_error/go/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/stack_outputs_program_error/go/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/run_plugin/provider-go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/run_plugin/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/rotate_passphrase

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/resource_refs_get_resource/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/resource_hooks/go_transform

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/resource_hooks/go_secret

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/resource_hooks/go/step-1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/refresh/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/project_main/go/a/path/to/main

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/program_error/go/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/printf/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/package-add/namespace/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/log_debug/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/large_resource/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/program-panic

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/parameterized

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/packageadd

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/go-no-main-package

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/go-exit-error

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/go-exit-5

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/go-build-target

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/go/component-configure-panic/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/get_resource/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/gather_plugin/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/empty/gorun_main/gorun_main_src

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/empty/gorun

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/empty/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/deleted_with/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_nested_component/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_unknown/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_resource_options/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_provider_propagation/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_provider_explicit/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_provider/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_plain/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_output_values/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_methods_unknown/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_methods_resources/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_methods_provider/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_methods_errors/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_methods/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_failures/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_configure_provider/testcomponent-go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component_configure_provider/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/construct_component/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/config_secrets_warn/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/config_missing/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/config_basic/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/call_component_failures/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/backend/diy/project

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/retype_remote_component_and_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/retype_parents/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/retype_component_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/retype_component/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/rename_component_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/rename_component_and_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/rename_component/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/rename/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/extract_component_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/adopt_into_component/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/aliases/go/adopt_component_child/step1

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/integration/about/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/tests/benchmarks/go-alias-norm

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/python/lib/test/automation/errors/runtime_error/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/python/lib/test/automation/errors/conflict_error

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/python/lib/test/automation/errors/compilation_error/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/python/lib/test/automation/data/testproj

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/python/cmd/pulumi-language-python

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/nodejs/tests/automation/data/testproj

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/nodejs/cmd/pulumi-language-nodejs

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/pulumi-language-go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/auto/testdata/slow

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/auto/test/testproj

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/auto/test/errors/runtime_error/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/auto/test/errors/conflict_error

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk/go/auto/test/errors/compilation_error/go

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/sdk

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/pkg

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: pulumi/cmd/pulumi-test-language

  - pipeline:
      - runs: |
          set -x

          export PULUMI_VERSION="v${{package.version}}"
          export PULUMI_ROOT="$(mktemp -d)"
          export GOBIN="${PULUMI_ROOT}/bin"
          mkdir -p "${{targets.contextdir}}/usr/bin" "${{targets.contextdir}}/usr/lib"

          # Build the Pulumi CLI itself
          SDKS= make install
          mv -v "${PULUMI_ROOT}"/bin/pulumi* "${{targets.contextdir}}/usr/bin"

          # Build the Pulumi Language SDKs (Go, Node.js, Python)
          for lang in go nodejs python; do
            cd "sdk/${lang}"

            # Update some more dependencies
            # go mod tidy is needed because of some go generate stuff that mutates the go.mod
            if [[ "${lang}" == "go" ]]; then
              # Remediate GHSA-m425-mq94-257g
              cd pulumi-language-${lang} && \
                go get golang.org/x/crypto@v0.37.0 && \
                go mod edit -replace=golang.org/x/net=golang.org/x/net@v0.38.0 && \
                go get github.com/Azure/azure-sdk-for-go/sdk/azidentity@v1.6.0 && \
                go get github.com/hashicorp/go-retryablehttp@v0.7.7 && \
                go get github.com/pulumi/pulumi/pkg/v3 && \
                go get github.com/pulumi/pulumi/sdk/v3 && \
                go mod tidy && \
                cd ..

            # Python and Node have a cmd folder, Go does not
            elif [[ "${lang}" == "nodejs" || "${lang}" == "python" ]]; then
              # Remediate GHSA-m425-mq94-257g
              cd cmd/pulumi-language-${lang} && \
                go get golang.org/x/crypto@v0.37.0 && \
                go mod edit -replace=golang.org/x/net=golang.org/x/net@v0.38.0 && \
                go get github.com/Azure/azure-sdk-for-go/sdk/azidentity@v1.6.0 && \
                go get github.com/hashicorp/go-retryablehttp@v0.7.7 && \
                go get github.com/pulumi/pulumi/pkg/v3 && \
                go get github.com/pulumi/pulumi/sdk/v3 && \
                go mod tidy

                if  [[ "${lang}" == "nodejs" ]]
                then
                    # Remediate GHSA-v6h2-p8h4-qcjw
                    yarn upgrade brace-expansion@^2.0.1 --latest
                    # Fix tmp CVE GHSA-52f5-9888-hmc6
                    yarn upgrade tmp@^0.2.4
                fi

                cd ../..
            fi

            make build
            make install

            # Copy the npm modules so that `require.resolve()` will work later at runtime:
            if [[ "${lang}" == "nodejs" ]]; then
              cp -R "${PULUMI_ROOT}/node_modules" "${{targets.contextdir}}/usr/lib/node_modules"
            fi

            # Remove .cmd files only used on Windows
            rm -f "${PULUMI_ROOT}"/bin/*.cmd
            ls -la "${PULUMI_ROOT}/bin"
            mv -v "${PULUMI_ROOT}"/bin/pulumi* "${{targets.contextdir}}/usr/bin"
            cd ../..
          done
      - uses: strip
    working-directory: ${{package.name}}

subpackages:
  - name: "pulumi-language-go"
    description: "Pulumi Language SDK for Go"
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/bin"
          mv -v "${{targets.destdir}}"/usr/bin/pulumi-*go* "${{targets.contextdir}}/usr/bin"
    test:
      pipeline:
        - runs: |
            pulumi-language-go --help

  - name: "pulumi-language-nodejs"
    description: "Pulumi Language SDK for Node.js"
    dependencies:
      runtime:
        - nodejs
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/bin" "${{targets.contextdir}}/usr/lib"
          mv -v "${{targets.destdir}}"/usr/bin/pulumi-*nodejs* "${{targets.contextdir}}/usr/bin"
          # pulumi-analyzer-policy is built by the nodejs sdk even though it doesnt contain the string "nodejs"
          mv -v "${{targets.destdir}}"/usr/bin/pulumi-analyzer-policy "${{targets.contextdir}}/usr/bin"

          # Move node modules from main package to this subpackage so the tools can find and use them
          mv "${{targets.destdir}}/usr/lib/node_modules" "${{targets.contextdir}}/usr/lib/node_modules"

          # Remove any powershell junk
          find "${{targets.contextdir}}/usr/lib/node_modules/" -type f -name "*.ps1" -exec rm -f {} \;

          # Fix up the wrapper scripts to be able to locate the necessary node modules
          sed -i 's|PULUMI_RUN_SCRIPT_PATH=.*|PULUMI_RUN_SCRIPT_PATH="/usr/lib/node_modules/@pulumi/pulumi/cmd/run-policy-pack/index.js"|' "${{targets.contextdir}}/usr/bin/pulumi-analyzer-policy"
          sed -i 's|PULUMI_DYNAMIC_PROVIDER_SCRIPT_PATH=.*|PULUMI_DYNAMIC_PROVIDER_SCRIPT_PATH="/usr/lib/node_modules/@pulumi/pulumi/cmd/dynamic-provider/index.js"|' "${{targets.contextdir}}/usr/bin/pulumi-resource-pulumi-nodejs"
    test:
      pipeline:
        - runs: |
            pulumi-analyzer-policy 2>&1 | grep "usage:"
            pulumi-language-nodejs --help
            pulumi-resource-pulumi-nodejs 2>&1 | grep "fatal: Missing <engine> address"

  - name: "pulumi-language-python"
    description: "Pulumi Language SDK for Python"
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/usr/bin"
          mv -v "${{targets.destdir}}"/usr/bin/pulumi-*python* "${{targets.contextdir}}/usr/bin"
    test:
      pipeline:
        - runs: |
            pulumi-language-python --help

test:
  pipeline:
    - name: Verify Pulumi installation
      runs: |
        pulumi version | grep ${{package.version}}
        pulumi --help

update:
  enabled: true
  github:
    identifier: pulumi/pulumi
    strip-prefix: v
