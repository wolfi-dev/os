package:
  name: pvc-autoresizer
  version: "0.19.0"
  epoch: 0 # go/wolfi-rsc/pvc-autoresizer
  description: Auto-resize PersistentVolumeClaim objects based on Prometheus metrics
  copyright:
    - license: Apache-2.0
  resources:
    cpu: "1"
    memory: 2Gi

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 8d5263aa7dbd53069a401434ce444e7ba700d053
      repository: https://github.com/topolvm/pvc-autoresizer
      tag: v${{package.version}}

  - uses: go/build
    with:
      packages: ./cmd
      output: pvc-autoresizer

subpackages:
  - name: ${{package.name}}-compat
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}
          ln -sf /usr/bin/pvc-autoresizer ${{targets.subpkgdir}}/pvc-autoresizer
    test:
      pipeline:
        - name: Check symlink
          runs: |
            stat /pvc-autoresizer

test:
  pipeline:
    - name: Help tests for pvc-autoresizer
      runs: |
        pvc-autoresizer --help
    - runs: |
        # We expect the below command to fail.
        set -e
        pvc-autoresizer --prometheus-url=http://invalid-prometheus-server/api/v1/query --namespaces=default 2>&1 | grep -i "unable to load in-cluster config"

update:
  enabled: true
  github:
    identifier: topolvm/pvc-autoresizer
    strip-prefix: v
    tag-filter: v
