# Generated from https://pypi.org/project/cassandra-medusa/
package:
  name: py3-cassandra-medusa
  version: 0.22.3
  epoch: 2
  description: Apache Cassandra backup and restore tool
  copyright:
    - license: Apache-2.0
  options:
    no-provides: true
    no-depends: true
  dependencies:
    runtime:
      - py${{vars.py-version}}-aiohttp
      - py${{vars.py-version}}-azure-identity
      - py${{vars.py-version}}-azure-storage-blob
      - py${{vars.py-version}}-boto3
      - py${{vars.py-version}}-cassandra-driver
      - py${{vars.py-version}}-click
      - py${{vars.py-version}}-click-aliases
      - py${{vars.py-version}}-certifi
      - py${{vars.py-version}}-cryptography
      - py${{vars.py-version}}-datadog
      - py${{vars.py-version}}-dnspython
      - py${{vars.py-version}}-ffwd
      - py${{vars.py-version}}-gcloud-aio-storage
      - py${{vars.py-version}}-gevent
      - py${{vars.py-version}}-grpcio
      - py${{vars.py-version}}-grpcio-health-checking
      - py${{vars.py-version}}-idna
      - py${{vars.py-version}}-parallel-ssh
      - py${{vars.py-version}}-psutil
      - py${{vars.py-version}}-pyopenssl
      - py${{vars.py-version}}-requests
      - py${{vars.py-version}}-retrying
      - py${{vars.py-version}}-urllib3
      - py${{vars.py-version}}-pyyaml

vars:
  py-version: 3.11

environment:
  contents:
    packages:
      - build-base
      - ca-certificates-bundle
      - py${{vars.py-version}}-build-base-dev
      - py${{vars.py-version}}-poetry
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/thelastpickle/cassandra-medusa
      tag: v${{package.version}}
      expected-commit: 6202aca6e4c2859d2ad601571571a774df7bebc8

  - runs: |
      # Setup the virtualenv
      python${{vars.py-version}} -m venv .venv --system-site-packages

  - name: Python Build
    uses: py/pip-build-install
    with:
      python: .venv/bin/python${{vars.py-version}}

  - name: Install deps from PyPI that aren't currently packaged in wolfi
    runs: |
      # python-snappy is required to run medusa using $MEDUSA_MODE=GRPC.
      .venv/bin/pip${{vars.py-version}} install -I python-snappy --no-compile --no-deps

  - runs: |
      mkdir -p ${{targets.destdir}}/home/cassandra
      mv .venv ${{targets.destdir}}/home/cassandra/

      # edit the venv paths
      find '${{targets.destdir}}/home/cassandra/.venv/bin/' -type f | \
        xargs sed -i "s|/home/build|${{targets.destdir}}/home/cassandra|g"

      # allow site-packages
      sed -i "s|include-system-site-packages = false|include-system-site-packages = true|g" ${{targets.destdir}}/home/cassandra/.venv/pyvenv.cfg

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      cp k8s/medusa.sh ${{targets.destdir}}/usr/bin/medusa
      chmod +x ${{targets.destdir}}/usr/bin/medusa

  - runs: |
      cp pyproject.toml ${{targets.destdir}}/home/cassandra
      cp k8s/docker-entrypoint.sh ${{targets.destdir}}/home/cassandra
      chmod +x ${{targets.destdir}}/home/cassandra/docker-entrypoint.sh

subpackages:
  - name: "${{package.name}}-compat"
    description: "Compatibility package to place binaries and docker entrypoints in the location expected by upstream helm charts"
    dependencies:
      runtime:
        # The entrypoint script fails to start without bash and sleep (which comes from busybox)
        - bash
        - busybox
        - grpc-health-probe
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/home/cassandra/"
          ln -sf /usr/bin/medusa ${{targets.subpkgdir}}/home/cassandra/medusa
          # Symlink the binary from usr/bin to /bin
          mkdir -p "${{targets.subpkgdir}}"/bin
          ln -sf /usr/bin/grpc-health-probe ${{targets.subpkgdir}}/bin/grpc_health_probe

update:
  enabled: true
  github:
    identifier: thelastpickle/cassandra-medusa
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - grpc-health-probe
  pipeline:
    - runs: medusa --version
    - runs: |
        set +e
        fail() { echo "$@" 1>&2; exit 1; }
        out=$(/home/cassandra/.venv/bin/python${{vars.py-version}} -m medusa.service.grpc.server 2>&1)
        status=$?
        echo "$out" | grep -q '/etc/medusa/medusa.ini' || fail "medusa.service.grpc.server output did not contain expected 'medusa.ini' message. Exit status $status: $out"
        echo "medusa.service.grpc.server exited with expected error message"
