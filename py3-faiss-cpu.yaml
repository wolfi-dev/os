package:
  name: py3-faiss-cpu
  version: "1.13.1"
  epoch: 0
  description: Community-maintained faiss wheel builder
  annotations:
    cgr.dev/ecosystem: python
  copyright:
    - license: MIT
  dependencies:
    provider-priority: 0

vars:
  import: faiss
  pypi-package: faiss-cpu

data:
  - name: py-versions
    items:
      3.10: '310'
      3.11: '311'
      3.12: '312'
      3.13: '313'

environment:
  contents:
    packages:
      - build-base
      - cmake
      - coreutils
      - faiss-cpu
      - gfortran
      - openblas-dev
      - py3-supported-build-base-dev
      - py3-supported-numpy-2.2
      - py3-supported-scikit-build-core
      - swig

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 54f5aeb4afa2c08c6d719f200930f5d98cb496d1
      recurse-submodules: true
      repository: https://github.com/faiss-wheels/faiss-wheels
      tag: v${{package.version}}

  - uses: patch
    with:
      patches: dont-build-with-stable-abi.patch

subpackages:
  - range: py-versions
    name: py${{range.key}}-${{vars.pypi-package}}
    description: python${{range.key}} version of ${{vars.pypi-package}}
    dependencies:
      runtime:
        - faiss-cpu
        - py${{range.key}}-numpy-2.2
        - py${{range.key}}-packaging
        - py${{range.key}}-setuptools
    pipeline:
      - uses: py/pip-build-install
        with:
          python: python${{range.key}}
      - uses: strip
    test:
      environment:
        contents:
          packages:
            - py${{range.key}}-numpy-2.2
      pipeline:
        - uses: python/import
          with:
            python: python${{range.key}}
            import: ${{vars.import}}
        - runs: mkdir -p sift1M
        - name: Fetch demo dataset
          uses: fetch
          with:
            directory: sift1M
            expected-sha256: 92f1270c5e3a0cb46b89983e72b0511e4df065c31a9fa0276d8c9b1fca5bc81a
            uri: ftp://ftp.irisa.fr/local/texmex/corpus/sift.tar.gz
        - name: Test loading data for index server
          runs: |
            for stage in 0 4
            do
              python${{range.key}} demo_client_server_ivf.py $stage
            done

  - name: py3-supported-${{vars.pypi-package}}
    description: meta package providing ${{vars.pypi-package}} for supported python versions.
    dependencies:
      runtime:
        - py3.10-${{vars.pypi-package}}
        - py3.11-${{vars.pypi-package}}
        - py3.12-${{vars.pypi-package}}
        - py3.13-${{vars.pypi-package}}
    test:
      pipeline:
        - uses: test/metapackage

update:
  enabled: true
  ignore-regex-patterns:
    - \.post[0-9]+$
  github:
    identifier: faiss-wheels/faiss-wheels
    strip-prefix: v
    tag-filter: v

# Based on package contents inspection, it was found that this origin package is empty apart from its own SBOM and this test was added to confirm it is empty and will fail if the package is no longer empty (contains more than an SBOM)
test:
  pipeline:
    - uses: test/emptypackage
