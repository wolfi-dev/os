From 04721272ce0d5041580d0a38a0efcbd31ffa7155 Mon Sep 17 00:00:00 2001
From: dann frazier <dann.frazier@chainguard.dev>
Date: Thu, 14 Aug 2025 11:54:53 -0600
Subject: [PATCH] Add a dist-packages scheme to sysconfig

Based on Debian's sysconfig-debian-shemes.diff

Signed-off-by: dann frazier <dann.frazier@chainguard.dev>
---
 Lib/sysconfig/__init__.py  | 29 ++++++++++++++++++++++++++---
 Lib/test/test_sysconfig.py |  2 +-
 2 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/Lib/sysconfig/__init__.py b/Lib/sysconfig/__init__.py
index c583b74ce54..b5d9edc7f9e 100644
--- a/Lib/sysconfig/__init__.py
+++ b/Lib/sysconfig/__init__.py
@@ -38,6 +38,18 @@
         'scripts': '{base}/bin',
         'data': '{base}',
         },
+    'chainguard_system': {
+        'stdlib': '{installed_base}/lib/python{py_version_short}',
+        'platstdlib': '{platbase}/lib/python{py_version_short}',
+        'purelib': '{base}/lib/python{py_version_short}/dist-packages',
+        'platlib': '{platbase}/lib/python{py_version_short}/dist-packages',
+        'include':
+            '{installed_base}/include/python{py_version_short}{abiflags}',
+        'platinclude':
+            '{installed_platbase}/include/python{py_version_short}{abiflags}',
+        'scripts': '{base}/bin',
+        'data': '{base}',
+        },
     'posix_home': {
         'stdlib': '{installed_base}/lib/{implementation_lower}',
         'platstdlib': '{base}/lib/{implementation_lower}',
@@ -228,7 +240,7 @@ def is_python_build():
 _PYTHON_BUILD = is_python_build()
 
 if _PYTHON_BUILD:
-    for scheme in ('posix_prefix', 'posix_home'):
+    for scheme in ('posix_prefix', 'posix_home', 'chainguard_system'):
         # On POSIX-y platforms, Python will:
         # - Build from .h files in 'headers' (which is only added to the
         #   scheme when building CPython)
@@ -289,8 +301,19 @@ def _get_preferred_schemes():
             'user': 'osx_framework_user',
         }
 
+    if sys.base_prefix != sys.prefix or hasattr(sys, "real_prefix"):
+        # virtual environments
+        prefix_scheme = 'posix_prefix'
+    else:
+        # default to /usr for package builds, /usr/local otherwise
+        deb_build = os.environ.get('CHAINGUARD_PYTHON_INSTALL_LAYOUT', 'posix_prefix')
+        if deb_build in ('chainguard', 'chainguard_system'):
+            prefix_scheme = 'chainguard_system'
+        else:
+            prefix_scheme = 'posix_prefix'
+
     return {
-        'prefix': 'posix_prefix',
+        'prefix': prefix_scheme,
         'home': 'posix_home',
         'user': 'posix_user',
     }
@@ -467,7 +490,7 @@ def get_config_h_filename():
         else:
             inc_dir = _PROJECT_BASE
     else:
-        inc_dir = get_path('platinclude')
+        inc_dir = get_path('platinclude', 'posix_prefix')
     return os.path.join(inc_dir, 'pyconfig.h')
 
 
diff --git a/Lib/test/test_sysconfig.py b/Lib/test/test_sysconfig.py
index 4aaef5b1429..b29faffde34 100644
--- a/Lib/test/test_sysconfig.py
+++ b/Lib/test/test_sysconfig.py
@@ -387,7 +387,7 @@ def test_get_config_h_filename(self):
         self.assertTrue(os.path.isfile(config_h), config_h)
 
     def test_get_scheme_names(self):
-        wanted = ['nt', 'posix_home', 'posix_prefix', 'posix_venv', 'nt_venv', 'venv']
+        wanted = ['chainguard_system', 'posix_local', 'nt', 'posix_home', 'posix_prefix', 'posix_venv', 'nt_venv', 'venv']
         if HAS_USER_BASE:
             wanted.extend(['nt_user', 'osx_framework_user', 'posix_user'])
         self.assertEqual(get_scheme_names(), tuple(sorted(wanted)))
-- 
2.48.1

