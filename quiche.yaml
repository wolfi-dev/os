package:
  name: quiche
  version: 0.24.4
  epoch: 0
  description: An implementation of the QUIC transport protocol and HTTP/2 as specified by the IETF
  copyright:
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - clang
      - cmake
      - rustup
  environment:
    RUSTUP_TOOLCHAIN: stable
    CARGO_TARGET_DIR: target

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/cloudflare/quiche
      tag: ${{package.version}}
      expected-commit: 70d6d3e233568e906e66179a56c93cf9b0616899

  - name: Prepare
    runs: |
      cargo update
      cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"

  - uses: cargo/build
    with:
      output: quiche-server
      rustflags: "-C link-args=-Wl,-z,shstk"
      opts: |
        --release \
        --frozen \
        --no-default-features \
        --features ffi,pkg-config-meta,qlog,boringssl-boring-crate

  - name: Install files
    runs: |
      mkdir -p ${{targets.destdir}}/usr/lib
      mkdir -p ${{targets.destdir}}/usr/lib/pkgconfig
      mkdir -p ${{targets.destdir}}/usr/share/licenses/${{package.name}}
      install -Dm755 ./target/release/quiche-client ${{targets.destdir}}/usr/bin/quiche-client
      install -Dm755 ./target/release/libquiche.so ${{targets.destdir}}/usr/lib
      install -Dm755 ./target/release/quiche.pc ${{targets.destdir}}/usr/lib/pkgconfig/quiche.pc
      install -Dm644 quiche/include/quiche.h ${{targets.destdir}}/usr/include
      install -Dm644 COPYING ${{targets.destdir}}/usr/share/licenses/${{package.name}}/COPYING

  - uses: strip

update:
  enabled: true
  github:
    identifier: cloudflare/quiche
    use-tag: true

test:
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        quiche-client --help
        quiche-server --help
