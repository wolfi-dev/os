package:
  name: rabbitmq-cluster-operator
  version: "2.12.1"
  epoch: 5
  description: Open source RabbitMQ cluster operator. Kubernetes operator to deploy and manage RabbitMQ clusters.
  copyright:
    - license: MPL-2.0

# Create a new major-version variable that contains only the major version
# to use in the bitnami/compat pipeline to find out the correct folder for the image.
# e.g. 2.12.1 will create a new var major-version=2
var-transforms:
  - from: ${{package.version}}
    match: ^(\d+).*
    replace: $1
    to: major-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rabbitmq/cluster-operator
      tag: v${{package.version}}
      expected-commit: 0cb65ca2be61b38d79800b1e5805c887c076736b

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/oauth2@v0.27.0
        golang.org/x/net@v0.36.0

  - uses: go/build
    with:
      packages: .
      output: manager
      tags: timetzdata

subpackages:
  - name: ${{package.name}}-compat
    pipeline:
      - runs: |
          # link /usr/bin/manager to /manager due to hardcoded command
          # See https://github.com/rabbitmq/cluster-operator/blob/main/config/manager/manager.yaml#L34-L35
          mkdir -p ${{targets.subpkgdir}}/
          ln -sf /usr/bin/manager ${{targets.subpkgdir}}/manager

  # Note, we don't need to fetch any upstream files, as there aren't any custom
  # entrypoints or scripts required for compatibility with the rabbitmq-cluster-operator
  # Bitnami helm chart.
  - name: ${{package.name}}-bitnami-compat
    description: Compat package with bitnami/rabbitmq-cluster-operator image
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/opt/bitnami/rabbitmq-cluster-operator/bin
          ln -sf /usr/bin/manager ${{targets.contextdir}}/opt/bitnami/rabbitmq-cluster-operator/bin/manager
          ln -sf /opt/bitnami/rabbitmq-cluster-operator/bin/manager ${{targets.contextdir}}/manager
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
        environment:
          PATH: "/opt/bitnami/rabbitmq-cluster-operator/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          BITNAMI_APP_NAME: "rabbitmq-cluster-operator"
        accounts:
          groups:
            - groupname: rabbitmq-cluster-operator
              gid: 1001
          users:
            - username: rabbitmq-cluster-operator
              gid: 1001
              uid: 1001
          run-as: 1001
      pipeline:
        - working-directory: /tmp # Workaround for "can't cd to /home/build: Permission denied" error
          pipeline:
            # We don't need to have `test/daemon-check-output` pipeline here as upstream entrypoint doesn't
            # wrap with the `entrypoint.sh`, so we're covered by in the main pipeline test.
            - name: Verify the symlinks were created
              runs: |
                test "$(readlink /manager)" = "/opt/bitnami/rabbitmq-cluster-operator/bin/manager"
                test "$(readlink /opt/bitnami/rabbitmq-cluster-operator/bin/manager)" = "/usr/bin/manager"
            - runs: /manager --help

update:
  enabled: true
  github:
    identifier: rabbitmq/cluster-operator
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        manager --help
