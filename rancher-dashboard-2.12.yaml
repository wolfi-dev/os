package:
  name: rancher-dashboard-2.12
  version: "2.12.4"
  epoch: 0
  description: Rancher UI Dashboard
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - rancher-dashboard=${{package.full-version}}

vars:
  nodejs-version: '22'
  ui-dir: '/usr/share/rancher/ui-dashboard'

environment:
  contents:
    packages:
      - bash
      - busybox
      - curl
      - nodejs-${{vars.nodejs-version}}
      - yarn
      - yq

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rancher/dashboard
      tag: v${{package.version}}
      expected-commit: cdb04d1a409124c3c175de8a5d4507e7eb915b65
      recurse-submodules: true

  - runs: |
      # Parse URL to embedded Harvester extension
      EMBED_PKG=$(yq '.jobs."build-and-upload-embedded".steps[] | select(.id=="build-embedded").env.EMBED_PKG' .github/workflows/build-and-upload.yaml)
      if [ "${EMBED_PKG//harvester}" = "$EMBED_PKG" ]; then
        echo "Unable to parse URL to Harvester extension!"
        echo "Please reference EMBED_PKG at:"
        echo "- https://github.com/rancher/dashboard/blob/v${{package.version}}/.github/workflows/build-and-upload.yaml"
        exit 1
      fi

      # Build dashboard and embed Harvester extension
      ./scripts/build-embedded

      # Extract and install dashboard
      mkdir -p ${{targets.destdir}}/${{vars.ui-dir}}/dashboard
      tar xvf dist/v${{package.version}}.tar.gz \
        -C ${{targets.contextdir}}/${{vars.ui-dir}}/dashboard \
        --strip-components=2
      ln -s dashboard/index.html ${{targets.contextdir}}/${{vars.ui-dir}}/

  - uses: strip

update:
  enabled: true
  github:
    identifier: rancher/dashboard
    strip-prefix: v
    tag-filter: v2.12.
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - nodejs-${{vars.nodejs-version}}
        - npm
        - wait-for-it
  pipeline:
    - name: "Test UI"
      uses: test/daemon-check-output
      with:
        start: "npx http-server ${{vars.ui-dir}}/dashboard -p 8080"
        timeout: 60
        expected_output: |
          serving
          Available on
        post: |
          wait-for-it -t 10 --strict localhost:8080 -- echo "Server is up"
          curl http://localhost:8080/index.html | grep -i "Rancher"
