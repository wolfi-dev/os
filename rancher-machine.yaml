#nolint:valid-pipeline-git-checkout-tag
package:
  name: rancher-machine
  # Upstream doesn't follow proper symantic versioning, even though there are newer 0.16.x
  # tags, they are not newer releases than 0.15.0-rancherN. This is a forked version of
  # docker/machine and upstream also archieved and deprecated. So it's OK to use the
  # master branch here.
  version: "0.15.0.126_git20250331"
  epoch: 0
  description: Machine management for a container-centric world
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rancher/machine
      expected-commit: 99d2c8daa21d3e81eebb3cfcda46459473628126
      branch: master

  - uses: go/bump
    with:
      deps: |-
        github.com/golang-jwt/jwt/v4@v4.5.2
        golang.org/x/crypto@v0.35.0
        golang.org/x/net@v0.36.0
        golang.org/x/oauth2@v0.27.0

  - uses: go/build
    with:
      modroot: .
      packages: ./cmd/rancher-machine
      output: rancher-machine
      ldflags: |
        -X github.com/rancher/machine/version.Version=${{package.version}}
        -X github.com/rancher/machine/version.GitCommit=$(git rev-parse HEAD)

update:
  enabled: true
  git: {}
  schedule:
    period: weekly
    reason: Upstream only maintains 0.15.0 tag and there are newer tags exist, so we have to watch only master branch.

test:
  pipeline:
    - runs: |
        rancher-machine --help
        rancher-machine --version | grep ${{package.version}}
        rancher-machine create --driver none --url localhost test-machine
        rancher-machine ls | grep test-machine
