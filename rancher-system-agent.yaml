package:
  name: rancher-system-agent
  version: 0.3.11
  epoch: 0
  description: rancher-system-agent is a daemon designed to run on a system and apply "plans" to the system.
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rancher/system-agent
      tag: v${{package.version}}
      expected-commit: b8c28d00ff30fecf8029f0e5f75252b4cb7f5565

  - uses: go/build
    with:
      ldflags: |
        -X github.com/rancher/system-agent/pkg/version.Version=${{package.version}}
        -X github.com/rancher/system-agent/pkg/version.GitCommit=$(git rev-parse HEAD)
      modroot: .
      output: rancher-system-agent
      packages: .

update:
  enabled: true
  ignore-regex-patterns:
    - -rc
  github:
    identifier: rancher/system-agent
    strip-prefix: v

test:
  pipeline:
    - runs: |
        rancher-system-agent --help
        rancher-system-agent --version | grep -qi "${{package.version}}"
    - uses: test/kwok/cluster
    - name: Test startup
      uses: test/daemon-check-output
      with:
        setup: |
          # https://github.com/rancher/system-agent/blob/main/examples/configuration/README.md
          mkdir -p /etc/rancher/agent
          cat <<EOF > /etc/rancher/agent/config.yaml
          workDirectory: /var/lib/rancher/agent/work
          localPlanDirectory: /var/lib/rancher/agent/plans
          remoteEnabled: true
          connectionInfoFile: /etc/rancher/agent/conninfo.yaml
          preserveWorkDirectory: true
          EOF
          chmod 0600 /etc/rancher/agent/config.yaml
          cat <<EOF > /etc/rancher/agent/conninfo.yaml
          kubeConfig: |-
            kubeConfig: |-
              apiVersion: v1
              kind: Config
              clusters:
              - name: "kubernetes"
                cluster:
                  server: "https://my-k8s-apiserver"
              users:
              - name: "cluster-admin"
                user:
                  token: <redacted>
              contexts:
              - name: "kubernetes"
                context:
                  user: "cluster-admin"
                  cluster: "kubernetes"
              current-context: "kubernetes"
          namespace: mynamespace
          secretName: mysecret
          EOF
          chmod 0600 /etc/rancher/agent/conninfo.yaml
        start: rancher-system-agent sentinel
        timeout: 5
        expected_output: |
          test
