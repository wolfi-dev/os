package:
  name: redpanda
  version: "25.1.4"
  epoch: 50
  description: "Redpanda is a streaming platform based on Apache Kafka API"
  copyright:
    - license: "Apache-2.0"
  dependencies:
    runtime:
      - bash

vars:
  java-version: 21

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - bazelisk-default
      - binutils
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - clang
      - coreutils
      - crane
      - e2fsprogs-dev
      - git
      - glibc-locale-en
      - go
      - krb5-dev
      - libtool
      - liburing-dev
      - libxml2-dev
      - openjdk-${{vars.java-version}}-default-jdk
      - openssl-dev
      - ragel
      - samurai
      - yamllint
      - zlib
      - zstd
  environment:
    STABLE_GIT_LATEST_TAG: ${{package.version}}

pipeline:
  - uses: git-checkout
    with:
      repository: "https://github.com/redpanda-data/redpanda.git"
      expected-commit: "6cd1d4ef6b8424ee4fd219df94a90abe839a36bc"
      tag: "v${{package.version}}"
      destination: redpanda

  - working-directory: redpanda
    uses: patch
    with:
      patches: ../0001-build-update-krb5-configuration-to-include-system-er.patch

  - working-directory: redpanda
    runs: |
      mkdir -p ${{targets.destdir}}/usr/bin/
      mkdir -p ${{targets.destdir}}/usr/lib/redpanda
      bazel build --verbose_failures --action_env=STABLE_GIT_LATEST_TAG=${{package.version}} --show_loading_progress --config=release //...
      mv bazel-bin/src/v/redpanda/redpanda ${{targets.destdir}}/usr/bin/
      mv bazel-bin/src/go/rpk/cmd/rpk/rpk_/rpk ${{targets.destdir}}/usr/bin/
      # Copy redpanda config file to default location /etc/redpanda
      mkdir -p ${{targets.destdir}}/etc/redpanda
      cp conf/redpanda.yaml ${{targets.destdir}}/etc/redpanda/redpanda.yaml

  - uses: strip


  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

test:
  environment:
    contents:
      packages:
        - ${{package.name}}-compat
  pipeline:
    - uses: test/tw/ldd-check
    - name: "Verify binary versions"
      runs: |
        redpanda --version
        rpk --version
    - name: "Test rpk commands"
      runs: |
        # A full blown redpanda cluster requires resources that the CI cluster cannot provide
        rpk redpanda start --mode dev-container --smp 1 --memory 1G --node-id 0 &
        sleep 5
        rpk cluster health | grep -iE '^Healthy:[[:space:]]+true$'
        rpk topic create tutorial
        rpk topic list | grep tutorial
    - name: "Test rpk cluster commands"
      runs: |
        rpk cluster --help
        rpk cluster info --help
    - name: "test entrypoint usage"
      runs: |
        /entrypoint.sh --help

update:
  enabled: true
  github:
    identifier: "redpanda-data/redpanda"
    strip-prefix: "v"
    use-tag: true
