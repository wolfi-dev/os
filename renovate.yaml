package:
  name: renovate
  version: "43.8.1"
  epoch: 0
  description: "Automated dependency updates. Multi-platform and multi-language."
  copyright:
    - license: AGPL-3.0-only
  checks:
    disabled:
      - usrlocal
  dependencies:
    runtime:
      - git
      - nodejs-${{vars.node-version}}
  resources:
    cpu: "2"
    memory: 11Gi

vars:
  # Upstream is using node 24
  node-version: 24

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - corepack
      - jq
      - nodejs-${{vars.node-version}}
      - npm
      - pnpm

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/renovatebot/renovate
      tag: ${{package.version}}
      expected-commit: f5f32bdcb4661d03aeddf7631d024c001c7aef7b

  - runs: |
      sed -i 's/"version": "0.0.0-semantic-release"/"version": "${{package.version}}"/' package.json

  - name: Bump dependencies
    runs: |
      jq '.pnpm.overrides."fast-xml-parser" = "5.3.4"' package.json > temp.json && mv temp.json package.json # GHSA-37qj-frw5-hhjh
      jq '.pnpm.overrides."@isaacs/brace-expansion" = "5.0.1"' package.json > temp.json && mv temp.json package.json # GHSA-7h2j-956f-4vf2
      jq '.pnpm.overrides."npm" = "11.9.0"' package.json > temp.json && mv temp.json package.json # GHSA-34x7-hfp2-rc4v

  - runs: |
      corepack enable
      corepack install
      pnpm i --no-frozen-lockfile
      pnpm build

  - runs: |
      mkdir -p ${{targets.contextdir}}/usr/bin \
      ${{targets.contextdir}}/usr/lib/renovate \
      ${{targets.contextdir}}/usr/local

      cp -a dist ${{targets.contextdir}}/usr/lib/renovate/
      cp -a node_modules ${{targets.contextdir}}/usr/lib/renovate/
      cp package.json ${{targets.contextdir}}/usr/lib/renovate/

      # Create executable wrapper
      for cmd in config-validator proxy renovate; do
        [ "$cmd" = "renovate" ] && name=$cmd || name=renovate-$cmd
        printf '#!/bin/sh\nexec node /usr/lib/renovate/dist/%s.js "$@"\n' "$cmd" > ${{targets.contextdir}}/usr/bin/$name
        chmod +x ${{targets.contextdir}}/usr/bin/$name
        ln -sf ../bin/$name ${{targets.contextdir}}/usr/local/$name
      done

      # Clean up musl directories
      find ${{targets.contextdir}}/usr/lib/renovate/node_modules -type d -name '*musl*' -exec rm -rf {} + 2>/dev/null || true

test:
  environment:
    contents:
      packages:
        - go
        - nodejs-${{vars.node-version}}
        - npm
  pipeline:
    - name: Verify renovate version
      runs: |
        renovate --version | grep -i ${{package.version}}
        npx --yes --package renovate -- renovate-config-validator
        renovate-proxy --help
    - name: Run with patgithub123
      runs: |
        # work around github push protection GH013
        # renovate_token is github read-only token.
        set +x
        t1=_OrLizP6TZHJuTpnEPE9
        export RENOVATE_TOKEN="ghp${t1}tlc69MrsuS84fUS9Y"
        set -x

        output=$(renovate --dry-run patgithub123/gomod1 2>&1)

        # Verify successful processing (Repository start and dependency extraction)
        if ! echo "$output" | grep -q "INFO: Repository started" || ! echo "$output" | grep -q "INFO: Dependency extraction complete"; then
          echo "Failed to start repository processing or complete dependency extraction"
          echo "$output"
          exit 1
        fi

        # Verify no errors occurred
        if echo "$output" | grep -q "ERROR:"; then
          echo "Errors found in renovate output:"
          echo "$output"
          exit 1
        fi

        # Verify gomod and npm dependencies were found
        if ! echo "$output" | grep -q '"gomod": {"fileCount": 1, "depCount": 5}' || ! echo "$output" | grep -q '"npm": {"fileCount": 1, "depCount": 1}'; then
          echo "Failed to detect dependencies correctly (gomod/npm)"
          echo "$output"
          exit 1
        fi
    - uses: test/tw/ldd-check

update:
  enabled: true
  ignore-regex-patterns:
    - -next
  github:
    identifier: renovatebot/renovate
    use-tag: true
  schedule:
    period: daily
    reason: upstream project creates a tag many times a day
