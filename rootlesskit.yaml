package:
  name: rootlesskit
  version: "2.3.5"
  epoch: 9 # GHSA-jv3w-x3r3-g6rm
  description: RootlessKit is a Linux-native implementation of "fake root" using user_namespaces(7).
  copyright:
    - license: Apache-2.0
  dependencies:
    # Let's ensure that we have config. This gets the default, but can also
    # be overridden by users.
    runtime:
      - rootlesskit-config

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rootless-containers/rootlesskit
      expected-commit: 0cc0811acc6e4daee71817383e62fb811590bc13
      tag: v${{package.version}}

  - uses: go/bump
    with:
      deps: |-
        github.com/containernetworking/plugins@v1.9.0

  - uses: go/build
    with:
      output: rootlesskit
      packages: ./cmd/rootlesskit

  - uses: go/build
    with:
      output: rootlessctl
      packages: ./cmd/rootlessctl

  - uses: go/build
    with:
      output: rootlesskit-docker-proxy
      packages: ./cmd/rootlesskit-docker-proxy

subpackages:
  - name: "rootlesskit-config-nonroot"
    description: Rootlesskit config for nonroot user
    dependencies:
      runtime:
        - rootlesskit
      provides:
        - rootlesskit-config=${{package.full-version}}
    pipeline:
      # See https://rootlesscontaine.rs/getting-started/common/subuid/
      - runs: |
          mkdir -p ${{targets.destdir}}/etc
          echo "nonroot:100000:65536" > ${{targets.destdir}}/etc/subuid
          echo "nonroot:100000:65536" > ${{targets.destdir}}/etc/subgid
    test:
      pipeline:
        - uses: test/virtualpackage
          with:
            virtual-pkg-name: rootlesskit-config
            real-pkg-name: ${{subpkg.name}}

update:
  enabled: true
  github:
    identifier: rootless-containers/rootlesskit
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        rootlessctl --version
        rootlesskit --version
        rootlesskit-docker-proxy --help
        rootlessctl --help
        rootlesskit --help
