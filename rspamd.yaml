package:
  name: rspamd
  version: "3.14.2"
  epoch: 0
  description: "Rapid spam filtering system"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates-bundle
      - glib
      - libarchive
      - libevent
      - libicu77
      - libmagic
      - libsodium
      - luajit
      - openssl
      - pcre2
      - sqlite-libs
      - zlib

environment:
  contents:
    packages:
      - build-base
      - busybox
      - glib-dev
      - icu-dev
      - libarchive-dev
      - libsodium-dev
      - luajit-dev
      - openssl-dev
      - pcre2-dev
      - perl
      - ragel-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rspamd/rspamd
      tag: ${{package.version}}
      expected-commit: e6f401afb3c5dc4b72999d3a7a4d0923b43880fa

  - uses: cmake/configure
    with:
      opts: |
        -DENABLE_PCRE2=ON \
        -DENABLE_LUAJIT=ON \
        -DINSTALL_WEBUI=OFF \
        -DINSTALL_EXAMPLES=OFF \
        -DCMAKE_INSTALL_SYSCONFDIR=/etc

  - uses: cmake/build

  - uses: cmake/install

  - runs: |
      # Create required runtime directories
      install -d -m 755 "${{targets.destdir}}"/var/lib/rspamd
      install -d -m 755 "${{targets.destdir}}"/var/log/rspamd
      install -d -m 755 "${{targets.destdir}}"/run/rspamd

      # Create runtime directory when /run is a tmpfs
      install -d -m 755 "${{targets.destdir}}"/usr/lib/tmpfiles.d
      echo 'd /run/rspamd 0755 root root -' >"${{targets.destdir}}"/usr/lib/tmpfiles.d/rspamd.conf

      install -d -m 700 "${{targets.destdir}}"/var/lib/rspamd/dkim
      install -d -m 755 "${{targets.destdir}}"/etc/rspamd/local.d
      install -d -m 755 "${{targets.destdir}}"/etc/rspamd/override.d

      # Copy config files from /usr/etc/rspamd to /etc/rspamd as upstream
      if [ -d "${{targets.destdir}}"/usr/etc/rspamd ]; then
          cp -r "${{targets.destdir}}"/usr/etc/rspamd/* "${{targets.destdir}}"/etc/rspamd/
          rm -rf "${{targets.destdir}}"/usr/etc/rspamd
      fi

      # Create symlink for binary compatibility (hardcoded paths)
      install -d -m 755 "${{targets.destdir}}"/usr/etc
      ln -sf /etc/rspamd "${{targets.destdir}}"/usr/etc/rspamd

      # Create symlinks for unversioned binary names (upstream standard)
      ln -sf rspamadm-${{package.version}} "${{targets.destdir}}"/usr/bin/rspamadm
      ln -sf rspamc-${{package.version}} "${{targets.destdir}}"/usr/bin/rspamc
      ln -sf rspamd-${{package.version}} "${{targets.destdir}}"/usr/bin/rspamd

  - uses: strip

update:
  enabled: true
  github:
    identifier: rspamd/rspamd
    use-tag: true
    strip-prefix: v

test:
  environment:
    contents:
      packages:
        - bash
        - coreutils
  pipeline:
    - uses: test/tw/ldd-check
    - name: "Basic binary check"
      runs: |
        rspamd --version | grep -F -e "${{package.version}}"
        rspamc --help | grep -F -e "run rspamc client"
        rspamadm --version | grep -F -e "${{package.version}}"
    - name: "Test rspamadm administrative tools"
      runs: |
        rspamadm configtest | grep -F -e "syntax OK"
        rspamadm pw -p test123 | grep -q "\\$"
        rspamadm confighelp -k actions | grep -F -e "Configuration element: .actions"
