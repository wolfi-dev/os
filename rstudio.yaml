package:
  name: rstudio
  version: "2026.01.0_p392"
  epoch: 0
  description: RStudio is an integrated development environment (IDE) for R
  copyright:
    - license: GPL-3.0-or-later
  resources:
    cpu: 48
    memory: 48Gi
  options:
    # There is a dependency on cmd:lua because of usr/bin/quarto/share/pandoc/datadir/luacov_reporter.lua
    # but nothing provides this, so we'll just include lua manually.
    no-depends: true
  dependencies:
    runtime:
      - R
      - R-dev
      - R-doc
      - bash
      - cmd:deno # Auto generated dependency
      - esbuild
      - linux-pam-dev # ldd dependency
      # Melange wants to add cmd:lua which doesn't have any providers, so we set this manually
      - lua5.4
      - nodejs~22
      - yaml-cpp-dev # ldd dependency

var-transforms:
  - from: ${{package.version}}
    match: _p
    replace: +
    to: mangled-package-version

environment:
  contents:
    packages:
      - R
      - R-dev
      - R-doc
      - R-mathlib
      - ant
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - libuuid
      - libxml2-dev
      - linux-pam-dev
      - nodejs~22
      - openjdk-21-default-jdk
      - openssl-dev
      - posix-libc-utils
      - sqlite-dev
      - util-linux-dev
      - wget
      - yaml-cpp
      - yaml-cpp-dev
      - yarn
      - zlib-dev
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/java-21-openjdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/rstudio/rstudio
      expected-commit: 49fbea7a09a468fc4d1993ca376fd5b971cb58e3
      tag: v${{vars.mangled-package-version}}

  - uses: patch
    with:
      patches: build-fixes-yaml-cpp-target-not-found.patch

  - runs: |
      cd dependencies/common
      ./install-boost
      ./install-copilot-language-server
      ./install-dictionaries
      ./install-mathjax
      ./install-panmirror
      ./install-quarto
      ./install-soci
      ./install-gwt

  - name: Use system nodejs
    runs: |
      # The upstream build fetches Node from the Internet: this stanza symlinks
      # our node into place instead, and touches the marker file to indicate
      # Node has been installed.  N.B. Upstream are on the latest Node 22 at
      # the moment, so we use our Node's version to generate the marker
      # filename, so we can catch drift between our version and upstream's
      # expectation.
      mkdir -p dependencies/common/node/bin
      ln -s /usr/bin/node dependencies/common/node/bin
      node_ver="$(node --version | sed 's/^v//')"
      touch dependencies/common/node/${node_ver}-installed

  - uses: cmake/configure
    with:
      opts: |
        -DRSTUDIO_TARGET=Server \
        -DCMAKE_BUILD_TYPE=Release \
        -DRSTUDIO_USE_SYSTEM_YAML_CPP=true \
        -DCMAKE_CXX_FLAGS="-O2 -Wno-maybe-uninitialized -Wno-unused-result" \
        -DCMAKE_PREFIX_PATH="/usr/lib/cmake/yaml-cpp"

  - uses: cmake/build

  - uses: cmake/install

  - runs: |
      # Upstream's build scripts install their vendored `node`, which we don't
      # want
      rm melange-out/rstudio/usr/bin/node

  # quarto includes its own esbuild. drop that to use ours; the
  # copilot-language-server-js binaries for the other arch confuse `strip`
  - if: ${{build.arch}} == "x86_64"
    runs: |
      rm ${{targets.destdir}}/usr/bin/quarto/bin/tools/x86_64/esbuild
      ln -sf /usr/bin/esbuild ${{targets.destdir}}/usr/bin/quarto/bin/tools/x86_64/esbuild

      rm -rf melange-out/rstudio/usr/bin/copilot-language-server-js/compiled/linux/arm64/ melange-out/rstudio/usr/bin/copilot-language-server-js/bin/linux/arm64/

  - if: ${{build.arch}} == "aarch64"
    runs: |
      rm ${{targets.destdir}}/usr/bin/quarto/bin/tools/aarch64/esbuild
      ln -sf /usr/bin/esbuild ${{targets.destdir}}/usr/bin/quarto/bin/tools/aarch64/esbuild

      rm -rf melange-out/rstudio/usr/bin/copilot-language-server-js/compiled/linux/x64/ melange-out/rstudio/usr/bin/copilot-language-server-js/bin/linux/x64/

  - runs: |
      # rsession struggles to find libR.so in its default location (according to ldd-check):
      # FAIL[ldd-check]: /usr/bin/rsession: missing libR.so
      # so we link it in the main /usr/lib folder to ensure it can be found
      mkdir ${{targets.destdir}}/usr/lib
      ln -sf /usr/lib/R/lib/libR.so ${{targets.destdir}}/usr/lib/libR.so

  - uses: strip

update:
  enabled: true
  version-transform:
    - match: '\+'
      replace: '_p'
  github:
    identifier: rstudio/rstudio
    use-tag: true
    strip-prefix: v

test:
  pipeline:
    - runs: |
        rstudio-server version
        # Basic test to show that the r-ldpath command outputs something reasonable (instead of nothing)
        r-ldpath /usr/lib/R | grep "/usr/local/lib"
        rpostback --help
        rserver --help
        esbuild --version
        esbuild --help
    - uses: test/tw/ldd-check
