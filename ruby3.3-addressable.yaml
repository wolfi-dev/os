package:
  name: ruby3.3-addressable
  version: "2.8.8"
  epoch: 0
  description: Addressable is an alternative implementation to the URI implementation that is part of Ruby's standard library. It is flexible, offers heuristic parsing, and additionally provides extensive support for IRIs and URI templates.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ruby${{vars.rubyMM}}-public_suffix

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - ruby-${{vars.rubyMM}}
      - ruby-${{vars.rubyMM}}-dev

vars:
  gem: addressable

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/sporkmonger/addressable
      tag: addressable-${{package.version}}
      expected-commit: 111af8e8d3260dbd5b10a2dfec42a4e129d18705

  # see https://github.com/sporkmonger/addressable/issues/565
  - name: "remove wrong reference to a file"
    runs: |
      sed -i 's/"data\/unicode\.data"\.freeze, //g' addressable.gemspec

  - uses: ruby/build
    with:
      gem: ${{vars.gem}}

  - uses: ruby/install
    with:
      gem: ${{vars.gem}}
      version: ${{package.version}}

  - uses: ruby/clean

  - name: "remove unused /usr/bin/ directory"
    runs: rm -r ${{targets.destdir}}/usr/bin

test:
  pipeline:
    - runs: ruby -e "require 'addressable'"
    - name: Parse URI
      runs: |
        cat <<EOF > /tmp/test.rb
        require 'addressable/uri'
        uri = Addressable::URI.parse("https://edu.chainguard.dev/open-source/wolfi/overview/")
        uri.scheme
        uri.host
        uri.path
        uri.normalize
        EOF
        ruby /tmp/test.rb

update:
  enabled: true
  github:
    identifier: sporkmonger/addressable
    strip-prefix: addressable-
    use-tag: true

var-transforms:
  - from: ${{package.name}}
    match: ^ruby(\d\.\d+)-.*
    replace: $1
    to: rubyMM
