package:
  name: ruby3.4-bcrypt_pbkdf
  version: "1.1.2"
  epoch: 1 # go/wolfi-rsc/ruby3.4-bcrypt_pbkdf
  description: Ruby gem implementing bcrypt_pbkdf
  copyright:
    - license: MIT
  dependencies:
    runtime:
  resources:
    cpu: "1"
    memory: 5Gi

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - ruby-${{vars.rubyMM}}
      - ruby-${{vars.rubyMM}}-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: e52088f9a28e34321a9b359f30d472097f1d7f01
      repository: https://github.com/net-ssh/bcrypt_pbkdf-ruby
      tag: v${{package.version}}

  - uses: ruby/build
    with:
      gem: ${{vars.gem}}

  - uses: ruby/install
    with:
      gem: ${{vars.gem}}
      version: ${{package.version}}

  - uses: ruby/clean

vars:
  gem: bcrypt_pbkdf

update:
  enabled: true
  github:
    identifier: net-ssh/bcrypt_pbkdf-ruby
    tag-filter-prefix: v
    use-tag: true

var-transforms:
  - from: ${{package.name}}
    match: ^ruby(\d\.\d+)-.*
    replace: $1
    to: rubyMM

test:
  environment:
    contents:
      packages:
        - build-base
  pipeline:
    - uses: test/tw/ldd-check
    - uses: test/tw/gem-check
    - name: simple bcrypt_bpkfd smoke test
      runs: |
        cat <<EOF > example.rb
        require 'bcrypt_pbkdf'

        password = "my_secure_password"
        salt = "random_salt_value"
        key_len = 32
        rounds = 100

        # Test 1: Basic functionality
        puts "\nTest 1: Basic functionality"
        begin
          derived_key = BCryptPbkdf.key(password, salt, key_len, rounds)
          puts "✓ Successfully derived key"
          puts "  Key length: #{derived_key.bytesize} bytes"
          puts "  Key (hex): #{derived_key.unpack1('H*')}"
        rescue => e
          puts "✗ Failed: #{e.message}"
          exit 1
        end

        # Test 2: Consistency check
        puts "\nTest 2: Consistency check (same inputs = same output)"
        derived_key2 = BCryptPbkdf.key(password, salt, key_len, rounds)
        if derived_key == derived_key2
          puts "✓ Consistent output verified"
        else
          puts "✗ Inconsistent output"
          exit 1
        end

        # Test 3: Different passwords produce different keys
        puts "\nTest 3: Different passwords produce different keys"
        different_key = BCryptPbkdf.key("different_password", salt, key_len, rounds)
        if derived_key != different_key
          puts "✓ Different passwords produce different keys"
        else
          puts "✗ Same key produced for different passwords"
          exit 1
        end

        # Test 4: Different salts produce different keys
        puts "\nTest 4: Different salts produce different keys"
        different_salt_key = BCryptPbkdf.key(password, "different_salt", key_len, rounds)
        if derived_key != different_salt_key
          puts "✓ Different salts produce different keys"
        else
          puts "✗ Same key produced for different salts"
          exit 1
        end

        # Test 5: Variable key lengths
        puts "\nTest 5: Variable key lengths"
        [16, 32, 64].each do |length|
          key = BCryptPbkdf.key(password, salt, length, rounds)
          if key.bytesize == length
            puts "✓ Generated #{length}-byte key successfully"
          else
            puts "✗ Expected #{length} bytes, got #{key.bytesize}"
            exit 1
          end
        end
        EOF

        ruby example.rb
