package:
  name: ruby3.4-ed25519
  version: "1.4.0"
  epoch: 1 # go/wolfi-rsc/ruby3.4-ed25519
  description: Ed25519 high-performance public-key signature system as a RubyGem
  copyright:
    - license: MIT
  dependencies:
    runtime:
  resources:
    cpu: "2"
    memory: 6Gi

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - ruby-${{vars.rubyMM}}
      - ruby-${{vars.rubyMM}}-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 79d7b8aed5753ce294933ce290985300aeace5c1
      repository: https://github.com/RubyCrypto/ed25519
      tag: v${{package.version}}

  - uses: ruby/build
    with:
      gem: ${{vars.gem}}

  - uses: ruby/install
    with:
      gem: ${{vars.gem}}
      version: ${{package.version}}

  - uses: ruby/clean

vars:
  gem: ed25519

update:
  enabled: true
  github:
    identifier: RubyCrypto/ed25519
    tag-filter-prefix: v
    use-tag: true

var-transforms:
  - from: ${{package.name}}
    match: ^ruby(\d\.\d+)-.*
    replace: $1
    to: rubyMM

test:
  environment:
    contents:
      packages:
        - build-base
  pipeline:
    - uses: test/tw/ldd-check
    - uses: test/tw/gem-check
    - runs: |
        cat <<EOF > example.rb
        require 'ed25519'

        puts "ED25519 Gem Smoke Test"

        # Test 1: Generate a signing key
        puts "\n1. Generating signing key..."
        signing_key = Ed25519::SigningKey.generate
        puts "✓ Signing key generated"

        # Test 2: Extract verify key
        puts "\n2. Extracting verify key..."
        verify_key = signing_key.verify_key
        puts "✓ Verify key extracted"

        # Test 3: Sign a message
        puts "\n3. Signing a message..."
        message = "Hello, ED25519!"
        signature = signing_key.sign(message)
        puts "✓ Message signed"
        puts "   Message: #{message}"
        puts "   Signature (hex): #{signature.unpack1('H*')}"

        # Test 4: Verify the signature
        puts "\n4. Verifying signature..."
        begin
          verify_key.verify(signature, message)
          puts "✓ Signature verified successfully"
        rescue Ed25519::VerifyError
          puts "✗ Signature verification failed"
          exit 1
        end

        # Test 5: Verify with wrong message (should fail)
        puts "\n5. Testing verification with wrong message..."
        wrong_message = "Wrong message"
        begin
          verify_key.verify(signature, wrong_message)
          puts "✗ Verification should have failed but didn't"
          exit 1
        rescue Ed25519::VerifyError
          puts "✓ Verification correctly failed for wrong message"
        end

        # Test 6: Export and import keys
        puts "\n6. Testing key serialization..."
        signing_key_bytes = signing_key.to_bytes
        verify_key_bytes = verify_key.to_bytes

        restored_signing_key = Ed25519::SigningKey.new(signing_key_bytes)
        restored_verify_key = Ed25519::VerifyKey.new(verify_key_bytes)

        puts "✓ Keys serialized and restored"

        # Test 7: Verify with restored key
        puts "\n7. Verifying with restored key..."
        begin
          restored_verify_key.verify(signature, message)
          puts "✓ Signature verified with restored key"
        rescue Ed25519::VerifyError
          puts "✗ Verification with restored key failed"
          exit 1
        end

        puts "All tests passed! ✓"
        EOF
        ruby example.rb
