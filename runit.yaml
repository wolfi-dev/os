package:
  name: runit
  version: 2.2.0
  epoch: 20
  description: UNIX init scheme with service supervision
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - merged-sbin
      - wolfi-baselayout

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle

pipeline:
  - uses: fetch
    with:
      uri: https://smarden.org/runit/runit-${{package.version}}.tar.gz
      expected-sha512: cedfe6d3505aca754ff11d791055f023a7be42e2fbdd2e4964b3460692474371a72363cf181ae2dfae5c02df45ebf568cdab72a5000d1b48e26e12217d4e9a3d
      strip-components: 2

  - runs: |
      mv src/* .

  - runs: |
      # patch in some flags, or it will not build with gcc-14
      cp conf-cc conf-cc.dist
      for flag in \
          implicit-function-declaration \
          incompatible-pointer-types \
          ; do
          sed -i -e "1s/$/ -Wno-error=$flag/" conf-cc
      done
      diff conf-cc.dist conf-cc && exit 1

  - uses: autoconf/make

  - runs: |
      install -d "${{targets.destdir}}"/usr/bin
      for i in chpst runit runit-init runsv runsvchdir runsvdir sv svlogd utmpset; do
        install -m755 "$i" "${{targets.destdir}}"/usr/bin/$i
      done
      install -d "${{targets.destdir}}"/usr/share/man/man8
      cp -rf man/* "${{targets.destdir}}"/usr/share/man/man8
      mkdir -p "${{targets.destdir}}"/etc/service
      mkdir -p "${{targets.destdir}}"/etc/sv

  - uses: strip

subpackages:
  - name: runit-doc
    pipeline:
      - uses: split/manpages
    description: runit manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-sbin
        - wolfi-baselayout

update:
  enabled: true
  release-monitor:
    identifier: 279717

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        runit-init --version
        runit-init --help
