package:
  name: runit
  version: "2.3.0"
  epoch: 0
  description: UNIX init scheme with service supervision
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - merged-sbin
      - wolfi-baselayout

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc-14-default

pipeline:
  - uses: fetch
    with:
      uri: https://smarden.org/runit/runit-${{package.version}}.tar.gz
      expected-sha512: 6d1d79a69fe8eb366b8c72db777bb64d2cdf3c1f8aa5c8a6e31212666091f6489d7cb830f8273350e20d6e1d8f6b6a07c0ef7a9da426077f7243a983d6fa2e66
      strip-components: 2

  - runs: |
      mv src/* .

  - runs: |
      # patch in some flags, or it will not build with gcc-14
      cp conf-cc conf-cc.dist
      for flag in \
          implicit-function-declaration \
          incompatible-pointer-types \
          ; do
          sed -i -e "1s/$/ -Wno-error=$flag/" conf-cc
      done
      diff conf-cc.dist conf-cc && exit 1

  - uses: autoconf/make

  - runs: |
      install -d "${{targets.destdir}}"/usr/bin
      for i in chpst runit runit-init runsv runsvchdir runsvdir sv svlogd utmpset; do
        install -m755 "$i" "${{targets.destdir}}"/usr/bin/$i
      done
      install -d "${{targets.destdir}}"/usr/share/man/man8
      cp -rf man/* "${{targets.destdir}}"/usr/share/man/man8
      mkdir -p "${{targets.destdir}}"/etc/service
      mkdir -p "${{targets.destdir}}"/etc/sv

  - uses: strip

subpackages:
  - name: runit-doc
    pipeline:
      - uses: split/manpages
    description: runit manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-sbin
        - wolfi-baselayout

update:
  enabled: true
  release-monitor:
    identifier: 279717

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        runit-init --version
        runit-init --help
