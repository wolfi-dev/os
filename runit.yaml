package:
  name: runit
  version: "2.3.1"
  epoch: 0 # go/wolfi-rsc/runit
  description: UNIX init scheme with service supervision
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - merged-sbin
      - wolfi-baselayout
  resources:
    cpu: "1"
    memory: 5Gi

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle

pipeline:
  - uses: fetch
    with:
      uri: https://smarden.org/runit/runit-${{package.version}}.tar.gz
      expected-sha512: 448fb5de516fe3fded478a7e24cc54e5bf68e465681ec911ec8988c39da17ee7bbb62cd2faeb40bdd95d439d2b6fba170a40c7f8567b0db1664f4a1a763138db
      strip-components: 2

  - runs: |
      mv src/* .

  - runs: |
      # patch in some flags, or it will not build with gcc-14
      cp conf-cc conf-cc.dist
      for flag in \
          implicit-function-declaration \
          incompatible-pointer-types \
          ; do
          sed -i -e "1s/$/ -Wno-error=$flag/" conf-cc
      done
      diff conf-cc.dist conf-cc && exit 1

  - uses: autoconf/make

  - runs: |
      install -d "${{targets.destdir}}"/usr/bin
      for i in chpst runit runit-init runsv runsvchdir runsvdir sv svlogd utmpset; do
        install -m755 "$i" "${{targets.destdir}}"/usr/bin/$i
      done
      install -d "${{targets.destdir}}"/usr/share/man/man8
      cp -rf man/* "${{targets.destdir}}"/usr/share/man/man8
      mkdir -p "${{targets.destdir}}"/etc/service
      mkdir -p "${{targets.destdir}}"/etc/sv

  - uses: strip

subpackages:
  - name: runit-doc
    pipeline:
      - uses: split/manpages
    description: runit manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-sbin
        - wolfi-baselayout

update:
  enabled: true
  release-monitor:
    identifier: 279717

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        runit-init --version
        runit-init --help
