package:
  name: samba
  version: 4.21.3
  epoch: 2
  description: "Tools to access a server's filespace and printers via SMB"
  copyright:
    - license: GPL-3.0-or-later AND LGPL-3.0-or-later

environment:
  contents:
    packages:
      - acl-dev
      - autoconf
      - automake
      - bind-dev
      - bison
      - build-base
      - busybox
      - cups-dev
      - dbus-dev
      - docbook-xml
      - e2fsprogs-dev
      - flex
      - gnutls-dev
      - iniparser-dev
      - jansson-dev
      - libarchive-dev
      - libcap-dev
      - libtirpc-dev
      - liburing-dev
      - linux-pam-dev
      - lmdb-dev
      - ncurses-dev
      - ncurses-terminfo
      - ncurses-terminfo-base
      - openldap-dev
      - perl
      - perl-json
      - perl-parse-yapp
      - pkgconf-dev
      - popt-dev
      - py3-dnspython
      - py3-markdown
      - py3-tdb
      - py3-tevent
      - python3-dev
      - rpcgen
      - subunit-dev
      - talloc-dev
      - tdb
      - tdb-dev
      - tevent-dev
      - zlib-dev
  environment:
    IDMAP_MODULES: idmap_ad,idmap_rid,idmap_adex,idmap_hash,idmap_tdb2
    PDB_MODULES: pdb_tdbsam,pdb_ldap,pdb_ads,pdb_smbpasswd,pdb_wbc_sam,pdb_samba4
    AUTH_MODULES: auth_unix,auth_wbc,auth_server,auth_netlogond,auth_script,auth_samba4

pipeline:
  - uses: fetch
    with:
      expected-sha256: ae2179a613e7a5d4088735ab100d4ca1cae0f92374d6307e22eaec13ad90125c
      uri: https://download.samba.org/pub/samba/stable/samba-${{package.version}}.tar.gz

  - uses: patch
    with:
      patches: tinfo.patch

  - uses: autoconf/configure
    with:
      opts: |
        --prefix=/usr \
        --sysconfdir=/etc/${{package.name}} \
        --with-configdir=/etc/${{package.name}} \
        --localstatedir=/var \
        --libexecdir=/usr/lib \
        --enable-fhs \
        --with-lockdir=/var/cache/${{package.name}} \
        --with-piddir=/run/${{package.name}} \
        --with-logfilebase=/var/log/${{package.name}} \
        --with-pam \
        --without-systemd \
        --with-ads \
        --with-shared-modules="$IDMAP_MODULES,$PDB_MODULES,$AUTH_MODULES,vfs_io_uring" \
        --enable-cups \
        --without-gettext \
        --bundled-libraries=NONE,ntdb,roken,wind,hx509,asn1,heimbase,hcrypto,krb5,gssapi,heimntlm,hdb,kdc,cmocka \
        --disable-rpath-install \
        --without-gpgme \
        --disable-fault-handling \
        --private-libraries='!ldb,!samba-credentials' \
        --without-regedit

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

  - runs: |
      rm -rf ${{targets.destdir}}/var/lib/samba/bind-dns
      rm -rf ${{targets.destdir}}/usr/share/info/dir
      rm -rf ${{targets.destdir}}/tmp/*
      rm -rf ${{targets.destdir}}/var/empty/*

subpackages:
  - name: samba-common
    description: Samba common files for both client an servers
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/etc
          mv "${{targets.destdir}}"/etc/* "${{targets.contextdir}}"/etc

  - name: samba-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - samba
    description: samba dev
    test:
      pipeline:
        - uses: test/pkgconf

  - name: samba-libs-py3
    description: Samba libraries that require libpython
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-net*private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-python*private-samba.so "${{targets.contextdir}}"/usr/lib/samba

  - name: samba-common-tools
    description: Tools for Samba servers and clients
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/bin

          mv "${{targets.destdir}}"/usr/bin/net "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/pdbedit "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/profiles "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbcontrol "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbpasswd "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/testparm "${{targets.contextdir}}"/usr/bin
    test:
      pipeline:
        - runs: |
            pdbedit --version
            pdbedit --help
            profiles --version
            profiles --help
            testparm --version
            testparm --help

  - name: samba-common-server-libs
    description: Samba libraries shared by common-tools and servers
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/lib/libdcerpc-server-core.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libnetapi.so.* "${{targets.contextdir}}"/usr/lib

          mv "${{targets.destdir}}"/usr/lib/samba/libRPC-SERVER-LOOP-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libdfs-server-ad-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libprinting-migrate-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsmbd-base-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsmbldaphelper-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/pdb "${{targets.contextdir}}"/usr/lib/samba

  - name: libsmbclient
    description: The SMB client library
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsmbclient.so.* "${{targets.contextdir}}"/usr/lib

  - name: samba-client
    description: Samba client programs
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/bin

          mv "${{targets.destdir}}"/usr/bin/cifsdd "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/dumpmscat "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/dbwrap_tool "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/mdsearch "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/mvxattr "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/nmblookup "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/oLschema2ldif "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/regdiff "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/regpatch "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/regshell "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/regtree "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/rpcclient "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/sharesec "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbcacls "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbclient "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbcquotas "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbget "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbspool "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbtar "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbtree "${{targets.contextdir}}"/usr/bin

          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/samba/smbspool_krb5_wrapper "${{targets.contextdir}}"/usr/lib
    test:
      environment:
        contents:
          packages:
            - samba-server
            - libauth-samba
      pipeline:
        - runs: |
            dbwrap_tool --version
            dbwrap_tool --help
            mvxattr --help
            nmblookup --version
            nmblookup --help
            oLschema2ldif --version
            oLschema2ldif --help
            sharesec --version
            sharesec --help
            smbcacls --version
            smbcacls --help
            smbclient --version
            smbclient --help
            smbcquotas --version
            smbcquotas --help
            smbget --version
            smbget --help
            smbtree --version
            smbtree --help
        - name: Test Samba client
          runs: |
            mkdir -p /var/lib/samba/private/ /var/log/samba /var/run/samba /etc/samba
            touch /etc/samba/smb.conf
            smbd
            sleep 1
            smbclient -L 127.0.0.1

  - name: samba-server-libs
    description: Samba libraries shared by server and windbind
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libdcerpc-samba4-private-samba.so "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/samba/libidmap-private-samba.so "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/samba/libnss-info-private-samba.so "${{targets.contextdir}}"/usr/lib

  - name: winbind
    description: Samba user and group resolver
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba
          mkdir -p "${{targets.contextdir}}"/usr/sbin

          mv "${{targets.destdir}}"/usr/sbin/winbindd "${{targets.contextdir}}"/usr/sbin
          mv "${{targets.destdir}}"/usr/lib/samba/idmap "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/nss_info "${{targets.contextdir}}"/usr/lib/samba

  - name: samba-util-libs
    description: Samba utility libraries
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/lib/libsamba-util.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/samba/libgenrand-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsocket-blocking-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-debug-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libtime-basic-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsys-rw-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libiov-buf-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcom-err-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libreplace-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libstable-sort-private-samba.so "${{targets.contextdir}}"/usr/lib/samba

  - name: libwbclient
    description: Samba winbind client libraries
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libwbclient.so.* "${{targets.contextdir}}"/usr/lib

  - name: samba-winbind-clients
    description: Samba winbind client tools
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/ntlm_auth "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/wbinfo "${{targets.contextdir}}"/usr/bin
    test:
      pipeline:
        - runs: |
            ntlm_auth --version
            ntlm_auth --help
            wbinfo --version
            wbinfo --help

  - name: samba-libnss-winbind
    description: Samba winbind NSS plugin
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libnss_winbind.so* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libnss_wins.so* "${{targets.contextdir}}"/usr/lib

  - name: samba-winbind-krb5-locator
    description: Samba winbind krb5 locator
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/krb5 "${{targets.contextdir}}"/usr/lib/samba

  - name: samba-pam-winbind
    description: PAM module for winbind
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/lib/security
          mv "${{targets.destdir}}"/usr/lib/security/* "${{targets.contextdir}}"/lib/security

  - name: samba-server
    description: Samba server
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/sbin
          mkdir -p "${{targets.contextdir}}"/usr/bin
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/sbin/nmbd "${{targets.contextdir}}"/usr/sbin
          mv "${{targets.destdir}}"/usr/sbin/smbd "${{targets.contextdir}}"/usr/sbin
          mv "${{targets.destdir}}"/usr/sbin/eventlogadm "${{targets.contextdir}}"/usr/sbin
          mv "${{targets.destdir}}"/usr/bin/smbstatus "${{targets.contextdir}}"/usr/bin

          mv "${{targets.destdir}}"/usr/lib/samba/auth "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libREG-FULL-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libRPC-WORKER-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libxattr-tdb-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/rpcd_* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/samba-bgqd "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/samba-dcerpcd "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/vfs "${{targets.contextdir}}"/usr/lib/samba
    dependencies:
      runtime:
        - samba-common
    test:
      pipeline:
        - runs: |
            eventlogadm version
            eventlogadm --help
            nmbd --help

  - name: py3-samba
    description: Samba python libraries
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/python* "${{targets.contextdir}}"/usr/lib
    dependencies:
      runtime:
        - py3-tdb

  - name: samba-test
    description: Samba server and client testing tools
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/bin
          mkdir -p "${{targets.contextdir}}"/usr/lib

          mv "${{targets.destdir}}"/usr/bin/gentest "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/locktest "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/masktest "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/ndrdump "${{targets.contextdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/smbtorture "${{targets.contextdir}}"/usr/bin

          mv "${{targets.destdir}}"/usr/lib/samba/libdlz-bind9-for-torture-private-samba.so "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/samba/libtorture-private-samba.so "${{targets.contextdir}}"/usr/lib
    dependencies:
      runtime:
        - py3-tdb
    test:
      pipeline:
        - runs: |
            gentest --version
            gentest --help
            locktest --version
            locktest --help
            masktest --version
            masktest --help
            ndrdump --version

  - name: libauth-samba
    description: Samba auth library shared by common-tools, server and clients
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libauth-private-samba.so "${{targets.contextdir}}"/usr/lib/samba

  - name: samba-libs
    description: Samba core libraries shared by common-tools, server and clients
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/lib/samba/libasn1-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libgssapi-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libhcrypto-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libheimbase-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libheimntlm-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libhx509-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libkrb5-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libroken-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libwind-private-samba.so* "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/lib/samba/libCHARSET3-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libMESSAGING-SEND-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libMESSAGING-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libaddns-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libads-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libasn1util-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libauthkrb5-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcli-cldap-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcli-ldap-common-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcli-nbt-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcli-smb-common-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcli-spoolss-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcliauth-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libclidns-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcluster-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcmdline-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcmocka-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libcommon-auth-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libdbwrap-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libdcerpc-pkt-auth-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libdcerpc-samba-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libevents-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libflag-mapping-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libgensec-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libgse-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libinterfaces-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libkrb5samba-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libldbsamba-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/liblibcli-lsa3-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/liblibcli-netlogon3-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/liblibsmb-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libmessages-dgm-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libmessages-util-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libmsghdr-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libmsrpc3-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libndr-samba-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libndr-samba4-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libnpa-tstream-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-cluster-support-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-modules-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-security-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba-sockets-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamba3-util-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsamdb-common-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsecrets3-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libserver-id-db-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libserver-role-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsmb-transport-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libsmbd-shim-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libtalloc-report-printf-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libtalloc-report-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libtdb-wrap-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libutil-reg-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libutil-setid-private-samba.so "${{targets.contextdir}}"/usr/lib/samba
          mv "${{targets.destdir}}"/usr/lib/samba/libutil-tdb-private-samba.so "${{targets.contextdir}}"/usr/lib/samba

          mv "${{targets.destdir}}"/usr/lib/libdcerpc-binding.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libndr-krb5pac.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libndr-nbt.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libndr-standard.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libndr.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsamba-credentials.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsamba-errors.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsamba-hostconfig.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsamba-passdb.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsamdb.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsmbconf.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libsmbldap.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libtevent-util.so.* "${{targets.contextdir}}"/usr/lib
          mv "${{targets.destdir}}"/usr/lib/libldb.so.* "${{targets.contextdir}}"/usr/lib

update:
  enabled: true
  release-monitor:
    identifier: 4758

test:
  environment:
    contents:
      packages:
        - libauth-samba
        - samba-server
        - samba-libs
  pipeline:
    - name: "Check Installed Binaries"
      runs: |
        find /usr -name smbd
        find /usr -name nmbd
    - name: "Check smbd Installation"
      runs: |
        if [ -f /usr/sbin/smbd ]; then
          echo "smbd found in /usr/sbin."
        else
          echo "smbd could not be found in /usr/sbin!" && exit 1
        fi
    - name: "Check nmbd Installation"
      runs: |
        if [ -f /usr/sbin/nmbd ]; then
          echo "nmbd found in /usr/sbin."
        else
          echo "nmbd could not be found in /usr/sbin!" && exit 1
        fi
    - name: "Test smbd Version"
      runs: |
        export LD_LIBRARY_PATH=/usr/lib/samba:$LD_LIBRARY_PATH
        /usr/sbin/smbd --version
    - name: "Test smbd Service Start"
      runs: |
        TMP_CONF=$(mktemp)
        echo -e "[global]\nlog file = /dev/stdout\n[public]\npath = /tmp\nread only = no" > $TMP_CONF
        smbd -i -s $TMP_CONF &
        SMBD_PID=$!
        sleep 2
        if kill -0 $SMBD_PID; then
          echo "smbd started successfully."
          kill $SMBD_PID
        else
          echo "smbd failed to start!" && exit 1
        fi
        rm $TMP_CONF
