package:
  name: sasl-xoauth2
  version: "0.27"
  epoch: 2
  description: "SASL plugin for XOAUTH2"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - cyrus-sasl
      - py3-msal
      - python-3

environment:
  contents:
    packages:
      - build-base
      - ca-certificates-bundle
      - curl-dev
      - cyrus-sasl-dev
      - jsoncpp-dev
      - openssl-dev
      - pkgconf
      - py3-msal
      - python-3
      - python-3-dev
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/tarickb/sasl-xoauth2
      tag: release-${{package.version}}
      expected-commit: 637356f5effaeb7336ab6ebaf2fad1fe0e9a6a50

  - runs: |
      # Skipping docs build since it requires pandoc (not packaged) and sasl-xoauth2 is only used as a postfix dep with no standalone image
      if [ -f CMakeLists.txt ]; then
        sed -i 's/add_subdirectory(docs)/# add_subdirectory(docs)/' CMakeLists.txt
      fi

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_INSTALL_SYSCONFDIR=/etc \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DSASL_PLUGIN_DIR=/usr/lib/sasl2 \
        -DBUILD_SHARED_LIBS=ON \
        -DBUILD_DOCS=OFF \
        -DBUILD_MAN_PAGES=OFF \
        -DBUILD_TOOLS=ON

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: sasl-xoauth2-dev
    description: "Development files for SASL XOAUTH2 plugin"
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - sasl-xoauth2
    test:
      pipeline:
        - uses: test/tw/ldd-check
          with:
            packages: sasl-xoauth2-dev

update:
  enabled: true
  github:
    identifier: tarickb/sasl-xoauth2
    use-tag: true
    strip-prefix: release-

test:
  environment:
    contents:
      packages:
        - cyrus-sasl
        - py3-msal
        - python-3
  pipeline:
    - name: "Basic binary check"
      runs: |
        sasl-xoauth2-tool --help
    - name: "Test configuration file validation"
      runs: |
        cat > /tmp/test-config.json << 'EOF'
        {
          "client_id": "test-client-id",
          "client_secret": "test-client-secret"
        }
        EOF

        sasl-xoauth2-tool test-config --config-file /tmp/test-config.json
    - name: "Test token file validation"
      runs: |
        # Create a test token file (this will fail refresh but should pass config check)
        cat > /tmp/test-token.json << 'EOF'
        {
          "access_token": "test-access-token",
          "refresh_token": "test-refresh-token",
          "expiry": "0"
        }
        EOF

        sasl-xoauth2-tool test-token-refresh /tmp/test-token.json || echo "Token refresh failed as expected"
