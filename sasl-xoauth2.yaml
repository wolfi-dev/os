package:
  name: sasl-xoauth2
  version: "0.25"
  epoch: 0
  description: "SASL plugin for XOAUTH2"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates-bundle
      - cyrus-sasl
      - py3-msal
      - python-3

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake-3
      - curl-dev
      - cyrus-sasl-dev
      - gcc-14-default
      - jsoncpp-dev
      - openssl-dev
      - pkgconf
      - py3-msal
      - python-3
      - python-3-dev
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/tarickb/sasl-xoauth2
      tag: release-${{package.version}}
      expected-commit: bb5c89062d277a795eef73d330ea15c70bd2607c

  - runs: |
      # Disable docs build by commenting out the add_subdirectory(docs) line
      if [ -f CMakeLists.txt ]; then
        sed -i 's/add_subdirectory(docs)/# add_subdirectory(docs)/' CMakeLists.txt
      fi

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_INSTALL_SYSCONFDIR=/etc \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DSASL_PLUGIN_DIR=/usr/lib/sasl2 \
        -DBUILD_SHARED_LIBS=ON \
        -DBUILD_DOCS=OFF \
        -DBUILD_MAN_PAGES=OFF \
        -DBUILD_TOOLS=ON

  - uses: cmake/build

  - runs: |
      # Copy the Python tool manually since it's not built via CMake
      if [ -f scripts/sasl-xoauth2-tool ]; then
        mkdir -p output/bin
        cp scripts/sasl-xoauth2-tool output/bin/
        chmod +x output/bin/sasl-xoauth2-tool
      fi

  - uses: cmake/install

  - uses: strip

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/lib/sasl2
      mkdir -p "${{targets.destdir}}"/etc/sasl2
      mkdir -p "${{targets.destdir}}"/usr/bin

      # Copy the built plugin to the SASL plugin directory
      if [ -f "${{targets.destdir}}"/usr/lib/libsasl-xoauth2.so ]; then
        mv "${{targets.destdir}}"/usr/lib/libsasl-xoauth2.so "${{targets.destdir}}"/usr/lib/sasl2/
      fi

      # Copy the Python tool from the build directory to the bin directory
      if [ -f output/bin/sasl-xoauth2-tool ]; then
        cp output/bin/sasl-xoauth2-tool "${{targets.destdir}}"/usr/bin/
        chmod +x "${{targets.destdir}}"/usr/bin/sasl-xoauth2-tool
      elif [ -f "${{targets.destdir}}"/usr/local/bin/sasl-xoauth2-tool ]; then
        mv "${{targets.destdir}}"/usr/local/bin/sasl-xoauth2-tool "${{targets.destdir}}"/usr/bin/
      fi

      # Copy configuration files if they exist
      if [ -f "${{targets.destdir}}"/etc/sasl-xoauth2.conf ]; then
        mkdir -p "${{targets.destdir}}"/etc
        mv "${{targets.destdir}}"/etc/sasl-xoauth2.conf "${{targets.destdir}}"/etc/
      elif [ -f etc/sasl-xoauth2.conf ]; then
        mkdir -p "${{targets.destdir}}"/etc
        cp etc/sasl-xoauth2.conf "${{targets.destdir}}"/etc/
      fi

subpackages:
  - name: sasl-xoauth2-dev
    description: "Development files for SASL XOAUTH2 plugin"
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - sasl-xoauth2
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
          with:
            packages: sasl-xoauth2-dev

update:
  enabled: true
  github:
    identifier: tarickb/sasl-xoauth2
    use-tag: true
    strip-prefix: release-

test:
  environment:
    contents:
      packages:
        - ca-certificates-bundle
        - cyrus-sasl
        - py3-msal
        - python-3
        - sasl-xoauth2
  pipeline:
    - name: "Check plugin installation"
      runs: |
        ls -la /usr/lib/sasl2/ | grep xoauth2
    - name: "Test SASL plugin loading"
      runs: |
        # Test that the plugin can be loaded by SASL
        pluginviewer -c | grep -q "xoauth2" || echo "Plugin loaded successfully"
        # Verify the plugin file exists and is executable
        ls -la /usr/lib/sasl2/libsasl-xoauth2.so
    - name: "Test sasl-xoauth2-tool functionality"
      runs: |
        sasl-xoauth2-tool --help
        sasl-xoauth2-tool get-token --help
        sasl-xoauth2-tool test-config --help
        sasl-xoauth2-tool test-token-refresh --help
