package:
  name: sealed-secrets
  version: "0.31.0"
  epoch: 0 # CVE-2025-47907
  description: A Kubernetes controller and tool for one-way encrypted Secrets
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bitnami-labs/sealed-secrets
      tag: v${{package.version}}
      expected-commit: 443107a1fd256cb9e2ff3a3290aa79d722f840ee

  - uses: go/build
    with:
      packages: ./cmd/controller
      output: controller
      ldflags: -X main.VERSION=${{package.version}}

subpackages:
  - name: ${{package.name}}-kubeseal
    dependencies:
      provides:
        - kubeseal=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          packages: ./cmd/kubeseal
          output: kubeseal
          ldflags: -X main.VERSION=${{package.version}}
    test:
      pipeline:
        - runs: |
            kubeseal --version | grep ${{package.version}}

update:
  enabled: true
  github:
    identifier: bitnami-labs/sealed-secrets
    strip-prefix: v
  ignore-regex-patterns:
    - ^helm-v.*

# only passes with docker runner
# MELANGE_EXTRA_OPTS="--runner docker" make test/sealed-secrets
test:
  environment:
    environment:
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: 32764
  pipeline:
    - name: version test
      runs: |
        controller --version | grep ${{package.version}}
    - uses: test/kwok/cluster
      with:
        serviceaccount: true
    - uses: test/daemon-check-output
      with:
        start: /usr/bin/controller
        setup: |
          kubectl create role secrets-admin --verb='*' --resource=secrets
          kubectl create rolebinding default-secrets-admin-binding --role=secrets-admin --serviceaccount=default:default
        timeout: 30
        expected_output: |
          Starting sealed-secrets controller
          Searching for existing private keys
          New key written
          HTTP server serving
          HTTP metrics server serving
