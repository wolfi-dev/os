package:
  name: seaweedfs
  version: "4.10"
  epoch: 0 # go/wolfi-rsc/seaweedfs
  description: SeaweedFS is a fast distributed storage system for blobs, objects, files.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - fuse2
  resources:
    cpu: "9"
    memory: 12Gi

var-transforms:
  - from: ${{package.version}}
    match: ^(\d+).*
    replace: $1
    to: major-version

environment:
  environment:
    CGO_ENABLED: "0"
    GODEBUG: http2client=0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/seaweedfs/seaweedfs
      tag: ${{package.version}}
      expected-commit: 5a279c4d2ff3de146508179e378534db3706827e

  - uses: go/build
    with:
      packages: ./weed
      output: weed
      ldflags: |
        -extldflags -static -X github.com/seaweedfs/seaweedfs/weed/util/version.COMMIT=$(git rev-parse HEAD)

  - name: Add config file
    runs: |
      mkdir -p ${{targets.destdir}}/etc/seaweedfs
      cp ./docker/filer.toml ${{targets.destdir}}/etc/seaweedfs/filer.toml
      mkdir -p ${{targets.destdir}}/data

subpackages:
  - name: ${{package.name}}-oci-entrypoint
    description: Entrypoint for SeaweedFS in OCI containers
    dependencies:
      runtime:
        - dash-binsh
        - su-exec
    pipeline:
      - runs: |
          install -Dm755 docker/entrypoint.sh ${{targets.contextdir}}/entrypoint.sh
    test:
      environment:
        accounts:
          groups:
            - groupname: seaweed
              gid: 1001
          users:
            - username: seaweed
              uid: 1001
              gid: 1001
          run-as: 0
        contents:
          packages:
            - "${{package.name}}"
      pipeline:
        - runs: |
            test -x /entrypoint.sh
            /entrypoint.sh help | grep -F "SeaweedFS"

  - name: ${{package.name}}-iamguarded-compat
    description: Compatibility package for iamguarded variant of SeaweedFS
    dependencies:
      runtime:
        - bash
        - busybox
        - procps
    pipeline:
      - uses: iamguarded/build-compat
        with:
          package: ${{package.name}}
          version: ${{vars.major-version}}
      - runs: |
          mkdir -p ${{targets.contextdir}}/opt/iamguarded/seaweedfs/bin
          mkdir -p ${{targets.contextdir}}/data
          mkdir -p ${{targets.contextdir}}/tmp
          chmod g+rwX ${{targets.contextdir}}/opt/iamguarded
          chmod g+rwX ${{targets.contextdir}}/data
          ln -sf /usr/bin/weed ${{targets.contextdir}}/opt/iamguarded/seaweedfs/bin/weed
      - uses: iamguarded/finalize-compat
        with:
          package: ${{package.name}}
          version: ${{vars.major-version}}
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
            - curl
            - jq
            - wait-for-it
        environment:
          MASTER_PORT: "9333"
      pipeline:
        - uses: iamguarded/test-compat
          with:
            package: ${{package.name}}
            version: ${{vars.major-version}}
        - uses: test/tw/symlink-check
          with:
            allow-absolute: true
        - name: "Test master server startup and API"
          uses: test/daemon-check-output
          with:
            start: /opt/iamguarded/seaweedfs/bin/weed master -ip=0.0.0.0 -port="${MASTER_PORT}" -mdir=/tmp/seaweedfs-test
            timeout: 45
            expected_output: |
              Start Seaweed Master
              No existing leader found!
              Initializing new cluster
            post: |
              wait-for-it "localhost:${MASTER_PORT}" -t 30

              curl -sf "http://localhost:${MASTER_PORT}/cluster/status" | grep -F "Leader"
              # /dir/assign requires volume servers which aren't running in this test
              curl -sf "http://localhost:${MASTER_PORT}/dir/status" | jq -e ".Topology"

test:
  environment:
    contents:
      packages:
        - curl
        - jq
        - wait-for-it
    environment:
      MASTER_PORT: "9333"
  pipeline:
    - uses: test/tw/ldd-check
    - uses: test/tw/help-check
      with:
        bins: weed
    - uses: test/tw/ver-check
      with:
        bins: weed
    - name: "Test master server startup and API"
      uses: test/daemon-check-output
      with:
        start: weed master -ip=0.0.0.0 -port="${MASTER_PORT}" -mdir=/tmp/seaweedfs-test
        timeout: 45
        expected_output: |
          Start Seaweed Master
          No existing leader found!
          Initializing new cluster
        post: |
          wait-for-it "localhost:${MASTER_PORT}" -t 30

          curl -sf "http://localhost:${MASTER_PORT}/cluster/status" | grep -F "Leader"
          # /dir/assign requires volume servers which aren't running in this test
          curl -sf "http://localhost:${MASTER_PORT}/dir/status" | jq -e ".Topology"

update:
  enabled: true
  github:
    identifier: seaweedfs/seaweedfs
