package:
  name: sftp
  version: "9.9_p2"
  epoch: 0
  description: Secure File Transfer Protocol (SFTP) server based on OpenSSH
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - bash
      - shadow
      - openssh-server-pam
      - openssh-sftp-server
      - openssh-client  # Includes `sftp` command

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - openssh-client
      - openssl-dev
      - zlib-dev
      - libedit-dev
      - linux-pam-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/atmoz/sftp
      expected-commit: 46a8b3db48a99257249a79fcbdf1cd9f666e161b  # Last active commit on 2024-09-14

  - runs: |
      mkdir -p ${{targets.contextdir}}/etc/ssh
      mkdir -p ${{targets.contextdir}}/usr/local/bin
      mkdir -p ${{targets.contextdir}}/usr/sbin

      cp -av files/sshd_config ${{targets.contextdir}}/etc/ssh/sshd_config
      cp -av files/create-sftp-user ${{targets.contextdir}}/usr/local/bin/
      cp -av files/entrypoint ${{targets.contextdir}}/

      # Ensure correct SSHD setup
      ln -sf /usr/sbin/sshd.pam ${{targets.contextdir}}/usr/sbin/sshd
      rm -f ${{targets.contextdir}}/etc/ssh/ssh_host_*key*

test:
  pipeline:
    - name: Verify OpenSSH installation
      runs: |
        ssh -V | grep -q "OpenSSH"

    - name: Verify SFTP entrypoint
      runs: |
        chmod +x /entrypoint
        /entrypoint --help

    - name: SFTP basic test
      runs: |
        /usr/sbin/sshd.pam -D &
        sleep 5
        sftp -o StrictHostKeyChecking=no test@localhost <<EOF
        ls
        exit
        EOF

update:
  enabled: false
