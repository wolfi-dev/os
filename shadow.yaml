# Generated from https://git.alpinelinux.org/aports/plain/community/shadow/APKBUILD
package:
  name: shadow
  version: 4.16.0
  epoch: 2
  description: PAM login and passwd utilities
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - libbsd-dev
      - libcap-dev
      - libcap-utils
      - libtool
      - libxslt-dev
      - linux-pam-dev
      - m4
      - openssf-compiler-options

pipeline:
  - uses: fetch
    with:
      expected-sha256: b78e3921a95d53282a38e90628880624736bf6235e36eea50c50835f59a3530b
      uri: https://github.com/shadow-maint/shadow/releases/download/${{package.version}}/shadow-${{package.version}}.tar.xz

  - uses: patch
    with:
      patches: |
        fix-undefined-reference.patch \
        useradd-defaults.patch

  - uses: autoconf/configure
    with:
      opts: |
        --enable-static \
        --disable-account-tools-setuid \
        --disable-nls \
        --enable-lastlog \
        --without-audit \
        --with-libpam \
        --without-selinux \
        --without-acl \
        --without-attr \
        --without-tcb \
        --with-yescrypt \
        --without-nscd \
        --without-group-name-max-length \
        --with-fcaps

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      make -C man DESTDIR=${{targets.destdir}} install-man

      # Do not install shipped pam.d.
      rm ${{targets.destdir}}/etc/pam.d/*

      # Config uses "--disable-account-tools-setuid" so most binaries are not pam aware
      # Add shadow-utils.pam and link only required configs
      install -m644 ./shadow-utils.pamd ${{targets.destdir}}/etc/pam.d/shadow-utils
      for pam_aware in groupmems chpasswd chfn newusers; do
        ln -s shadow-utils ${{targets.destdir}}/etc/pam.d/"$pam_aware";
      done

      install -m644 ./chsh.pamd ${{targets.destdir}}/etc/pam.d/chsh

      # passwd, login and su should work fine with 'linux-pam' config

      # Avoid conlict with coreutils-doc package.
      rm ${{targets.destdir}}/usr/share/man/man1/groups.*

      # Avoid conflict with man-pages package.
      rm ${{targets.destdir}}/usr/share/man/man3/getspnam.3*
      rm ${{targets.destdir}}/usr/share/man/man5/passwd.5*

      # /etc/login.defs is not very useful - replace it with an *almost* blank file.
      rm ${{targets.destdir}}/etc/login.defs
      echo "USERGROUPS_ENAB yes" > ${{targets.destdir}}/etc/login.defs

      # Used e.g. for unprivileged LXC containers.
      install -m644 /dev/null ${{targets.destdir}}/etc/subuid
      install -m644 /dev/null ${{targets.destdir}}/etc/subgid

  - uses: strip

vars:
  login-utils: faillog lastlog login newgrp nologin sg su
  conv-utils: pwconv pwunconv grpconv grpunconv

subpackages:
  - name: shadow-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - shadow
    description: shadow dev

  - name: shadow-login
    pipeline:
      - runs: |
          cd ${{targets.destdir}}
          for bin in ${{vars.login-utils}}; do
            for dir in bin sbin usr/bin usr/sbin; do
              if [ -e $dir/$bin ] || [ -L $dir/$bin ]; then
                mkdir -p ${{targets.subpkgdir}}/$dir
                mv ${{targets.destdir}}/$dir/$bin ${{targets.subpkgdir}}/$dir/
              fi
            done
          done
    description: Login utils from shadow
    test:
      pipeline:
        - runs: |
            su --help
            nologin --help
            faillog --help
            lastlog --help

  - name: shadow-doc
    pipeline:
      - uses: split/manpages
    description: shadow manpages

  - name: shadow-conv
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/sbin
          for bin in ${{vars.conv-utils}}; do
            mv ${{targets.destdir}}/usr/sbin/$bin ${{targets.subpkgdir}}/usr/sbin/
          done
    description: Utilities for converting to and from shadow passwords and groups
    test:
      pipeline:
        - runs: |
            grpconv --help
            grpunconv --help
            pwconv --help
            pwunconv --help

  - name: shadow-subids
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/bin
          mv ${{targets.destdir}}/bin/getsubids ${{targets.subpkgdir}}/bin/

          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/new*idmap ${{targets.subpkgdir}}/usr/bin/

          mkdir -p ${{targets.subpkgdir}}/etc
          mv ${{targets.destdir}}/etc/subuid ${{targets.subpkgdir}}/etc/
          mv ${{targets.destdir}}/etc/subgid ${{targets.subpkgdir}}/etc/
    description: Utilities for using subordinate UIDs and GIDs

update:
  enabled: true
  github:
    identifier: shadow-maint/shadow
    tag-filter: "4."
    use-tag: true

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        groups --help
        chage --help
        chfn --help
        chsh --help
        expiry --help
        gpasswd --help
        passwd --help
        chgpasswd --help
        chpasswd --help
        groupadd --help
        groupdel --help
        groupmems --help
        groupmod --help
        grpck --help
        logoutd --version
        newusers --help
        pwck --help
        useradd --help
        userdel --help
        usermod --help
        vigr --help
        vipw --help
        chgpasswd version
        chpasswd version
        groupadd version
        groupdel version
        grpck version
        logoutd --help
        useradd version
        userdel version
    - uses: test/ldd-check
      with:
        files: |-
          /usr/lib/libsubid.so.5
          /usr/lib/libsubid.so.5.0.0
