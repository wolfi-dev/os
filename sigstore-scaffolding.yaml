package:
  name: sigstore-scaffolding
  version: "0.7.31"
  epoch: 3 # GHSA-4qg8-fj49-pxjh
  description: Software Supply Chain Transparency Log
  copyright:
    - license: Apache-2.0
  checks:
    disabled:
      - empty

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - git
      - go

data:
  - name: components
    items:
      ctlog-createctconfig: ./cmd/ctlog/createctconfig
      ctlog-managectroots: ./cmd/ctlog/managectroots
      ctlog-verifyfulcio: ./cmd/ctlog/verifyfulcio
      fulcio-createcerts: ./cmd/fulcio/createcerts
      getoidctoken: ./cmd/getoidctoken
      rekor-createsecret: ./cmd/rekor/rekor-createsecret
      trillian-createdb: ./cmd/trillian/createdb
      trillian-createtree: ./cmd/trillian/createtree
      trillian-updatetree: ./cmd/trillian/updatetree
      tsa-createcertchain: ./cmd/tsa/createcertchain
      tuf-createsecret: ./cmd/tuf/createsecret
      tuf-server: ./cmd/tuf/server

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/sigstore/scaffolding
      tag: v${{package.version}}
      expected-commit: 8e9b439dcf7072c0a9e3b1653c6227c258f94202

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
        github.com/sigstore/sigstore-go@v1.1.4
        github.com/sigstore/fulcio@v1.8.3

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/crypto@v0.45.0
      modroot: actions/setup-sigstore-env/fakeoidc

  - runs: |
      # Fix CVEs: GHSA-4qg8-fj49-pxjh and GHSA-f83f-xpx7-ffpw
      # why these sed commands instead of go/bump: https://github.com/wolfi-dev/os/pull/75100#discussion_r2618266554
      sed -i.bak 's|github.com/sigstore/timestamp-authority/pkg/signer|github.com/sigstore/timestamp-authority/v2/pkg/signer|g' ./cmd/tsa/createcertchain/main.go
      sed -i.bak 's|github.com/sigstore/cosign/v2|github.com/sigstore/cosign/v3|g' ./cmd/prober/write.go
      sed -i.bak 's|github.com/sigstore/cosign/v2|github.com/sigstore/cosign/v3|g' ./cmd/prober/prober.go
      go mod tidy

subpackages:
  - range: components
    name: "${{package.name}}-${{range.key}}"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          packages: ${{range.value}}
          output: ${{range.key}}
          ldflags: -w
      - uses: strip
    test:
      pipeline:
        - runs: test -x /usr/bin/${{range.key}}

  - name: "${{package.name}}-cloudsqlproxy"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          packages: ./cmd/cloudsqlproxy
          output: cloudsqlproxy
          ldflags: -w
      - uses: strip
    dependencies:
      runtime:
        - cloud-sql-proxy
        - cloud-sql-proxy-compat
    test:
      pipeline:
        - runs: test -x /usr/bin/cloudsqlproxy

update:
  enabled: true
  github:
    identifier: sigstore/scaffolding
    strip-prefix: v

# Based on package contents inspection, it was found that this origin package is empty apart from its own SBOM and this test was added to confirm it is empty and will fail if the package is no longer empty (contains more than an SBOM)
test:
  pipeline:
    - uses: test/emptypackage
