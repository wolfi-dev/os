package:
  name: soci-snapshotter
  version: "0.9.0"
  epoch: 0
  description: A containerd snapshotter plugin which enables standard OCI images to be lazily loaded without requiring a build-time conversion step.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - containerd

environment:
  contents:
    packages:
      - build-base
      - busybox
      - go
      - zlib-dev
      - zlib-static

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/awslabs/soci-snapshotter
      tag: v${{package.version}}
      expected-commit: 737f61a3db40c386f997c1f126344158aa3ad43c

  - runs: |
      make
      make CMD_DESTDIR=${{targets.contextdir}} install

  - uses: strip

subpackages:
  - name: soci-snapshotter-static
    dependencies:
      runtime:
        - soci-snapshotter
    options:
      # Do not provide any embedded components
      no-provides: true
    pipeline:
      - runs: |
          make STATIC=1
          make CMD_DESTDIR=${{targets.contextdir}} install

update:
  enabled: true
  github:
    identifier: awslabs/soci-snapshotter
    strip-prefix: v

test:
  pipeline:
    # soci needs containerd running, which needs privilege, so we can't really do much here
    - runs: |
        soci -h
        soci-snapshotter-grpc -h
