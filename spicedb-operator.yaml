package:
  name: spicedb-operator
  version: "1.21.0"
  epoch: 0
  description: Kubernetes operator for managing SpiceDB clusters
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/authzed/spicedb-operator
      tag: v${{package.version}}
      expected-commit: 118d866a2ce66b22801a4ad1934aa6fb37fb2744

  - uses: go/build
    with:
      packages: ./cmd/spicedb-operator
      output: spicedb-operator
      ldflags: |
        -X github.com/jzelinskie/cobrautil.Version=v${{package.version}}

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility package for SpiceDB
    dependencies:
      runtime:
        - ${{package.name}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/ko-app
          ln -sf /usr/bin/spicedb-operator ${{targets.subpkgdir}}/ko-app/spicedb-operator
    test:
      pipeline:
        - runs: |
            test "$(readlink /ko-app/spicedb-operator)" = "/usr/bin/spicedb-operator"

update:
  enabled: true
  github:
    identifier: authzed/spicedb-operator
    strip-prefix: v
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - wait-for-it
    environment:
      OPERATOR_NAME: "spicedb-operator"
      POD_NAME: "spicedb-operator-test"
      POD_NAMESPACE: "default"
      DEBUG_PORT: "8090"
  pipeline:
    - name: Verify operator version and help
      runs: |
        spicedb-operator --help 2>&1 | grep -F "Available Commands:"
    - name: Test operator with mock Kubernetes
      uses: test/kwok/cluster
    - name: Test operator startup
      uses: test/daemon-check-output
      with:
        timeout: 60
        start: |
          spicedb-operator run \
            -v 2 \
            --debug-address=:${DEBUG_PORT}
        expected_output: |
          Feature gate default state
          Caches populated
          reflector.go
        post: |
          wait-for-it "localhost:${DEBUG_PORT}" -t 30
          curl -fsSL "http://localhost:${DEBUG_PORT}/metrics" | grep -F -q "go_gc_duration_seconds"
          curl -fsSL "http://localhost:${DEBUG_PORT}/metrics" | grep -F -q "spicedb_operator_clusters_count"
          curl -fsSL "http://localhost:${DEBUG_PORT}/metrics" | grep -F "spicedb_operator_clusters_status_collector"
