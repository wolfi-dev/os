package:
  name: sssd
  version: 2.10.0
  epoch: 0
  description: "A daemon to manage identity, authentication and authorization for centrally-managed systems."
  url: https://sssd.io
  copyright:
    - license: GPL-3.0
  dependencies:
    runtime:
      - sssd-libs

environment:
  contents:
    packages:
      - busybox
      - build-base
      - bash
      - coreutils
      - gcc
      - openssl-dev
      - glibc-dev
      - krb5-dev
      - linux-pam-dev
      - popt-dev
      - talloc-dev
      - tdb-dev
      - tevent-dev
      - keyutils-dev
      - ldb-dev
      - ding-libs-dev
      - openldap-dev
      - pcre2-dev
      - c-ares-dev
      - samba-dev
      - samba-util-libs
      - samba-common
      - samba-libs
      - samba-server-libs
      - samba-winbind-clients
      - samba-pam-winbind
      - bind-tools
      - nfs-utils-dev
      - cifs-utils-dev
      - libfido2-dev
      - samba-libnss-winbind
      - jansson-dev
      - curl-dev
      - libjose-dev
      - libunistring-dev
      - dbus-dev
      - libxslt-dev
      - libxml2-dev
      - libxml2-utils
      - docbook-xml
      - python-3-dev
      - python-3
      - py3-setuptools
      - p11-kit-dev
      - linux-headers
pipeline:
  - uses: fetch
    with:
      uri: https://github.com/SSSD/sssd/releases/download/${{package.version}}/sssd-${{package.version}}.tar.gz
      expected-sha256: bf955cc26b6d215bbb9083eadb613f78d7b727fb023f39987aec37680ae40ae3
  - uses: autoconf/configure
    with:
      opts: "--with-selinux=no --with-semanage=no --enable-nsslibdir=/usr/lib --enable-pammoddir=/usr/lib/security --enable-silent-rules"
  - uses: autoconf/make
  - uses: autoconf/make-install
  - name: "Shell reference removal"
    runs: |
        # We don't need rc.d support, especially not as it pulls a shell
        rm -rf "${{targets.destdir}}"/etc/rc.d
      
        # Simple convenience script to run sssctl at specific debug level
        rm "${{targets.destdir}}"/usr/sbin/sss_debuglevel
  - uses: strip
  
subpackages:

  - name: sssd-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - sssd-libs
    description: SSSD development files
    test:
      pipeline:
        - uses: test/pkgconf
    
  - name: sssd-locales
    pipeline:
      - uses: split/locales
    description: SSSD locales
    
  - name: sssd-doc
    pipeline:
      - uses: split/manpages
    description: SSSD manual pages
    
  - name: sssd-pam
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/etc
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/pam.d
          
          d=/usr/lib/security
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/pam_sss.so*
          
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_pam
  
  - name: sssd-pam-gss
    dependencies:
      runtime:
        - sssd-pam
    pipeline:
      - runs: |
          d=/usr/lib/security
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/pam_sss_gss.so*
   
  - name: sssd-nss
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_nss_idmap.so* \
              "${{targets.destdir}}${d}"/libnss_sss.so*
         
          d=/usr/libexec/sssd/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_nss
   
  - name: sssd-ssh
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/bin
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sss_ssh_*
             
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_ssh
            
  - name: sssd-samba
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/samba \
              "${{targets.destdir}}${d}"/cifs-utils
              
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_pac
              
  - name: sssd-ldb
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/ldb
    
  - name: sssd-sudo
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_sudo.so*
          
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_sudo*    

  - name: sssd-krb5
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/krb5
          
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_krb5*.so*
              
          d=/usr/lib/sssd/modules
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_krb5*plugin.so*
              
          d=/usr/share/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/krb5-snippets
          
          d=/usr/share/sssd/sssd.api.d
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-krb5.conf
          
          d=/var/lib/sss/pubconf
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/krb5.include.d
          
          d=/var/lib/sss
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/keytabs
              
  - name: sssd-krb5-kcm
    dependencies:
      runtime:
        - sssd-krb5
    pipeline:
      - runs: |
          d=/usr/share
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-kcm
              
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/krb5_child \
              "${{targets.destdir}}${d}"/sssd_kcm
      
              
  - name: sssd-ipa
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libipa_hbac.so*
          
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_ipa.so*
            
          d=/usr/share/sssd/sssd.api.d/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-ipa.conf
              
  - name: sssd-ldap
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/ldap_child
          
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_ldap*.so*
            
          d=/usr/share/sssd/sssd.api.d/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-ldap.conf
              
  - name: sssd-ad
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_ad.so*
            
          d=/usr/share/sssd/sssd.api.d/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-ad.conf
              
  - name: sssd-autofs
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/sssd/modules
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_autofs.so*
              
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_autofs
              
  - name: sssd-ifp
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libifp_iface*.so*
              
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd_ifp
              
  - name: sssd-idmap
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_idmap*.so*

  - name: sssd-certmap
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_certmap*.so*
              
  - name: sssd-nfsidmap
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libnfsidmap
              
  - name: sssd-simple
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_simple.so*
            
          d=/usr/share/sssd/sssd.api.d/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-simple.conf
              
  - name: sssd-proxy
    dependencies:
      runtime:
        - sssd
    pipeline:
      - runs: |
          d=/usr/lib/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/libsss_proxy.so*
            
          d=/usr/share/sssd/sssd.api.d/
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd-proxy.conf
              
  - name: sssd-libs
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sssd
              
  - name: py3-sssd
    dependencies:
      runtime:
        - sssd-libs
    pipeline:
      - runs: |
          d=/usr/lib
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/python3*
              
  - name: sssd-sss_obfuscate
    dependencies:
      runtime:
        - py3-sssd
        - sssd
    pipeline:
      - runs: |
          d=/usr/sbin
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sss_obfuscate
              
  - name: sssd-sss_analyze
    dependencies:
      runtime:
        - py3-sssd
        - sssd
    pipeline:
      - runs: |
          d=/usr/libexec/sssd
          mkdir -p "${{targets.subpkgdir}}${d}"
          mv -t "${{targets.subpkgdir}}${d}" \
              "${{targets.destdir}}${d}"/sss_analyze
             
update:
  enabled: true
  github: 
    identifier: SSSD/sssd 
