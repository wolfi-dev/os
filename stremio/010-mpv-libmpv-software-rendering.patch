From 79c362eba8585ea5250d4f615a3fbe889c2fdb20 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Juan=20Manuel=20M=C3=A9ndez=20Rey?= <vejeta@gmail.com>
Date: Sun, 26 Oct 2025 14:27:54 +0100
Subject: [PATCH] After patch 010 - mpv libmpv software rendering with vo and
 hwdec blocking

---
 mpv.cpp | 18 ++++++++++++++++++
 mpv.h   |  4 ++++
 2 files changed, 22 insertions(+)

diff --git a/mpv.cpp b/mpv.cpp
index d874177..a46366f 100644
--- a/mpv.cpp
+++ b/mpv.cpp
@@ -301,6 +301,24 @@ void MpvObject::command(const QVariant& params)
 
 void MpvObject::setProperty(const QString& name, const QVariant& value)
 {
+    // CRITICAL: Block vo changes in containers without GPU
+    // Always keep libmpv for Qt embedding, only hwdec should change
+    if (name == "vo" && g_inContainer && !g_hasGPUAccess) {
+        QString voValue = value.toString();
+        if (voValue != "libmpv") {
+            qDebug() << "mpv: Blocked vo change to" << voValue
+                     << "- keeping libmpv (required for Qt embedding)";
+            return; // Ignore the change
+        }
+    }
+
+    // Also block any hwdec changes in containers without GPU
+    if (name == "hwdec" && g_inContainer && !g_hasGPUAccess) {
+        qDebug() << "mpv: Blocked hwdec change - keeping software decoding";
+        return;
+    }
+
+    // Normal property setting for all other cases
     mpv::qt::set_property(mpv, name, value);
 }
 
diff --git a/mpv.h b/mpv.h
index faf74c6..a519774 100644
--- a/mpv.h
+++ b/mpv.h
@@ -2,6 +2,10 @@
 #define MPVRENDERER_H_
 #define MPV_ENABLE_DEPRECATED 0
 
+// From main.cpp (patch 009) - GPU detection state
+extern bool g_hasGPUAccess;
+extern bool g_inContainer;
+
 #include <QtQuick/QQuickFramebufferObject>
 
 #include <mpv/client.h>
-- 
2.51.0

