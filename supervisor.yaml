package:
  name: supervisor
  version: 4.2.5
  epoch: 9
  description: Supervisor process control system for Unix (supervisord)
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - py${{vars.py-version}}-setuptools
      - supervisor-config

vars:
  py-version: 3.13

environment:
  contents:
    packages:
      - py${{vars.py-version}}-build-base

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 99a3e3e240d9d13e143b306818731e224e1e73d2
      repository: https://github.com/Supervisor/supervisor
      tag: ${{package.version}}

  - name: Python Install
    runs: |
      sitepackages=$(python${{vars.py-version}} -c 'import site; print(site.getsitepackages()[0])')
      concatenated_path="${{targets.destdir}}${sitepackages}"

      echo "sitepackages=$sitepackages"
      echo "concatenated_path=$concatenated_path"

      if [ ! -d "$sitepackages" ]; then
        echo "making site packages directory"
        mkdir -p "${sitepackages}"
      fi

      if [ ! -d "$concatenated_path" ]; then
        echo "making DESTDIR sitepackages directory"
        mkdir -p "${concatenated_path}"
      fi

      mkdir -p "${{targets.destdir}}/etc/supervisor"
      mkdir -p "${{targets.destdir}}/etc/supervisor/conf.d"
      mkdir -p "${{targets.destdir}}/var/log/supervisor/"
      mkdir -p "${{targets.destdir}}/etc/logrotate.d"
      mkdir -p "${{targets.destdir}}/usr/bin/"

      pip${{vars.py-version}} install supervisor

      /usr/bin/echo_supervisord_conf > "${{targets.destdir}}/etc/supervisord.conf"
      cat "${{targets.destdir}}/etc/supervisord.conf"
      sed -i 's/\;files\s.*/files = supervisord.d\/*.conf/g' "${{targets.destdir}}/etc/supervisord.conf"
      cat "${{targets.destdir}}/etc/supervisord.conf"

      mv "${sitepackages}/supervisor" "${concatenated_path}"
      mv /usr/bin/supervisord ${{targets.destdir}}/usr/bin/supervisord
      mv /usr/bin/supervisorctl ${{targets.destdir}}/usr/bin/supervisorctl

      cat >${{targets.destdir}}/etc/logrotate.d/supervisord <<EOF
      /var/log/supervisor/*.log {
        missingok
        weekly
        notifempty
        nocompress
      }
      EOF

      chmod 600 ${{targets.destdir}}/etc/supervisord.conf
      chmod 644 ${{targets.destdir}}/etc/logrotate.d/supervisord

      find "${{targets.destdir}}" -name "*.pyo" -exec rm -rf '{}' +
      find "${{targets.destdir}}" -name "tests" -exec rm -rf '{}' +

  - uses: strip

subpackages:
  - name: supervisor-config
    description: Supervisor configuration
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/etc
          mv ${{targets.destdir}}/etc/supervisord.conf ${{targets.subpkgdir}}/etc/

  - name: supervisor-pyc
    description: Precompiled Python bytecode for supervisor
    pipeline:
      - runs: |
          sitepackages=$(python${{vars.py-version}} -c 'import site; print(site.getsitepackages()[0])')
          destdir_concatenated_path="${{targets.destdir}}${sitepackages}"
          subpkg_concatenated_path="${{targets.subpkgdir}}${sitepackages}"
          mkdir -p "${subpkg_concatenated_path}/supervisor/__pycache__/"
          find "${destdir_concatenated_path}/supervisor/__pycache__/" -name "*.pyc" \
            -exec mv {} "${subpkg_concatenated_path}/supervisor/__pycache__/" +

  - name: supervisor-openrc
    description: system for controlling process state under UNIX (OpenRC init scripts)
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/etc/init.d/"
          cat >${{targets.subpkgdir}}/etc/init.d/supervisord <<EOF
          #!/sbin/openrc-run

          name="Supervisor"
          command="/usr/bin/supervisord"
          pidfile="/var/run/supervisord.pid"
          configfile="/etc/supervisord.conf"
          command_args="--nodaemon --pidfile ${pidfile} --configuration ${configfile}"
          command_background="yes"

          required_files="${configfile}"
          EOF
          chmod 755 ${{targets.subpkgdir}}/etc/init.d/supervisord

update:
  enabled: true
  github:
    identifier: Supervisor/supervisor
    use-tag: true

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        supervisorctl --help
        supervisord --version
        supervisord --help
