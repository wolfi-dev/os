package:
  name: svt-av1
  version: "4.0.1"
  epoch: 0 # go/wolfi-rsc/svt-av1
  description: "Scalable Video Technology for AV1 (SVT-AV1 Encoder)"
  copyright:
    - license: BSD-2-Clause
  resources:
    cpu: "3"
    memory: 12Gi

vars:
  soversion: "4"

environment:
  contents:
    packages:
      - build-base
      - busybox
      - clang
      - cmake
      - nasm
      - samurai
      - yasm

pipeline:
  - uses: git-checkout
    with:
      repository: https://gitlab.com/AOMediaCodec/SVT-AV1.git
      expected-commit: 4ae9272b588a05ee6e77a43e8dfdac05f54c4ff0
      tag: v${{package.version}}

  - runs: ln -s /usr/lib/llvm-19/lib/LLVMgold.so /usr/lib/LLVMgold.so

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_COMPILER=clang \
        -DCMAKE_CXX_COMPILER=clang++ \

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: libsvtav1enc${{vars.soversion}}
    pipeline:
      - uses: split/lib
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: "${{package.name}}-dev"
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - libsvtav1enc${{vars.soversion}}=${{package.full-version}}
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
          with:
            packages: svt-av1-dev

update:
  enabled: true
  release-monitor:
    identifier: 24271

test:
  pipeline:
    - name: Verify SvtAv1EncApp binary exists
      runs: |
        SvtAv1EncApp --version
        SvtAv1EncApp --help
