From 0f031fc95985661e5993cc9b42504c5f0491f461 Mon Sep 17 00:00:00 2001
From: Zach <zach.marano@chainguard.dev>
Date: Tue, 12 Aug 2025 10:28:47 -0700
Subject: [PATCH] Revert "detect-virt: add bare-metal support for GCE"

This reverts commit fb71571d3a4efddeb44f02939304be9007301974.
---
 src/basic/virt.c | 11 +++--------
 1 file changed, 3 insertions(+), 8 deletions(-)

diff --git a/src/basic/virt.c b/src/basic/virt.c
index 5d36f68..9cd7943 100644
--- a/src/basic/virt.c
+++ b/src/basic/virt.c
@@ -475,9 +475,7 @@ Virtualization detect_vm(void) {
                     * for non-x86 architectures due to its necessity for cpuid
                     * detection, which functions solely on x86 platforms. Report
                     * as a VM for other architectures. */
-#if !defined(__i386__) && !defined(__x86_64__)
                    VIRTUALIZATION_GOOGLE,
-#endif
                    VIRTUALIZATION_PARALLELS)) {
                 v = dmi;
                 goto finish;
@@ -514,10 +515,6 @@ Virtualization detect_vm(void) {
                 hyperv = true;
         else if (v == VIRTUALIZATION_VM_OTHER)
                 other = true;
-        else if (v == VIRTUALIZATION_KVM && dmi == VIRTUALIZATION_GOOGLE)
-                /* The DMI vendor tables in /sys/class/dmi/id don't help us distinguish between GCE
-                 * virtual machines and bare-metal instances, so we need to look at hypervisor. */
-                return VIRTUALIZATION_GOOGLE;
         else if (v != VIRTUALIZATION_NONE)
                 goto finish;
 
@@ -530,9 +527,7 @@ Virtualization detect_vm(void) {
                 return dmi;
         if (dmi == VIRTUALIZATION_VM_OTHER)
                 other = true;
-        else if (!IN_SET(dmi, VIRTUALIZATION_NONE, VIRTUALIZATION_GOOGLE)) {
-                /* At this point if GCE has been detected in dmi, do not report as a VM. It should
-                 * be a bare-metal machine */
+        else if (dmi != VIRTUALIZATION_NONE) {
                 v = dmi;
                 goto finish;
         }
-- 
2.48.1

