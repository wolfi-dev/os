package:
  name: teleport-18
  version: "18.6.6"
  epoch: 0 # go/wolfi-rsc/teleport-18
  description: The easiest, and most secure way to access and protect all of your infrastructure.
  copyright:
    - license: AGPL-3.0-only
  dependencies:
    runtime:
      - posix-libc-utils # getent
    provides:
      - teleport=${{package.full-version}}
  resources:
    cpu: "16"
    memory: 34Gi

environment:
  contents:
    packages:
      - autoconf
      - automake
      - binaryen
      - build-base
      - busybox
      - ca-certificates-bundle
      - cargo-auditable
      - corepack
      - go
      - node-gyp
      - nodejs-22
      - npm
      - openssl-dev
      - pnpm
      - python3
      - rust
      - rustup
      - wasm-pack
      - yarn
      - zstd-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/gravitational/teleport
      expected-commit: 6750243da7b8aa8a59b00ade968efa8748966656
      tag: v${{package.version}}

  # Fixes build failure introduced with 17.0.5 version:
  # "([wasm-validator error in function fastpathprocessor_process\20externref\20shim]
  # unexpected false: table.fill requires bulk-memory [--enable-bulk-memory])"
  # Should be able to remove this patch once the following issue is resolved:
  # https://github.com/gravitational/teleport/issues/50194
  - uses: patch
    with:
      patches: bulk-memory.patch

  - runs: |
      mkdir -p "${{targets.contextdir}}"/var/lib/teleport
      mkdir -p "${{targets.contextdir}}"/usr/local/bin

      rustup install stable
      rustup default stable
      ARCH=$(uname -m)
      export PATH="$HOME/.rustup/toolchains/stable-${ARCH}-unknown-linux-gnu/bin:$PATH"
      rustup target add wasm32-unknown-unknown

      corepack enable
      pnpm config set package-import-method copy

      # Install dependencies and build web assets
      make ensure-wasm-bindgen FORCE=true
      export PATH="$HOME/.cargo/bin:$PATH"
      make ensure-js-deps
      make ensure-webassets

  - uses: go/build
    with:
      packages: ./tool/teleport
      prefix: usr/local
      output: ./
      tags: webassets_embed,kustomize_disable_go_plugin_support

  - uses: go/build
    with:
      packages: ./tool/tctl ./tool/tsh ./tool/tbot ./tool/teleport-update
      prefix: usr/local
      output: ./
      tags: kustomize_disable_go_plugin_support

  - runs: |
      cd tool/fdpass-teleport && cargo auditable build --release --locked
      install -Dm755 target/release/fdpass-teleport "${{targets.contextdir}}"/usr/local/bin/

  - uses: strip

subpackages:
  - name: ${{package.name}}-kube-agent-updater
    description: Kubernetes agent updater for Teleport
    dependencies:
      provides:
        - teleport-kube-agent-updater=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          packages: ./integrations/kube-agent-updater/cmd/teleport-kube-agent-updater
          output: teleport-kube-agent-updater
    test:
      environment:
        contents:
          packages:
            - curl
        environment:
          METRICS_PORT: "8080"
          HEALTHZ_PORT: "8081"
          KUBERNETES_SERVICE_HOST: "127.0.0.1"
          KUBERNETES_SERVICE_PORT: "32764"
      pipeline:
        - uses: test/tw/help-check
          with:
            bins: teleport-kube-agent-updater
        - uses: test/kwok/cluster
        - uses: test/daemon-check-output
          with:
            start: |
              teleport-kube-agent-updater \
                --agent-name=test-agent \
                --agent-namespace=default \
                --metrics-addr=:${METRICS_PORT} \
                --healthz-addr=:${HEALTHZ_PORT} \
                --disable-leader-election \
                --insecure-no-verify-image \
                --insecure-no-resolve-image
            timeout: 30
            expected_output: |
              Starting Controller
            post: |-
              set -o pipefail
              # curl -sf fails on non-2xx responses, so no need to grep the body
              curl -sf http://localhost:${HEALTHZ_PORT}/healthz | grep -F "ok"
              curl -sf http://localhost:${HEALTHZ_PORT}/readyz | grep -F "ok"
              curl -sf http://localhost:${METRICS_PORT}/metrics | grep -F "go_info"

  - name: ${{package.name}}-kube-agent-updater-compat
    description: Compatibility package for teleport-kube-agent-updater
    dependencies:
      runtime:
        - ${{package.name}}-kube-agent-updater
      provides:
        - teleport-kube-agent-updater-compat=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/"
          ln -sf ./usr/bin/teleport-kube-agent-updater "${{targets.contextdir}}/teleport-kube-agent-updater"
    test:
      pipeline:
        - uses: test/tw/symlink-check

  - name: ${{package.name}}-operator
    description: Kubernetes operator for managing Teleport resources
    dependencies:
      provides:
        - teleport-operator=${{package.full-version}}
    pipeline:
      - uses: go/build
        with:
          packages: ./integrations/operator
          output: teleport-operator
          tags: kustomize_disable_go_plugin_support
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}
            - wait-for-it
            - curl
        environment:
          METRICS_PORT: "8080"
          HEALTH_PORT: "8081"
      pipeline:
        - uses: test/tw/help-check
          with:
            bins: teleport-operator
            expect-contains: "namespace metrics-bind-address health-probe-bind-address log-level"
        - uses: test/kwok/cluster
        - name: "Functional test with live Teleport auth server"
          uses: test/daemon-check-output
          with:
            setup: |
              set -euo pipefail
              mkdir -p /tmp/teleport /var/lib/teleport

              # Create Teleport auth server config
              tee /tmp/teleport-auth.yaml << 'EOF'
              version: v3
              teleport:
                data_dir: /tmp/teleport
                log:
                  output: stderr
                  severity: INFO
              auth_service:
                enabled: "yes"
                cluster_name: "test-cluster"
                listen_addr: 127.0.0.1:3025
              proxy_service:
                enabled: "no"
              ssh_service:
                enabled: "no"
              EOF

              # Initialize Teleport with static UUID
              echo "00000000-0000-0000-0000-000000000000" > /var/lib/teleport/host_uuid
              chmod 644 /var/lib/teleport/host_uuid

              teleport start --config=/tmp/teleport-auth.yaml --roles=auth &
              TELEPORT_PID=$!
              echo $TELEPORT_PID > /tmp/teleport.pid

              wait-for-it 127.0.0.1:3025 -t 60

              tee /tmp/teleport-resources.yaml << 'EOF'
              kind: role
              metadata:
                name: operator
              spec:
                allow:
                  rules:
                    - resources: [role, user]
                      verbs: [list, create, read, update, delete]
                deny: {}
              version: v7
              ---
              kind: bot
              version: v1
              metadata:
                name: operator
              spec:
                roles:
                  - operator
              ---
              kind: token
              version: v2
              metadata:
                name: operator-bot-token
              spec:
                roles:
                  - Bot
                bot_name: operator
                join_method: token
              EOF

              # Retry creating teleport resources (up to 30 seconds)
              for i in $(seq 1 30); do
                if tctl --config=/tmp/teleport-auth.yaml create -f /tmp/teleport-resources.yaml; then
                  break
                fi
                sleep 1
              done

              mkdir -p ~/.kube
              cp $HOME/.kwok/clusters/kwok/kubeconfig.yaml ~/.kube/config

              # Install the TeleportRole CRD (minimal CRD for testing)
              kubectl apply -f https://raw.githubusercontent.com/gravitational/teleport/v${{package.version}}/integrations/operator/config/crd/bases/resources.teleport.dev_roles.yaml
              kubectl wait --for=condition=Established --timeout=30s crd/teleportroles.resources.teleport.dev
            start: |
              teleport-operator \
                -auth-server 127.0.0.1:3025 \
                -join-method token \
                -token operator-bot-token \
                -insecure \
                -namespace default \
                -metrics-bind-address ":${METRICS_PORT}" \
                -health-probe-bind-address ":${HEALTH_PORT}"
            timeout: 90
            expected_output: |
              starting manager
            error_strings: |
              FATAL
              panic:
              Traceback.*most.recent.call
              Exception in thread
              command not found
              unable to build tbot
              tbot preflight checks failed
            post: |
              set -o pipefail
              wait-for-it "localhost:${HEALTH_PORT}" -t 30
              curl -fsS "http://localhost:${HEALTH_PORT}/healthz"
              curl -fsS "http://localhost:${METRICS_PORT}/metrics" | grep -F "controller_runtime"

              # Clean up background processes started in setup (required for QEMU runner)
              pkill -x teleport || true

  - name: ${{package.name}}-operator-compat
    description: Compatibility package for teleport-operator
    dependencies:
      runtime:
        - ${{package.name}}-operator
      provides:
        - teleport-operator-compat=${{package.full-version}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/"
          ln -sf ./usr/bin/teleport-operator "${{targets.contextdir}}/teleport-operator"
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-operator
      pipeline:
        - uses: test/tw/symlink-check

update:
  enabled: true
  ignore-regex-patterns:
    - ".*alpha.*"
    - ".*beta.*"
    - ".*dev.*"
    - ".*rc.*"
    - ".*gus.*"
    - ".*wasm.*"
    - ".*fred.*"
    - ".*ldapbind.*"
  git:
    strip-prefix: v
    tag-filter-prefix: v18.

test:
  environment:
    contents:
      packages:
        - wait-for-it
        - curl
  pipeline:
    - name: Check binary versions
      runs: |
        tbot version
        tbot --help
        tctl version
        tctl --help
        teleport version
        teleport --help
        tsh version
        tsh --help
    - name: Test auth service and tctl
      runs: |
        #!/bin/bash
        set -e

        # Create required directories
        mkdir -p /tmp/teleport
        mkdir -p /var/lib/teleport

        # Create minimal config file for auth server
        cat <<-EOF > /tmp/teleport-auth.yaml
        version: v3
        teleport:
          data_dir: /tmp/teleport
          log:
            output: stderr
            severity: DEBUG
        auth_service:
          enabled: "yes"
          cluster_name: "test-cluster"
          listen_addr: 127.0.0.1:3025
          tokens:
            - "proxy,node:test123"
        proxy_service:
          enabled: "no"
        ssh_service:
          enabled: "no"
        EOF

        # Initialize auth server with static UUID for tctl
        echo "00000000-0000-0000-0000-000000000000" > /var/lib/teleport/host_uuid
        chmod 644 /var/lib/teleport/host_uuid

        # Start auth server
        teleport start --config=/tmp/teleport-auth.yaml --roles=auth > /dev/null 2>&1 &
        AUTH_PID=$!

        # Wait for auth server
        wait-for-it 127.0.0.1:3025 -t 30 || (kill $AUTH_PID; exit 1)

        # Give auth server time to initialize
        sleep 5

        # Test tctl
        TCTL_CONFIG=$(base64 /tmp/teleport-auth.yaml)
        TELEPORT_CONFIG="$TCTL_CONFIG" tctl get roles --format=text

        echo "Auth service test successful!"
        kill $AUTH_PID
    - name: Test proxy service
      runs: |
        #!/bin/bash
        set -e

        # Create required directories
        mkdir -p /tmp/teleport-auth /tmp/teleport-proxy

        # Create auth server config
        cat <<-EOF > /tmp/teleport-auth.yaml
        version: v3
        teleport:
          data_dir: /tmp/teleport-auth
          log:
            output: stderr
            severity: DEBUG
        auth_service:
          enabled: "yes"
          cluster_name: "test-cluster"
          listen_addr: 127.0.0.1:3025
          tokens:
            - "proxy,node:test123"
        proxy_service:
          enabled: "no"
        ssh_service:
          enabled: "no"
        EOF

        # Create proxy config
        cat <<-EOF > /tmp/teleport-proxy.yaml
        version: v3
        teleport:
          data_dir: /tmp/teleport-proxy
          auth_token: "test123"
          auth_server: "127.0.0.1:3025"
        proxy_service:
          enabled: "yes"
          web_listen_addr: "127.0.0.1:3080"
          listen_addr: "127.0.0.1:3023"
        auth_service:
          enabled: "no"
        ssh_service:
          enabled: "no"
        EOF

        # Start auth server
        teleport start --config=/tmp/teleport-auth.yaml --roles=auth > /dev/null 2>&1 &
        AUTH_PID=$!

        # Wait for auth server
        wait-for-it 127.0.0.1:3025 -t 30 || (kill $AUTH_PID; exit 1)

        # Start proxy
        teleport start --config=/tmp/teleport-proxy.yaml --roles=proxy > /dev/null 2>&1 &
        PROXY_PID=$!

        # Wait for proxy
        wait-for-it 127.0.0.1:3080 -t 30 || (kill $AUTH_PID $PROXY_PID; exit 1)

        # Test proxy web interface with HTTPS
        HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" https://127.0.0.1:3080/webapi/ping)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Proxy web interface test failed with HTTP code: $HTTP_CODE"
          kill $AUTH_PID $PROXY_PID
          exit 1
        fi

        echo "Proxy test successful!"
        kill $AUTH_PID $PROXY_PID
