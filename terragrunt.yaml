package:
  name: terragrunt
  version: "0.93.10"
  epoch: 0 # GHSA-jc7w-c686-c4v9
  description: Thin wrapper for Terraform providing extra tools
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - terraform

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go
      - mockery~2
      - mockgen

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 25150a61693db8edb1a5eeb173d4de20c2ec25ab
      repository: https://github.com/gruntwork-io/terragrunt
      tag: v${{package.version}}

  - runs: go generate ./...

  - uses: go/build
    with:
      output: terragrunt
      packages: .
      ldflags: "-X  github.com/gruntwork-io/go-commons/version.Version=v${{package.version}}"

  - uses: strip

test:
  pipeline:
    - name: Smoke test
      runs: |
        terragrunt --version
        terragrunt --help
    - name: Create terraform module fixtures
      working-directory: /tmp/terragrunt/modules/example
      runs: |
        cat >versions.tf <<'EOF'
        terraform {
          required_version = ">= 1.0"
          required_providers {
            null = {
              source  = "hashicorp/null"
              version = ">= 3.0"
            }
          }
          backend "local" {}
        }
        EOF
        cat >variables.tf <<'EOF'
        variable "example_input" {
          type = string
        }
        EOF
        cat >main.tf <<'EOF'
        resource "null_resource" "example" {
          triggers = {
            example_input = var.example_input
          }
        }
        EOF
    - name: Create terragrunt fixtures
      working-directory: /tmp/terragrunt/envs/test
      runs: |
        cat >terragrunt.hcl <<EOF
        terraform {
          source = "../../modules/example"
        }

        inputs = {
          example_input = "hello-from-terragrunt-test"
        }
        EOF
    - name: Test plan
      working-directory: /tmp/terragrunt/envs/test
      runs: |
        terragrunt plan -out=plan.tfplan -input=false
    - name: Test validate
      working-directory: /tmp/terragrunt/envs/test
      runs: |
        echo "}" >>terragrunt.hcl
        set +e
        terragrunt validate
        exit=$?
        set -e
        test "${exit}" == "1"
        sed -i '$d' terragrunt.hcl
        terragrunt validate
    - name: Test hcl format
      working-directory: /tmp/terragrunt/envs/test
      runs: |
        sed -i 's|  source|source|g' terragrunt.hcl
        set +e
        terragrunt hcl fmt --check
        exit=$?
        set -e
        test "${exit}" == "1"
        terragrunt hcl fmt
        terragrunt hcl fmt --check

update:
  enabled: true
  github:
    identifier: gruntwork-io/terragrunt
    strip-prefix: v
    use-tag: true
    tag-filter: v
