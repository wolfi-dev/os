package:
  name: tflint
  version: "0.61.0"
  epoch: 0 # GHSA-4c4x-jm2x-pf9j
  description: A Pluggable Terraform Linter
  copyright:
    - license: MPL-2.0
  resources:
    cpu: "3"
    memory: 7Gi

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/terraform-linters/tflint.git
      tag: v${{package.version}}
      expected-commit: c604bd634554b29602eae507e5a75baebb6365bf

  - uses: go/build
    with:
      packages: .
      output: tflint

  - uses: strip

update:
  enabled: true
  github:
    identifier: terraform-linters/tflint
    use-tag: true
    strip-prefix: v

subpackages:
  - name: ${{package.name}}-compat
    description: Compatibility symlink for upstream image
    dependencies:
      runtime:
        - ${{package.name}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/local/bin"
          ln -s ../../bin/tflint "${{targets.subpkgdir}}/usr/local/bin/tflint"
    test:
      pipeline:
        - uses: test/tw/symlink-check

test:
  pipeline:
    - uses: test/tw/help-check
      with:
        bins: tflint
    - uses: test/tw/ver-check
      with:
        bins: tflint
    - runs: |
        tflint --init
        touch main.tf
        # --force flag so it exits with 0
        tflint --force | grep -F -e "terraform_required_version"

        tee main.tf <<'EOF'
        terraform {
          required_version = ">= 1.0"
        }
        locals {
          map   = { a = 0 }
          value = lookup(local.map, "a")
        }
        EOF
        tflint --force | grep -F -e "terraform_deprecated_lookup"
        tflint --fix --force
        sed -n '4p' main.tf | grep -F -e "locals {"
        sed -n '5p' main.tf | grep -F -e "}"
