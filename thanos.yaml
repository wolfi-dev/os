package:
  name: thanos
  version: "0.38.0"
  epoch: 3
  description: Highly available Prometheus setup with long term storage capabilities.
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - bash
      - busybox
      - ca-certificates-bundle
      - curl
      - go

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 0439da0dd291735c36bb515c03e9dfa0012c76c9
      repository: https://github.com/thanos-io/thanos
      tag: v${{package.version}}

  - uses: go/bump
    with:
      deps: |-
        golang.org/x/oauth2@v0.27.0
        github.com/golang-jwt/jwt/v5@v5.2.2
        golang.org/x/net@v0.39.0

  - uses: go/build
    with:
      packages: ./cmd/thanos
      output: thanos
      tags: netgo
      ldflags: |
        -X github.com/prometheus/common/version.Version=${{package.version}}
        -X github.com/prometheus/common/version.Revision=$(git rev-parse HEAD)
        -X github.com/prometheus/common/version.BuildDate=$(date -d @$SOURCE_DATE_EPOCH +%Y%m%d-%H:%M:%S)

update:
  enabled: true
  ignore-regex-patterns:
    - rc*
  github:
    identifier: thanos-io/thanos
    strip-prefix: v
    tag-filter: v

test:
  environment:
    contents:
      packages:
        - curl
  pipeline:
    # AUTOGENERATED
    - runs: |
        VERSION_OUTPUT=$(thanos --version 2>&1)
        echo "$VERSION_OUTPUT" | grep "version ${{ package.version }}"
        thanos --help
        thanos query --help
        thanos sidecar --help
        thanos tools bucket verify --help
    - name: Validate thanos with local filesystem
      uses: test/daemon-check-output
      with:
        setup: |
          mkdir -p /tmp/bucket-test
          echo "placeholder" > /tmp/bucket-test/obj1.txt

          cat <<EOF > /tmp/filesystem.yaml
          type: FILESYSTEM
          config:
            directory: /tmp/bucket-test
          EOF
        start: thanos tools bucket verify --objstore.config-file=/tmp/filesystem.yaml
        timeout: 30
        expected_output: |
          started verifying issue
          loading bucket configuration
          verify task completed
    - name: Launch Thanos Query
      uses: test/daemon-check-output
      with:
        setup: |
          mkdir -p /tmp/data
        start: thanos query --http-address=127.0.0.1:19192 --log.level=debug
        timeout: 30
        expected_output: |
          starting query node
          changing probe status
          listening for requests and metrics
          Listening on
        post: |
          if curl -sf --retry 5 http://127.0.0.1:19192/-/healthy; then
            echo "Thanos query is healthy"
          else
            echo "Thanos query is not healthy"
          fi
