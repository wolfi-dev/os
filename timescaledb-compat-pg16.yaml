#nolint:valid-pipeline-git-checkout-tag
package:
  name: timescaledb-compat-pg16
  version: "2.20.3"
  epoch: 0
  description: A time-series database for high-performance real-time analytics packaged as a Postgres extension.
  # Outside of the "tsl" directory, source code in a given file is licensed under the Apache License Version 2.0
  # We are only building the opensource bits here.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - git
      - postgresql-${{vars.pg-version}}
      - postgresql-${{vars.pg-version}}-client
      - timescaledb-parallel-copy
      - timescaledb-tune

environment:
  contents:
    packages:
      - build-base
      - busybox
      - cmake
      - postgresql-${{vars.pg-version}}
      - postgresql-${{vars.pg-version}}-dev

vars:
  pg-version: 16

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/timescale/timescaledb
      tag: ${{package.version}}
      expected-commit: 7b30533d4d9b6ce1353b8bac0ba6215be20f2633

  - uses: cmake/configure
    with:
      opts: |
        -DAPACHE_ONLY=ON \
        -DPG_CONFIG=/usr/bin/pg_config

  - uses: cmake/build

  - uses: cmake/install

  - uses: git-checkout
    with:
      repository: https://github.com/timescale/timescaledb-docker
      branch: main
      expected-commit: d6339b0f6f8cb0c41c4eb2087034557fda7fb2f1

  - runs: |
      mkdir -p ${{targets.contextdir}}/docker-entrypoint-initdb.d
      cp docker-entrypoint-initdb.d/* ${{targets.contextdir}}/docker-entrypoint-initdb.d/
      rm -f $(pg_config --pkglibdir)/timescaledb-tsl-*.so
      rm -rf ${{targets.contextdir}}/build

test:
  environment:
    contents:
      packages:
        - postgresql-${{vars.pg-version}}-client
        - shadow
        - sudo-rs
    environment:
      PGUSER: wolfi
  pipeline:
    - name: Check postgres version
      runs: |
        postgres --version
        psql --version
    - name: Check extension control file
      runs: |
        ls $(pg_config --sharedir)/extension/timescaledb.control
    - name: Create database and load extension
      runs: |
        useradd $PGUSER
        sudo -u $PGUSER initdb -D /tmp/test_db
        echo "shared_preload_libraries = 'timescaledb'" >> /tmp/test_db/postgresql.conf
        sudo -u $PGUSER pg_ctl -D /tmp/test_db -o "-c unix_socket_directories='/tmp'" -l /tmp/logfile start
        createdb -h /tmp testdb
        psql -h /tmp -d testdb -c "CREATE TABLE test_table (time TIMESTAMPTZ, value INT);"
        psql -d testdb -c "CREATE EXTENSION timescaledb;"
        sudo -u $PGUSER pg_ctl -D /tmp/test_db -m fast stop
    - name: Test CLI tools
      runs: |
        timescaledb-tune --version
        timescaledb-parallel-copy --help

update:
  enabled: true
  github:
    identifier: timescale/timescaledb
