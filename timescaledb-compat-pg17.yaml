package:
  name: timescaledb-compat
  version: "2.20.3"
  epoch: 0
  description: A time-series database for high-performance real-time analytics packaged as a Postgres extension.
  # Outside of the "tsl" directory, source code in a given file is licensed under the Apache License Version 2.0
  # We are only building the opensource bits here.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - git
      - postgresql-${{vars.pg-version}}
      - postgresql-${{vars.pg-version}}-client
      - timescaledb-parallel-copy
      - timescaledb-tune

environment:
  contents:
    packages:
      - build-base
      - busybox
      - cmake
      - postgresql-${{vars.pg-version}}
      - postgresql-${{vars.pg-version}}-dev

vars:
  pg-version: 17

# user must add shared_preload_libraries = 'timescaledb':
pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/timescale/timescaledb
      tag: ${{package.version}}
      expected-commit: 7b30533d4d9b6ce1353b8bac0ba6215be20f2633
  - uses: cmake/configure
    with:
      opts: |
        -DAPACHE_ONLY=ON \
        -DPG_CONFIG=/usr/bin/pg_config
  - uses: cmake/build
  - uses: cmake/install
  - uses: git-checkout
    with:
      repository: https://github.com/timescale/timescaledb-docker
      expected-commit: d6339b0f6f8cb0c41c4eb2087034557fda7fb2f1
  - runs: |
      mkdir -p ${{targets.contextdir}}/docker-entrypoint-initdb.d
      cp docker-entrypoint-initdb.d/* ${{targets.contextdir}}/docker-entrypoint-initdb.d/
      rm -f $(pg_config --pkglibdir)/timescaledb-tsl-*.so
      rm -rf ${{targets.contextdir}}/build

test:
  environment:
    contents:
      packages:
        - postgresql-client
  pipeline:
    - name: Check postgres version
      runs: |
        postgres --version
        psql --version
    - name: Check extension control file
      runs: |
        ls $(pg_config --sharedir)/extension/timescaledb.control
    - name: Create database and load extension
      runs: |
        mkdir /tmp/pgtest
        initdb -D /tmp/pgtest
        echo "shared_preload_libraries = 'timescaledb'" >> /tmp/pgtest/postgresql.conf
        pg_ctl -D /tmp/pgtest -o "-c listen_addresses=''" -w start
        createdb testdb
        psql -d testdb -c "CREATE EXTENSION timescaledb;"
        pg_ctl -D /tmp/pgtest -m fast stop
    - name: Test CLI tools
      runs: |
        timescaledb-tune --version
        timescaledb-parallel-copy --help
