package:
  name: tomcat-11.0
  version: "11.0.16"
  epoch: 0
  description: Apache Tomcat Web Server
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - tomcat=${{package.full-version}}
      - tomcat-11=${{package.full-version}}

data:
  - name: openjdk-versions
    items:
      25:
      21:
      17:

vars:
  # This is the version of OpenJDK actually used for building
  target-jdk-version: 25

environment:
  contents:
    packages:
      - ant
      - busybox
      - openjdk-${{vars.target-jdk-version}}

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/tomcat
      tag: ${{package.version}}
      expected-commit: f2a18d2aa892941e91e214f954a5ee31d60093ed

  - runs: |
      tee build.properties <<EOF
      skip.installer=true
      base.path=$PWD
      compile.debug=false
      EOF

subpackages:
  - range: openjdk-versions
    name: ${{package.name}}-openjdk-${{range.key}}
    dependencies:
      runtime:
        - openjdk-${{range.key}}-default-jvm
        - tomcat-native
    pipeline:
      - environment:
          JAVA_HOME: /usr/lib/jvm/java-${{vars.target-jdk-version}}-openjdk
        runs: |
          ant -Dskip.build.java.version=true

          install -Dpm0644 -t "${{targets.subpkgdir}}/usr/share/tomcat/" LICENSE
          install -Dpm0755 -t "${{targets.subpkgdir}}/usr/share/tomcat/bin/" output/build/bin/*
          install -Dpm0644 -t "${{targets.subpkgdir}}/usr/share/tomcat/conf/" output/build/conf/*
          install -Dpm0644 -t "${{targets.subpkgdir}}/usr/share/tomcat/lib/" output/build/lib/*

          install -d ${{targets.subpkgdir}}/usr/share/tomcat/logs \
            ${{targets.subpkgdir}}/usr/share/tomcat/temp \
            ${{targets.subpkgdir}}/usr/share/tomcat/webapps

          # This includes the manager and host-manager apps.
          # The apps are not directly usable without copying into the webapps directory.
          # See https://github.com/docker-library/tomcat/pull/181 for more context.
          mkdir -p ${{targets.contextdir}}/usr/share/tomcat/webapps.dist
          rm -rf output/build/webapps/examples
          cp -r output/build/webapps/* ${{targets.contextdir}}/usr/share/tomcat/webapps.dist/
    test:
      environment:
        contents:
          packages:
            - curl
            - wait-for-it
      pipeline:
        - uses: test/tw/ver-check
          with:
            bins: /usr/share/tomcat/bin/version.sh
            version-flag: " "
            version: "Server version: Apache Tomcat/${{package.version}}"
        - name: Test Tomcat catalina.sh with OpenJDK ${{range.key}}
          environment:
            JAVA_HOME: /usr/lib/jvm/java-${{range.key}}-openjdk
            LD_LIBRARY_PATH: /usr/lib/tomcat-native
          uses: test/daemon-check-output
          with:
            setup: cp /usr/share/tomcat/webapps.dist/docs/appdev/sample/sample.war /usr/share/tomcat/webapps/
            start: /usr/share/tomcat/bin/catalina.sh run
            expected_output: |
              Tomcat/${{package.version}}
              JVM.Version
              Deploying.*sample.war
              Server startup in
            post: |
              wait-for-it localhost:8080
              curl "http://localhost:8080/sample/" | grep -F -e "Sample \"Hello, World\" Application"
        - name: Test Tomcat startup.sh with OpenJDK ${{range.key}}
          environment:
            CATALINA_HOME: /usr/share/tomcat
            CATALINA_BASE: /usr/share/tomcat
            LD_LIBRARY_PATH: /usr/lib/tomcat-native
            JAVA_HOME: /usr/lib/jvm/java-${{range.key}}-openjdk
          uses: test/daemon-check-output
          with:
            start: /usr/share/tomcat/bin/startup.sh
            expected_output: |
              Tomcat started.
            post: |
              wait-for-it localhost:8080
              curl "http://localhost:8080/" | grep -F -e "Apache Tomcat"

update:
  enabled: true
  ignore-regex-patterns:
    - '-M\d+$'
  github:
    identifier: apache/tomcat
    use-tag: true
    tag-filter: 11.0.

test:
  pipeline:
    - uses: test/emptypackage
