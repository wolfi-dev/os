package:
  name: topgrade
  version: "16.0.3"
  epoch: 1
  description: Detects which tools you use and runs the appropriate commands to update them
  copyright:
    - license: GPL-3.0-or-later

environment:
  contents:
    packages:
      - build-base
      - busybox
      - cargo-auditable
      - rust

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/topgrade-rs/topgrade
      tag: v${{package.version}}
      expected-commit: 4488f3d5d3c7b907ec3dc9747a1aabce23d8ebc7

  - uses: rust/cargobump

  - runs: |
      # Build topgrade
      cargo fetch --locked
      cargo auditable build --release --frozen

      # Generate shell completions
      target/release/topgrade --gen-completion bash > topgrade.bash
      target/release/topgrade --gen-completion fish > topgrade.fish
      target/release/topgrade --gen-completion zsh > _topgrade

      # Generate manpages
      target/release/topgrade --gen-manpage > topgrade.8

      # Install topgrade
      install -Dm755 target/release/topgrade "${{targets.destdir}}"/usr/bin/topgrade

      # License
      install -Dm644 LICENSE "${{targets.destdir}}"/usr/share/license/topgrade/LICENSE

      # Shell completions
      install -Dm644 topgrade.bash "${{targets.destdir}}"/usr/share/bash-completion/completions/topgrade
      install -Dm644 topgrade.fish "${{targets.destdir}}"/usr/share/fish/vendor_completions.d/topgrade.fish
      install -Dm644 _topgrade "${{targets.destdir}}"/usr/share/zsh/site-functions/_topgrade

      # Documentation
      install -Dm644 config.example.toml "${{targets.destdir}}"/usr/share/doc/topgrade/config.example.toml
      install -Dm644 topgrade.8 "${{targets.destdir}}"/usr/share/man/man8/topgrade.8

  - uses: strip

subpackages:
  - name: topgrade-bash-completion
    description: bash completion for topgrade
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/bash-completion/completions"
          mv "${{targets.destdir}}/usr/share/bash-completion/completions/topgrade" \
            "${{targets.subpkgdir}}/usr/share/bash-completion/completions/topgrade"
          rm -rf "${{targets.destdir}}/usr/share/bash-completion"

  - name: topgrade-zsh-completion
    description: zsh completion for topgrade
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/zsh/site-functions"
          mv "${{targets.destdir}}/usr/share/zsh/site-functions/_topgrade" \
            "${{targets.subpkgdir}}/usr/share/zsh/site-functions/_topgrade"
          rm -rf "${{targets.destdir}}/usr/share/zsh"

  - name: topgrade-fish-completion
    description: fish completion for topgrade
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/usr/share/fish/vendor_completions.d"
          mv "${{targets.destdir}}/usr/share/fish/vendor_completions.d/" \
            "${{targets.subpkgdir}}/usr/share/fish/vendor_completions.d"
          rm -rf "${{targets.destdir}}/usr/share/fish"

  - name: topgrade-doc
    pipeline:
      - uses: split/manpages
    description: topgrade manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: topgrade-rs/topgrade
    use-tag: true
    strip-prefix: v

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        topgrade --version
        topgrade --help
