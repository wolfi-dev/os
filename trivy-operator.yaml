package:
  name: trivy-operator
  version: "0.25.0"
  epoch: 13
  description: "Kubernetes-native security toolkit that finds and reports vulnerabilities and misconfigurations"
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - ca-certificates
      - trivy
      - tzdata

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/aquasecurity/trivy-operator
      tag: v${{package.version}}
      expected-commit: 0816542808e81dc318a34a1ce8a5cd004c59dfdd

  - uses: go/build
    with:
      packages: "./cmd/trivy-operator"
      output: trivy-operator
      ldflags: |-
        -X github.com/aquasecurity/trivy-operator/pkg/operator.buildVersion=${{package.version}}
        -X github.com/aquasecurity/trivy-operator/pkg/operator.buildCommit=melange-build
        -X github.com/aquasecurity/trivy-operator/pkg/operator.buildDate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

update:
  enabled: true
  github:
    identifier: aquasecurity/trivy-operator
    strip-prefix: v

test:
  environment:
    environment:
      OPERATOR_NAMESPACE: "trivy-system"
      KUBERNETES_SERVICE_HOST: "127.0.0.1"
      KUBERNETES_SERVICE_PORT: "32764"
    contents:
      packages:
        - ${{package.name}}
  pipeline:
    - name: "Basic binary verification"
      runs: |
        # Check that the binary exists and has correct permissions
        if [ ! -x /usr/bin/trivy-operator ]; then
          echo "Error: trivy-operator binary not found or not executable"
          exit 1
        fi

        # Simple version check (may still fail with connection error but should show version)
        if ! /usr/bin/trivy-operator version 2>&1 | grep -q "Starting operator"; then
          echo "Error: Binary doesn't produce expected startup message"
          exit 1
        fi

        echo "Basic binary verification passed"
    - uses: test/kwok/cluster
    - uses: test/daemon-check-output
      with:
        timeout: 60
        start: /usr/bin/trivy-operator
        expected_output: |
          Starting operator
          Resolved install mode
          Watching all namespaces
