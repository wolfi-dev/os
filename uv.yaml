package:
  name: uv
  version: "0.10.4"
  epoch: 0 # GHSA-h395-gr6q-cpjc
  description: An extremely fast Python package installer and resolver, written in Rust.
  copyright:
    - license: MIT
  resources:
    cpu: "12"
    memory: 19Gi

vars:
  build-pypi-package: uv-build
  build-module-name: uv_build

data:
  - name: py-versions
    items:
      3.10: '310'
      3.11: '311'
      3.12: '312'
      3.13: '313'

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cargo-auditable
      - clang
      - cmake
      - maturin
      - openssl-dev
      - perl
      - py3-supported-build-base
      - py3-supported-maturin
      - rust

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/astral-sh/uv
      tag: ${{package.version}}
      expected-commit: 079e3fd059c3d073151a6ac3b39eb129d66b517d
      destination: uv

  # This is needed until https://github.com/apache/opendal-reqsign/pull/689 is merged
  # That project makes a release; and then uv upgrades as well
  - uses: patch
    working-directory: uv
    with:
      patches: |
        ../0001-uv-patch-dependencies.patch

  - uses: git-checkout
    with:
      repository: https://github.com/apache/opendal-reqsign
      tag: v0.19.0
      expected-commit: cc77c270da5d3d311b24c5d059e639cc6da0ff96
      destination: opendal-reqsign

  - uses: patch
    working-directory: opendal-reqsign
    with:
      patches: |
        ../0001-cargo-upgrade-jsonwebtoken.patch
        ../0002-Bump-version.patch

  - working-directory: uv
    runs: |
      cargo update
      cargo auditable build --locked --release
      install -Dm755 target/release/uv "${{targets.destdir}}"/usr/bin/uv
      install -Dm755 target/release/uvx "${{targets.destdir}}"/usr/bin/uvx

  - uses: strip

subpackages:
  - range: py-versions
    name: py${{range.key}}-${{vars.build-pypi-package}}
    description: ${{vars.build-pypi-package}} installed for python${{range.key}}
    dependencies:
      provides:
        - py3-${{vars.build-pypi-package}}
      provider-priority: ${{range.value}}
    pipeline:
      - uses: py/pip-build-install
        with:
          python: python${{range.key}}
        working-directory: uv/crates/uv-build
      - name: move usr/bin executables for -bin
        runs: |
          mkdir -p ./cleanup/${{range.key}}/
          mv ${{targets.contextdir}}/usr/bin ./cleanup/${{range.key}}/
      - uses: strip
    test:
      pipeline:
        - uses: python/import
          with:
            python: python${{range.key}}
            import: ${{vars.build-module-name}}

  - range: py-versions
    name: py${{range.key}}-${{vars.build-pypi-package}}-bin
    description: Executable binaries for ${{vars.build-pypi-package}} installed for python${{range.key}}
    dependencies:
      provider-priority: ${{range.value}}
      provides:
        - py3-${{vars.build-pypi-package}}-bin
      runtime:
        - py${{range.key}}-${{vars.build-pypi-package}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/
          mv ./cleanup/${{range.key}}/bin ${{targets.contextdir}}/usr/
    test:
      pipeline:
        - runs: |
            uv-build --help

  - name: py3-supported-${{vars.build-pypi-package}}
    description: meta package providing ${{vars.build-pypi-package}} for supported python versions.
    dependencies:
      runtime:
        - py3.10-${{vars.build-pypi-package}}
        - py3.11-${{vars.build-pypi-package}}
        - py3.12-${{vars.build-pypi-package}}
        - py3.13-${{vars.build-pypi-package}}
    test:
      pipeline:
        - uses: test/metapackage

update:
  enabled: true
  github:
    identifier: astral-sh/uv

test:
  pipeline:
    - name: uv version and help
      runs: |
        uv --version | grep ${{package.version}}
        uvx --version | grep ${{package.version}}
        uv --help
        uvx --help
    - name: uv simple example
      runs: |
        uv init example
        cd example
        uv add ruff
        uv run ruff check
    - name: uv toolings
      runs: |
        uv tool install ruff
        uv venv
        uv python list
