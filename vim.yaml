package:
  name: vim
  version: "9.1.1663"
  epoch: 1
  description: "Improved vi-style text editor"
  copyright:
    - license: Vim
      license-path: LICENSE
    - license: BSD-2-Clause
      license-path: runtime/pack/dist/opt/editorconfig/LICENSE
    - license: MIT
      license-path: src/libvterm/LICENSE
    - license: LGPL-2.1
      license-path: src/xdiff/COPYING
    - license: MIT
      license-path: src/xpm/COPYRIGHT
    - license: Python-2.0
      license-path: runtime/pack/dist/opt/editorconfig/LICENSE.PSF
    - license: BSD-0-Clause
      license-path: runtime/pack/dist/opt/netrw/LICENSE.txt

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - lua5.3-dev
      - ncurses-dev
      - python3-dev
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/vim/vim
      tag: v${{package.version}}
      expected-commit: 836ed5271edc5d5657255662acea01dc2d9939c2

  - runs: |
      # vim seems to manually set FORTIFY_SOURCE=1, and setting both breaks the build
      export CFLAGS=${CFLAGS/-Wp,-D_FORTIFY_SOURCE=3/}
      export CPPFLAGS="$CFLAGS"
      export CXXFLAGS="$CFLAGS"
      ./configure \
        --build=$CBUILD \
        --host=$CHOST \
        --prefix=/usr \
        --enable-luainterp \
        --enable-python3interp=dynamic \
        --without-x \
        --disable-nls \
        --enable-multibyte \
        --enable-gui=no \
        --with-lua-prefix=/usr/lua5.3 \
        --with-compiledby="Wolfi Linux"

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

test:
  pipeline:
    - name: Verify vim installation
      runs: |
        vim --version || exit 1
        ex --version
        ex --help
        rview --version
        rview --help
        rvim --version
        rvim --help
        view --version
        view --help
        vim --help
        vimdiff --version
        vimdiff --help
        xxd --version

subpackages:
  - name: vim-doc
    description: vim docs
    pipeline:
      - uses: split/manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: vim/vim
    strip-prefix: v
    use-tag: true
  schedule:
    period: daily
    reason: upstream project creates a tag for each commit to main
