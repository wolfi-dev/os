package:
  name: wildfly
  version: 35.0.1
  epoch: 0
  description: WildFly Application Server
  copyright:
    - license: Apache-2.0

data:
  - name: openjdk-versions
    items:
      21: "openjdk-21"
      17: "openjdk-17"

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - maven
      - openjdk-17
      - openjdk-21

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/wildfly/wildfly
      tag: ${{package.version}}.Final
      expected-commit: 1ffef94b7a7ababb767b0dd20f7c0d754388ad12

  - runs: |
      export JAVA_HOME="/usr/lib/jvm/java-17-openjdk"
      ./mvnw install -DskipTests -Dskip.docs

subpackages:
  - range: openjdk-versions
    name: ${{package.name}}-${{range.value}}
    dependencies:
      runtime:
        - ${{range.value}}-default-jvm
    pipeline:
      - runs: |
          export JAVA_HOME="/usr/lib/jvm/java-${{range.key}}-openjdk"


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly
          cp dist/target/wildfly-${{package.version}}.Final/LICENSE.txt ${{targets.contextdir}}/usr/share/wildfly/
          cp dist/target/wildfly-${{package.version}}.Final/README.txt ${{targets.contextdir}}/usr/share/wildfly/
          cp dist/target/wildfly-${{package.version}}.Final/copyright.txt ${{targets.contextdir}}/usr/share/wildfly/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/appclient
          cp -r dist/target/wildfly-${{package.version}}.Final/appclient/* ${{targets.contextdir}}/usr/share/wildfly/appclient/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/bin
          cp -r dist/target/wildfly-${{package.version}}.Final/bin/* ${{targets.contextdir}}/usr/share/wildfly/bin/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/docs
          cp -r dist/target/wildfly-${{package.version}}.Final/docs/* ${{targets.contextdir}}/usr/share/wildfly/docs/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain
          cp -r dist/target/wildfly-${{package.version}}.Final/domain/configuration ${{targets.contextdir}}/usr/share/wildfly/domain/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain/tmp


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone
          cp -r dist/target/wildfly-${{package.version}}.Final/standalone/configuration ${{targets.contextdir}}/usr/share/wildfly/standalone/
          cp -r dist/target/wildfly-${{package.version}}.Final/standalone/deployments ${{targets.contextdir}}/usr/share/wildfly/standalone/
          cp -r dist/target/wildfly-${{package.version}}.Final/standalone/lib ${{targets.contextdir}}/usr/share/wildfly/standalone/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone/log
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone/tmp
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone/data


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/modules
          cp -r dist/target/wildfly-${{package.version}}.Final/modules/* ${{targets.contextdir}}/usr/share/wildfly/modules/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/welcome-content
          cp -r dist/target/wildfly-${{package.version}}.Final/welcome-content/* ${{targets.contextdir}}/usr/share/wildfly/welcome-content/


          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/.galleon/
          cp -r dist/target/wildfly-${{package.version}}.Final/.galleon/* ${{targets.contextdir}}/usr/share/wildfly/.galleon/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/.installation/
          cp -r dist/target/wildfly-${{package.version}}.Final/.installation/* ${{targets.contextdir}}/usr/share/wildfly/.installation/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/.well-known/
          cp -r dist/target/wildfly-${{package.version}}.Final/.well-known/* ${{targets.contextdir}}/usr/share/wildfly/.well-known/

          cp dist/target/wildfly-${{package.version}}.Final/jboss-modules.jar ${{targets.contextdir}}/usr/share/wildfly/
    test:
      environment:
        contents:
          packages:
            - curl
      pipeline:
        - name: Test Wildfly with OpenJDK ${{range.key}}
          uses: test/daemon-check-output
          with:
            start: |
              sh -c "
              export JAVA_HOME=/usr/lib/jvm/java-${{range.key}}-openjdk
              /usr/share/wildfly/bin/standalone.sh &
              sleep 10
              "
            timeout: 60
            expected_output: |
              Started server
              Http management interface listening on http://127.0.0.1:9990/management
              Admin console listening on http://127.0.0.1:9990
              JBoss Bootstrap Environment
              JBoss Modules version
              JBOSS_HOME
              WildFly
            post: |
              #!/bin/sh -e
              url=http://localhost:8080
              response=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$response" -ne 200 ]; then
                echo "WildFly instance is not responding correctly"
                exit 1
              fi
              html=$(curl -s "$url")
              if [ -z "$html" ]; then
                echo "Got empty HTML content from $url"
                exit 1
              fi
              echo "$html" | grep -q "Welcome to WildFly" || {
                echo "response from $url did not contain \"Welcome to WildFly\""
                exit 1
              }
              echo "WildFly instance is up"

  - range: openjdk-versions
    name: wildfly-compat-${{range.key}}
    description: "Compatibility package providing /opt/jboss/wildfly and /opt/java/openjdk symlinks"
    dependencies:
      runtime:
        - wildfly-openjdk-${{range.key}}
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/opt/jboss"
          ln -sf /usr/share/wildfly "${{targets.subpkgdir}}/opt/jboss/wildfly"

          mkdir -p "${{targets.subpkgdir}}/opt/java"
          ln -sf /usr/lib/jvm/java-${{range.key}}-openjdk "${{targets.subpkgdir}}/opt/java/openjdk"

update:
  enabled: true
  github:
    identifier: wildfly/wildfly
    strip-suffix: .Final
    tag-filter-contains: .Final
    use-tag: true
