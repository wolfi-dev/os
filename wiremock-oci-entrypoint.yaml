package:
  name: wiremock-oci-entrypoint
  version: 3.12.1.1
  epoch: 0
  description: Wiremock Image entrypoint
  dependencies:
    runtime:
      - bash
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - busybox

# convert 3.12.1.1 to 3.12.1-1
var-transforms:
  - from: ${{package.version}}
    match: ^(\d+\.\d+\.\d+)\.(\d+)$
    replace: ${1}-${2}
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/wiremock/wiremock-docker
      tag: ${{vars.mangled-package-version}}
      expected-commit: a61656bc87397ae7c5f9b9704a4923bf60f9d040

  - name: install entrypoint
    runs: |
      install -m755 docker-entrypoint.sh ${{targets.contextdir}}/docker-entrypoint.sh

update:
  enabled: true
  github:
    identifier: wiremock/wiremock-docker
    use-tag: true

test:
  environment:
    contents:
      packages:
        - wiremock
        - curl
  pipeline:
    - runs: stat /docker-entrypoint.sh
    - name: test wiremock
      uses: test/daemon-check-output
      with:
        start: /docker-entrypoint.sh
        timeout: 60
        expected_output: |
          version
          port
          enable-browser-proxying
        post: |
          curl http://localhost:8080/__admin/health | grep -i "Wiremock is ok"
          curl http://localhost:8080/__admin/health | grep -i "healthy"
