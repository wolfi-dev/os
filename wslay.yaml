package:
  name: wslay
  version: 1.1.1
  epoch: 0
  description: The WebSocket library in C
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - file
      - libtool
      - mtdev-dev
      - nettle-dev
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/tatsuhiro-t/wslay
      tag: release-${{package.version}}
      expected-commit: c9a84aa6df8512584c77c8cd15be9536b89c35aa

  - name: Disable docs
    runs: |
      # Upstream is not compatible with latest py3-sphinx, which build resulting
      # with the error: "AttributeError: 'Sphinx' object has no attribute 'add_stylesheet'"
      # Let's disable docs for now until upstream fixes or someone asks for it.
      sed -i 's/\bdoc\b//g' Makefile.am

  - runs: autoreconf -i

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: wslay-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - wslay
    description: wslay dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
        - uses: test/tw/header-check

update:
  enabled: true
  github:
    identifier: tatsuhiro-t/wslay
    use-tag: true
    strip-prefix: release-

test:
  environment:
    contents:
      packages:
        - wait-for-it
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        set -e
        testclient --help 2>&1 | grep -q "Usage"
    - name: "Test quick tunnel creation"
      uses: test/daemon-check-output
      with:
        start: echoserv 9000
        timeout: 10
        expected_output: |
          listening on
        post: |
          wait-for-it -t 3 --strict localhost:9000 -- echo "echoserv is up"
          # Since its a WS server, it never closes the connection, so we need to kill it after a timeout.
          timeout 5s bash -c 'printf "test\n" | testclient 127.0.0.1 9000 | tr -d "\r"'
