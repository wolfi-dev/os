package:
  name: xdp-tools
  version: 1.5.5
  epoch: 0
  description: Utilities and example programs for use with XDP
  copyright:
    - license: GPL-2.0-only
    - license: LGPL-2.1-or-later
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - bpftool
      - build-base
      - busybox
      - clang
      - emacs
      - libbpf-dev
      - libelf
      - libpcap-dev
      - linux-headers
      - m4
      - util-linux-dev
      - zlib-dev
  environment:
    PRODUCTION: 1
    DYNAMIC_LIBXDP: 1
    FORCE_SYSTEM_LIBBPF: 1
    FORCE_EMACS: 1
    LIBDIR: /usr/lib
    SBINDIR: /usr/bin

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/xdp-project/xdp-tools
      tag: v${{package.version}}
      expected-commit: 16660520561863d49b7de15b1b0c56caebad9d52

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: libxdp
    description: The libxdp package contains the libxdp library for managing XDP programs
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/lib*.so.* ${{targets.contextdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/pkgconfig/ ${{targets.contextdir}}/usr/lib/pkgconfig/
    test:
      pipeline:
        - uses: test/tw/ldd-check

  - name: ${{package.name}}-tests
    description: xdp-tools test scripts and programs
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share
          mv ${{targets.destdir}}/usr/local/share/xdp-tools/ ${{targets.contextdir}}/usr/share/xdp-tools/

  - name: xdp-tools-dev
    pipeline:
      - uses: split/dev
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/include
          mv ${{targets.contextdir}}/usr/local/include/xdp ${{targets.contextdir}}/usr/include/
          rm -rf ${{targets.contextdir}}/usr/local
          rm -rf ${{targets.destdir}}/usr/lib # Empty folder
    dependencies:
      runtime:
        - xdp-tools
    description: xdp-tools dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
        - uses: test/tw/header-check

  - name: xdp-tools-doc
    pipeline:
      - uses: split/manpages
    description: xdp-tools manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: xdp-project/xdp-tools
    use-tag: true
    strip-prefix: v

test:
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        set -e
        xdp-filter help 2>&1 | grep "Usage"
        xdp-loader help 2>&1 | grep "Usage"
        xdpdump help 2>&1 | grep "Usage"
