package:
  name: xdp-tools
  version: 1.5.5
  epoch: 0
  description: A lightweight C library which eases the writing of UNIX daemons
  copyright:
    - license: GPL-2.0-only
    - license: LGPL-2.1-or-later
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - libbpf-dev
      - libelf
      - libpcap-dev
      - linux-headers
      - util-linux-dev
      - clang
  environment:
    PRODUCTION: 1
    DYNAMIC_LIBXDP: 1
    FORCE_SYSTEM_LIBBPF: 1
    SBINDIR: /usr/bin

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/xdp-project/xdp-tools
      tag: v${{package.version}}
      expected-commit: 16660520561863d49b7de15b1b0c56caebad9d52

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: libxdp
    description: The libxdp package contains the libxdp library for managing XDP programs
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          mv ${{targets.destdir}}/usr/local/lib/lib*.so.* ${{targets.contextdir}}/usr/lib
    test:
      pipeline:
        - uses: test/tw/ldd-check
    dependencies:
      runtime:
        - merged-usrsbin
        - wolfi-baselayout

  - name: xdp-tools-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - xdp-tools
    description: xdp-tools dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check

  - name: xdp-tools-doc
    pipeline:
      - uses: split/manpages
    description: xdp-tools manpages
    test:
      pipeline:
        - uses: test/docs

update:
  enabled: true
  github:
    identifier: xdp-project/xdp-tools
    use-tag: true

test:
  pipeline:
    - uses: test/tw/ldd-check
    - runs: |
        set -e
        xdp-filter help 2>&1 | grep "Usage"
        xdp-loader help 2>&1 | grep "Usage"
        xdpdump help 2>&1 | grep "Usage"
