# Generated from https://git.alpinelinux.org/aports/plain/main/zfs/APKBUILD
package:
  name: zfs
  version: "2.3.1"
  epoch: 40
  description: Advanced filesystem and volume manager
  copyright:
    - license: CDDL-1.0
  dependencies:
    runtime:
      - merged-sbin
      - merged-usrsbin
      - wolfi-baselayout

environment:
  contents:
    packages:
      - attr-dev
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - e2fsprogs-dev
      - glib-dev
      - libtirpc-dev
      - libtool
      - linux-headers
      - openssl-dev
      - util-linux-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openzfs/zfs
      expected-commit: f3e4043a36942e67ccbc05318479a07d242fc611
      tag: zfs-${{package.version}}

  - runs: |
      export CFLAGS="$CFLAGS -fno-tree-vectorize"
      export CXXFLAGS="$CXXFLAGS -fno-tree-vectorize"
      ./autogen.sh
      ./configure \
        --prefix=/usr \
        --sbindir=/usr/bin \
        --with-udevdir=/lib/udev \
        --disable-systemd \
        --disable-static \
        --with-python=3 \
        --with-tirpc \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --localstatedir=/var \
        --with-config=user

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      mv ${{targets.destdir}}/sbin/mount.zfs ${{targets.destdir}}/usr/bin/
      rmdir ${{targets.destdir}}/sbin

  - runs: |
      rm -rf "${{targets.destdir}}"/usr/share/initramfs-tools

  - uses: strip

subpackages:
  - name: zfs-dev
    pipeline:
      - uses: split/dev
    description: zfs dev
    test:
      pipeline:
        - uses: test/pkgconf
        - uses: test/tw/ldd-check
    dependencies:
      runtime:
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout

  - name: zfs-doc
    pipeline:
      - uses: split/manpages
    description: zfs manpages
    test:
      pipeline:
        - uses: test/docs
    dependencies:
      runtime:
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout

  - name: zfs-udev
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/lib/udev
          mv ${{targets.destdir}}/lib/udev/* ${{targets.subpkgdir}}/lib/udev/
    description: zfs udev
    dependencies:
      runtime:
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout

  - name: zfs-scripts
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/zfs
          mv ${{targets.destdir}}/usr/share/zfs/* ${{targets.subpkgdir}}/usr/share/zfs/
    description: zfs scripts
    dependencies:
      runtime:
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout

  - name: zfs-utils-py
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/arc_summary \
              ${{targets.destdir}}/usr/bin/arcstat \
              ${{targets.destdir}}/usr/bin/dbufstat \
              ${{targets.subpkgdir}}/usr/bin
    description: zfs utils
    dependencies:
      runtime:
        - merged-sbin
        - merged-usrsbin
        - wolfi-baselayout

update:
  enabled: true
  github:
    identifier: openzfs/zfs
    strip-prefix: zfs-
    tag-filter: zfs-

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        raidz_test -h
        fsck.zfs --version
        zed -h
        zfs --help
        zpool --help
        ztest --help
        fsck.zfs --help
        zed version
        zed help
        zstreamdump -v
    - uses: test/tw/ldd-check
