package:
  name: zipkin
  version: 3.5.0
  epoch: 0
  description: Zipkin distributed tracing system
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - busybox
      - ca-certificates
      - openjdk-21-default-jvm

data:
  - name: openjdk-versions
    items:
      21: "/usr/lib/jvm/java-21-openjdk"

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - maven
      - openjdk-21
      - unzip

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openzipkin/zipkin
      tag: ${{package.version}}
      expected-commit: 0f8fc88d33131dc938532322e19126def8cad8e8

  - runs: |
      export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
      ./mvnw -X -q --batch-mode -DskipTests --also-make -pl zipkin-server clean install
      mkdir -p ${{targets.destdir}}/zipkin
      mkdir -p ${{targets.destdir}}/usr/local/bin
      unzip zipkin-server/target/zipkin-server-*-exec.jar -d ${{targets.destdir}}/zipkin
      cp -av docker/start-zipkin ${{targets.destdir}}/usr/local/bin/

subpackages:
  - name: zipkin-slim
    dependencies:
      runtime:
        - bash
        - busybox
        - ca-certificates
        - openjdk-21-default-jvm
    pipeline:
      - runs: |
          export JAVA_HOME="/usr/lib/jvm/java-21-openjdk"
          mkdir -p ${{targets.subpkgdir}}/zipkin
          mkdir -p ${{targets.subpkgdir}}/usr/local/bin
          unzip zipkin-server/target/zipkin-server-*-slim.jar -d ${{targets.subpkgdir}}/zipkin
          cp -av docker/start-zipkin ${{targets.subpkgdir}}/usr/local/bin/
    test:
      pipeline:
        - name: Running the server
          uses: test/daemon-check-output
          working-directory: /zipkin
          with:
            start: |
              start-zipkin
            timeout: 60
            expected_output: |
              Serving HTTP
              http://127.0.0.1:9411/

test:
  pipeline:
    - name: Running the server
      uses: test/daemon-check-output
      working-directory: /zipkin
      with:
        start: |
          start-zipkin
        timeout: 60
        expected_output: |
          Serving HTTP
          http://127.0.0.1:9411/

update:
  enabled: true
  github:
    identifier: openzipkin/zipkin
    use-tag: true
