# Generated from https://git.alpinelinux.org/aports/plain/main/zsh/APKBUILD
package:
  name: zsh
  version: "5.9"
  epoch: 5
  description: Very advanced and programmable command interpreter (shell)
  copyright:
    - license: MIT-Modern-Variant AND ISC AND GPL-2.0-only

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - diffutils
      - libcap-dev
      - ncurses-dev
      - pcre-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 73d317384c9225e46d66444f93b46f0fbe7084ef
      repository: https://git.code.sf.net/p/zsh/code
      tag: zsh-${{package.version}}

  - runs: |
      set -x
      # see https://github.com/chainguard-dev/melange/issues/1422
      git fetch --no-tags origin master:master
      # Fix configure.ac to use valid C in tests with gcc-14
      git show 4c89849c98172c951a9def3690e8647dae76308f -- configure.ac > partial-cherry-pick.patch
      git apply partial-cherry-pick.patch

  # https://www.zsh.org/mla/workers/2022/msg00964.html
  - uses: patch
    with:
      patches: implicit.patch no-build-docs.patch

  - name: Remove completions for other platforms.
    runs: |
      rm -rf Completion/{AIX, BSD, Cygwin, Darwin, Debian, Mandriva, Redhat, Solaris, openSUSE}

  - runs: autoreconf -fiv

  - uses: autoconf/configure
    with:
      opts: |
        --build=${{host.triplet.gnu}} \
        --host=${{host.triplet.gnu}} \
        --prefix=/usr \
        --bindir=/bin \
        --enable-etcdir=/etc/zsh \
        --enable-pcre \
        --enable-cap \
        --enable-multibyte \
        --enable-function-subdirs \
        --enable-zsh-secure-free \
        --sysconfdir=/etc \
        --with-tcsetpgrp \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      install -Dm644 LICENCE ${{targets.destdir}}/usr/share/licenses/${{package.name}}/LICENCE

      install -d ${{targets.destdir}}/usr/share/zsh/plugins
      install -d ${{targets.destdir}}/etc/zsh/zshrc.d

      install -Dm644 -t ${{targets.destdir}}/etc/zsh/ \
        zprofile \
        zshenv \
        zshrc

  - uses: strip

subpackages:
  - name: zsh-calendar
    dependencies:
      runtime:
        - zsh
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
          mv ${{targets.destdir}}/usr/share/${{package.name}}/${{package.version}}/functions/Calendar ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
    description: Calendar Function System for Zsh

  - name: zsh-pcre
    dependencies:
      runtime:
        - zsh
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh
          mv ${{targets.destdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh/pcre.so ${{targets.subpkgdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})
    description: zsh FIXME

  - name: zsh-vcs
    dependencies:
      runtime:
        - zsh
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
          mv ${{targets.destdir}}/usr/share/${{package.name}}/${{package.version}}/functions/VCS_Info ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
    description: Version Control Information module for Zsh (vcs_info)

  - name: zsh-zftp
    dependencies:
      runtime:
        - zsh
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh
          mv ${{targets.destdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh/zftp.so ${{targets.subpkgdir}}/usr/lib/${{package.name}}/${{package.version}}/zsh
          mkdir -p ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
          mv ${{targets.destdir}}/usr/share/${{package.name}}/${{package.version}}/functions/Zftp ${{targets.subpkgdir}}/usr/share/${{package.name}}/${{package.version}}/functions
    description: Zftp Function System for Zsh
    test:
      pipeline:
        - uses: test/ldd-check
          with:
            packages: $(basename ${{targets.contextdir}})

update:
  enabled: true
  release-monitor:
    identifier: 5307

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        zsh --version
        zsh-5.9 --version
        zsh --help
        zsh-5.9 --help
    - uses: test/ldd-check
      with:
        packages: ${{package.name}}
